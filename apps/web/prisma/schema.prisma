generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  role          String    @default("USER") // ADMIN, USER, VET
  approved      Boolean   @default(false)
  
  // Extended Profile
  firstName     String?
  lastName      String?
  dni           String?
  phone         String?
  jobTitle      String?
  dob           DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  farms            Farm[]
}

// 1. Entidades Principales (Referenciales y Estructurales)

model Farm {
  id                    String    @id @default(cuid())
  name                  String
  lat                   Float?
  lon                   Float?
  altitude              Float?
  defaultManagementSystem String? // extensivo, intensivo, mixto, ecologico
  
  // New Fields from Frontend
  municipio             String?
  municipioCode         String?
  provinciaCode         String?
  poligono              String?
  parcela               String?
  recintos              String?   // JSON
  coords                String?   // JSON
  superficie            Float     @default(0)
  license               String?
  maxHeads              Int       @default(0)
  soilId                String?
  corrals               Int       @default(0)
  corralNames           String?   // JSON or comma-separated
  feedingSystem         String?
  slope                 Float     @default(0)
  irrigationCoef        Float     @default(0)
  
  // Analysis & Recommendations (Stored as JSON strings or JSON type if DB supports, keeping as String? for compatibility)
  climateStudy          String?   // JSON
  cropsRecommendation   String?   // JSON
  breedsRecommendation  String?   // JSON
  f1Recommendation      String?   // JSON

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt @default(now())

  // User Relation
  userId                String?   // Optional for now to avoid breaking existing data, but should be required in strict mode
  user                  User?     @relation(fields: [userId], references: [id])
  
  // Relaciones
  animals               Animal[]
  dailyLogs             FarmDaily[]
  managementEvents      ManagementEvent[]
}

model Breed {
  id                    String    @id // Código ej. CHA, MOR, WAG
  name                  String
  subspecies            String    // taurus, indicus, composito
  
  // Parámetros Funcionales de Referencia
  adultMaleWeight       Float
  adultFemaleWeight     Float
  refAdgFeedlot         Float
  refAdgPasture         Float
  refFcrFeedlot         Float
  
  heatTolerance         Float     // 0-1
  marblingPotential     Int       // 1-5
  calvingEase           Float     // 0-1 (renamed or kept as is, schema said %)
  
  // Nuevos Parámetros Sapiens (Fase 5)
  milkPotential         Int       @default(1) // 1-5
  conformationPotential Int       @default(3) // 1-6 (P-S scale: P=1, O=2, R=3, U=4, E=5, S=6)
  yieldPotential        Float     @default(0.55) // 0.50 - 0.70

  source                String?

  // Relaciones
  genotypesByMother     Genotype[] @relation("MotherBreed")
  genotypesByFather     Genotype[] @relation("FatherBreed")
}

model Genotype {
  id                    String    @id @default(cuid())
  type                  String    // pure, f1, mestizo, composito
  label                 String    // ej. "F1 MOR-CHA"
  confidence            Float     // 0-1
  functionalType        String    // infiltracion, crecimiento_magro, rustica_adaptada, composito

  // Genealogía Genética
  motherBreedId         String?
  motherBreed           Breed?    @relation("MotherBreed", fields: [motherBreedId], references: [id])
  fatherBreedId         String?
  fatherBreed           Breed?    @relation("FatherBreed", fields: [fatherBreedId], references: [id])

  // Overrides opcionales
  customAdg             Float?
  customFcr             Float?

  animals               Animal[]
}

model Animal {
  id                    String    @id // Crotal ES...
  farmId                String
  farm                  Farm      @relation(fields: [farmId], references: [id])
  
  sex                   String    // M, H
  birthDate             DateTime
  
  genotypeId            String
  genotype              Genotype  @relation(fields: [genotypeId], references: [id])

  motherId              String?   // ID Animal Madre
  mother                Animal?   @relation("Mother", fields: [motherId], references: [id])
  fatherId              String?   // ID Animal Padre
  father                Animal?   @relation("Father", fields: [fatherId], references: [id])

  status                String?    // activo, vendido, muerto, sacrificado
  
  // New Fields
  notes                 String?
  corral                String?
  category              String?
  breedName             String?   // For simple string storage if strict relation not used
  currentWeight         Float?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt @default(now())

  // Relaciones Inversas
  childrenAsMother      Animal[]  @relation("Mother")
  childrenAsFather      Animal[]  @relation("Father")
  
  weights               Weight[]
  rations               Ration[]
  events                ManagementEvent[]
  dailyMetrics          DailyMetric[]
  alerts                Alert[]
  qualityPredictions    QualityPrediction[]
  traceabilityReports   TraceabilityReport[]
}

model Weight {
  id                    String    @id @default(cuid())
  animalId              String
  animal                Animal    @relation(fields: [animalId], references: [id])
  
  date                  DateTime
  weightKg              Float
  method                String    // bascula, estimado

  @@unique([animalId, date])
}

// 2. Alimentación y Composición

model Feed {
  id                    String    @id @default(cuid())
  name                  String
  category              String    // pasto, forraje, concentrado, subproducto, suplemento
  
  // Nutricional (Base MS)
  dmPercent             Float
  cpPercentDm           Float
  fdnPercentDm          Float
  adfPercentDm          Float
  netEnergyMcalKgDm     Float
  
  riskLevel             String?   // bajo, medio, alto
  notes                 String?
  costPerKgFresh        Float     // €/kg fresco
  
  source                String?

  rationItems           RationItem[]
}

model Ration {
  id                    String    @id @default(cuid())
  animalId              String
  animal                Animal    @relation(fields: [animalId], references: [id])
  
  date                  DateTime
  objective             String    // calidad, eficiencia, acabado, rusticidad
  origin                String    // manual, recomendada, ajuste

  items                 RationItem[]

  @@unique([animalId, date])
}

model RationItem {
  id                    String    @id @default(cuid())
  rationId              String
  ration                Ration    @relation(fields: [rationId], references: [id])
  
  feedId                String
  feed                  Feed      @relation(fields: [feedId], references: [id])
  
  amountFreshKg         Float
  amountDmKg            Float?

  @@index([rationId])
  @@index([feedId])
}

// 3. Entorno y Manejo

model FarmDaily {
  id                    String    @id @default(cuid())
  farmId                String
  farm                  Farm      @relation(fields: [farmId], references: [id])
  
  date                  DateTime
  
  maxTemp               Float?
  minTemp               Float?
  humidity              Float?
  precipitation         Float?
  heatStressIndex       Float?
  
  notes                 String?

  @@unique([farmId, date])
}

model ManagementEvent {
  id                    String    @id @default(cuid())
  farmId                String
  farm                  Farm      @relation(fields: [farmId], references: [id])
  
  animalId              String?
  animal                Animal?   @relation(fields: [animalId], references: [id])
  
  date                  DateTime
  type                  String    // destete, cambio_lote, tratamiento, cambio_dieta, cubricion, parto, entrada_cebo, salida_cebo
  
  details               String?   // New: Description/Notes
  cost                  Float     @default(0)
  status                String    @default("completed") // scheduled, pending, completed
  eventData             String?   // JSON for extra data
  
  notes                 String?
}

// 4. Motor: Objetivos, Métricas, Alertas y Predicciones

model Target {
  id                    String    @id @default(cuid())
  functionalType        String    // infiltracion, crecimiento_magro...
  stage                 String    // pre_destete, recria, terminado...
  
  minEnergy             Float
  minProtein            Float
  minFdn                Float
  minConcentrate        Float
  maxConcentrate        Float
  
  refAdg                Float
  refFcr                Float
  
  version               Int       @default(1)
}

model DailyMetric {
  id                    String    @id @default(cuid())
  animalId              String
  animal                Animal    @relation(fields: [animalId], references: [id])
  
  date                  DateTime
  calculatedStage       String
  
  totalDmKg             Float
  dietEnergy            Float
  dietProtein           Float
  dietFdn               Float
  dietAdf               Float
  
  adgObserved           Float?
  fcrObserved           Float?
  
  adgPredicted          Float?
  fcrPredicted          Float?

  @@unique([animalId, date])
}

model Alert {
  id                    String    @id @default(cuid())
  animalId              String
  animal                Animal    @relation(fields: [animalId], references: [id])
  
  date                  DateTime
  type                  String    // acidosis_riesgo, baja_ganancia, ineficiencia...
  severity              String    // info, warning, critical
  message               String
  ruleCode              String    // ej. RISK_ACIDOSIS_01
  
  resolvedAt            DateTime?
}

model QualityPrediction {
  id                    String    @id @default(cuid())
  animalId              String
  animal                Animal    @relation(fields: [animalId], references: [id])
  
  date                  DateTime
  qualityIndex          Float     // 0-100
  
  predTenderness        Float?
  predMarbling          Float?
  predColor             String?
  
  confidence            Float     // 0-1
  modelVersion          String
}

model TraceabilityReport {
  id                    String    @id @default(cuid())
  animalId              String
  animal                Animal    @relation(fields: [animalId], references: [id])
  
  issueDate             DateTime
  summaryJson           String    // JSON string
  qrToken               String    @unique
}
