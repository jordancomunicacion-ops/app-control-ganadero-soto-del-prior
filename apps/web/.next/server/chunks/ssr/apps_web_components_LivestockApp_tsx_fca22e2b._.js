module.exports=[33770,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(18402),e=a.i(4806);let f=a=>{let b=a.replace(/^([A-Z])|[\s-_]+(\w)/g,(a,b,c)=>c?c.toUpperCase():b.toLowerCase());return b.charAt(0).toUpperCase()+b.slice(1)},g=(...a)=>a.filter((a,b,c)=>!!a&&""!==a.trim()&&c.indexOf(a)===b).join(" ").trim();var h={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let i=(0,c.forwardRef)(({color:a="currentColor",size:b=24,strokeWidth:d=2,absoluteStrokeWidth:e,className:f="",children:i,iconNode:j,...k},l)=>(0,c.createElement)("svg",{ref:l,...h,width:b,height:b,stroke:a,strokeWidth:e?24*Number(d)/Number(b):d,className:g("lucide",f),...!i&&!(a=>{for(let b in a)if(b.startsWith("aria-")||"role"===b||"title"===b)return!0})(k)&&{"aria-hidden":"true"},...k},[...j.map(([a,b])=>(0,c.createElement)(a,b)),...Array.isArray(i)?i:[i]])),j=(a,b)=>{let d=(0,c.forwardRef)(({className:d,...e},h)=>(0,c.createElement)(i,{ref:h,iconNode:b,className:g(`lucide-${f(a).replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}`,`lucide-${a}`,d),...e}));return d.displayName=f(a),d},k=j("house",[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"r6nss1"}]]),l=j("map-pin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]),m=j("beef",[["path",{d:"M16.4 13.7A6.5 6.5 0 1 0 6.28 6.6c-1.1 3.13-.78 3.9-3.18 6.08A3 3 0 0 0 5 18c4 0 8.4-1.8 11.4-4.3",key:"cisjcv"}],["path",{d:"m18.5 6 2.19 4.5a6.48 6.48 0 0 1-2.29 7.2C15.4 20.2 11 22 7 22a3 3 0 0 1-2.68-1.66L2.4 16.5",key:"5byaag"}],["circle",{cx:"12.5",cy:"8.5",r:"2.5",key:"9738u8"}]]),n=j("calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]),o=j("trending-up",[["path",{d:"M16 7h6v6",key:"box55l"}],["path",{d:"m22 7-8.5 8.5-5-5L2 17",key:"1t1m79"}]]),p=j("chart-column",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"M18 17V9",key:"2bz60n"}],["path",{d:"M13 17V5",key:"1frdt8"}],["path",{d:"M8 17v-3",key:"17ska0"}]]),q=j("database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]]),r=j("user",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]),s=j("users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]]),t=j("log-out",[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]]);function u({activeTab:a,onTabChange:d,onLogout:f}){let{read:g,write:h}=(0,e.useStorage)(),i=g("appSession","Usuario"),j=g("userAvatar",null);c.default.useEffect(()=>{let a=g("users",[]),b=a.find(a=>a.name.toLowerCase().includes("gerencia")||"gerencia@sotodelprior.com"===a.email);if(b){if("admin"!==b.role){let c={...b,role:"admin"};h("users",[...a.filter(a=>a.name!==b.name),c]),window.location.reload()}}else h("users",[...a,{name:"Gerencia",email:"gerencia@sotodelprior.com",pass:"admin123",role:"admin",joined:new Date().toISOString(),jobTitle:"Direcci√≥n General",firstName:"Gerencia",lastName:"Soto del Prior"}]),console.log("Auto-created Gerencia account")},[i,g,h]);let u=g("users",[]).find(a=>a.name===i),v=u?.role||"worker",w=i?.toLowerCase().includes("gerencia")||"gerencia@sotodelprior.com"===i,x="admin"===v||w,y=[{id:"home",label:"Inicio",icon:k},{id:"farms",label:"Fincas",icon:l},{id:"animals",label:"Animales",icon:m},{id:"events",label:"Eventos",icon:n},{id:"calculator",label:"Rendimiento",icon:o},{id:"reports",label:"Reportes",icon:p},{id:"users",label:"Equipo",icon:s},{id:"data",label:"Datos",icon:q}].filter(a=>"calculator"!==a.id&&"reports"!==a.id&&"data"!==a.id&&"users"!==a.id||x),z=i||"Usuario";return(0,b.jsxs)("aside",{className:"w-64 bg-white border-r border-gray-200 h-screen flex flex-col fixed left-0 top-0 z-30 shadow-sm",children:[(0,b.jsx)("div",{className:"p-4 flex justify-center border-b border-gray-100",children:(0,b.jsx)("img",{src:"/logo-text.png",alt:"SOTO DEL PRIOR",className:"h-12"})}),(0,b.jsxs)("div",{className:"p-6 border-b border-gray-100 flex items-center gap-3",children:[j?(0,b.jsx)("img",{src:j,alt:"Profile",className:"w-10 h-10 rounded-full object-cover"}):(0,b.jsx)("div",{className:"w-10 h-10 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-lg",children:z.charAt(0).toUpperCase()}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"font-bold text-gray-800 text-sm truncate w-32",children:z}),(0,b.jsx)("p",{className:"text-xs text-gray-500 capitalize",children:x?"Administrador":v})]})]}),(0,b.jsx)("nav",{className:"flex-1 p-4 space-y-1 overflow-y-auto",children:y.map(c=>(0,b.jsxs)("button",{onClick:()=>d(c.id),className:`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors ${a===c.id?"bg-green-50 text-green-700":"text-gray-600 hover:bg-gray-50 hover:text-gray-900"}`,children:[(0,b.jsx)(c.icon,{className:"w-5 h-5"}),c.label]},c.id))}),(0,b.jsxs)("div",{className:"p-4 border-t border-gray-100 space-y-2",children:[(0,b.jsxs)("button",{onClick:()=>d("profile"),className:`w-full flex items-center gap-3 px-4 py-2 text-sm font-medium transition-colors ${"profile"===a?"bg-green-50 text-green-700":"text-gray-600 hover:bg-gray-50 hover:text-gray-900"}`,children:[(0,b.jsx)(r,{className:"w-5 h-5"}),(0,b.jsx)("span",{children:"Mi Perfil"})]}),(0,b.jsxs)("button",{onClick:f,className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:text-red-700 rounded-lg hover:bg-red-50",children:[(0,b.jsx)(t,{className:"w-5 h-5"}),(0,b.jsx)("span",{children:"Cerrar Sesi√≥n"})]})]})]})}function v({children:a,activeTab:c,onTabChange:d,onLogout:e}){return(0,b.jsxs)("div",{className:"min-h-screen bg-gray-50 flex",children:[(0,b.jsx)(u,{activeTab:c,onTabChange:d,onLogout:e}),(0,b.jsx)("main",{className:"flex-1 ml-64 p-8",children:(0,b.jsx)("div",{className:"max-w-7xl mx-auto",children:a})})]})}let w={getWeatherDescription(a){switch(a){case 0:return"Despejado";case 1:case 2:case 3:return"Nublado";case 45:case 48:return"Niebla";case 51:case 53:case 55:return"Llovizna";case 61:case 63:case 65:return"Lluvia";case 71:case 73:case 75:return"Nueve";case 95:case 96:case 99:return"Tormenta";default:return"Desconocido"}},async getCurrentWeather(a,b){try{let c=`https://api.open-meteo.com/v1/forecast?latitude=${a}&longitude=${b}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m`,d=await fetch(c);if(!d.ok)throw Error("Weather API Error");let e=(await d.json()).current;return{temperature:e.temperature_2m,humidity:e.relative_humidity_2m,wind_speed:e.wind_speed_10m,weather_code:e.weather_code,weather_desc:this.getWeatherDescription(e.weather_code)}}catch(a){return console.error(a),null}},async getWeeklyPrecipitation(a,b){try{let c=`https://api.open-meteo.com/v1/forecast?latitude=${a}&longitude=${b}&daily=precipitation_sum&past_days=7`,d=await fetch(c),e=await d.json();if(e.daily&&e.daily.precipitation_sum)return e.daily.precipitation_sum.reduce((a,b)=>a+b,0);return 0}catch(a){return 0}},async getForecast(a,b){try{let c=`https://api.open-meteo.com/v1/forecast?latitude=${a}&longitude=${b}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto&forecast_days=4`,d=await fetch(c),e=await d.json();if(!e.daily)return[];let f=e.daily,g=[];for(let a=0;a<3;a++)g.push({date:f.time[a],icon:this.getWeatherIcon(f.weather_code[a]),max:f.temperature_2m_max[a],min:f.temperature_2m_min[a],precip:f.precipitation_sum[a],code:f.weather_code[a]});return g}catch(a){return console.error("Forecast Error",a),[]}},getWeatherIcon:a=>0===a?"‚òÄÔ∏è":a<3?"‚õÖ":a<48?"‚òÅÔ∏è":a<60?"üåßÔ∏è":a<80?"‚õàÔ∏è":"üå®Ô∏è",async analyzeClimate(a,b){try{let c=await this.getCurrentWeather(a,b),d=await this.getWeeklyPrecipitation(a,b),e=a<40;return{avgTemp:c?c.temperature:15,classification:e?"Mediterr√°neo Seco":"Continental Templado",annualPrecip:Math.round(40*d+(e?300:600))}}catch(a){return console.error("Climate Analysis Error",a),{avgTemp:15,classification:"Desconocido",annualPrecip:500}}}},x={w_age:.015,w_energy:.01,w_adg:.01,w_stress:-.01,age_ref_start_months:12,age_ref_end_months:24,EN_min:1.3,EN_max:2.2,THI_threshold:72,THI_max:84,adg_ratio_min:.8,adg_ratio_max:1.2},y={rc_feedlot:.59,rc_grazing:.56,rc_mixed:.575},z={EN_finish_threshold:1.85,concentrate_share_threshold:.4},A={clamp:(a,b,c)=>Math.max(b,Math.min(c,a)),normalize(a,b,c){return c===b?0:this.clamp((a-b)/(c-b),0,1)},calculateTHI(a,b){if(null==a)return 0;let c=1.8*a+32;return c-(.55-.0055*(null==b?50:b))*(c-58)},estimateCarcassResult(a,b,c,d,e,f){let g=x,h=parseFloat(f.yield_potential||f.rc_base);if(isNaN(h)){let b=(a.system||"Intensivo").toLowerCase();h=b.includes("pastoreo")?y.rc_grazing:b.includes("mixto")?y.rc_mixed:y.rc_feedlot}let i=a.ageMonths||12,j=this.normalize(i,g.age_ref_start_months,g.age_ref_end_months),k=this.normalize(d,g.EN_min,g.EN_max),l=parseFloat(f.adg_feedlot||"1.2");0===l&&(l=1.2);let m=c/l,n=this.normalize(m,g.adg_ratio_min,g.adg_ratio_max),o=this.normalize(e,g.THI_threshold,g.THI_max),p=g.w_age*j+g.w_energy*k+g.w_adg*n+g.w_stress*o,q=parseFloat(f.rc_min)||.54,r=parseFloat(f.rc_max)||.66,s=this.clamp(h+p,q,r),t=b*s;return{rc_est:parseFloat(s.toFixed(4)),rc_percent:parseFloat((100*s).toFixed(2)),carcass_weight:parseFloat(t.toFixed(1))}},calculateQualityIndex(a,b,c,d,e,f,g,h,i={}){let j={nei_min:b.nei_min||12,nei_max:b.nei_max||18,dof_min:b.dof_min||90,dof_max:b.dof_max||200,adg_min:b.adg_min_quality||.6,adg_max:b.adg_max_quality||1.4,thi_comfort:b.thi_comfort||72,thi_max:b.thi_max||84,changes_limit:b.changes_30d_limit||4,weights:b.weights||{w_dof:1,w_nei:1,w_conc:.6,w_adg:.8,w_heat:1,w_stab:.8,w_health:.7,z0:1,k:3}},k=j.weights,l=a.weight||a.currentWeight||500,m=b.dmi_pct_pv||.021,n=this.normalize(l*m*c,j.nei_min,j.nei_max),o=this.normalize(f,j.dof_min,j.dof_max),p=this.normalize(d,j.adg_min,j.adg_max),q=this.clamp((e-j.thi_comfort)/(j.thi_max-j.thi_comfort),0,1),r=this.clamp(g/j.changes_limit,0,1),s=this.clamp(h,0,1),t=k.w_dof*o+k.w_nei*n+k.w_conc*n+k.w_adg*p-k.w_heat*q-k.w_stab*r-k.w_health*s-k.z0,u=100/(1+Math.exp(-k.k*t)),v=parseFloat(b.marbling_potential)||3,w=this.clamp(1+u/100*(v-1),1,v),x=i&&(i.isBellota||i.highOleic),y=i&&i.hasLecithin;if(x&&y){let b=.25;("Macho"===a.sex||"Castrado"===a.sex)&&(a.ageMonths||0)>30&&(b=.6),w+=b}w=this.clamp(w,1,5);let z=this.clamp(1+(w-1)*2.75,1,12),A=w>=4.2;return{iq_score:parseFloat(u.toFixed(1)),marbling_est:parseFloat(w.toFixed(1)),bms_est:parseFloat(z.toFixed(1)),conformation_est:this.estimateConformation(a.rc_percent||55),is_premium:A}},isFinishingDiet(a,b){let c=z;return a>=c.EN_finish_threshold||b>=c.concentrate_share_threshold},estimateConformation:a=>a?a>=64?"S":a>=62?"E":a>=60?"U":a>=57?"R":a>=54?"O":"P":"R"},B=[{id:"WAG",code:"WAG",name:"Wagyu",subspecies:"Bos taurus",biological_type:"British",weight_male_adult:850,weight_female_adult:550,slaughter_age_months:29,adg_feedlot:.9,adg_grazing:.6,fcr_feedlot:8.5,heat_tolerance:5,marbling_potential:5,calving_ease:9,milk_potential:2,conformation_potential:3,yield_potential:.52},{id:"ANG",code:"ANG",name:"Angus",subspecies:"Bos taurus",biological_type:"British",weight_male_adult:900,weight_female_adult:500,slaughter_age_months:18,adg_feedlot:1.4,adg_grazing:.9,fcr_feedlot:7.9,heat_tolerance:4,marbling_potential:4,calving_ease:8,milk_potential:3,conformation_potential:4,yield_potential:.54},{id:"HER",code:"HER",name:"Hereford",subspecies:"Bos taurus",biological_type:"British",weight_male_adult:1e3,weight_female_adult:580,slaughter_age_months:20,adg_feedlot:1.4,adg_grazing:.8,fcr_feedlot:7.8,heat_tolerance:3,marbling_potential:3,calving_ease:7,milk_potential:2,conformation_potential:4,yield_potential:.53},{id:"CHA",code:"CHA",name:"Charolais",subspecies:"Bos taurus",biological_type:"Continental",weight_male_adult:1100,weight_female_adult:800,slaughter_age_months:24,adg_feedlot:1.5,adg_grazing:1,fcr_feedlot:7.2,heat_tolerance:3,marbling_potential:2,calving_ease:4,milk_potential:2,conformation_potential:5,yield_potential:.58},{id:"LIM",code:"LIM",name:"Limousin",subspecies:"Bos taurus",biological_type:"Continental",weight_male_adult:950,weight_female_adult:650,slaughter_age_months:16,adg_feedlot:1.4,adg_grazing:.9,fcr_feedlot:7.4,heat_tolerance:4,marbling_potential:3,calving_ease:6,milk_potential:2,conformation_potential:5,yield_potential:.58},{id:"BDA",code:"BDA",name:"Blonde d'Aquitaine",subspecies:"Bos taurus",biological_type:"Continental",weight_male_adult:1200,weight_female_adult:700,slaughter_age_months:18,adg_feedlot:1.6,adg_grazing:1.1,fcr_feedlot:7.1,heat_tolerance:3,marbling_potential:2,calving_ease:5,milk_potential:2,conformation_potential:5,yield_potential:.61},{id:"AZB",code:"AZB",name:"Azul Belga",subspecies:"Bos taurus",biological_type:"Continental",weight_male_adult:1175,weight_female_adult:775,slaughter_age_months:16,adg_feedlot:1.7,adg_grazing:1,fcr_feedlot:6.8,heat_tolerance:1,marbling_potential:1,calving_ease:2,milk_potential:2,conformation_potential:6,yield_potential:.64},{id:"PIR",code:"PIR",name:"Pirenaica",subspecies:"Bos taurus",biological_type:"Rustic_European",weight_male_adult:900,weight_female_adult:600,slaughter_age_months:18,adg_feedlot:1.3,adg_grazing:.85,fcr_feedlot:7.8,heat_tolerance:5,marbling_potential:3,calving_ease:7,milk_potential:2,conformation_potential:4,yield_potential:.56},{id:"MOR",code:"MOR",name:"Morucha",subspecies:"Bos taurus",biological_type:"Rustic_European",weight_male_adult:900,weight_female_adult:500,slaughter_age_months:30,adg_feedlot:1.1,adg_grazing:.7,fcr_feedlot:8.4,heat_tolerance:8,marbling_potential:3,calving_ease:8,milk_potential:2,conformation_potential:2,yield_potential:.52},{id:"RET",code:"RET",name:"Retinta",subspecies:"Bos taurus",biological_type:"Rustic_European",weight_male_adult:1e3,weight_female_adult:580,slaughter_age_months:30,adg_feedlot:1.1,adg_grazing:.75,fcr_feedlot:8.3,heat_tolerance:8,marbling_potential:3,calving_ease:8,milk_potential:2,conformation_potential:3,yield_potential:.53},{id:"BER",code:"BER",name:"Berrenda",subspecies:"Bos taurus",biological_type:"Rustic_European",weight_male_adult:800,weight_female_adult:500,slaughter_age_months:23,adg_feedlot:1.1,adg_grazing:.7,fcr_feedlot:8.3,heat_tolerance:8,marbling_potential:3,calving_ease:8,milk_potential:2,conformation_potential:3,yield_potential:.53},{id:"BET",code:"BET",name:"Betizu",subspecies:"Bos taurus",biological_type:"Rustic_European",weight_male_adult:450,weight_female_adult:325,slaughter_age_months:36,adg_feedlot:.9,adg_grazing:.55,fcr_feedlot:9.2,heat_tolerance:7,marbling_potential:2,calving_ease:10,milk_potential:1,conformation_potential:2,yield_potential:.48},{id:"SIM",code:"SIM",name:"Simmental",subspecies:"Bos taurus",biological_type:"Dairy",weight_male_adult:1100,weight_female_adult:750,slaughter_age_months:18,adg_feedlot:1.5,adg_grazing:.85,fcr_feedlot:7,heat_tolerance:4,marbling_potential:3,calving_ease:6,milk_potential:3,conformation_potential:5,yield_potential:.56},{id:"HOL",code:"HOL",name:"Holstein",subspecies:"Bos taurus",biological_type:"Dairy",weight_male_adult:1e3,weight_female_adult:650,slaughter_age_months:20,adg_feedlot:1.2,adg_grazing:.6,fcr_feedlot:8.5,heat_tolerance:2,marbling_potential:2,calving_ease:5,milk_potential:5,conformation_potential:2,yield_potential:.49},{id:"FRI",code:"FRI",name:"Frisona",subspecies:"Bos taurus",biological_type:"Dairy",weight_male_adult:950,weight_female_adult:600,slaughter_age_months:20,adg_feedlot:1.15,adg_grazing:.6,fcr_feedlot:8.6,heat_tolerance:2,marbling_potential:2,calving_ease:5,milk_potential:5,conformation_potential:2,yield_potential:.48},{id:"BRA",code:"BRA",name:"Brahman",subspecies:"Bos indicus",biological_type:"Indicus",weight_male_adult:900,weight_female_adult:550,slaughter_age_months:24,adg_feedlot:1.1,adg_grazing:.8,fcr_feedlot:8,heat_tolerance:10,marbling_potential:2,calving_ease:9,milk_potential:3,conformation_potential:3,yield_potential:.51},{id:"NEL",code:"NEL",name:"Nelore",subspecies:"Bos indicus",biological_type:"Indicus",weight_male_adult:900,weight_female_adult:550,slaughter_age_months:26,adg_feedlot:1.05,adg_grazing:.75,fcr_feedlot:8.2,heat_tolerance:10,marbling_potential:2,calving_ease:9,milk_potential:2,conformation_potential:3,yield_potential:.52},{id:"DRM",code:"DRM",name:"Droughtmaster",subspecies:"Cruzado",biological_type:"Composite",weight_male_adult:900,weight_female_adult:550,slaughter_age_months:24,adg_feedlot:1.2,adg_grazing:.9,fcr_feedlot:7.9,heat_tolerance:9,marbling_potential:3,calving_ease:9,milk_potential:2,conformation_potential:3,yield_potential:.53}],C={getAllBreeds:()=>B,getBreedById:a=>B.find(b=>b.id===a||b.code===a),getBreedByName:a=>B.find(b=>b.name.toLowerCase()===a.toLowerCase()),calculateHybrid(a,b){let c=this.getBreedById(a),d=this.getBreedById(b);if(!c||!d)return null;let e={British:1,Continental:2,Rustic_European:3,Dairy:4,Indicus:5,Composite:3},f=(e[c.biological_type]||3)===(e[d.biological_type]||3)?.02:.05;"Indicus"===c.biological_type!=("Indicus"===d.biological_type)&&(f=.12);let g=c.weight_male_adult/d.weight_female_adult,h=0;g>1.1&&(h=(g-1.1)*20);let i=(.6*c.adg_feedlot+.4*d.adg_feedlot)*(1+1.5*f)*(d.milk_potential>=4?1.05:d.milk_potential<=2?.95:1),j=.6*c.yield_potential+.4*d.yield_potential,k=.4*c.marbling_potential+.6*d.marbling_potential,l=(.6*c.weight_male_adult+.4*d.weight_male_adult)*(1+f),m=(.6*c.weight_female_adult+.4*d.weight_female_adult)*(1+f),n=.6*c.conformation_potential+.4*d.conformation_potential,o=Math.max(1,.3*c.calving_ease+.7*d.calving_ease-h);return{id:`F1_${c.code}_${d.code}`,code:`${c.code}x${d.code}`,name:`F1 ${d.name} x ${c.name}`,subspecies:"Cruzado",biological_type:"Composite",weight_male_adult:l,weight_female_adult:m,slaughter_age_months:(c.slaughter_age_months+d.slaughter_age_months)/2,adg_feedlot:i,adg_grazing:.7*i,fcr_feedlot:(c.fcr_feedlot+d.fcr_feedlot)/2*(1-.5*f),heat_tolerance:Math.max(c.heat_tolerance,d.heat_tolerance),marbling_potential:k,calving_ease:o,milk_potential:.6*c.milk_potential+.4*d.milk_potential,conformation_potential:n,yield_potential:j,is_hybrid:!0,sire_name:c.name,dam_name:d.name}}},D={isBuey:(a,b)=>a?.category==="Buey"||a?.sex==="Castrado"&&!!(b>12),inferSystem(a){let b=(a.farm||"").toLowerCase();return b.includes("feedlot")||b.includes("cebo")?"Intensivo (Feedlot)":"SOTO del PRIOR"===a.farm||b.includes("dehesa")||b.includes("soto")?"Montanera (Bellota)":"Extensivo (Pastoreo)"},getReproStatus(a,b,c){if("Hembra"!==a.sex||!b||0===b.length)return 0;let d=[...b].sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime()).filter(a=>new Date(a.date)<=c),e=d.find(a=>"Parto"===a.type),f=d.find(a=>"Inseminaci√≥n"===a.type||"Monta"===a.type);if(f&&(!e||new Date(f.date)>new Date(e.date))){let a=(c.getTime()-new Date(f.date).getTime())/864e5/30.44;if(a>8.5)return 50;if(a>7.5)return 30;if(a>6)return 15}if(e){let a=(c.getTime()-new Date(e.date).getTime())/864e5;if(a<90)return -35;if(a<150)return -15}return 0},calculateRealisticWeight(a,b,c=[]){if(!a.birth&&!a.birthDate)return 0;let d=new Date(a.birth||a.birthDate),e=new Date,f=C.getBreedByName(a.breed),g=(a.breed||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");!f&&g&&(g.includes("betizu")?f={id:"MANUAL_BETIZU",code:"BET",name:"Betizu",biological_type:"Rustic_European",weight_female_adult:320,weight_male_adult:450,adg_feedlot:.6,slaughter_age_months:36}:g.includes("limousin")||g.includes("limusin")?f={id:"MANUAL_LIM",code:"LIM",name:"Limousin",biological_type:"Continental",weight_female_adult:700,weight_male_adult:1100,adg_feedlot:1.4,slaughter_age_months:18}:g.includes("charol")?f={id:"MANUAL_CHA",code:"CHA",name:"Charolais",biological_type:"Continental",weight_female_adult:800,weight_male_adult:1200,adg_feedlot:1.5,slaughter_age_months:18}:g.includes("avile")?f={id:"MANUAL_AVI",code:"AVI",name:"Avile√±a",biological_type:"Rustic_European",weight_female_adult:550,weight_male_adult:900,adg_feedlot:1.1,slaughter_age_months:24}:g.includes("retinta")?f={id:"MANUAL_RET",code:"RET",name:"Retinta",biological_type:"Rustic_European",weight_female_adult:580,weight_male_adult:950,adg_feedlot:1.1,slaughter_age_months:24}:g.includes("morucha")?f={id:"MANUAL_MOR",code:"MOR",name:"Morucha",biological_type:"Rustic_European",weight_female_adult:550,weight_male_adult:900,adg_feedlot:1.1,slaughter_age_months:24}:g.includes("frison")?f={id:"MANUAL_FRI",code:"FRI",name:"Frisona",biological_type:"Dairy",weight_female_adult:650,weight_male_adult:1e3,adg_feedlot:1.2,slaughter_age_months:22}:g.includes("wagyu")?f={id:"MANUAL_WAG",code:"WAG",name:"Wagyu",biological_type:"British",weight_female_adult:550,weight_male_adult:850,adg_feedlot:.9,slaughter_age_months:30}:(g.includes("mestiz")||g.includes("cruzad"))&&(f={id:"MANUAL_MIX",code:"MIX",name:"Mestiza",biological_type:"Rustic_European",weight_female_adult:580,weight_male_adult:950,adg_feedlot:1.2,slaughter_age_months:24}));let h=600,i=.002;f&&(h="Hembra"===a.sex?f.weight_female_adult:f.weight_male_adult,"Rustic_European"===f.biological_type?i=.0018:"Continental"===f.biological_type?i=.0022:("British"===f.biological_type||f.slaughter_age_months<20)&&(i=.0025));let j="Buey"===a.category||"Castrado"===a.sex;j&&(h*=1.25,i*=.85);let k=40;f&&(k=.07*f.weight_female_adult);let l=new Date(d),m=0;for(;l<e&&m<240;){let a=m,c=l.getMonth(),d=1;if(a<=6)d=1.2,b.includes("Feedlot")&&(d*=1.1);else if(a<=7)d=.5;else if(b.includes("Feedlot"))d=1.3;else if(b.includes("Montanera")){let b=[9,10,11,0,1].includes(c),e=j&&a>12;d=b&&e?1.5:[6,7,8].includes(c)?.4:[2,3,4,5].includes(c)?1.1:.6}else d=[6,7,8].includes(c)?.4:[2,3,4,5].includes(c)?1.1:[9,10].includes(c)?.9:.6;let e=i*(h-k)*d;d<.5&&a>6&&(e=(d-.5)*.5),k+=30.44*e,l.setMonth(l.getMonth()+1),m++}return(k+=this.getReproStatus(a,c,e))<40&&(k=40),parseFloat(k.toFixed(1))}},E={BELLOTA_PROTOCOL:{season_start_month:9,season_end_month:1,min_oleic_acid:55,min_age_months:14,max_bellota_percent:40,min_fdn_bellota:28,min_protein_bellota:12,TYPE_ENCINA:"ENCINA",TYPE_ROBLE:"ROBLE"},calculateKPITargets(a,b,c){let d={adg:.1,fcr:0,energyDensity:2,proteinDensity:10,fiberMin:35,maxConcentrate:30},e=a.functionalType||"rustica_adaptada";!a.functionalType&&a.biological_type&&("Rustic_European"===a.biological_type?e="rustica_adaptada":"Continental"===a.biological_type?e="crecimiento_magro":"British"===a.biological_type?e="infiltracion":"Dairy"===a.biological_type?e="aptitud_lechera":"Indicus"===a.biological_type&&(e="rustica_adaptada"));let f=a.stage||(a.ageMonths<8?"recria":"terminado");return"infiltracion"===e?"terminado"===f||b.includes("Engorde")||b.includes("Cebo")||b.includes("Eficiencia")?(d.energyDensity=2.9,d.proteinDensity=12,d.fiberMin=15,d.maxConcentrate=85,d.adg=.9,d.fcr=8.5):(d.energyDensity=2.4,d.proteinDensity=14,d.adg=.8):"crecimiento_magro"===e?"terminado"===f||b.includes("Engorde")||b.includes("Cebo")||b.includes("Eficiencia")?(d.energyDensity=2.8,d.proteinDensity=14.5,d.fiberMin=18,d.maxConcentrate=80,d.adg=1.6,d.fcr=5.8):(d.energyDensity=2.5,d.proteinDensity=16,d.adg=1.1,d.fcr=5.5):"rustica_adaptada"===e?(d.energyDensity=2.2,d.proteinDensity=11,d.fiberMin=30,d.maxConcentrate=40,d.adg=.7,d.fcr=7.5,c.includes("Montanera")&&(d.adg=1,d.energyDensity=2.8)):"aptitud_lechera"===e?(d.energyDensity=2.6,d.proteinDensity=15,d.fiberMin=25,d.maxConcentrate=60,d.adg=1.2,d.fcr=6.5):"carnica_general"===e?(d.energyDensity=2.7,d.proteinDensity=14,d.fiberMin=20,d.maxConcentrate=70,d.adg=1.4,d.fcr=6.2):"doble_proposito"===e&&(d.energyDensity=2.4,d.proteinDensity=12.5,d.fiberMin=28,d.maxConcentrate=50,d.adg=.9,d.fcr=7.2),"composito"===e&&(d.adg*=1.1,d.fcr*=.95),"Eficiencia Econ√≥mica"===b?(d.adg*=.9,d.maxConcentrate*=.8,d.energyDensity=Math.max(2,.95*d.energyDensity)):"Mantenimiento"===b&&(d.energyDensity=2,d.adg=.1,d.maxConcentrate=10),c.includes("Extensivo")&&!c.includes("Montanera")&&(d.maxConcentrate=Math.min(d.maxConcentrate,30),d.adg=Math.min(d.adg,.8)),d},generateSmartDiet(a,b,c,d){let e=[],f=.025*b.weight,g=0;if(c.includes("Montanera")){let a=.15*f;e.push({feed_id:"paja",feed_name:"Paja de Cereales",dm_kg:parseFloat(a.toFixed(1))});let b=f-(g+=a);return e.push({feed_id:"BELLHO_01",feed_name:"Bellota de Encina",dm_kg:parseFloat((.8*b).toFixed(1))}),e.push({feed_id:"P01",feed_name:"Soja (Harina 44%)",dm_kg:parseFloat((.2*b).toFixed(1))}),e}let h="paja",i="Paja de Cereales",j=.2*f;a.energyDensity>2.7&&(j=.12*f),a.energyDensity<2.3&&(j=.5*f),c.includes("Extensivo")?(h="F01",i="Pasto Dehesa (Primavera)"):c.includes("Ecol√≥gico")&&(h="F03",i="Heno de Avena"),e.push({feed_id:h,feed_name:i,dm_kg:parseFloat(j.toFixed(1))}),g+=j;let k="C01",l="Ma√≠z (Grano)";a.energyDensity<2.5&&(k="C02",l="Cebada"),c.includes("Ecol√≥gico")&&(k="C01",l="Cereal Ecol√≥gico");let m=f-g,n=.6*m;if(a.energyDensity>2.6&&(n=.8*m),a.maxConcentrate<60&&(n=Math.min(n,f*(a.maxConcentrate/100))),e.push({feed_id:k,feed_name:l,dm_kg:parseFloat(n.toFixed(1))}),g+=n,(m=f-g)>0){let a="Soja (Harina 44%)";c.includes("Ecol√≥gico")&&(a="Guisantes Proteicos"),e.push({feed_id:"P01",feed_name:a,dm_kg:parseFloat(m.toFixed(1))})}return e},calculateRequirements(a,b,c,d,e){let f=.025;a>400&&(f=.022),a>700&&(f=.019),"Mantenimiento"===d&&a>600&&(f=.018);let g=a*f,h=Math.pow(a,.75),i=.077*h;"Mantenimiento"===d&&(i*=1.2);let j=1;"Hembra"===e&&(j=1.15),"Castrado"===e&&(j=1.1);let k=12;"Mantenimiento"===d?k=8.5:"Lactancia"===d?k=15:a<300?k=16:a>500&&(k=11.5);let l=30;return"Cebo"===d&&(l=15),"Lactancia"===d&&(l=28),{pb_percent:k,em_mcal:parseFloat(((i+.05*h*Math.pow(b,1.1)*j)/g).toFixed(2)),fdn_min:l,dmi_capacity_kg:parseFloat(g.toFixed(1))}},validateDiet(a,b,c){let d=[];if(b.totalDMI<=0)return d;let e=b.totalFDN/b.totalDMI,f=b.totalProteinVal/10/b.totalDMI,g=String(c||""),h=.28;(g.includes("Cebo")||g.includes("Intensivo"))&&(h=.15),e<h?d.push({code:"ACIDOSIS",level:"critical",message:`Riesgo de Acidosis: Fibra muy baja (${(100*e).toFixed(1)}%). M\xednimo recomendado: ${(100*h).toFixed(0)}%.`,action:"Aumente la proporci√≥n de forraje o fibra efectiva."}):e<h+.04&&d.push({code:"LOW_FIBER",level:"warning",message:`Fibra ajustada (${(100*e).toFixed(1)}%). Vigile la rumia.`,action:"Considere a√±adir algo m√°s de paja o heno."});let i=a.filter(a=>"Leguminosa"===a.item.category||a.item.name.includes("Alfalfa")||a.item.name.includes("Tr√©bol")).reduce((a,b)=>a+b.amount*(b.item.dm_percent/100),0)/b.totalDMI;if((i>.5||i>.3&&e<.22)&&d.push({code:"BLOAT",level:"critical",message:"Alto Riesgo de Meteorismo (Hinchaz√≥n).",action:"Exceso de leguminosas. A√±ada paja o aceite/bloque anti-meteorismo."}),g.includes("Montanera")){let c=a.filter(a=>a.item.name.toLowerCase().includes("bellota")).reduce((a,b)=>a+b.amount*(b.item.dm_percent/100),0)/b.totalDMI,e=a.filter(a=>"Forraje"===a.item.category).reduce((a,b)=>a+b.amount*(b.item.dm_percent/100),0)/b.totalDMI;c>0&&e<.1&&d.push({code:"BELLOTA_FIBER",level:"critical",message:"Falta de Fibra en Montanera.",action:"La bellota no tiene fibra efectiva. El animal DEBE comer hierba o paja."}),c>.6&&f<.1&&d.push({code:"BELLOTA_PROTEIN",level:"warning",message:"D√©ficit Proteico en Montanera.",action:"La bellota es energ√©tica pero baja en prote√≠na. Suplemente con torta de girasol/soja si busca crecimiento."}),a.filter(a=>a.item.name.toLowerCase().includes("roble")).reduce((a,b)=>a+b.amount*(b.item.dm_percent/100),0)/b.totalDMI>.5&&d.push({code:"BELLOTA_TOXICITY",level:"warning",message:"Precauci√≥n: Exceso de Taninos (Roble).",action:"Carga alta de bellota amarga. Vigile el estre√±imiento o rechazo."})}let j=b.reqs.pb_percent/100;return f<j-.02&&d.push({code:"LOW_N_EFF",level:"critical",message:`D\xe9ficit de Prote\xedna (${(100*f).toFixed(1)}% vs ${(100*j).toFixed(1)}%).`,action:"El crecimiento se detendr√°. A√±ada proteaginosas."}),f>j+.04&&d.push({code:"HIGH_POLLUTION",level:"warning",message:`Exceso de Nitr\xf3geno (+${((f-j)*100).toFixed(1)}%). Contaminante y caro.`,action:"Reduzca la prote√≠na para mejorar la eficiencia econ√≥mica y ambiental."}),d},calculateSynergies(a,b,c={}){let d=[],e=a.map(a=>a.feed_name.toLowerCase()),f=e.some(a=>a.includes("bellota")),g=e.some(a=>a.includes("lecitina")||a.includes("harina de soja"));if(f&&g){let a=.5;("Castrado"===b.sex||"Buey"===b.sex)&&(a=.8);let e="üî• Bellota + Lecitina: Infiltraci√≥n mejorada.";"ENCINA"===c.bellotaType?(a+=.4,e="üî• Bellota Encina (Alto Oleico): Infiltraci√≥n M√°xima."):"ROBLE"===c.bellotaType&&(e="üçÇ Bellota Roble (Taninos): Sabor Intenso."),d.push({active:!0,name:"ACIDOS_GRASOS_EMULSIONADOS",bonus_marbling:a,bonus_yield:1.5,description:e})}return d},checkBellotaCompliance:(a,b)=>[9,10,11,0,1].includes(b)?a.ageMonths<14?{compliant:!1,reason:"Muy joven <14m"}:{compliant:!0}:{compliant:!1,reason:"Fuera temporada"},calculateNitrogenBalance(a,b,c,d){let e=c/100*d*1e3/6.25,f=1e3*b*.027,g=Math.max(0,e-f),h=e>0?f/e*100:0,i=b>.1?g/b:0;return{n_intake_g:e.toFixed(1),n_retained_g:f.toFixed(1),n_excreted_g:g.toFixed(1),efficiency_pct:h.toFixed(1),excretion_per_gain:i.toFixed(1),is_critical:i>150}},predictPerformance(a,b,c,d,e={}){let f=.077*Math.pow(d,.75);if("Rustic_European"===a.biological_type?f*=.9:"Continental"===a.biological_type?f*=1.05:"Dairy"===a.biological_type?f*=1.25:"Indicus"===a.biological_type&&(f*=.85),void 0!==e.currentMonth){let b=e.currentMonth;b>=5&&b<=8&&5>(a.heat_tolerance||5)&&(f*=1.25),(11===b||b<=1)&&"AZB"===a.code&&(f*=1.15)}let g=.35*(b*c-f);return e.activeSynergies?.includes("ACIDOS_GRASOS_EMULSIONADOS")&&(g*=1.1),parseFloat((g=g>0?Math.min(g,1.2*a.adg_feedlot):Math.max(g,-2)).toFixed(2))}},F={generateUUID(){if("undefined"!=typeof crypto&&crypto.randomUUID)try{return crypto.randomUUID()}catch(a){}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:3&b|8).toString(16)})},async handleSaneamiento(a,b){let{result:c,infectedCrotalsText:d,date:e,farmId:f}=a,{animals:g,events:h,currentUser:i,storage:j,getFincas:k}=b,l=(k?k():[]).find(a=>a.id===f),m=l?l.name:"Finca Desconocida",n=g.filter(a=>(a.farmId===f||a.farm===m)&&"Muerto"!==a.status&&"Vendido"!==a.status&&"Sacrificado"!==a.status);if(0===n.length)throw Error("No hay animales activos en esta finca.");let o="",p=0;if("Negativo"===c)n.forEach(a=>{a.healthStatus="Sano",a.status||(a.status="Activo")}),o="Saneamiento NEGATIVO. Todo el reba√±o declarado SANO.";else if("Positivo"===c){let a=(d||"").split(",").map(a=>a.trim().toUpperCase()).filter(a=>a);if(0===a.length)throw Error("Has indicado POSITIVO. Introduce los crotales infectados.");n.forEach(b=>{a.some(a=>(b.crotal||"").toUpperCase().endsWith(a))?(b.healthStatus="Tuberculosis+",b.status="Sacrificado",b.exitDate=e,b.actualPrice=0,b.actualCarcassWeight=0,b.deathReason="Saneamiento Positivo",p++,h.push({id:this.generateUUID(),type:"Sacrificio",date:e,animalId:b.id,animalCrotal:b.crotal,desc:"Sacrificio Obligatorio (Saneamiento+)",cost:0,createdAt:new Date().toISOString()})):b.healthStatus="Cuarentena"}),o=`Saneamiento POSITIVO en ${m}. ${p} sacrificados. Resto (${n.length-p}) en CUARENTENA.`;let b=new Date(e);b.setDate(b.getDate()+15),h.push({id:this.generateUUID(),type:"Revisi√≥n Cuarentena",date:b.toISOString().split("T")[0],animalId:n[0].id,animalCrotal:`${m} (REBA\xd1O)`,desc:`‚ö†Ô∏è Revisi\xf3n Cuarentena: ${m} (15 d\xedas post-positivo)`,actionRequired:"Saneamiento",status:"scheduled",createdAt:new Date().toISOString()})}return h.push({id:this.generateUUID(),type:"Saneamiento",date:e,animalId:n[0]?n[0].id:"FARM_EVENT",animalCrotal:`${m} (General)`,desc:o,completed:!0,status:"completed",createdAt:new Date().toISOString()}),j.write(`animals_${i}`,g),j.write("events",h),{message:"Saneamiento procesado correctamente.",events:h,animals:g}},async handleInsemination(a,b){let{animal:c,date:d,bullBreed:e,desc:f}=a,{events:g,storage:h}=b,i=e?` Toro: ${e}.`:"",j={id:this.generateUUID(),type:"Inseminaci√≥n",animalId:c.id,animalCrotal:c.crotal,date:d,desc:`Inicio Protocolo IA (D\xeda 0): Evaluaci\xf3n + GnRH 1.${i} ${f||""}`,cost:0,status:"completed",createdAt:new Date().toISOString()};return g.push(j),[{day:7,type:"Tratamiento",desc:"Protocolo IA (D√≠a 7): Prostaglandina (PGF2a)"},{day:9,type:"Tratamiento",desc:"Protocolo IA (D√≠a 9): GnRH 2¬™ dosis"},{day:10,type:"Inseminaci√≥n",desc:`Protocolo IA (D\xeda 10): IA a Tiempo Fijo (16-20h tras GnRH).${i}`},{day:35,type:"Revisi√≥n",desc:"Protocolo IA (D√≠a 35): Ecograf√≠a (Diagn√≥stico Gestaci√≥n)"},{day:60,type:"Revisi√≥n",desc:"Protocolo IA (D√≠a 60): Confirmaci√≥n Viabilidad"}].forEach(a=>{let b=new Date(d);b.setDate(b.getDate()+a.day),g.push({id:this.generateUUID(),type:a.type,animalId:c.id,animalCrotal:c.crotal,date:b.toISOString().split("T")[0],desc:a.desc,cost:0,status:"scheduled",createdAt:new Date().toISOString()})}),h.write("events",g),{message:"Protocolo de Inseminaci√≥n iniciado (5 eventos programados).",events:g}},async handleWeighing(a,b){let{animal:c,weight:d,date:e,notes:f}=a,{events:g,animals:h,currentUser:i,storage:j}=b,k=c.currentWeight||0;c.currentWeight=d;let l=g.filter(a=>a.animalId===c.id&&"Pesaje"===a.type);l.sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime());let m=l[0],n=new Date(m?m.date:c.birthDate),o=m?m.weight||k:c.birthWeight||0;!m&&k>0&&(o=k);let p=new Date(e),q=(p.getTime()-n.getTime())/864e5,r=1;q>0&&d>o&&(r=(d-o)/q);let s=A.calculateTHI(20,50),t=C.getBreedByName(c.breed),u=D.inferSystem(c),v=(p.getTime()-new Date(c.birthDate).getTime())/2630016e3,w=t&&({British:"infiltracion",Continental:"crecimiento_magro",Rustic_European:"rustica_adaptada",Dairy:"aptitud_lechera",Indicus:"rustica_adaptada",Composite:"composito"})[t.biological_type]||"rustica_adaptada",x=E.calculateKPITargets({breed:c.breed,sex:c.sex,weight:d,ageMonths:v,functionalType:w},"Engorde",u).energyDensity,y=[9,10,11,0,1].includes(p.getMonth()),z=u.includes("Montanera"),B={isBellota:z&&y,highOleic:z&&y&&(c.farm||"").includes("SOTO"),hasLecithin:z},F=A.estimateCarcassResult({ageMonths:v},d,r,x,s,t||{}),G=A.calculateQualityIndex({ageMonths:v,currentWeight:d,sex:c.sex,rc_percent:F.rc_percent},t||{},x,r,s,150,0,1,B);c.monthlyRecords||(c.monthlyRecords=[]),c.monthlyRecords.push({date:e,weightKg:d,adg:r,rc_est:F.rc_percent,carcass_weight_est:F.carcass_weight,meat_quality_index:G.iq_score,marbling_est:G.marbling_est,diet_energy:x,thi:s}),c.monthlyRecords.length>12&&(c.monthlyRecords=c.monthlyRecords.slice(-12));let H=new Date(e);return H.setDate(H.getDate()+30),g.push({id:this.generateUUID(),type:"Pesaje",animalId:c.id,animalCrotal:c.crotal,date:H.toISOString().split("T")[0],desc:"CONTROL MENSUAL AUTOM√ÅTICO",cost:0,status:"pending",createdAt:new Date().toISOString()}),g.push({id:this.generateUUID(),type:"Pesaje",animalId:c.id,animalCrotal:c.crotal,date:e,desc:`Pesaje: ${d.toFixed(2)}kg. ${f||""}`,weight:d,cost:0,status:"completed",createdAt:new Date().toISOString()}),j.write(`animals_${i}`,h),j.write("events",g),{message:"Pesaje registrado y pr√≥xima revisi√≥n programada.",events:g,animals:h}},async handleStandardEvent(a,b){let{type:c,animal:d,date:e,desc:f,cost:g,nextDate:h,typeData:i}=a,{events:j,animals:k,storage:l,currentUser:m}=b;if(["Sacrificio","Venta","Muerte/Sacrificio","Salida"].includes(c)||c.startsWith("Sacrificio")){let{category:a,carcassWeight:b,price:f,conf:g,fat:h,pricePerKg:j,liveWeight:n,yield:o,seuropConf:p,fatCover:q}=i||{};c.includes("Sacrificio")?d.status="Sacrificado":"Venta"===c?d.status="Vendido":"Muerte"===c?d.status="Muerto":d.status="Baja",d.exitDate=e,a&&(d.actualCategory=a),b&&(d.actualCarcassWeight=parseFloat(b)),n&&(d.actualLiveWeight=parseFloat(n)),o&&(d.actualYield=parseFloat(o)),f&&(d.actualPrice=parseFloat(f)),j?d.actualPricePerKg=parseFloat(j):f&&b&&(d.actualPricePerKg=parseFloat((parseFloat(f)/parseFloat(b)).toFixed(2))),(g||p)&&(d.actualSeuropConf=g||p),(h||q)&&(d.actualSeuropFat=h||q),l.write(`animals_${m}`,k)}else if("Cambio de corral"===c){let{newCorralId:a}=i||{};d.corral=parseInt(a),l.write(`animals_${m}`,k)}else if("Decisi√≥n Macho"===c){let{decision:a}=i||{};if("Castrado"===a){d.sex="Castrado";let a=new Date(d.birth||d.birthDate),b=(new Date(e).getTime()-a.getTime())/2630016e3;b>=6&&b<=9?d.category="Buey":b>9?d.category="Toro":d.category="Ternero Castrado",d.castrationDate=e}else"Semental"===a&&(d.sex="Macho",d.category="Semental",d.isBreeder=!0);l.write(`animals_${m}`,k)}else if("Parto"===c){let{calfCrotal:a,calfSex:b,fatherCrotal:c,birthWeight:f}=i||{},g={id:this.generateUUID(),crotal:a,farmId:d.farmId,farm:d.farm,breed:d.breed||"Desconocida",sex:b,father:c,mother:d.crotal,birthDate:e.split("T")[0],birthWeight:f,currentWeight:f,notes:`Nacido de ${d.crotal}`,createdAt:new Date().toISOString()};k.push(g),l.write(`animals_${m}`,k);let h=new Date;h.setDate(h.getDate()+30),j.push({id:this.generateUUID(),type:"Pesaje",animalId:g.id,animalCrotal:g.crotal,date:h.toISOString().split("T")[0],desc:"CONTROL MENSUAL (1er Mes)",cost:0,status:"pending",createdAt:new Date().toISOString()})}return j.push({id:this.generateUUID(),type:c,animalId:d.id,animalCrotal:d.crotal,date:e,desc:f,cost:g,nextDate:h,completed:"Parto"!==c&&"Pesaje"!==c,status:"completed",createdAt:new Date().toISOString()}),l.write("events",j),{message:"Evento registrado correctamente.",events:j,animals:k}},getUpcomingEvents(a,b=30){if(!a||!Array.isArray(a))return[];let c=new Date,d=new Date;return d.setDate(d.getDate()+b),a.filter(a=>{if("completed"===a.status||a.completed)return!1;let b=new Date(a.date);return b>=c&&b<=d}).sort((a,b)=>new Date(a.date).getTime()-new Date(b.date).getTime())}};function G({onNavigate:a}){let{read:d}=(0,e.useStorage)(),[f,g]=(0,c.useState)(null),[h,i]=(0,c.useState)(!0),[j,k]=(0,c.useState)({males:{},females:{}}),[l,m]=(0,c.useState)([]),[n,o]=(0,c.useState)(0),[p,q]=(0,c.useState)([]);(0,c.useEffect)(()=>{try{let a=d("appSession",""),b=d(`fincas_${a}`,[]);if(q(b),b&&0!==b.length){let a=b[n]||b[0],c=40.4168,d=-3.7038,e=a.name||"General";a.coords&&a.coords.lat&&a.coords.lng&&(c=a.coords.lat,d=a.coords.lng),w.getCurrentWeather(c,d).then(async a=>{let b=await w.getForecast(c,d),f=`https://embed.windy.com/embed2.html?lat=${c}&lon=${d}&width=650&height=450&zoom=8&level=surface&overlay=wind&product=ecmwf&menu=&message=&marker=true&pressure=&type=map&location=coordinates&detail=&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1`;a?g({temp:a.temperature,condition:a.weather_desc,location:e,mapUrl:f,icon:w.getWeatherIcon?w.getWeatherIcon(a.weather_code):"‚õÖ",humidity:a.humidity,wind:a.wind_speed,forecast:b}):g(null),i(!1)}).catch(a=>{console.error("Weather load error:",a),g(null),i(!1)})}else i(!1),g(null);let c=d(`animals_${a}`,[]),e=r(c);k(e);let f=d("events",[]),h=F.getUpcomingEvents(f,30);m(h)}catch(a){}},[d,n]);let r=a=>{let b={Bueyes:0,Toros:0,Utreros:0,Novillos:0,A√±ojos:0,Terneros:0,Becerros:0},c={Nodrizas:0,Vacas:0,Novillas:0,A√±ojas:0,Terneras:0,Becerras:0};return a.forEach(a=>{if(a.status&&["Sacrificado","Muerto","Vendido","Baja","Inactivo","Retirado"].includes(a.status)||a.status&&"Activo"!==a.status)return;let d=a.category;if(!d||"Sin Clasificar"===d){let b=new Date(a.birth||a.birthDate),c=(new Date().getTime()-b.getTime())/2630016e3;d="Macho"===a.sex?c<6?"Becerros":c<12?"Terneros":c<24?"A√±ojos":c<36?"Novillos":c<48?"Utreros":"Toros":c<6?"Becerras":c<12?"Terneras":c<24?"A√±ojas":c<36?"Novillas":"Vacas"}"Castrado"===a.sex&&(d="Buey"),"Macho"===a.sex||"Castrado"===a.sex?void 0!==b[d]?b[d]++:"Buey"===d?b.Bueyes++:void 0!==b[d+"s"]&&b[d+"s"]++:void 0!==c[d]?c[d]++:void 0!==c[d+"s"]&&c[d+"s"]++}),{males:b,females:c}};return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h2",{className:"text-2xl font-bold text-gray-800",children:"Resumen General"}),(0,b.jsx)("p",{className:"text-gray-600",children:"Vista general de tu operaci√≥n ganadera"})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:[(0,b.jsxs)("div",{className:"flex flex-col h-full space-y-2",children:[p.length>0&&(0,b.jsx)("div",{className:"flex space-x-1 overflow-x-auto pb-1",children:p.map((a,c)=>(0,b.jsx)("button",{onClick:()=>{o(c),i(!0)},className:`px-4 py-2 rounded-t-lg text-sm font-medium transition-colors border-t border-l border-r ${n===c?"bg-white text-green-700 border-gray-200 border-b-white z-10 -mb-px shadow-[0_-2px_5px_rgba(0,0,0,0.02)]":"bg-gray-100 text-gray-500 hover:bg-gray_50 border-transparent hover:text-gray-700"}`,children:a.name},a.id||c))}),(f||h)&&(0,b.jsxs)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 h-full flex flex-col justify-between",children:[(0,b.jsxs)("div",{className:"flex justify-between items-start mb-6",children:[(0,b.jsxs)("div",{children:[(0,b.jsxs)("p",{className:"text-gray-500 font-bold text-xs uppercase tracking-wider mb-1",children:["Clima en: ",f?.location||"..."]}),h?(0,b.jsx)("p",{className:"text-sm animate-pulse text-gray-400",children:"Cargando..."}):f?(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsx)("span",{className:"text-4xl",children:f.icon}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("span",{className:"text-4xl font-extrabold block text-gray-800",children:[f.temp,"¬∞C"]}),(0,b.jsx)("span",{className:"text-sm text-gray-500 capitalize font-medium",children:f.condition})]})]}):(0,b.jsx)("p",{className:"text-sm text-gray-400",children:"No disponible"})]}),f&&(0,b.jsxs)("div",{className:"text-right text-xs text-gray-400 font-medium space-y-1 bg-gray-50 px-3 py-2 rounded-lg",children:[(0,b.jsxs)("p",{children:["üíß ",f.humidity,"% Humedad"]}),(0,b.jsxs)("p",{children:["üí® ",f.wind," km/h Viento"]})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 border-t border-gray-100 pt-4 flex-1",children:[!h&&f?.mapUrl&&(0,b.jsxs)("div",{className:"h-48 rounded-lg overflow-hidden border border-gray-200 shadow-sm relative group",children:[(0,b.jsx)("div",{className:"absolute top-2 left-2 z-10 bg-white/80 text-gray-700 text-[10px] px-2 py-1 rounded backdrop-blur-md font-bold shadow-sm",children:"üå™Ô∏è Viento vivo"}),(0,b.jsx)("iframe",{src:f.mapUrl,className:"w-full h-full border-none",title:"Windy Weather Map"})]}),!h&&f?.forecast&&(0,b.jsxs)("div",{className:"flex flex-col justify-between h-48",children:[(0,b.jsx)("p",{className:"text-xs font-bold text-gray-400 uppercase tracking-widest mb-2",children:"Pron√≥stico 3 D√≠as"}),(0,b.jsx)("div",{className:"flex-1 flex flex-col gap-2",children:f.forecast.map((a,c)=>(0,b.jsxs)("div",{className:"flex items-center justify-between bg-gray-50 rounded-lg p-3 border border-gray-100 hover:border-gray-300 transition-colors flex-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsx)("span",{className:"text-xl",children:a.icon}),(0,b.jsx)("span",{className:"text-sm font-bold text-gray-700 capitalize",children:new Date(a.date).toLocaleDateString(void 0,{weekday:"short"})})]}),(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[a.precip>0&&(0,b.jsxs)("span",{className:"text-[10px] font-bold text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded-full flex items-center gap-1",children:["‚òî ",a.precip,"mm"]}),(0,b.jsxs)("div",{className:"text-sm font-bold text-gray-800",children:[(0,b.jsxs)("span",{className:"text-gray-900",children:[Math.round(a.max),"¬∞"]}),(0,b.jsx)("span",{className:"mx-1 text-gray-300",children:"/"}),(0,b.jsxs)("span",{className:"text-gray-500",children:[Math.round(a.min),"¬∞"]})]})]})]},c))})]})]})]})]}),(0,b.jsxs)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 h-full",children:[(0,b.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Distribuci√≥n de Animales"}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8 h-full",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h4",{className:"text-blue-600 font-semibold mb-3 border-b border-blue-100 pb-2",children:"Machos"}),(0,b.jsx)("div",{className:"space-y-2 text-sm",children:Object.entries(j.males).map(([a,c])=>(0,b.jsxs)("div",{className:"flex justify-between",children:[(0,b.jsx)("span",{className:"text-gray-600",children:a}),(0,b.jsx)("span",{className:"font-bold text-gray-900",children:String(c)})]},a))})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h4",{className:"text-pink-600 font-semibold mb-3 border-b border-pink-100 pb-2",children:"Hembras"}),(0,b.jsx)("div",{className:"space-y-2 text-sm",children:Object.entries(j.females).map(([a,c])=>(0,b.jsxs)("div",{className:"flex justify-between",children:[(0,b.jsx)("span",{className:"text-gray-600",children:a}),(0,b.jsx)("span",{className:"font-bold text-gray-900",children:String(c)})]},a))})]})]})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,b.jsxs)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6",children:[(0,b.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Acciones R√°pidas"}),(0,b.jsxs)("div",{className:"space-y-3",children:[(0,b.jsx)("button",{onClick:()=>a?.("animals"),className:"w-full bg-green-50 text-green-700 font-medium py-2 px-4 rounded-lg hover:bg-green-100 transition-colors text-left flex items-center gap-2",children:"Registrar nuevo animal"}),(0,b.jsx)("button",{onClick:()=>a?.("events"),className:"w-full bg-green-50 text-green-700 font-medium py-2 px-4 rounded-lg hover:bg-green-100 transition-colors text-left flex items-center gap-2",children:"Registrar evento sanitario"}),(0,b.jsx)("button",{onClick:()=>a?.("reports"),className:"w-full bg-green-50 text-green-700 font-medium py-2 px-4 rounded-lg hover:bg-green-100 transition-colors text-left flex items-center gap-2",children:"Generar reporte mensual"})]})]}),(0,b.jsxs)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6",children:[(0,b.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Pr√≥ximos Eventos"}),(0,b.jsx)("div",{className:"space-y-3",children:0===l.length?(0,b.jsx)("p",{className:"text-gray-500 italic text-sm",children:"No hay eventos pr√≥ximos."}):l.map((a,c)=>(0,b.jsxs)("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg",children:[(0,b.jsx)("div",{className:"w-2 h-2 mt-2 rounded-full bg-green-500 shrink-0"}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"font-medium text-gray-800 text-sm",children:a.type}),(0,b.jsxs)("p",{className:"text-xs text-gray-500",children:[new Date(a.date).toLocaleDateString()," - ",a.animalId||"General"]})]})]},c))})]})]})]})}let H={async fetchParcelData(a,b,c,d){try{let e=`PROVINCIA=${a} AND MUNICIPIO=${b} AND AGREGADO=0 AND ZONA=0 AND POLIGONO=${c} AND PARCELA=${d}`,f=new URLSearchParams({where:e,outFields:"*",returnGeometry:"true",f:"json"}),g=await fetch(`https://sigpac-hubcloud.mapama.es/server/rest/services/SIGPAC/PARCELAS/MapServer/0/query?${f.toString()}`);if(!g.ok)throw Error("SIGPAC API Error");let h=await g.json();if(!h.features||0===h.features.length)return null;let i=h.features[0],j=i.attributes,k=i.geometry,l=0,m=0;if(k&&k.rings&&k.rings.length>0){let a=k.rings[0],b=a[0][0],c=a[0][1];if(c>1e6){let a=function(a,b,c=30){let d=.00669438/.99330562,e=Math.sqrt(.99330562),f=(1-e)/(1+e),g=Math.pow(f,2),h=Math.pow(f,3),i=Math.pow(f,4),j=b/.9996/(6378137*(1-.001673595-1344441707532e-16/64-15000339463446782e-22/256)),k=j+(3*f/2-27*h/32)*Math.sin(2*j)+(21*g/16-55*i/32)*Math.sin(4*j)+151*h/96*Math.sin(6*j)+1097*i/512*Math.sin(8*j),l=d*Math.pow(Math.cos(k),2),m=Math.pow(Math.tan(k),2),n=6378137/Math.sqrt(1-.00669438*Math.pow(Math.sin(k),2)),o=6378137*.99330562/Math.pow(1-.00669438*Math.pow(Math.sin(k),2),1.5),p=(a-5e5)/(.9996*n);return{lat:180*(k-n*Math.tan(k)/o*(Math.pow(p,2)/2-(5+3*m+10*l-4*Math.pow(l,2)-9*d)*Math.pow(p,4)/24+(61+90*m+298*l+45*Math.pow(m,2)-252*d-3*Math.pow(l,2))*Math.pow(p,6)/720))/Math.PI,lon:180*(Math.PI/180*(6*c-183)+(p-(1+2*m+l)*Math.pow(p,3)/6+(5-2*l+28*m-3*Math.pow(l,2)+8*d+24*Math.pow(m,2))*Math.pow(p,5)/120)/Math.cos(k))/Math.PI}}(b,c,30);l=a.lat,m=a.lon}else l=c,m=b}return{provincia:a,municipio:b,poligono:c,parcela:d,area_ha:(j.SUPERFICIE||0)/1e4,use:j.USO_SIGPAC||"PR",slope_avg:j.PENDIENTE_MEDIA||0,irrigation_coef:j.COEF_REGADIO||0,coordinates:0!==l?{lat:l,lon:m}:void 0}}catch(a){return console.error("SigpacService Error:",a),null}}},I=[{code:"01",name:"Araba/√Ålava",community:"Pa√≠s Vasco"},{code:"02",name:"Albacete",community:"Castilla-La Mancha"},{code:"03",name:"Alicante/Alacant",community:"Comunidad Valenciana"},{code:"04",name:"Almer√≠a",community:"Andaluc√≠a"},{code:"05",name:"√Åvila",community:"Castilla y Le√≥n"},{code:"06",name:"Badajoz",community:"Extremadura"},{code:"07",name:"Illes Balears",community:"Illes Balears"},{code:"08",name:"Barcelona",community:"Catalu√±a"},{code:"09",name:"Burgos",community:"Castilla y Le√≥n"},{code:"10",name:"C√°ceres",community:"Extremadura"},{code:"11",name:"C√°diz",community:"Andaluc√≠a"},{code:"12",name:"Castell√≥n/Castell√≥",community:"Comunidad Valenciana"},{code:"13",name:"Ciudad Real",community:"Castilla-La Mancha"},{code:"14",name:"C√≥rdoba",community:"Andaluc√≠a"},{code:"15",name:"A Coru√±a",community:"Galicia"},{code:"16",name:"Cuenca",community:"Castilla-La Mancha"},{code:"17",name:"Girona",community:"Catalu√±a"},{code:"18",name:"Granada",community:"Andaluc√≠a"},{code:"19",name:"Guadalajara",community:"Castilla-La Mancha"},{code:"20",name:"Gipuzkoa",community:"Pa√≠s Vasco"},{code:"21",name:"Huelva",community:"Andaluc√≠a"},{code:"22",name:"Huesca",community:"Arag√≥n"},{code:"23",name:"Ja√©n",community:"Andaluc√≠a"},{code:"24",name:"Le√≥n",community:"Castilla y Le√≥n"},{code:"25",name:"Lleida",community:"Catalu√±a"},{code:"26",name:"La Rioja",community:"La Rioja"},{code:"27",name:"Lugo",community:"Galicia"},{code:"28",name:"Madrid",community:"Comunidad de Madrid"},{code:"29",name:"M√°laga",community:"Andaluc√≠a"},{code:"30",name:"Murcia",community:"Regi√≥n de Murcia"},{code:"31",name:"Navarra",community:"Comunidad Foral de Navarra"},{code:"32",name:"Ourense",community:"Galicia"},{code:"33",name:"Asturias",community:"Principado de Asturias"},{code:"34",name:"Palencia",community:"Castilla y Le√≥n"},{code:"35",name:"Las Palmas",community:"Canarias"},{code:"36",name:"Pontevedra",community:"Galicia"},{code:"37",name:"Salamanca",community:"Castilla y Le√≥n"},{code:"38",name:"Santa Cruz de Tenerife",community:"Canarias"},{code:"39",name:"Cantabria",community:"Cantabria"},{code:"40",name:"Segovia",community:"Castilla y Le√≥n"},{code:"41",name:"Sevilla",community:"Andaluc√≠a"},{code:"42",name:"Soria",community:"Castilla y Le√≥n"},{code:"43",name:"Tarragona",community:"Catalu√±a"},{code:"44",name:"Teruel",community:"Arag√≥n"},{code:"45",name:"Toledo",community:"Castilla-La Mancha"},{code:"46",name:"Valencia/Val√®ncia",community:"Comunidad Valenciana"},{code:"47",name:"Valladolid",community:"Castilla y Le√≥n"},{code:"48",name:"Bizkaia",community:"Pa√≠s Vasco"},{code:"49",name:"Zamora",community:"Castilla y Le√≥n"},{code:"50",name:"Zaragoza",community:"Arag√≥n"},{code:"51",name:"Ceuta",community:"Ceuta"},{code:"52",name:"Melilla",community:"Melilla"}],J=[{id:"1",name:"Arcilloso",texture:"Arcillosa",ph_typical:6,water_retention:"Alta",drainage:"Lento",risks:["Encharcamiento","Agrietamiento en sequ√≠a"],recommended_uses:["Pradera permanente","Pastoreo controlado"],productive_objectives:["Cr√≠a extensiva","Doble prop√≥sito"],indices:{retention:.9,drainage:.2,fertility:.8,risk_waterlogging:.9,risk_drought:.2,risk_erosion:.4}},{id:"2",name:"Arenoso",texture:"Arenosa",ph_typical:5.5,water_retention:"Baja",drainage:"R√°pido",risks:["Sequ√≠a","Lixiviaci√≥n de nutrientes","Erosi√≥n e√≥lica"],recommended_uses:["Cultivos de invierno","Pastoreo invernal"],productive_objectives:["Recr√≠a","Cebo ligero"],indices:{retention:.3,drainage:.9,fertility:.4,risk_waterlogging:.1,risk_drought:.9,risk_erosion:.7}},{id:"3",name:"Franco (Loam)",texture:"Franca",ph_typical:6.5,water_retention:"Media",drainage:"Medio",risks:["Ninguno grave"],recommended_uses:["Policultivo","Ma√≠z forrajero","Alfalfa"],productive_objectives:["Engorde intensivo","Alto rendimiento"],indices:{retention:.6,drainage:.6,fertility:.85,risk_waterlogging:.3,risk_drought:.3,risk_erosion:.3}},{id:"4",name:"Franco-Arcilloso",texture:"Franco-Arcillosa",ph_typical:6.8,water_retention:"Alta",drainage:"Medio-Lento",risks:["Compactaci√≥n"],recommended_uses:["Praderas de alto rendimiento","Cereales"],productive_objectives:["Leche","Cr√≠a intensiva"],indices:{retention:.75,drainage:.45,fertility:.9,risk_waterlogging:.5,risk_drought:.2,risk_erosion:.4}},{id:"5",name:"Franco-Arenoso",texture:"Franco-Arenosa",ph_typical:6.2,water_retention:"Media-Baja",drainage:"R√°pido",risks:["Erosi√≥n","Lavado nutrientes"],recommended_uses:["Hort√≠colas","Leguminosas anuales"],productive_objectives:["Rotaci√≥n r√°pida","Pastoreo estacional"],indices:{retention:.45,drainage:.8,fertility:.6,risk_waterlogging:.2,risk_drought:.7,risk_erosion:.5}}],K={getAllSoils:()=>J,getSoilById:a=>J.find(b=>b.id===a),getRecommendedCrops(a,b,c=0){let d=this.getSoilById(a);if(!d)return[];let e=[];for(let a of[{name:"Trigo Blando",type:"Cereal Invierno",min_precip:450,max_slope:12,ph_min:6,ph_max:8,drainage:["Medio","R√°pido","Medio-Lento"],season:"Oto√±o"},{name:"Cebada",type:"Cereal Invierno",min_precip:350,max_slope:12,ph_min:6,ph_max:8.5,drainage:["Medio","R√°pido"],season:"Oto√±o"},{name:"Avena",type:"Cereal Invierno",min_precip:400,max_slope:15,ph_min:5,ph_max:7.5,drainage:["Medio","Lento","Medio-Lento"],season:"Oto√±o"},{name:"Triticale",type:"Cereal Invierno",min_precip:350,max_slope:15,ph_min:5.5,ph_max:8,drainage:["Medio","Medio-Lento"],season:"Oto√±o"},{name:"Centeno",type:"Cereal Invierno",min_precip:300,max_slope:15,ph_min:5,ph_max:8,drainage:["R√°pido","Medio"],season:"Oto√±o"},{name:"Ray-grass Italiano",type:"Pradera",min_precip:600,max_slope:15,ph_min:5.5,ph_max:7.5,drainage:["Medio","Lento","Medio-Lento"],season:"Oto√±o"},{name:"Festuca Alta",type:"Pradera",min_precip:450,max_slope:15,ph_min:5,ph_max:8,drainage:["Lento","Medio-Lento","Medio"],season:"Oto√±o"},{name:"Alfalfa",type:"Leguminosa",min_precip:500,max_slope:10,ph_min:6.2,ph_max:8.2,drainage:["R√°pido","Medio"],season:"Primavera"},{name:"Vezas",type:"Leguminosa",min_precip:350,max_slope:15,ph_min:5.5,ph_max:8,drainage:["R√°pido","Medio","Medio-Lento"],season:"Oto√±o"},{name:"Tr√©bol Subterr√°neo",type:"Leguminosa",min_precip:400,max_slope:20,ph_min:5,ph_max:6.5,drainage:["Medio","R√°pido","Medio-Lento"],season:"Oto√±o"},{name:"Ma√≠z Forrajero",type:"Cereal Verano",min_precip:300,max_slope:8,ph_min:5.8,ph_max:8,drainage:["Medio","Medio-Lento"],season:"Primavera"},{name:"Sorgo",type:"Cereal Verano",min_precip:250,max_slope:10,ph_min:5.5,ph_max:8.5,drainage:["Medio","R√°pido"],season:"Primavera"}]){let f=[],g=!0;c>a.max_slope&&(g=!1),(d.ph_typical<a.ph_min||d.ph_typical>a.ph_max)&&(g=!1),a.drainage.includes(d.drainage)||(g=!1),b&&b.annualPrecip<a.min_precip&&"Ma√≠z Forrajero"!==a.name&&b.annualPrecip<.7*a.min_precip&&(g=!1),g&&(c>8&&c<=a.max_slope&&f.push("Pendiente l√≠mite"),b&&b.annualPrecip>a.min_precip+200&&f.push("Clima favorable"),"Alfalfa"===a.name&&"R√°pido"===d.drainage&&f.push("Excelente drenaje"),"Festuca Alta"===a.name&&("Lento"===d.drainage||"Medio-Lento"===d.drainage)&&f.push("Tolera suelo pesado"),e.push({crop:a.name,type:`${a.type} (${a.season})`,reason:f.length?f.join(". "):"Condiciones aptas."}))}return c>15&&e.push({crop:"Prado Natural",type:"Pradera",reason:"Pendiente alta: evitar laboreo."}),e},calculateSuitability(a,b){let c=this.getSoilById(a);if(!c)return 0;let d=c.indices;if("Pastoreo"===b){let a=40*d.retention+40*d.drainage+20*d.fertility;return d.risk_waterlogging>.7&&(a-=20),Math.min(100,Math.max(0,a))}return"Cultivo"===b?Math.min(100,60*d.fertility+20*d.drainage+20*d.retention):"Engorde"===b?Math.min(100,70*d.fertility+30*d.drainage):50}};function L(){let a,{read:d,write:f}=(0,e.useStorage)(),[g,h]=(0,c.useState)([]),[i,j]=(0,c.useState)(!1),[k,l]=(0,c.useState)(""),[m,n]=(0,c.useState)(""),[o,p]=(0,c.useState)("45"),[q,r]=(0,c.useState)(""),[s,t]=(0,c.useState)(""),[u,v]=(0,c.useState)(""),[x,y]=(0,c.useState)(""),[z,A]=(0,c.useState)(""),[B,D]=(0,c.useState)(""),[E,F]=(0,c.useState)(""),[G,J]=(0,c.useState)(""),[L,M]=(0,c.useState)([]),[N,O]=(0,c.useState)(""),[P,Q]=(0,c.useState)(null),[R,S]=(0,c.useState)(!1),[T,U]=(0,c.useState)({crops:[],breeds:[],f1s:[]}),[V,W]=(0,c.useState)(!1),[X,Y]=(0,c.useState)(!1),[Z,$]=(0,c.useState)(!1),[_,aa]=(0,c.useState)([]),[ab,ac]=(0,c.useState)([]),[ad,ae]=(0,c.useState)(!1),[af,ag]=(0,c.useState)(null);(0,c.useEffect)(()=>{ac(K.getAllSoils().map(a=>({id_suelo:a.id,nombre:a.name})));let a=d("sessionUser","");l(a),h(d(`fincas_${a}`,[]));let b=localStorage.getItem(`farm_draft_${a}`);if(b)try{let c=JSON.parse(b);confirm("Hemos encontrado datos de una finca que no se guard√≥. ¬øQuieres recuperarlos?")?(n(c.newName||""),p(c.provincia||"10"),r(c.municipio||""),t(c.municipioName||""),v(c.poligono||""),y(c.parcela||""),A(c.license||""),D(c.maxHeads||""),F(c.soilId||""),J(c.corrals||""),O(c.feedingSystem||""),j(!0)):localStorage.removeItem(`farm_draft_${a}`)}catch(a){console.error("Error restoring draft",a)}},[d]),(0,c.useEffect)(()=>{k&&i&&(m||z||u||x)&&localStorage.setItem(`farm_draft_${k}`,JSON.stringify({newName:m,provincia:o,municipio:q,municipioName:s,poligono:u,parcela:x,license:z,maxHeads:B,soilId:E,corrals:G,feedingSystem:N}))},[m,o,q,u,x,z,B,E,G,N,i,k]);let[ah,ai]=(0,c.useState)([]),[aj,ak]=(0,c.useState)(!1);(0,c.useEffect)(()=>{(async()=>{try{let a=await fetch("/data/municipios.json");if(a.ok){let b=await a.json();ai(b)}}catch(a){console.error("Error loading municipalities",a)}})()},[]),(0,c.useEffect)(()=>{o&&ah.length>0?aa(ah.filter(a=>a.provincia_id===o).map(a=>({codigo:a.cmun,descripcion:a.nombre})).sort((a,b)=>a.descripcion.localeCompare(b.descripcion))):aa([])},[o,ah]),(0,c.useEffect)(()=>{E&&U(al(E,P,af?.slope_avg||(aw?g.find(a=>a.id===aw)?.slope:0)||0))},[E,P]);let al=(a,b,c)=>{let d=K.getRecommendedCrops(a,b,c).map(a=>({nombre_alimento:a.crop,tipo:a.type,reasons:[a.reason]})),e=[C.calculateHybrid("ANG","BRA"),C.calculateHybrid("HER","ANG"),C.calculateHybrid("LIM","RET"),C.calculateHybrid("LIM","MOR"),C.calculateHybrid("CHA","RET")].filter(a=>null!==a),f=C.getAllBreeds(),g=a=>b&&b.avgTemp>25?a.filter(a=>a.heat_tolerance>=7).sort((a,b)=>b.heat_tolerance-a.heat_tolerance).slice(0,3).map(a=>({breed:a.name,reasons:["Alta tolerancia al calor","Adaptaci√≥n"]})):a.filter(a=>a.adg_feedlot>1.2).sort((a,b)=>b.adg_feedlot-a.adg_feedlot).slice(0,3).map(a=>({breed:a.name,reasons:["Alta productividad","Eficiencia"]})),h=g(f),i=g(e);return 0===h.length&&h.push(...f.slice(0,3).map(a=>({breed:a.name,reasons:["Est√°ndar"]}))),0===i.length&&e.length>0&&i.push(...e.slice(0,3).map(a=>({breed:a.name,reasons:["Vigor H√≠brido Est√°ndar"]}))),{crops:d,breeds:h,f1s:i}},am=async()=>{if(!q||!u||!x)return void alert("Completa los datos de SIGPAC");ae(!0);try{let a=await H.fetchParcelData(Number(o),Number(q),Number(u),Number(x));a?(ag(a),B||D(Math.floor(2*a.area_ha).toString()),a.coordinates?at(a.coordinates.lat,a.coordinates.lon):at(39.4,-6),alert(`‚úÖ Parcela Localizada: ${a.area_ha.toFixed(2)} ha - Uso: ${a.use}`)):alert("No se encontr√≥ la parcela en SIGPAC")}catch(a){console.error(a),alert("Error consultando SIGPAC")}finally{ae(!1)}},[an,ao]=(0,c.useState)("public"),[ap,aq]=(0,c.useState)(""),[ar,as]=(0,c.useState)(""),at=async(a,b)=>{S(!0);try{if("private"===an&&ap)alert(`Conectando a estaci\xf3n privada en: ${ap}... (Simulaci\xf3n)`),Q({avgTemp:16.5,classification:"Clima Local (Estaci√≥n)",annualPrecip:550});else{let c=await w.analyzeClimate(a,b);c&&Q(c)}}catch(a){console.error(a)}finally{S(!1)}},[au,av]=(0,c.useState)(null),[aw,ax]=(0,c.useState)(null),[ay,az]=(0,c.useState)({}),aA=a=>{let b=d(`animals_${k}`,[]).filter(b=>b.farm===a.name&&(!b.status||"Activo"===b.status)).length,c=b/(a.maxHeads||1)*100,e="bg-green-500";return c>=100?e="bg-red-500":c>90&&(e="bg-yellow-500"),{current:b,pct:c,color:e}};return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"flex justify-between items-center",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h2",{className:"text-2xl font-bold text-gray-800",children:"Mis Fincas"}),(0,b.jsx)("p",{className:"text-gray-600",children:"Gesti√≥n de parcelas y terrenos"})]}),(0,b.jsx)("button",{onClick:()=>{ax(null),n(""),A(""),D(""),F(""),J(""),M([]),O(""),Q(null),U({crops:[],breeds:[]}),j(!0)},className:"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors",children:i?"Cancelar":"Nueva Finca"})]}),i&&(0,b.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-in fade-in slide-in-from-top-4",children:[(0,b.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Registrar Finca (SIGPAC)"}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4",children:[(0,b.jsxs)("div",{className:"md:col-span-2",children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre Finca *"}),(0,b.jsx)("input",{type:"text",value:m,onChange:a=>n(a.target.value),className:`w-full border rounded-lg px-3 py-2 ${ay.name?"border-red-500 bg-red-50":""}`,placeholder:"Ej: La Dehesa"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"N¬∫ Licencia REGA *"}),(0,b.jsx)("input",{type:"text",value:z,onChange:a=>A(a.target.value),className:`w-full border rounded-lg px-3 py-2 ${ay.license?"border-red-500 bg-red-50":""}`,placeholder:"ES..."})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cabezas M√°ximas *"}),(0,b.jsx)("input",{type:"number",value:B,onChange:a=>D(a.target.value),className:`w-full border rounded-lg px-3 py-2 ${ay.maxHeads?"border-red-500 bg-red-50":""}`,placeholder:"Ej: 150"})]})]}),(0,b.jsxs)("div",{className:"space-y-4 mb-6 pt-4 border-t border-gray-100",children:[(0,b.jsx)("h4",{className:"font-semibold text-gray-800 text-sm",children:"Ubicaci√≥n (SIGPAC)"}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Provincia"}),(0,b.jsxs)("select",{value:o,onChange:a=>{p(a.target.value),r("")},className:"w-full border rounded-lg px-3 py-2 bg-white focus:border-green-500 focus:outline-none",children:[(0,b.jsx)("option",{value:"",children:"Seleccione Provincia"}),I.map(a=>(0,b.jsx)("option",{value:a.code,children:a.name},a.code))]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Municipio"}),(0,b.jsxs)("select",{value:q,onChange:a=>{r(a.target.value);let b=_.find(b=>b.codigo==a.target.value);b&&t(b.descripcion)},className:"w-full border rounded-lg px-3 py-2 bg-white focus:border-green-500 focus:outline-none",disabled:!o,children:[(0,b.jsx)("option",{value:"",children:"Seleccione Municipio"}),_.map(a=>(0,b.jsx)("option",{value:a.codigo,children:a.descripcion},a.codigo))]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Pol√≠gono"}),(0,b.jsx)("input",{type:"text",value:u,onChange:a=>v(a.target.value),className:"w-full border rounded-lg px-3 py-2 focus:border-green-500 focus:outline-none",placeholder:"0"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Parcela"}),(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsx)("input",{type:"text",value:x,onChange:a=>y(a.target.value),className:"w-full border rounded-lg px-3 py-2 focus:border-green-500 focus:outline-none",placeholder:"0"}),(0,b.jsx)("button",{onClick:am,disabled:ad,className:"bg-green-600 text-white px-4 rounded-lg hover:bg-green-700 font-medium transition-colors border border-green-700 shadow-sm",children:ad?"...":"Buscar"})]})]})]})]}),(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tipo de Suelo *"}),(0,b.jsxs)("select",{value:E,onChange:a=>F(a.target.value),className:`w-full border rounded-lg px-3 py-2 bg-white ${ay.soilId?"border-red-500 bg-red-50":""}`,children:[(0,b.jsx)("option",{value:"",children:"Selecciona Suelo"}),ab.map(a=>(0,b.jsx)("option",{value:a.id_suelo,children:a.nombre},a.id_suelo))]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Sistema Alimentaci√≥n *"}),(0,b.jsxs)("select",{value:N,onChange:a=>O(a.target.value),className:`w-full border rounded-lg px-3 py-2 bg-white ${ay.feedingSystem?"border-red-500 bg-red-50":""}`,children:[(0,b.jsx)("option",{value:"",children:"Selecciona..."}),(0,b.jsx)("option",{value:"extensivo",children:"Extensivo (Pastoreo)"}),(0,b.jsx)("option",{value:"intensivo",children:"Intensivo (Cebadero)"}),(0,b.jsx)("option",{value:"mixto",children:"Mixto (Suplementaci√≥n)"}),(0,b.jsx)("option",{value:"ecologico",children:"Ecol√≥gico"})]})]}),(0,b.jsxs)("div",{className:"flex gap-4",children:[(0,b.jsxs)("div",{className:"w-1/3",children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"N¬∫ Corrales"}),(0,b.jsx)("input",{type:"number",value:G,onChange:a=>{let b=a.target.value;J(b);let c=parseInt(b)||0;M(a=>{let b=[...a];if(c>b.length)for(let a=b.length;a<c;a++)b.push(`Corral ${a+1}`);else b.length=c;return b})},className:"w-full border rounded-lg px-3 py-2",placeholder:"0"})]}),(0,b.jsx)("div",{className:"flex-1",children:L.length>0&&(0,b.jsxs)("div",{className:"bg-gray-50 rounded border border-gray-100 p-2 max-h-40 overflow-y-auto",children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-2",children:"Nombres"}),(0,b.jsx)("div",{className:"space-y-2",children:L.map((a,c)=>(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsxs)("span",{className:"text-xs text-gray-400 w-6",children:["#",c+1]}),(0,b.jsx)("input",{type:"text",value:a,onChange:a=>{let b=[...L];b[c]=a.target.value,M(b)},className:"flex-1 text-xs border rounded px-2 py-1 focus:ring-1 focus:ring-green-500 outline-none"})]},c))})]})})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 items-start",children:[(0,b.jsxs)("div",{className:"border border-green-200 bg-green-50 p-3 rounded-lg flex flex-col h-full",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h4",{className:"font-semibold text-green-900 text-sm mb-3",children:"Datos Clim√°ticos"}),(0,b.jsxs)("div",{className:"space-y-2 mb-3",children:[(0,b.jsxs)("label",{className:"flex items-center gap-2 text-sm text-green-800 cursor-pointer",children:[(0,b.jsx)("input",{type:"radio",name:"climateSource",defaultChecked:!0,className:"text-green-600 focus:ring-green-500"}),"API P√∫blica"]}),(0,b.jsxs)("label",{className:"flex items-center gap-2 text-sm text-green-800/50 cursor-not-allowed",children:[(0,b.jsx)("input",{type:"radio",name:"climateSource",disabled:!0}),"Estaci√≥n Propia"]})]})]}),(0,b.jsx)("div",{className:"text-sm text-green-800 pt-3 border-t border-green-200/50",children:o&&q?(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsxs)("p",{className:"flex justify-between",children:[(0,b.jsx)("span",{children:"Media:"})," ",(0,b.jsx)("strong",{children:"15.4¬∞C"})]}),(0,b.jsxs)("p",{className:"flex justify-between",children:[(0,b.jsx)("span",{children:"Clima:"})," ",(0,b.jsx)("strong",{children:"Templado Seco"})]}),(0,b.jsxs)("p",{className:"flex justify-between",children:[(0,b.jsx)("span",{children:"Precip:"})," ",(0,b.jsx)("strong",{children:"431mm"})]})]}):(0,b.jsx)("p",{className:"text-green-600 italic",children:"Selecciona ubicaci√≥n..."})})]}),(0,b.jsxs)("div",{className:"border border-orange-200 bg-orange-50 p-3 rounded-lg flex flex-col h-full",children:[(0,b.jsx)("h4",{className:"font-semibold text-orange-900 text-sm mb-3",children:"Razas Puras"}),T.breeds.length>0?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("ul",{className:"text-sm space-y-3 flex-1",children:T.breeds.slice(0,V?void 0:3).map((a,c)=>(0,b.jsxs)("li",{className:"text-orange-900 pb-2 border-b border-orange-200/50 last:border-0 last:pb-0",children:[(0,b.jsx)("strong",{className:"text-orange-900 block",children:a.breed}),(0,b.jsxs)("span",{className:"text-[11px] text-orange-700",children:["(",a.reasons.join(", ").replace("(GMD)",""),")"]})]},c))}),T.breeds.length>3&&(0,b.jsx)("button",{onClick:()=>W(!V),className:"text-[11px] text-orange-700 font-medium hover:text-orange-900 mt-2 text-center w-full pt-2 border-t border-orange-200/50",children:V?"Ver menos":`Ver ${T.breeds.length-3} m\xe1s...`})]}):(0,b.jsx)("p",{className:"text-sm text-orange-400 italic",children:"Completa datos..."})]}),(0,b.jsxs)("div",{className:"border border-amber-200 bg-amber-50 p-3 rounded-lg flex flex-col h-full",children:[(0,b.jsx)("h4",{className:"font-semibold text-amber-900 text-sm mb-3",children:"Cruces F1"}),T.f1s&&T.f1s.length>0?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("ul",{className:"text-sm space-y-3 flex-1",children:T.f1s.slice(0,X?void 0:3).map((a,c)=>(0,b.jsxs)("li",{className:"text-amber-900 pb-2 border-b border-amber-200/50 last:border-0 last:pb-0",children:[(0,b.jsx)("strong",{className:"text-amber-900 block",title:a.breed,children:a.breed}),(0,b.jsxs)("span",{className:"text-[11px] text-amber-700",children:["(",a.reasons.join(", "),")"]})]},c))}),T.f1s.length>3&&(0,b.jsx)("button",{onClick:()=>Y(!X),className:"text-[11px] text-amber-700 font-medium hover:text-amber-900 mt-2 text-center w-full pt-2 border-t border-amber-200/50",children:X?"Ver menos":`Ver ${T.f1s.length-3} m\xe1s...`})]}):(0,b.jsx)("p",{className:"text-sm text-amber-400 italic",children:"Calculando..."})]}),(0,b.jsxs)("div",{className:"border border-emerald-200 bg-emerald-50 p-3 rounded-lg flex flex-col h-full",children:[(0,b.jsx)("h4",{className:"font-semibold text-emerald-900 text-sm mb-3",children:"Cultivos"}),T.crops.length>0?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("ul",{className:"text-sm space-y-3 flex-1",children:T.crops.slice(0,Z?void 0:3).map((a,c)=>(0,b.jsxs)("li",{className:"text-emerald-900 pb-2 border-b border-emerald-200/50 last:border-0 last:pb-0",children:[(0,b.jsx)("strong",{className:"text-emerald-900 block",children:a.nombre_alimento}),(0,b.jsxs)("span",{className:"text-[11px] text-emerald-700",children:["(",a.tipo,")"]})]},c))}),T.crops.length>3&&(0,b.jsx)("button",{onClick:()=>$(!Z),className:"text-[11px] text-emerald-700 font-medium hover:text-emerald-900 mt-2 text-center w-full pt-2 border-t border-emerald-200/50",children:Z?"Ver menos":`Ver ${T.crops.length-3} m\xe1s...`})]}):(0,b.jsx)("p",{className:"text-sm text-emerald-400 italic",children:"Completa datos..."})]})]})]}),(0,b.jsxs)("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[(0,b.jsx)("button",{onClick:()=>j(!1),className:"text-gray-600 hover:text-gray-800 font-medium px-4",children:"Cancelar"}),(0,b.jsx)("button",{onClick:()=>{var a;let b,c={};if(m||(c.name=!0),z||(c.license=!0),E||(c.soilId=!0),B||(c.maxHeads=!0),N||(c.feedingSystem=!0),Object.keys(c).length>0){az(c),alert("Por favor, completa todos los campos obligatorios marcados en rojo.");return}let d=0,e=[];af&&(d=(e=!(a=af)?[]:!a.recintos||0===a.recintos.length?a.area_ha?[{usage:a.use||"PR",area:Math.round(1e4*a.area_ha),dn_oid:0}]:[]:a.recintos.map(a=>({usage:a.uso,area:1e4*a.superficie,dn_oid:0}))).reduce((a,b)=>a+(b.area||0),0),af.lat&&af.lon&&(b={lat:af.lat,lng:af.lon}));let i=_.find(a=>a.codigo==q||a.codigo==parseInt(q)),l=i?i.descripcion:s,p={id:aw||("undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():`farm-${Date.now()}`),name:m,municipio:l,municipioCode:q,provinciaCode:o,poligono:u,parcela:x,superficie:d||aw&&g.find(a=>a.id===aw)?.superficie||0,recintos:e.length?e:aw&&g.find(a=>a.id===aw)?.recintos||[],coords:b||(aw?g.find(a=>a.id===aw)?.coords:void 0),slope:af?.slope_avg||(aw?g.find(a=>a.id===aw)?.slope:0),license:z,maxHeads:Number(B),soilId:E,corrals:Number(G),corralNames:L,feedingSystem:N,climateStudy:P,cropsRecommendation:T.crops,breedsRecommendation:T.breeds,f1Recommendation:T.f1s},w=aw?g.map(a=>a.id===aw?p:a):[...g,p];h(w),f(`fincas_${k}`,w),n(""),A(""),D(""),F(""),J(""),M([]),O(""),Q(null),U({crops:[],breeds:[]}),az({}),r(""),t(""),v(""),y(""),ag(null),j(!1),ax(null),localStorage.removeItem(`farm_draft_${k}`),alert(aw?"‚úÖ Finca actualizada correctamente":"‚úÖ Finca guardada correctamente")},className:"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg",children:"Guardar Finca Completa"})]})]}),au&&(0,b.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4",children:(0,b.jsx)("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:(0,b.jsxs)("div",{className:"p-6",children:[(0,b.jsxs)("div",{className:"flex justify-between items-start mb-6",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:au.name}),(0,b.jsxs)("p",{className:"text-gray-500 text-sm",children:["Licencia: ",au.license]})]}),(0,b.jsx)("button",{onClick:()=>av(null),className:"text-gray-400 hover:text-gray-600",children:"‚úï"})]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-6 text-sm",children:[(0,b.jsxs)("div",{className:"bg-gray-50 p-3 rounded",children:[(0,b.jsx)("p",{className:"text-gray-500 text-xs uppercase mb-1",children:"Ubicaci√≥n"}),(0,b.jsx)("p",{className:"font-medium",children:au.municipio}),(0,b.jsxs)("p",{children:["Pol√≠gono ",au.poligono," / Parcela ",au.parcela]})]}),(0,b.jsxs)("div",{className:"bg-gray-50 p-3 rounded",children:[(0,b.jsx)("p",{className:"text-gray-500 text-xs uppercase mb-1",children:"Superficie"}),(0,b.jsxs)("p",{className:"font-medium text-lg",children:[Number(au.superficie/1e4).toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:4})," ha"]})]}),(0,b.jsxs)("div",{className:"bg-gray-50 p-3 rounded",children:[(0,b.jsx)("p",{className:"text-gray-500 text-xs uppercase mb-1",children:"Capacidad"}),(0,b.jsxs)("p",{className:"font-medium",children:[aA(au).current," / ",au.maxHeads," cabezas"]}),(0,b.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-1.5 mt-2",children:(0,b.jsx)("div",{className:`${aA(au).color} h-1.5 rounded-full`,style:{width:`${Math.min(aA(au).pct,100)}%`}})})]}),(0,b.jsxs)("div",{className:"bg-gray-50 p-3 rounded",children:[(0,b.jsx)("p",{className:"text-gray-500 text-xs uppercase mb-1",children:"Suelo / Sistema"}),(0,b.jsx)("p",{className:"text-sm font-medium text-gray-900",children:ab.find(a=>a.id_suelo===au.soilId)?.nombre||"Desconocido"}),(0,b.jsx)("p",{className:"text-sm font-medium text-gray-900 capitalize",children:au.feedingSystem||"No definido"})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 items-start",children:[au.climateStudy&&(0,b.jsxs)("div",{className:"border border-green-200 bg-green-50 p-3 rounded-lg flex flex-col h-full",children:[(0,b.jsx)("h4",{className:"font-semibold text-green-900 text-sm mb-3",children:"Datos Clim√°ticos"}),(0,b.jsxs)("div",{className:"space-y-1 text-sm text-green-800",children:[(0,b.jsxs)("p",{className:"flex justify-between",children:[(0,b.jsx)("span",{children:"Clima:"})," ",(0,b.jsx)("strong",{children:au.climateStudy.classification})]}),(0,b.jsxs)("p",{className:"flex justify-between",children:[(0,b.jsx)("span",{children:"Media:"})," ",(0,b.jsxs)("strong",{children:[au.climateStudy.avgTemp,"¬∞C"]})]}),(0,b.jsxs)("p",{className:"flex justify-between",children:[(0,b.jsx)("span",{children:"Precip:"})," ",(0,b.jsxs)("strong",{children:[au.climateStudy.annualPrecip,"mm"]})]})]})]}),au.breedsRecommendation&&(0,b.jsxs)("div",{className:"border border-orange-200 bg-orange-50 p-3 rounded-lg flex flex-col h-full",children:[(0,b.jsx)("h4",{className:"font-semibold text-orange-900 text-sm mb-3",children:"Razas Puras"}),(0,b.jsx)("ul",{className:"text-sm space-y-2",children:au.breedsRecommendation.slice(0,3).map((a,c)=>(0,b.jsxs)("li",{className:"text-orange-900 pb-1 border-b border-orange-200/50 last:border-0",children:[(0,b.jsx)("strong",{className:"text-orange-900 block",children:a.breed}),(0,b.jsxs)("span",{className:"text-[11px] text-orange-700",children:["(",a.reasons?a.reasons[0].replace("(GMD)",""):"",")"]})]},c))})]}),(0,b.jsxs)("div",{className:"border border-amber-200 bg-amber-50 p-3 rounded-lg flex flex-col h-full",children:[(0,b.jsx)("h4",{className:"font-semibold text-amber-900 text-sm mb-3",children:"Cruces F1"}),(a=au.f1Recommendation&&au.f1Recommendation.length>0?au.f1Recommendation:au.climateStudy?al(au.soilId,au.climateStudy,au.slope||0).f1s:[]).length>0?(0,b.jsx)("ul",{className:"text-sm space-y-2",children:a.slice(0,3).map((a,c)=>(0,b.jsxs)("li",{className:"text-amber-900 pb-1 border-b border-amber-200/50 last:border-0",children:[(0,b.jsx)("strong",{className:"text-amber-900 block",children:a.breed}),(0,b.jsxs)("span",{className:"text-[11px] text-amber-700",children:["(",a.reasons?a.reasons.join(", "):"",")"]})]},c))}):(0,b.jsx)("p",{className:"text-sm text-amber-600/70 italic",children:"No calculados"})]}),au.cropsRecommendation&&(0,b.jsxs)("div",{className:"border border-emerald-200 bg-emerald-50 p-3 rounded-lg flex flex-col h-full",children:[(0,b.jsx)("h4",{className:"font-semibold text-emerald-900 text-sm mb-3",children:"Cultivos"}),(0,b.jsx)("ul",{className:"text-sm space-y-2",children:au.cropsRecommendation.slice(0,3).map((a,c)=>(0,b.jsxs)("li",{className:"text-emerald-900 pb-1 border-b border-emerald-200/50 last:border-0",children:[(0,b.jsx)("strong",{className:"text-emerald-900 block",children:a.nombre_alimento}),(0,b.jsxs)("span",{className:"text-[11px] text-emerald-700",children:["(",a.tipo,")"]})]},c))})]})]}),(0,b.jsxs)("div",{className:"flex justify-end gap-3 mt-8 pt-4 border-t",children:[d("users",[]).find(a=>a.name===k)?.role==="admin"&&(0,b.jsx)("button",{onClick:()=>(a=>{if(confirm("¬øEst√°s seguro de que quieres eliminar esta finca? Esta acci√≥n no se puede deshacer.")){let b=g.filter(b=>b.id!==a);h(b),f(`fincas_${k}`,b),av(null)}})(au.id),className:"px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition-colors",children:"Eliminar Finca"}),(0,b.jsx)("button",{onClick:()=>{ax(au.id),n(au.name),A(au.license||""),p(au.provinciaCode||""),r(au.municipioCode||""),t(au.municipio||""),v(au.poligono||""),y(au.parcela||""),F(au.soilId||""),D(au.maxHeads?.toString()||""),J(au.corrals?.toString()||""),M(au.corralNames||Array.from({length:au.corrals||0},(a,b)=>`Corral ${b+1}`)),O(au.feedingSystem||""),au.climateStudy&&Q(au.climateStudy),au.cropsRecommendation&&U({crops:au.cropsRecommendation,breeds:au.breedsRecommendation||[]}),av(null),j(!0)},className:"px-6 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors shadow-sm",children:"Editar Informaci√≥n"})]})]})})}),(0,b.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:g.map(a=>{let c=aA(a);return(0,b.jsxs)("div",{onClick:()=>av(a),className:"cursor-pointer bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-lg transition-all transform hover:-translate-y-1 group",children:[(0,b.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,b.jsx)("h3",{className:"text-xl font-bold text-gray-800 group-hover:text-green-700 transition-colors",children:a.name}),(0,b.jsx)("span",{className:"text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded",children:a.license||"Sin Licencia"})]}),(0,b.jsxs)("div",{className:"text-sm text-gray-600 space-y-2 mb-4",children:[(0,b.jsxs)("p",{children:[a.municipio," (",Number(a.superficie/1e4).toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:4})," ha)"]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsxs)("div",{className:"flex justify-between text-xs",children:[(0,b.jsxs)("span",{children:["Capacidad (",c.current,"/",a.maxHeads,")"]}),(0,b.jsxs)("span",{className:c.pct>=100?"text-red-600 font-bold":"text-gray-500",children:[c.pct.toFixed(0),"%"]})]}),(0,b.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,b.jsx)("div",{className:`${c.color} h-2 rounded-full`,style:{width:`${Math.min(c.pct,100)}%`}})}),c.pct>=100&&(0,b.jsx)("p",{className:"text-xs text-red-600 font-bold",children:"Exceso de capacidad"})]}),(0,b.jsxs)("p",{className:"text-xs text-gray-500",children:["Suelo: ",ab.find(b=>b.id_suelo===a.soilId)?.nombre||"Desconocido",a.climateStudy&&` | Clima: ${a.climateStudy.classification}`]})]}),(0,b.jsx)("div",{className:"text-center text-xs text-green-600 font-medium opacity-0 group-hover:opacity-100 transition-opacity",children:"Ver Ficha Completa ‚Üí"})]},a.id)})})]})}let M={clamp:(a,b,c)=>Math.min(Math.max(a,b),c),norm(a,b,c){return this.clamp((a-b)/(c-b),0,1)},calculateCarcass(a,b,c,d,e,f={}){let g={...c};f.fatherBreed&&f.motherBreed&&f.fatherBreed.name!==f.motherBreed.name&&(g.conformation_potential=(f.fatherBreed.conformation_potential+f.motherBreed.conformation_potential)/2,g.marbling_potential=(f.fatherBreed.marbling_potential+f.motherBreed.marbling_potential)/2,g.yield_potential=((f.fatherBreed.yield_potential||.58)+(f.motherBreed.yield_potential||.58))/2,f.motherBreed.marbling_potential>=4&&(g.marbling_potential+=.5),f.motherBreed.milk_potential>=4&&(g.conformation_potential=(g.conformation_potential||3)+.3),f.motherBreed.milk_potential<=1&&(g.conformation_potential=(g.conformation_potential||3)-.2),g.yield_potential=(g.yield_potential||.58)+.01);let h=g.yield_potential||.53;g.yield_potential||("AZB"===c.code?h=.63:"LIM"===c.code||"BDA"===c.code?h=.59:"CHA"===c.code?h=.58:("ANG"===c.code||"HER"===c.code)&&(h=.55)),"Macho"===f.sex&&(h+=.01),"Hembra"===f.sex&&(h-=.02),("Castrado"===f.sex||f.isOx)&&(h-=.01);let i=.012*this.norm(d,1.5,3),j=.01*this.norm(b,12,36),k=f.synergyBonuses?f.synergyBonuses.yield_percent/100:0,l=h+i+j+k;console.log("[CarcassEngine] Yield Calc:",{baseYield:h,energyFactor:i,ageFactor:j,synergyYield:k,rc:l,breedCode:c.code}),l=this.clamp(l,.45,.7);let m=g.marbling_potential||1;if(m+=2*this.norm(d,1.6,3),m*=.5+.5*this.norm(a,300,600),f.isBellota&&(m+=.8),f.synergyBonuses?.marbling&&(m+=f.synergyBonuses.marbling),void 0!==f.currentMonth){let a=f.currentMonth;a>=5&&a<=8&&5>(g.heat_tolerance||5)&&(m-=.5)}("Castrado"===f.sex||f.isOx)&&(m+=.5,b>36&&(m+=.3));let n=Math.round(1+((m=Math.max(1,m))-1)*2.2);n=this.clamp(n,1,12);let o=this.clamp(m,1,5),p=g.conformation_potential||3;if(p+=1.5*this.norm(d,1.8,2.8),void 0!==f.currentMonth){let a=f.currentMonth,b=g.heat_tolerance||5;a>=5&&a<=8&&(b>=8&&(p+=.3),b<=3&&(p-=.5))}"Macho"===f.sex&&(p+=.5),"Hembra"===f.sex&&"AZB"!==c.code&&(p-=.5),("Castrado"===f.sex||f.isOx)&&(p+=0);let q=a/(("Hembra"===f.sex?g.weight_female_adult:g.weight_male_adult)||600);q<.75||q>1.15&&(d>2.75?p-=Math.min(2*(q-1.15),1):p+=.5);let r=["P","O","R","U","E","S"][(p=Math.min(Math.max(p=Math.round(p),1),6))-1]||"R";return{rc_est:parseFloat(l.toFixed(4)),rc_percent:parseFloat((100*l).toFixed(2)),carcass_weight:parseFloat((a*l).toFixed(1)),marbling_score:parseFloat(o.toFixed(1)),bms:this.clamp(n,1,12),conformation:r,synergy_bonus_applied:f.synergyBonuses?.marbling||0,is_premium:p>=4&&n>=5}}},N=[{id:"F01",name:"Pasto Natural",category:"Forraje",dm_percent:22,energy_mcal:1.28,protein_percent:13,fiber_percent:45,cost_per_kg:.12,description:"Mantenimiento y recr√≠a"},{id:"F02",name:"Pasto Mejorado (Ryegrass)",category:"Forraje",dm_percent:23,energy_mcal:1.35,protein_percent:15,fiber_percent:45,cost_per_kg:.12,description:"Recr√≠a y crecimiento"},{id:"F03",name:"Heno de Pradera",category:"Forraje",dm_percent:88,energy_mcal:1.1,protein_percent:10,fiber_percent:60,cost_per_kg:.12,description:"Mantenimiento"},{id:"F04",name:"Heno de Alfalfa",category:"Forraje",dm_percent:89,energy_mcal:1.25,protein_percent:18,fiber_percent:45,cost_per_kg:.12,description:"Recr√≠a y lactaci√≥n. Alto calcio"},{id:"F05",name:"Ensilado de Ma√≠z",category:"Forraje",dm_percent:35,energy_mcal:1.6,protein_percent:8,fiber_percent:49,cost_per_kg:.12,description:"Engorde. Alto aporte energ√©tico"},{id:"paja",name:"Paja de Cereal",category:"Forraje",dm_percent:90,energy_mcal:.6,protein_percent:3,fiber_percent:75,cost_per_kg:.05,description:"Fibra efectiva"},{id:"BELLHO_01",name:"Bellota (Dehesa)",category:"Forraje",dm_percent:62,energy_mcal:2.2,protein_percent:6,fiber_percent:22,cost_per_kg:.1,description:"Acabado extensivo estacional. Alta en √°cido oleico"},{id:"C01",name:"Ma√≠z Grano",category:"Concentrado",dm_percent:89,energy_mcal:2.05,protein_percent:9,fiber_percent:12,cost_per_kg:.25,description:"ADG y marmoleo"},{id:"C02",name:"Cebada",category:"Concentrado",dm_percent:88,energy_mcal:1.95,protein_percent:11,fiber_percent:18,cost_per_kg:.25,description:"Engorde seguro"},{id:"C03",name:"Trigo",category:"Concentrado",dm_percent:88,energy_mcal:2,protein_percent:12,fiber_percent:10,cost_per_kg:.25,description:"Engorde r√°pido. Peligro de acidosis"},{id:"C04",name:"DDGS (Ma√≠z)",category:"Concentrado",dm_percent:90,energy_mcal:2.05,protein_percent:28,fiber_percent:32,cost_per_kg:.25,description:"Sustituto de cereal"},{id:"C05",name:"Pulpa de Remolacha",category:"Concentrado",dm_percent:90,energy_mcal:1.7,protein_percent:10,fiber_percent:40,cost_per_kg:.25,description:"Mejora digestibilidad"},{id:"C06",name:"Cascarilla de Soja",category:"Concentrado",dm_percent:90,energy_mcal:1.4,protein_percent:14,fiber_percent:60,cost_per_kg:.25,description:"Fuente de fibra"},{id:"triticale",name:"Triticale",category:"Concentrado",dm_percent:88,energy_mcal:1.85,protein_percent:12,fiber_percent:14,cost_per_kg:.24},{id:"avena",name:"Avena",category:"Concentrado",dm_percent:89,energy_mcal:1.7,protein_percent:11,fiber_percent:28,cost_per_kg:.22},{id:"P01",name:"Harina de Soja 47%",category:"Concentrado",dm_percent:88,energy_mcal:1.9,protein_percent:47,fiber_percent:15,cost_per_kg:.42,description:"Construcci√≥n muscular"},{id:"P02",name:"Colza",category:"Concentrado",dm_percent:90,energy_mcal:1.7,protein_percent:38,fiber_percent:13,cost_per_kg:.42,description:"Sustituto de soja eficiente"},{id:"P03",name:"Guisante Proteico",category:"Concentrado",dm_percent:88,energy_mcal:1.6,protein_percent:24,fiber_percent:20,cost_per_kg:.42,description:"Recr√≠a joven. Producci√≥n KM0"},{id:"P04",name:"Urea (NNP)",category:"Suplemento",dm_percent:100,energy_mcal:0,protein_percent:281,fiber_percent:0,cost_per_kg:.42,description:"Solo animales >8 meses"},{id:"S01",name:"N√∫cleo Mineral",category:"Suplemento",dm_percent:100,energy_mcal:0,protein_percent:0,fiber_percent:0,cost_per_kg:.8,description:"Salud general"},{id:"S02",name:"Premezcla de Engorde",category:"Suplemento",dm_percent:95,energy_mcal:0,protein_percent:12,fiber_percent:0,cost_per_kg:.8,description:"Mejorar FCR"},{id:"S03",name:"Vitaminas ADE",category:"Suplemento",dm_percent:100,energy_mcal:0,protein_percent:0,fiber_percent:0,cost_per_kg:.8,description:"Salud inmunitaria"},{id:"S04",name:"Corrector de Acidosis",category:"Suplemento",dm_percent:100,energy_mcal:0,protein_percent:0,fiber_percent:0,cost_per_kg:.8,description:"Estabilidad ruminal"},{id:"pienso_eco",name:"Pienso Eco Certificado",category:"Ecol√≥gico",dm_percent:90,energy_mcal:1.9,protein_percent:13,fiber_percent:14,cost_per_kg:.58,is_ecological:!0},{id:"guisante_eco",name:"Guisante Eco",category:"Ecol√≥gico",dm_percent:90,energy_mcal:1.8,protein_percent:22,fiber_percent:6,cost_per_kg:.45,is_ecological:!0}];function O({animal:a,onClose:d,fatherBreed:e,motherBreed:f}){let[g,h]=(0,c.useState)([]),[i,j]=(0,c.useState)(N),[k,l]=(0,c.useState)(""),[m,n]=(0,c.useState)("ENCINA"),[o,p]=(0,c.useState)(null),[q,r]=(0,c.useState)([]),[s,t]=(0,c.useState)([]),[u,v]=(0,c.useState)(null),[w,x]=(0,c.useState)(0),y=(a,b=2)=>a?a.toFixed(b):"0";(0,c.useEffect)(()=>{z()},[g,a,m]);let z=()=>{let b=0,c=0,d=0,h=0,i=0,j=0,k=[],l=!1;g.forEach(a=>{let e=a.kg_as_fed,f=e*(a.feed.dm_percent/100);b+=e,c+=f,d+=a.feed.energy_mcal*f,h+=a.feed.protein_percent/100*f*1e3,i+=a.feed.fiber_percent/100*f,a.feed.name.toLowerCase().includes("bellota")&&(j+=f,l=!0),k.push({feed_name:a.feed.name,type:a.feed.category,percent_dm:0,dm_kg:f})}),k.forEach(a=>{a.percent_dm=c>0?a.dm_kg/c*100:0});let n=c>0?h/1e3/c*100:0,o=c>0?d/c:0,q=c>0?i/c*100:0,s=A(a.birth||a.birthDate),u=C.getBreedByName(a.breed)||C.getAllBreeds()[0],w=u.adg_feedlot||1.2,y=E.calculateRequirements(a.weight||a.currentWeight||400,w,s,"Cebo",a.sex||"Macho"),z=g.map(a=>({item:a.feed,amount:a.kg_as_fed})),B={totalDMI:c,totalFDN:i,totalProteinVal:h,totalEnergy:d,reqs:y},D=l?"Montanera":"Intensivo";r(E.validateDiet(z,B,D));let F=new Date().getMonth();u.heat_tolerance,u.code;let G=E.calculateSynergies(k,{sex:a.sex,ageMonths:s},{bellotaType:m});t(G);let H=G.filter(a=>a.active).map(a=>a.name),I=E.predictPerformance(u,o,c,a.weight||a.currentWeight||400,{currentMonth:F,activeSynergies:H});x(I);let J={marbling:0,yield_percent:0};G.forEach(a=>{a.active&&(J.marbling+=a.bonus_marbling,J.yield_percent+=a.bonus_yield)}),v(M.calculateCarcass(a.weight||a.currentWeight||400,s,u,o,I,{sex:a.sex,synergyBonuses:J,currentMonth:F,fatherBreed:e||(a.father?C.getBreedByName(a.father):void 0),motherBreed:f||(a.mother?C.getBreedByName(a.mother):void 0)}));let K=E.calculateNitrogenBalance(a.weight||400,I,n,c);p({dmi:c,mcal:o,cp:n,fdn:q,cost:g.reduce((a,b)=>a+b.kg_as_fed*b.feed.cost_per_kg,0),env:K,hasBellota:l})},A=a=>{if(!a)return 12;let b=new Date(a);return(new Date().getTime()-b.getTime())/2630016e3};return(0,b.jsxs)("div",{className:"flex flex-col h-full bg-gray-50 rounded-xl overflow-hidden",children:[(0,b.jsxs)("div",{className:"bg-gray-900 text-white p-4 flex justify-between items-center",children:[(0,b.jsxs)("div",{children:[(0,b.jsxs)("h3",{className:"font-bold text-lg flex items-center gap-2",children:["üß™ Compositor de Dieta Cient√≠fica",s.length>0&&(0,b.jsx)("span",{className:"bg-yellow-500 text-black text-xs px-2 py-0.5 rounded font-black animate-pulse",children:"SINERGIA ACTIVA"})]}),(0,b.jsxs)("p",{className:"text-gray-400 text-xs",children:[a.breed," ‚Ä¢ ",a.weight,"kg ‚Ä¢ ",a.sex]})]}),(0,b.jsx)("button",{onClick:d,className:"text-gray-400 hover:text-white",children:"√ó"})]}),(0,b.jsxs)("div",{className:"flex-1 flex flex-col md:flex-row overflow-hidden",children:[(0,b.jsxs)("div",{className:"w-full md:w-1/2 p-4 flex flex-col gap-4 border-r border-gray-200 overflow-y-auto",children:[(0,b.jsxs)("div",{className:"bg-white p-4 rounded-lg shadow-sm",children:[(0,b.jsx)("label",{className:"text-xs font-bold text-gray-500 uppercase mb-2 block",children:"A√±adir Ingrediente"}),(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsxs)("select",{className:"flex-1 border rounded px-3 py-2 text-sm",value:k,onChange:a=>l(a.target.value),children:[(0,b.jsx)("option",{value:"",children:"Seleccionar..."}),(0,b.jsx)("optgroup",{label:"Forrajes",children:i.filter(a=>"Forraje"===a.category).map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))}),(0,b.jsx)("optgroup",{label:"Concentrados",children:i.filter(a=>"Concentrado"===a.category).map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))}),(0,b.jsx)("optgroup",{label:"Suplementos",children:i.filter(a=>"Suplemento"===a.category).map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))})]}),(0,b.jsx)("button",{onClick:()=>{if(!k)return;let a=i.find(a=>a.id===k);a&&h([...g,{id:Date.now().toString(),feed:a,kg_as_fed:1}])},className:"bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 font-bold",children:"+"})]})]}),o?.hasBellota&&(0,b.jsxs)("div",{className:"bg-green-50 border border-green-200 p-4 rounded-lg shadow-sm animate-in fade-in slide-in-from-top-2",children:[(0,b.jsx)("h4",{className:"flex items-center gap-2 text-sm font-bold text-green-900 mb-3",children:"üå≤ Origen de Montanera (Bellota)"}),(0,b.jsxs)("div",{className:"flex gap-4",children:[(0,b.jsxs)("label",{className:`flex-1 cursor-pointer border rounded-lg p-3 transition-all ${"ENCINA"===m?"bg-white border-green-500 ring-2 ring-green-100 shadow":"bg-transparent border-green-200 hover:bg-white"}`,children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,b.jsx)("input",{type:"radio",name:"bellotaType",value:"ENCINA",checked:"ENCINA"===m,onChange:()=>n("ENCINA"),className:"text-green-600 focus:ring-green-500"}),(0,b.jsx)("span",{className:"font-bold text-gray-800 text-sm",children:"Bellota Encina"})]}),(0,b.jsx)("div",{className:"text-xs text-green-700 font-medium pl-6",children:"Perfil: Alto Oleico"})]}),(0,b.jsxs)("label",{className:`flex-1 cursor-pointer border rounded-lg p-3 transition-all ${"ROBLE"===m?"bg-white border-green-500 ring-2 ring-green-100 shadow":"bg-transparent border-green-200 hover:bg-white"}`,children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,b.jsx)("input",{type:"radio",name:"bellotaType",value:"ROBLE",checked:"ROBLE"===m,onChange:()=>n("ROBLE"),className:"text-green-600 focus:ring-green-500"}),(0,b.jsx)("span",{className:"font-bold text-gray-800 text-sm",children:"Bellota Roble"})]}),(0,b.jsx)("div",{className:"text-xs text-green-700 font-medium pl-6",children:"Perfil: Taninos"})]})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[g.map(a=>(0,b.jsxs)("div",{className:"bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex items-center justify-between group",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("div",{className:"font-bold text-gray-800",children:a.feed.name}),(0,b.jsxs)("div",{className:"text-xs text-gray-400",children:[a.feed.category," ‚Ä¢ ",a.feed.dm_percent,"% MS"]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsxs)("div",{className:"flex flex-col items-end",children:[(0,b.jsx)("input",{type:"number",step:"0.1",min:"0",className:"w-16 text-right border rounded px-1 py-1 font-mono text-sm font-bold text-gray-900 focus:ring-2 focus:ring-green-500 outline-none",value:a.kg_as_fed,onChange:b=>{var c,d;return c=a.id,d=parseFloat(b.target.value)||0,void h(g.map(a=>a.id===c?{...a,kg_as_fed:d}:a))}}),(0,b.jsx)("span",{className:"text-[10px] text-gray-400",children:"kg fresco"})]}),(0,b.jsx)("button",{onClick:()=>{var b;return b=a.id,void h(g.filter(a=>a.id!==b))},className:"text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity",children:"üóëÔ∏è"})]})]},a.id)),0===g.length&&(0,b.jsx)("div",{className:"text-center py-10 text-gray-400 italic text-sm",children:"No hay ingredientes en la raci√≥n."})]})]}),(0,b.jsxs)("div",{className:"w-full md:w-1/2 bg-gray-50 flex flex-col overflow-y-auto",children:[(0,b.jsxs)("div",{className:"p-4 space-y-2",children:[q.map((a,c)=>(0,b.jsxs)("div",{className:`p-3 rounded-lg border text-sm flex items-start gap-3 ${"critical"===a.level?"bg-red-50 border-red-200 text-red-800":"bg-yellow-50 border-yellow-200 text-yellow-800"}`,children:[(0,b.jsx)("span",{className:"text-xl",children:"critical"===a.level?"‚õî":"‚ö†Ô∏è"}),(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"font-bold",children:a.message}),a.action&&(0,b.jsxs)("div",{className:"text-xs mt-1 opacity-80 font-medium",children:["Recomendaci√≥n: ",a.action]})]})]},c)),s.map((a,c)=>(0,b.jsxs)("div",{className:"bg-indigo-50 border border-indigo-200 p-3 rounded-lg text-sm flex items-start gap-3 text-indigo-900",children:[(0,b.jsx)("span",{className:"text-xl",children:"üß¨"}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("div",{className:"font-bold",children:[a.name.replace(/_/g," ")," DETECTADA"]}),(0,b.jsx)("div",{className:"text-xs mt-1",children:a.description}),(0,b.jsxs)("div",{className:"text-xs mt-1 font-mono bg-indigo-100 px-1 rounded inline-block",children:["+",(a.bonus_marbling||0).toFixed(1)," BMS ‚Ä¢ +",(a.bonus_yield||0).toFixed(1),"% Rendimiento"]})]})]},`syn-${c}`))]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-px bg-gray-200 border-t border-b border-gray-200",children:[(0,b.jsxs)("div",{className:"bg-white p-4 flex flex-col items-center justify-center",children:[(0,b.jsx)("span",{className:"text-xs text-gray-500 uppercase tracking-wider",children:"ADG Predicha"}),(0,b.jsxs)("span",{className:`text-2xl font-black ${w<0?"text-red-600":w>1.2?"text-green-600":"text-gray-700"}`,children:[y(w)," ",(0,b.jsx)("span",{className:"text-sm font-normal text-gray-400",children:"kg/d√≠a"})]})]}),(0,b.jsxs)("div",{className:"bg-white p-4 flex flex-col items-center justify-center",children:[(0,b.jsx)("span",{className:"text-xs text-gray-500 uppercase tracking-wider",children:"Coste D√≠a"}),(0,b.jsxs)("span",{className:"text-2xl font-black text-gray-700",children:[y(o?o.cost:0)," ",(0,b.jsx)("span",{className:"text-sm font-normal text-gray-400",children:"‚Ç¨"})]})]}),(0,b.jsxs)("div",{className:"bg-white p-4 flex flex-col items-center justify-center",children:[(0,b.jsx)("span",{className:"text-xs text-gray-500 uppercase tracking-wider",children:"Marmoleo (BMS)"}),(0,b.jsxs)("span",{className:"text-2xl font-black text-purple-700",children:[u?u.bms:"?"," ",(0,b.jsx)("span",{className:"text-sm font-normal text-purple-300",children:"/ 12"})]}),(0,b.jsxs)("span",{className:"text-[10px] text-gray-400",children:["Score: ",u?u.marbling_score:0]})]}),(0,b.jsxs)("div",{className:"bg-white p-4 flex flex-col items-center justify-center",children:[(0,b.jsx)("span",{className:"text-xs text-gray-500 uppercase tracking-wider",children:"Clasificaci√≥n"}),(0,b.jsx)("span",{className:"text-2xl font-black text-gray-800",children:u?u.conformation:"?"}),(0,b.jsxs)("span",{className:"text-[10px] text-gray-400",children:["Rend: ",u?u.rc_percent:0,"%"]})]})]}),(0,b.jsxs)("div",{className:"p-4 bg-white",children:[(0,b.jsx)("h4",{className:"text-xs font-bold text-gray-400 uppercase mb-3",children:"Balance Nutricional"}),(0,b.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,b.jsxs)("div",{className:"flex justify-between",children:[(0,b.jsx)("span",{className:"text-gray-600",children:"Energ√≠a Dieta"}),(0,b.jsxs)("span",{className:"font-mono font-bold",children:[y(o?.mcal)," Mcal/kg"]})]}),(0,b.jsx)("div",{className:"w-full bg-gray-100 h-2 rounded-full overflow-hidden",children:(0,b.jsx)("div",{className:"bg-blue-500 h-full",style:{width:`${Math.min(100,(o?.mcal||0)/3*100)}%`}})}),(0,b.jsxs)("div",{className:"flex justify-between pt-2",children:[(0,b.jsx)("span",{className:"text-gray-600",children:"Prote√≠na Bruta"}),(0,b.jsxs)("span",{className:"font-mono font-bold",children:[y(o?.cp)," %"]})]}),(0,b.jsx)("div",{className:"w-full bg-gray-100 h-2 rounded-full overflow-hidden",children:(0,b.jsx)("div",{className:"bg-green-500 h-full",style:{width:`${Math.min(100,(o?.cp||0)/20*100)}%`}})}),(0,b.jsxs)("div",{className:"flex justify-between pt-2",children:[(0,b.jsx)("span",{className:"text-gray-600",children:"Fibra (FDN)"}),(0,b.jsxs)("span",{className:`font-mono font-bold ${o?.fdn<28?"text-red-500":"text-gray-900"}`,children:[y(o?.fdn)," %"]})]})]})]}),o?.env&&(0,b.jsxs)("div",{className:`p-4 border-t ${o.env.is_critical?"bg-red-50":"bg-green-50"}`,children:[(0,b.jsxs)("h4",{className:"text-xs font-bold uppercase mb-2 flex items-center gap-2",children:[(0,b.jsx)("span",{className:"text-lg",children:"üåç"})," Impacto Ambiental"]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-gray-500",children:"Eficiencia N"}),(0,b.jsxs)("div",{className:"font-bold text-lg",children:[o.env.efficiency_pct,"%"]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-gray-500",children:"Excreci√≥n/kg Ganancia"}),(0,b.jsxs)("div",{className:`font-bold text-lg ${o.env.is_critical?"text-red-600":"text-green-700"}`,children:[o.env.excretion_per_gain," g N"]})]})]})]})]})]}),(0,b.jsxs)("div",{className:"p-4 bg-white border-t border-gray-200 flex justify-end gap-2",children:[(0,b.jsx)("button",{className:"px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium",onClick:d,children:"Cancelar"}),(0,b.jsx)("button",{className:"px-6 py-2 bg-gray-900 text-white rounded-lg text-sm font-bold hover:bg-black transition-colors shadow-lg flex items-center gap-2",onClick:()=>alert("Guardado en historial (Simulado)"),children:"üíæ Guardar Dieta"})]})]})}function P(){var a;let d,f,g,h,i,j,k,{read:l,write:m}=(0,e.useStorage)(),[n,o]=(0,c.useState)([]),[p,q]=(0,c.useState)([]),[r,s]=(0,c.useState)([]),[t,u]=(0,c.useState)(""),[v,w]=(0,c.useState)(!1),[x,y]=(0,c.useState)(!1),[z,A]=(0,c.useState)({id:"",name:"",farm:"",breed:"",sex:"",birth:"",weight:"",notes:"",father:"",mother:"",corral:""});(0,c.useEffect)(()=>{let a=l("sessionUser","");if(u(a),a){let b=`animals_${a}`,c=`animals_${a} `,d=l(b,[]),e=l(c,[]),f=!1;e.length>0&&0===d.length&&(console.log("Recuperando datos antiguos..."),d=[...e],m(c,[]),f=!0),d=d.map(a=>{if(a.h_w&&Array.isArray(a.h_w)&&!a.monthlyRecords){let b=[],c=a.h_end?new Date(a.h_end):new Date;for(let d=0;d<a.h_w.length;d++){let e=a.h_w[d],f=a.h_w.length-1-d,g=new Date(c);g.setMonth(g.getMonth()-f),b.push({date:g.toISOString().split("T")[0].substring(0,7)+"-01",weightKg:e,adg:0})}return{...a,monthlyRecords:b}}return a});let g=l("events",[]),h=d.map(a=>{let b=parseFloat(a.weight)||0,c="current";if(a.monthlyRecords&&Array.isArray(a.monthlyRecords)&&a.monthlyRecords.length>0){let d=[...a.monthlyRecords].sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime())[0];d&&(d.weightKg||d.w)&&(b=parseFloat(d.weightKg||d.w),c="monthlyRecord")}else{let d=g.filter(b=>(b.animalId===a.id||b.animalCrotal===a.crotal)&&"Pesaje"===b.type).sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime());d.length>0&&(b=parseFloat(d[0].weight)||b,c="event")}return Math.abs(b-parseFloat(a.weight))>.1?(console.log(`Corrigiendo peso de ${a.crotal}: ${a.weight} -> ${b} (Fuente: ${c})`),f=!0,{...a,weight:b,currentWeight:b}):a});f&&(console.log("Sincronizando pesos con historial..."),d=h),o(d),s(l(`fincas_${a}`,[])),q(g)}},[l]);let B=(a,c=!1)=>{if(!a)return"";let d=a.length;if(d<4)return(0,b.jsx)("span",{className:`font - medium ${c?"text-white":"text-gray-900"} `,children:a});let e=a.substring(0,d-4),f=a.substring(d-4);return(0,b.jsxs)("span",{className:`${c?"text-white":"text-gray-900"} inline-flex font-mono tracking-tight items-baseline`,children:[(0,b.jsx)("span",{className:`${c?"text-green-100":"text-gray-400"} font-normal text-sm`,children:e}),(0,b.jsx)("span",{className:"font-black text-xl",children:f})]})},[D,F]=(0,c.useState)(""),[G,H]=(0,c.useState)(!1),I=n.filter(a=>{let b=!a.status||"Activo"===a.status;if(G){if(b)return!1}else if(!b)return!1;if(!D)return!0;let c=D.toLowerCase();return a.id.toLowerCase().includes(c)||a.id.slice(-4).includes(c)||a.breed&&a.breed.toLowerCase().includes(c)}),[J,K]=(0,c.useState)(null);return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"flex justify-between items-center",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h2",{className:"text-2xl font-bold text-gray-800",children:"Inventario de Animales"}),(0,b.jsx)("p",{className:"text-gray-600",children:"Registro y monitoreo individual"})]}),(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsx)("button",{onClick:()=>{let a=encodeURI("data:text/csv;charset=utf-8,Crotal,Nombre,Finca,Raza,Sexo,Nacimiento,Peso,Notas,Padre,Madre\n"),b=document.createElement("a");b.setAttribute("href",a),b.setAttribute("download","plantilla_animales.csv"),document.body.appendChild(b),b.click(),document.body.removeChild(b)},className:"bg-green-50 text-green-700 hover:bg-green-100 font-medium py-2 px-4 rounded-lg transition-colors text-sm",children:"‚¨á Plantilla CSV"}),(0,b.jsxs)("label",{className:"bg-green-50 text-green-700 hover:bg-green-100 font-medium py-2 px-4 rounded-lg transition-colors cursor-pointer text-sm flex items-center",children:["‚¨Ü Cargar CSV",(0,b.jsx)("input",{type:"file",accept:".csv",onChange:a=>{let b=a.target.files?.[0];if(!b)return;let c=new FileReader;c.onload=a=>{let b=a.target?.result;if(!b)return;let c=b.split("\n"),d=[],e=0;for(let a=1;a<c.length;a++){let b=c[a].trim();if(!b)continue;let f=b.split(",");if(f.length<5||!f[0]){e++;continue}d.push({id:f[0].trim(),name:f[1]?.trim()||"",farm:f[2]?.trim()||"Sin Asignar",breed:f[3]?.trim()||"Desconocida",sex:f[4]?.trim()||"Hembra",birth:f[5]?.trim()||"",weight:parseFloat(f[6])||0,notes:f[7]?.trim()||"",father:f[8]?.trim()||"",mother:f[9]?.trim()||"",corral:"",joined:new Date().toISOString()})}if(d.length>0){let a=[...n,...d];o(a),m(`animals_${t}`,a),alert(`Importados ${d.length} animales.${e>0?`(${e} errores)`:""} `)}else alert("No se pudieron importar animales. Verifica el formato del CSV.")},c.readAsText(b)},className:"hidden"})]}),(0,b.jsx)("button",{onClick:()=>w(!v),className:"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors",children:v?"Cancelar":"Nuevo Animal"})]})]}),(0,b.jsxs)("div",{className:"flex flex-col md:flex-row gap-4 items-center justify-between",children:[(0,b.jsx)("div",{className:"relative flex-1 w-full",children:(0,b.jsx)("input",{type:"text",placeholder:"Buscar por Crotal (ej. 1234), Raza...",className:"w-full border rounded-lg px-4 py-3 text-lg shadow-sm focus:ring-2 focus:ring-green-500 outline-none",value:D,onChange:a=>F(a.target.value)})}),(0,b.jsxs)("label",{className:"flex items-center gap-2 text-gray-700 font-medium cursor-pointer select-none whitespace-nowrap bg-gray-50 px-4 py-3 rounded-lg border border-gray-200 hover:bg-gray-100",children:[(0,b.jsx)("input",{type:"checkbox",checked:G,onChange:a=>H(a.target.checked),className:"w-5 h-5 text-green-600 rounded focus:ring-green-500"}),"Ver Bajas"]})]}),v&&(0,b.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-in fade-in slide-in-from-top-4",children:[(0,b.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Registrar Animal"}),(0,b.jsxs)("form",{onSubmit:a=>{if(a.preventDefault(),!z.id||!z.farm||!z.sex||!z.breed)return void alert("Por favor completa los campos obligatorios");if(n.find(a=>a.id===z.id))return void alert("Ya existe un animal con ese Crotal");let b=[...n,{...z,weight:parseFloat(z.weight)||0,category:"Sin Clasificar",joined:new Date().toISOString()}];o(b),m(`animals_${t}`,b),w(!1),A({id:"",name:"",farm:"",breed:"",sex:"",birth:"",weight:"",notes:"",father:"",mother:"",corral:""})},className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Crotal (ID) *"}),(0,b.jsx)("input",{type:"text",required:!0,className:"w-full border rounded-lg px-3 py-2",value:z.id,onChange:a=>A({...z,id:a.target.value})})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre (Opcional)"}),(0,b.jsx)("input",{type:"text",className:"w-full border rounded-lg px-3 py-2",value:z.name,onChange:a=>A({...z,name:a.target.value})})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Finca *"}),(0,b.jsxs)("select",{required:!0,className:"w-full border rounded-lg px-3 py-2",value:z.farm,onChange:a=>A({...z,farm:a.target.value}),children:[(0,b.jsx)("option",{value:"",children:"Selecciona Finca"}),(0,b.jsx)("option",{value:r[0]?.name||"SOTO del PRIOR",children:r[0]?.name||"SOTO del PRIOR"}),r.slice(1).map(a=>(0,b.jsx)("option",{value:a.name,children:a.name},a.id))]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Corral"}),(0,b.jsxs)("select",{className:"w-full border rounded-lg px-3 py-2",value:z.corral||"",onChange:a=>A({...z,corral:a.target.value}),disabled:!z.farm,children:[(0,b.jsx)("option",{value:"",children:"Sin Asignar"}),(j=r.find(a=>a.name===z.farm))?j.corralNames&&j.corralNames.length>0?j.corralNames.map((a,c)=>(0,b.jsx)("option",{value:a,children:a},c)):Array.from({length:j.corrals||0},(a,b)=>b+1).map(a=>(0,b.jsxs)("option",{value:a,children:["Corral ",a]},a)):null]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Raza *"}),(0,b.jsxs)("select",{required:!0,className:"w-full border rounded-lg px-3 py-2",value:z.breed,onChange:a=>A({...z,breed:a.target.value}),children:[(0,b.jsx)("option",{value:"",children:"Selecciona Raza"}),(0,b.jsx)("option",{value:"Wagyu",children:"Wagyu"}),(0,b.jsx)("option",{value:"Angus",children:"Angus"}),(0,b.jsx)("option",{value:"Hereford",children:"Hereford"}),(0,b.jsx)("option",{value:"Charolais",children:"Charolais"}),(0,b.jsx)("option",{value:"Limousin",children:"Limousin"}),(0,b.jsx)("option",{value:"Brahman",children:"Brahman"}),(0,b.jsx)("option",{value:"Nelore",children:"Nelore"}),(0,b.jsx)("option",{value:"Droughtmaster",children:"Droughtmaster"}),(0,b.jsx)("option",{value:"Retinta",children:"Retinta"}),(0,b.jsx)("option",{value:"Morucha",children:"Morucha"}),(0,b.jsx)("option",{value:"Pirenaica",children:"Pirenaica"}),(0,b.jsx)("option",{value:"Betiz√∫",children:"Betiz√∫"}),(0,b.jsx)("option",{value:"Berrenda",children:"Berrenda"}),(0,b.jsx)("option",{value:"Simmental",children:"Simmental"}),(0,b.jsx)("option",{value:"Blonde d'Aquitaine",children:"Blonde d'Aquitaine"}),(0,b.jsx)("option",{value:"Azul Belga",children:"Azul Belga"}),(0,b.jsx)("option",{value:"Cruzada",children:"Cruzada"})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Sexo *"}),(0,b.jsxs)("select",{required:!0,className:"w-full border rounded-lg px-3 py-2",value:z.sex,onChange:a=>A({...z,sex:a.target.value}),children:[(0,b.jsx)("option",{value:"",children:"Selecciona Sexo"}),(0,b.jsx)("option",{value:"Macho",children:"Macho"}),(0,b.jsx)("option",{value:"Hembra",children:"Hembra"})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Fecha Nacimiento"}),(0,b.jsx)("input",{type:"date",className:"w-full border rounded-lg px-3 py-2",value:z.birth,onChange:a=>A({...z,birth:a.target.value})})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Peso Actual (kg)"}),(0,b.jsx)("input",{type:"number",step:"0.1",className:"w-full border rounded-lg px-3 py-2",value:z.weight,onChange:a=>A({...z,weight:a.target.value})})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Padre (Crotal) - Opcional"}),(0,b.jsx)("input",{type:"text",className:"w-full border rounded-lg px-3 py-2",placeholder:"ID del Padre",value:z.father,onChange:a=>A({...z,father:a.target.value})})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Madre (Crotal) - Opcional"}),(0,b.jsx)("input",{type:"text",className:"w-full border rounded-lg px-3 py-2",placeholder:"ID de la Madre",value:z.mother,onChange:a=>A({...z,mother:a.target.value})})]}),(0,b.jsx)("div",{className:"md:col-span-2",children:(0,b.jsx)("button",{type:"submit",className:"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg w-full md:w-auto",children:"Guardar Animal"})})]})]}),(0,b.jsx)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden",children:(0,b.jsxs)("table",{className:"w-full text-left",children:[(0,b.jsx)("thead",{className:"bg-gray-50 text-gray-600 font-medium text-sm",children:(0,b.jsxs)("tr",{children:[(0,b.jsx)("th",{className:"p-4 w-1/3",children:"Crotal"}),(0,b.jsx)("th",{className:"p-4 w-1/3",children:"Sexo"}),(0,b.jsx)("th",{className:"p-4 w-1/3",children:"Finca"})]})}),(0,b.jsx)("tbody",{className:"divide-y divide-gray-100",children:0===I.length?(0,b.jsx)("tr",{children:(0,b.jsx)("td",{colSpan:3,className:"p-8 text-center text-gray-500",children:"No hay animales que coincidan."})}):I.map((a,c)=>(0,b.jsxs)("tr",{onClick:()=>K(a),className:"hover:bg-green-50 transition-colors cursor-pointer group",children:[(0,b.jsx)("td",{className:"p-4",children:(0,b.jsx)("div",{className:"flex flex-col",children:B(a.id)})}),(0,b.jsx)("td",{className:"p-4 text-gray-600",children:a.sex}),(0,b.jsx)("td",{className:"p-4 text-gray-600",children:(0,b.jsxs)("div",{className:"flex flex-col text-sm",children:[(0,b.jsx)("span",{children:a.farm}),a.corral&&(0,b.jsxs)("span",{className:"text-xs text-green-600 font-medium",children:["‚ûú ",a.corral]})]})})]},c))})]})}),J&&(0,b.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4 backdrop-blur-sm",children:(0,b.jsx)("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden animate-in fade-in zoom-in-95 h-[90vh] flex flex-col",children:x?(0,b.jsx)(O,{animal:J,onClose:()=>y(!1),fatherBreed:(()=>{if(!J.father)return;let a=n.find(a=>a.id===J.father);return C.getBreedByName(a?a.breed:J.father)})(),motherBreed:(()=>{if(!J.mother)return;let a=n.find(a=>a.id===J.mother);return C.getBreedByName(a?a.breed:J.mother)})()}):(0,b.jsxs)("div",{className:"flex flex-col h-full",children:[(0,b.jsxs)("div",{className:"bg-green-700 px-6 py-5 flex justify-between items-start text-white relative overflow-hidden flex-shrink-0",children:[(0,b.jsx)("div",{className:"absolute top-0 right-0 opacity-10 transform translate-x-1/4 -translate-y-1/4",children:(0,b.jsx)("svg",{width:"200",height:"200",viewBox:"0 0 200 200",fill:"currentColor",children:(0,b.jsx)("path",{d:"M100 0L200 200H0L100 0Z"})})}),(0,b.jsxs)("div",{className:"relative z-10",children:[(0,b.jsx)("div",{className:"scale-125 origin-top-left mb-1",children:B(J.id,!0)}),(0,b.jsxs)("div",{className:"flex items-center gap-2 mt-2 opacity-90 text-sm font-medium",children:[(0,b.jsx)("span",{className:"bg-white/20 px-2 py-0.5 rounded backdrop-blur-sm",children:J.breed}),(0,b.jsx)("span",{children:"‚Ä¢"}),(0,b.jsx)("span",{children:J.sex})]})]}),(0,b.jsxs)("div",{className:"flex gap-2 z-10 items-center",children:[(0,b.jsx)("button",{onClick:()=>y(!0),className:"bg-yellow-400 hover:bg-yellow-300 text-yellow-900 px-4 py-2 rounded-lg font-bold text-sm shadow-lg transform hover:scale-105 transition-all flex items-center gap-2",title:"Simular Dieta Cient√≠fica",children:"üß™ Crear Dieta"}),(0,b.jsx)("button",{onClick:()=>window.print(),className:"bg-white/20 hover:bg-white/30 text-white p-2 rounded-lg backdrop-blur-sm transition-colors",title:"Imprimir Ficha",children:"üñ®Ô∏è"}),(0,b.jsx)("button",{onClick:()=>{K(null),y(!1)},className:"text-white hover:text-green-200 text-3xl leading-none",children:"√ó"})]})]}),(0,b.jsxs)("div",{className:"p-6 space-y-6 overflow-y-auto flex-1",children:[(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{className:"bg-green-50 p-4 rounded-xl border border-green-100",children:[(0,b.jsx)("p",{className:"text-green-600 text-xs font-bold uppercase tracking-wider mb-1",children:"Peso Actual"}),(0,b.jsxs)("div",{className:"flex items-baseline gap-1",children:[(0,b.jsx)("span",{className:"text-3xl font-black text-gray-900",children:J.currentWeight||J.weight}),(0,b.jsx)("span",{className:"text-base font-medium text-gray-500",children:"kg"})]}),(0,b.jsxs)("p",{className:"text-xs text-green-700 mt-1 flex items-center gap-1",children:[(0,b.jsx)("span",{children:"‚öñÔ∏è"})," √öltimo pesaje verificado"]})]}),(0,b.jsxs)("div",{className:"bg-blue-50 p-4 rounded-xl border border-blue-100",children:[(0,b.jsx)("p",{className:"text-blue-600 text-xs font-bold uppercase tracking-wider mb-1",children:"Edad Exacta"}),(0,b.jsx)("p",{className:"font-bold text-gray-900 text-lg leading-tight",children:(a=>{if(!a)return"?";let b=new Date(a),c=new Date,d=c.getFullYear()-b.getFullYear(),e=c.getMonth()-b.getMonth(),f=c.getDate()-b.getDate();f<0&&(e--,f+=new Date(c.getFullYear(),c.getMonth(),0).getDate()),e<0&&(d--,e+=12);let g=[];return d>0&&g.push(`${d} a\xf1os`),e>0&&g.push(`${e} meses`),f>=0&&g.push(`${f} d\xedas`),g.join(", ")})(J.birth||J.birthDate)}),(0,b.jsxs)("p",{className:"text-xs text-blue-700 mt-2",children:["Nacimiento: ",J.birth||"Desconocido"]})]})]}),(0,b.jsxs)("div",{className:"bg-gray-50 rounded-xl border border-gray-100 p-4",children:[(0,b.jsxs)("h4",{className:"font-bold text-gray-800 text-sm mb-3 flex items-center gap-2",children:[(0,b.jsx)("span",{children:"üåæ"})," Estrategia Nutricional"]}),(d=new Date((a=J).birth||a.birthDate),g=((f=new Date).getTime()-d.getTime())/2630016e3,h=E.checkBellotaCompliance({ageMonths:g},f.getMonth()).compliant,i="Buey"===a.category||"Castrado"===a.sex&&g>12,k=h&&i?{label:"Bellota y Soja (Premium)",color:"bg-emerald-800 text-white border-emerald-900"}:"Lactancia"===a.status||a.category?.includes("Nodriza")?{label:"Pasto + Suplemento Materno",color:"bg-blue-100 text-blue-800 border-blue-200"}:a.farm&&a.farm.toLowerCase().includes("feedlot")?{label:"Cebo Intensivo",color:"bg-orange-100 text-orange-800 border-orange-200"}:{label:"Pasto / Mantenimiento",color:"bg-green-50 text-green-700 border-green-200"},(0,b.jsx)("div",{className:"flex items-center justify-between",children:(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-xs text-gray-500 mb-1",children:"Programa Actual"}),(0,b.jsx)("span",{className:`px - 3 py - 1 rounded - full text - sm font - bold border ${k.color} `,children:k.label})]})}))]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 text-sm border-t pt-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-gray-500 text-xs uppercase font-bold tracking-wider mb-1",children:"Ubicaci√≥n Actual"}),(0,b.jsx)("p",{className:"font-medium text-gray-900 text-base mb-2",children:J.farm}),J.corral&&(0,b.jsxs)("span",{className:"text-green-700 font-bold text-xs bg-white px-2 py-1 rounded border border-green-200 shadow-sm inline-block",children:["üìç Corral ",J.corral]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-gray-500 text-xs uppercase font-bold tracking-wider mb-1",children:"Genealog√≠a"}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("span",{className:"text-xs font-bold text-blue-600",children:"P:"}),(0,b.jsx)("span",{children:J.father||"N/A"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("span",{className:"text-xs font-bold text-pink-600",children:"M:"}),(0,b.jsx)("span",{children:J.mother||"N/A"})]})]})]})]}),(0,b.jsxs)("div",{className:"mt-6 border-t pt-4",children:[(0,b.jsx)("h4",{className:"font-bold text-gray-800 text-sm mb-3",children:"Historial de Eventos"}),(0,b.jsx)("div",{className:"border rounded-lg overflow-hidden text-sm",children:(0,b.jsxs)("table",{className:"w-full text-left",children:[(0,b.jsx)("thead",{className:"bg-gray-50 text-gray-600 text-xs uppercase",children:(0,b.jsxs)("tr",{children:[(0,b.jsx)("th",{className:"px-3 py-2",children:"Fecha"}),(0,b.jsx)("th",{className:"px-3 py-2",children:"Evento"}),(0,b.jsx)("th",{className:"px-3 py-2",children:"Detalle"})]})}),(0,b.jsx)("tbody",{className:"divide-y divide-gray-100",children:p.filter(a=>a.animalId===J.id||a.animalCrotal===J.id).sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime()).map((a,c)=>(0,b.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,b.jsx)("td",{className:"px-3 py-2 font-mono text-xs text-gray-500",children:a.date}),(0,b.jsx)("td",{className:"px-3 py-2 font-medium text-gray-800",children:a.type}),(0,b.jsx)("td",{className:"px-3 py-2 text-gray-600",children:a.desc})]},c))})]})})]})]}),(0,b.jsxs)("div",{className:"bg-gray-50 px-6 py-4 flex justify-between items-center border-t border-gray-100 flex-shrink-0",children:[(0,b.jsxs)("span",{className:"text-xs text-gray-400 font-mono",children:["ID: ",J.id]}),(0,b.jsx)("button",{onClick:()=>{K(null),y(!1)},className:"px-4 py-2 bg-white border border-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-50 text-sm shadow-sm transition-colors",children:"Cerrar Ficha"})]})]})})})]})}let Q={getAgeInMonths(a){if(!a)return 0;let b=new Date(a);return parseFloat((Math.abs(new Date().getTime()-b.getTime())/2630016e3).toFixed(1))},getReproductiveStatus(a,b){if("Hembra"!==a.sex)return{status:"Inmadura",daysInState:0};let c=[...b].filter(b=>b.animalId===a.id||b.animalCrotal===a.crotal).sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime()),d=c.find(a=>"Parto"===a.type),e=c.find(a=>"Inseminaci√≥n"===a.type||"Monta"===a.type),f=c.find(a=>"Diagn√≥stico"===a.type||"Revisi√≥n"===a.type&&a.desc.includes("Diagn√≥stico")),g=new Date;if(d){let a=new Date(d.date);e&&e.date;let b=Math.floor((g.getTime()-a.getTime())/864e5),f=c.filter(b=>new Date(b.date)>a),h=f.find(a=>"Inseminaci√≥n"===a.type),i=f.find(a=>"Diagn√≥stico"===a.type);if(!h)return b<45?{status:"Postparto",daysInState:b}:{status:"Vac√≠a",daysInState:b};if(h){let a=Math.floor((g.getTime()-new Date(h.date).getTime())/864e5);return i?"Positivo"===i.result||i.desc.includes("Gesta")||i.desc.includes("Pre√±a")?{status:"Gestante",daysInState:a}:{status:"Vac√≠a",daysInState:0}:{status:"Cubierta",daysInState:a}}}if(e){let a=Math.floor((g.getTime()-new Date(e.date).getTime())/864e5);return f?"Positivo"===f.result||f.desc.includes("Gesta")?{status:"Gestante",daysInState:a}:{status:"Vac√≠a",daysInState:0}:{status:"Cubierta",daysInState:a}}return{status:"Vac√≠a",daysInState:0}},getLifecycleAlerts(a){let b=[];if(!a.birthDate)return b;let c=new Date(a.birthDate),d=new Date,e=(d.getTime()-c.getTime())/2630016e3,f=new Date(c);if(f.setDate(f.getDate()+210),e>=6.5&&e<=8&&b.push({type:"Destete",date:f.toISOString().split("T")[0],desc:"Animal cumple 7 meses. Planificar destete.",animalId:a.id,isDue:d>=f}),"Macho"===a.sex&&e>=5.5&&e<=7){let e=new Date(c);e.setDate(e.getDate()+180),b.push({type:"Castraci√≥n",date:e.toISOString().split("T")[0],desc:`Decisi\xf3n Macho (6 meses): \xbfSemental o Buey?`,animalId:a.id,isDue:d>=e})}return b}},R={defaultPrices:{AR3:758,AU2:779,AU3:779,AO3:745,DR3:760,DO3:720,DP2:640,DU4:800,DR4:760,ER3:779,EU3:791,EO3:763,ZR3:780,ZU3:795,CR3:850,CU3:880,BR3:680,VR3:800,A:750,B:650,C:800,D:680,E:770,Z:780,V:800},determineMAPACode(a){let{ageMonths:b,sex:c,isCastrated:d,isParida:e}=a,f=(c||"").toLowerCase();return b<8?"V":b<12?"Z":"macho"===f||"castrado"===f?d||"castrado"===f?"C":b<24?"A":"B":"hembra"===f?e||b>48?"D":"E":"A"},calculateSalesPrice(a,b,c,d){let e=this.determineMAPACode(a),f=(c||"R").toUpperCase(),g=(d||3).toString(),h=`${e}${f}${g}`,i=`${e}${f}`,j=this.defaultPrices[h]||this.defaultPrices[i]||this.defaultPrices[e]||500;return{totalValue:parseFloat((b/100*j).toFixed(2)),pricePerKg:parseFloat((j/100).toFixed(2)),categoryCode:h,baseCategory:e}},importPricesFromCSV(a){let b=a.split("\n"),c={};return b.forEach(a=>{let b=a.split(/,|;/);if(b.length>=2){let a=b[0].trim().toUpperCase(),d=parseFloat(b[1].trim());isNaN(d)||(c[a]=d)}}),Object.assign(this.defaultPrices,c),Object.keys(c).length}};function S(){let{read:a}=(0,e.useStorage)(),{calculate:d,results:f,loading:g,error:h}=function(){let[a,b]=(0,c.useState)({}),[d,e]=(0,c.useState)(null),[f,g]=(0,c.useState)(!1),[h,i]=(0,c.useState)(null);return(0,c.useEffect)(()=>{let a=C.getAllBreeds(),c={};a.forEach(a=>{c[a.id]=a}),b(c)},[]),{breeds:a,calculate:async a=>{g(!0),i(null),e(null);try{let b,c,d,f,{animal:g,system:h}=a,i=Q.getAgeInMonths(g.birth_date||g.birth||g.birthDate),j=a.overrideBreed||C.getBreedById(g.breed);if(!j||"Cruzado"===g.breed||"Mestizo"===g.breed){let a=g.genotype?.fatherBreedId||g.fatherBreedId,b=g.genotype?.motherBreedId||g.motherBreedId;if(a&&b){let c=C.calculateHybrid(a,b);c&&(j=c)}}if(!j){let a=(g.breed||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(!(j=C.getAllBreeds().find(b=>a.includes(b.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""))||a.includes(b.code.toLowerCase())))&&(a.includes("cruzad")||a.includes("mestiz"))){let a=g.genotype?.fatherBreedId||g.fatherBreedId,b=g.genotype?.motherBreedId||g.motherBreedId;a&&b&&(j=C.calculateHybrid(a,b))}j||(j={id:"GENERIC_CROSS",code:"CROSS",name:"Cruzado (Gen√©rico)",subspecies:"Cruzado",biological_type:"Composite",weight_female_adult:600,weight_male_adult:950,adg_feedlot:1.2,slaughter_age_months:20,conformation_potential:4,marbling_potential:3,yield_potential:.58,heat_tolerance:6,milk_potential:3})}if(!j)throw Error("No se pudo determinar la raza del animal.");let k=parseFloat(g.currentWeight||g.weight||0),l="Cebo";"Mantenimiento"===a.objective&&(l="Mantenimiento"),a.objective.includes("Recr√≠a")&&(l="Mantenimiento"),(a.objective.includes("Cebo")||a.objective.includes("Engorde"))&&(l="Cebo");let m=j.adg_feedlot||1.2,n=E.calculateRequirements(k,m,i,l,g.sex||"Macho"),o=a.feeds||[];o&&0!==o.length||(o=[{name:"Raci√≥n Base (Estimada)",amount:10,dm_percent:40,energy_mcal:n.em_mcal,protein_percent:n.pb_percent,cost_per_kg:.03}]);let p=o.reduce((a,b)=>a+b.amount,0),q=o.reduce((a,b)=>a+b.amount*(b.cost_per_kg||0),0),r=0,s=0,t=0,u=0;o.forEach(a=>{let b=a.amount*(a.dm_percent/100);u+=b,r+=b*(a.energy_mcal||0),s+=b*(10*(a.protein_percent||0)),t+=b*((a.fiber_percent||a.ndf_percent||a.fdn_percent||0)/100)});let v=u>0?r/u:0,w=E.predictPerformance(j,v,u,k),x=M.calculateCarcass(g.weight+30*w,i+1,j,v,w,{isBellota:h.toLowerCase().includes("montanera")||h.toLowerCase().includes("bellota"),isOx:("Macho"===g.sex||"Castrado"===g.sex)&&i>24,sex:g.sex||"Macho"}),y=u>0?s/10/u:0,z=E.calculateNitrogenBalance(k,w,y,u),A=(a.events||[]).reduce((a,b)=>a+(parseFloat(b.cost)||0),0),B=(g.monthlyRecords||[]).reduce((a,b)=>{let c=b.totalCost||.02*(b.w||b.weightKg||0)*7.5;return a+c},0),D=30*q,F=A+B+D,G=R.calculateSalesPrice({ageMonths:i+1,sex:g.sex,isCastrated:"Castrado"===g.sex,isParida:"Parto"===g.status||"Nodriza"===g.category},x.carcass_weight,x.conformation,Math.round(x.marbling_score));e({diet:o,projectedGain:w,dmiTarget:n.dmi_capacity_kg,dmiActual:u,totalCost:q,totalKg:p,historicalCosts:{events:A,feed:B,total:A+B},financials:{projectedSales:G.totalValue,pricePerKg:G.pricePerKg,category:G.categoryCode,totalCost:F,margin:G.totalValue-F},fcr:w>0?q/w:0,energyTarget:n.em_mcal*u,energyActual:r,proteinPercent:y,alerts:E.validateDiet(o.map(a=>({item:a,amount:a.amount})),{totalDMI:u,totalFDN:t,totalProteinVal:s,totalEnergy:r,reqs:n},a.system),imbalances:[],carcass:{conformation_est:x.conformation,marbling_est:x.marbling_score,is_premium:x.is_premium,rc_percent:x.rc_percent,limitingFactor:(b=n.em_mcal*u,c=n.pb_percent/100*u*1e3,d=b>0?r/b:1,f=c>0?s/c:1,w>=(j.adg_feedlot||1.4)?"Gen√©tica (M√°x)":u>=.95*n.dmi_capacity_kg&&d<1&&f<1?"Ingesta (Llenado)":d<f?"Energ√≠a":"Prote√≠na")},envImpact:z})}catch(a){console.error(a),i(a.message||"Error en c√°lculo")}finally{g(!1)}},results:d,loading:f,error:h}}(),[i,j]=(0,c.useState)([]),[k,l]=(0,c.useState)(""),[m,n]=(0,c.useState)(null),[o,p]=(0,c.useState)("Mantenimiento"),[q,r]=(0,c.useState)("Extensivo (Pastoreo)"),[s,t]=(0,c.useState)(!1),[u,v]=(0,c.useState)(!1),[w,x]=(0,c.useState)([]),y=`${q}${s?" + Montanera":""}${u?" + Ecol√≥gico":""}`,[z,A]=(0,c.useState)(""),[B,D]=(0,c.useState)(!1),[F,G]=(0,c.useState)([]),[H]=(0,c.useState)(N);(0,c.useEffect)(()=>{let b=a("sessionUser","");b&&(j(a(`animals_${b}`,[])),x(a("events",[])))},[a]),(0,c.useEffect)(()=>{m&&d({animal:m,objective:o,system:y,feeds:F.map(a=>({...a.item,amount:a.amount})),events:w.filter(a=>a.animalId===m.id||a.animalCrotal===m.id)})},[F,m,o,y,w]);let[I,J]=(0,c.useState)(null);(0,c.useEffect)(()=>{if(m){let a=(a=>{if(!a)return null;let b=C.getBreedById(a.breed);if(!b){let c=a.genotype?.fatherBreedId||a.fatherBreedId,d=a.genotype?.motherBreedId||a.motherBreedId;c&&d&&(b=C.calculateHybrid(c,d)||void 0)}if(!b){let c=(a.breed||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");b=C.getAllBreeds().find(a=>c.includes(a.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""))||c.includes(a.code.toLowerCase()))}return b||void 0})(m);J(E.calculateKPITargets({breed:m.breed||"Unknown",sex:m.sex||"Macho",weight:parseFloat(m.currentWeight||m.weight||400),ageMonths:(a=>{if(!a)return 0;let b=new Date(a),c=new Date;return(c.getFullYear()-b.getFullYear())*12+(c.getMonth()-b.getMonth())})(m.birth||m.birthDate),biological_type:a?.biological_type},o,y))}},[m,o,y]);let K=Array.from(new Map(i.filter(a=>a.crotal||a.id).map(a=>[a.crotal||a.id,a])).values()).filter(a=>{let b=z.toLowerCase();return(a.crotal||"").toLowerCase().includes(b)||(a.id||"").toLowerCase().includes(b)}).sort((a,b)=>(a.crotal||a.id||"").localeCompare(b.crotal||b.id||""));return(0,b.jsx)("div",{className:"h-full bg-gray-50 p-6 overflow-y-auto",children:(0,b.jsxs)("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[(0,b.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Seleccionar Animal"}),(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Crotal del Animal"}),(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)("input",{type:"text",placeholder:"Buscar Crotal (ej. 8196)",className:"w-full border rounded-lg px-3 py-2 text-sm text-gray-700 focus:ring-2 focus:ring-green-500 outline-none",value:z,onFocus:()=>{D(!0)},onChange:a=>{A(a.target.value),D(!0)},onBlur:()=>setTimeout(()=>D(!1),200)}),(0,b.jsx)("div",{className:"absolute right-3 top-2.5 pointer-events-none text-gray-400 text-xs",children:"‚ñº"})]}),B&&K.length>0&&(0,b.jsx)("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-xl max-h-64 overflow-y-auto",children:K.map(a=>(0,b.jsxs)("div",{className:"px-4 py-3 hover:bg-green-50 cursor-pointer border-b last:border-0 flex justify-between items-center",onMouseDown:()=>{let b=parseFloat(a.currentWeight||a.weight||0),c=w.filter(b=>(b.animalId===a.id||b.animalCrotal===a.crotal)&&"Pesaje"===b.type).sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime());if(c.length>0){let a=parseFloat(c[0].weight);a>0&&(b=a)}n({...a,currentWeight:b,weight:b}),A(a.crotal||a.id),D(!1)},children:[(0,b.jsxs)("div",{className:"flex flex-col",children:[(0,b.jsx)("span",{className:"font-bold text-gray-800",children:a.crotal?(a=>{if(!a)return null;let c=a.length;if(c<4)return(0,b.jsx)("span",{className:"font-bold text-gray-900",children:a});let d=a.substring(0,c-4),e=a.substring(c-4);return(0,b.jsxs)("span",{className:"font-mono tracking-tight",children:[(0,b.jsx)("span",{className:"text-gray-400 font-normal text-xs align-middle mr-0.5",children:d}),(0,b.jsx)("span",{className:"font-black text-lg text-gray-900 align-middle",children:e})]})})(a.crotal):a.id}),(0,b.jsxs)("span",{className:"text-[10px] text-gray-400 font-bold uppercase",children:[a.breed," ‚Ä¢ ",a.sex]})]}),(0,b.jsx)("span",{className:"bg-gray-100 px-2 py-0.5 rounded text-[10px] font-bold text-gray-500 uppercase",children:a.farm})]},a.id))})]}),m&&(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm bg-gray-50 p-3 rounded-lg border border-gray-100",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-gray-500",children:"Raza"}),(0,b.jsx)("p",{className:"font-bold text-gray-800",children:m.breed})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-gray-500",children:"Peso"}),(0,b.jsxs)("p",{className:"font-bold text-gray-800",children:[m.currentWeight||m.weight," kg"]})]})]})]})]}),(0,b.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[(0,b.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Objetivos"}),(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Objetivo"}),(0,b.jsxs)("select",{className:"w-full border rounded-lg px-3 py-2",value:o,onChange:a=>p(a.target.value),children:[(0,b.jsx)("option",{value:"Mantenimiento",children:"Mantenimiento"}),(0,b.jsx)("option",{value:"Recr√≠a (Crecimiento Moderado)",children:"Recr√≠a (Crecimiento Moderado)"}),(0,b.jsx)("option",{value:"Cebo (M√°ximo Crecimiento)",children:"Cebo (M√°ximo Crecimiento)"}),(0,b.jsx)("option",{value:"Engorde",children:"Engorde (Acabado)"}),(0,b.jsx)("option",{value:"Eficiencia Econ√≥mica",children:"Eficiencia Econ√≥mica (Min Coste)"})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Sistema Base"}),(0,b.jsxs)("select",{className:"w-full border rounded-lg px-3 py-2 mb-3",value:q,onChange:a=>r(a.target.value),children:[(0,b.jsx)("option",{value:"Extensivo (Pastoreo)",children:"Extensivo (Pastoreo)"}),(0,b.jsx)("option",{value:"Semi-Intensivo",children:"Semi-Intensivo"}),(0,b.jsx)("option",{value:"Cebo (Feedlot)",children:"Cebo (Feedlot)"})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase",children:"Modificadores"}),(0,b.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,b.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-gray-50 border border-transparent hover:border-gray-200 transition-colors",children:[(0,b.jsx)("input",{type:"checkbox",checked:s,onChange:a=>t(a.target.checked),className:"w-4 h-4 text-green-600 rounded focus:ring-green-500"}),(0,b.jsx)("span",{className:"text-sm text-gray-700",children:"Montanera (Bellota)"})]}),(0,b.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-gray-50 border border-transparent hover:border-gray-200 transition-colors",children:[(0,b.jsx)("input",{type:"checkbox",checked:u,onChange:a=>v(a.target.checked),className:"w-4 h-4 text-green-600 rounded focus:ring-green-500"}),(0,b.jsx)("span",{className:"text-sm text-gray-700",children:"Ecol√≥gico"})]})]})]})]})]})]})]}),(0,b.jsx)("div",{className:"lg:col-span-2 space-y-6",children:f?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[(0,b.jsxs)("div",{className:`p-4 rounded-xl shadow-sm border ${f.projectedGain>=(I?.adg||0)?"bg-green-50 border-green-200":"bg-white border-gray-100"}`,children:[(0,b.jsx)("p",{className:"text-gray-500 text-xs uppercase font-bold",children:"GMD Estimada"}),(0,b.jsxs)("p",{className:`text-3xl font-bold ${f.projectedGain>=(I?.adg||0)?"text-green-700":"text-gray-900"} mt-1`,children:[(f.projectedGain||0).toFixed(2)," ",(0,b.jsx)("span",{className:"text-sm text-gray-400",children:"kg/d"})]}),(0,b.jsxs)("div",{className:"mt-2 text-xs font-medium",children:[(0,b.jsxs)("span",{className:"text-gray-500",children:["Meta: ",I?.adg]}),(0,b.jsx)("span",{className:`block mt-1 ${f.projectedGain>=(I?.adg||0)?"text-green-600":"text-gray-900"}`,children:f.projectedGain>=(I?.adg||0)?"Objetivo Cumplido":"Bajo Rendimiento"})]})]}),(0,b.jsxs)("div",{className:"bg-white p-4 rounded-xl shadow-sm border border-gray-100",children:[(0,b.jsx)("p",{className:"text-gray-500 text-xs uppercase font-bold",children:"Ingesta (MS)"}),(0,b.jsxs)("p",{className:"text-3xl font-bold text-gray-900 mt-1",children:[(f.dmiTarget||0).toFixed(1)," ",(0,b.jsx)("span",{className:"text-sm text-gray-400",children:"kg"})]}),(0,b.jsx)("p",{className:"text-xs text-gray-400 mt-2",children:"Capacidad M√°x. (Est.)"})]}),(0,b.jsxs)("div",{className:`p-4 rounded-xl shadow-sm border ${Number(f.fcr)<=(I?.fcr||10)?"bg-green-50 border-green-200":"bg-white border-gray-100"}`,children:[(0,b.jsx)("p",{className:"text-gray-500 text-xs uppercase font-bold",children:"Eficiencia (FCR)"}),(0,b.jsx)("p",{className:`text-3xl font-bold ${Number(f.fcr)<=(I?.fcr||10)?"text-green-700":"text-gray-900"} mt-1`,children:Number(f.fcr||0).toFixed(2)}),(0,b.jsxs)("div",{className:"mt-2 text-xs font-medium",children:[(0,b.jsxs)("span",{className:"text-gray-500",children:["Meta: <",I?.fcr]}),(0,b.jsx)("span",{className:`block mt-1 ${Number(f.fcr)<=(I?.fcr||10)?"text-green-600":"text-gray-900"}`,children:Number(f.fcr)<=(I?.fcr||10)?"Excelente Conversi√≥n":"Mejorable"})]})]}),(0,b.jsxs)("div",{className:"bg-white p-4 rounded-xl shadow-sm border border-gray-100",children:[(0,b.jsx)("p",{className:"text-gray-500 text-xs uppercase font-bold",children:"Coste Diario"}),(0,b.jsxs)("p",{className:"text-3xl font-bold text-gray-900 mt-1",children:[Number(f.totalCost||0).toFixed(2)," ",(0,b.jsx)("span",{className:"text-sm text-gray-400",children:"‚Ç¨"})]})]})]}),(0,b.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[(0,b.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsx)("h3",{className:"text-lg font-bold text-gray-800",children:"Constructor de Dieta"}),(0,b.jsx)("button",{onClick:()=>{if(!m||!I)return;let a=parseFloat(m.weight)||400;G(E.generateSmartDiet(I,{weight:a},y,H).map(a=>{let b=H.find(b=>b.id===a.feed_id);if(!b)return null;let c=b.dm_percent||100;return{item:b,amount:parseFloat((a.dm_kg/(c/100)).toFixed(1))}}).filter(Boolean))},className:"text-xs bg-green-600 text-white px-3 py-1 rounded-full hover:bg-green-700 shadow-sm transition-colors font-bold flex items-center gap-1",children:"Generar Dieta"})]}),(0,b.jsx)("div",{className:"flex gap-2",children:(0,b.jsxs)("select",{className:"border rounded-lg px-2 py-1 text-sm max-w-xs",onChange:a=>{if(a.target.value){var b;let c;b=a.target.value,(c=H.find(a=>a.id===b))&&!F.find(a=>a.item.id===b)&&G([...F,{item:c,amount:1}]),a.target.value=""}},children:[(0,b.jsx)("option",{value:"",children:"+ A√±adir Alimento"}),(0,b.jsx)("optgroup",{label:"Forrajes",children:H.filter(a=>"Forraje"===a.category).map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))}),(0,b.jsx)("optgroup",{label:"Concentrados",children:H.filter(a=>"Concentrado"===a.category).map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))}),(0,b.jsx)("optgroup",{label:"Suplementos",children:H.filter(a=>"Suplemento"===a.category).map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))}),(0,b.jsx)("optgroup",{label:"Ecol√≥gicos",children:H.filter(a=>"Ecol√≥gico"===a.category).map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))})]})})]}),(0,b.jsx)("div",{className:"overflow-x-auto",children:(0,b.jsxs)("table",{className:"w-full text-left text-sm",children:[(0,b.jsx)("thead",{className:"bg-gray-50 text-gray-600",children:(0,b.jsxs)("tr",{children:[(0,b.jsx)("th",{className:"p-3",children:"Ingrediente"}),(0,b.jsx)("th",{className:"p-3 w-32",children:"Kg (Fresco)"}),(0,b.jsx)("th",{className:"p-3 w-24",children:"Kg (MS)"}),(0,b.jsx)("th",{className:"p-3 text-right",children:"Costo"}),(0,b.jsx)("th",{className:"p-3 w-10"})]})}),(0,b.jsx)("tbody",{className:"divide-y divide-gray-100",children:0===F.length?(0,b.jsx)("tr",{children:(0,b.jsx)("td",{colSpan:5,className:"p-4 text-center text-gray-400 italic",children:"No hay ingredientes."})}):F.map((a,c)=>(0,b.jsxs)("tr",{className:"group hover:bg-gray-50",children:[(0,b.jsxs)("td",{className:"p-3 font-medium flex items-center gap-2",children:[(0,b.jsx)("span",{className:`w-2 h-2 rounded-full ${"Forraje"===a.item.category?"bg-green-500":"bg-yellow-500"}`}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{children:a.item.name}),(0,b.jsxs)("p",{className:"text-xs text-gray-400",children:[a.item.energy_mcal," Mcal/kg ‚Ä¢ ",a.item.protein_percent,"% PB"]})]})]}),(0,b.jsx)("td",{className:"p-3",children:(0,b.jsx)("input",{type:"number",min:"0",step:"0.5",className:"w-full border rounded px-2 py-1 text-center font-bold focus:ring-1 focus:ring-green-500 outline-none",value:a.amount,onChange:b=>{var c,d;return c=a.item.id,d=parseFloat(b.target.value)||0,void G(F.map(a=>a.item.id===c?{...a,amount:d}:a))}})}),(0,b.jsx)("td",{className:"p-3 text-gray-500",children:(a.amount*(a.item.dm_percent/100)).toFixed(2)}),(0,b.jsxs)("td",{className:"p-3 text-right text-gray-600",children:[(a.amount*a.item.cost_per_kg).toFixed(2)," ‚Ç¨"]}),(0,b.jsx)("td",{className:"p-3 text-right",children:(0,b.jsx)("button",{onClick:()=>{var b;return b=a.item.id,void G(F.filter(a=>a.item.id!==b))},className:"text-gray-400 hover:text-red-500 transition-colors",children:"‚úï"})})]},c))}),(0,b.jsx)("tfoot",{className:"border-t font-bold bg-green-50",children:(0,b.jsxs)("tr",{children:[(0,b.jsx)("td",{className:"p-3 text-green-800",children:"TOTAL"}),(0,b.jsxs)("td",{className:"p-3 text-green-800",children:[(f.totalKg||0).toFixed(2)," kg"]}),(0,b.jsxs)("td",{className:"p-3 text-green-800",children:[(f.dmiActual||0).toFixed(2)," kg"]}),(0,b.jsxs)("td",{className:"p-3 text-right text-green-800",children:[(f.totalCost||0).toFixed(2)," ‚Ç¨"]}),(0,b.jsx)("td",{})]})})]})})]}),(0,b.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,b.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[(0,b.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4 flex items-center gap-2",children:"Balance Nutricional"}),(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsxs)("div",{className:"flex justify-between text-sm mb-1",children:[(0,b.jsx)("span",{className:"text-gray-600",children:"Energ√≠a (Mcal)"}),(0,b.jsxs)("span",{className:"font-bold",children:[(f.energyTarget||0).toFixed(1)," / Requerido"]})]}),(0,b.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,b.jsx)("div",{className:"bg-green-600 h-2 rounded-full",style:{width:"85%"}})})]}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("div",{className:"flex justify-between text-sm mb-1",children:[(0,b.jsx)("span",{className:"text-gray-600",children:"Prote√≠na (%)"}),(0,b.jsxs)("span",{className:"font-bold",children:[(f.proteinPercent||0).toFixed(1),"%"]})]}),(0,b.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,b.jsx)("div",{className:"bg-green-600 h-2 rounded-full",style:{width:`${Math.min(5*f.proteinPercent,100)}%`}})})]}),(0,b.jsxs)("div",{className:"mt-4 bg-gray-50 p-3 rounded-lg border border-gray-200",children:[(0,b.jsx)("p",{className:"text-xs font-bold text-gray-500 uppercase mb-1",children:"Factor Limitante"}),(0,b.jsx)("p",{className:"text-red-600 font-bold",children:f.carcass?.limitingFactor||"Energ√≠a"})]}),f.alerts&&f.alerts.length>0&&(0,b.jsx)("div",{className:"space-y-2 mt-4",children:f.alerts.map((a,c)=>(0,b.jsxs)("div",{className:`p-4 rounded-2xl text-xs transition-all hover:shadow-md ${"critical"===a.level?"bg-red-50 text-red-700":"bg-orange-50 text-orange-800"}`,children:[(0,b.jsx)("p",{className:"font-black uppercase mb-1 tracking-widest",children:{ACIDOSIS:"RIESGO ACIDOSIS",LOW_FIBER:"FIBRA BAJA",BLOAT:"METEORISMO",BELLOTA_FIBER:"FIBRA (MONTANERA)",BELLOTA_PROTEIN:"PROTE√çNA (MONTANERA)",BELLOTA_TOXICITY:"TANINOS (BELLOTA)",LOW_N_EFF:"D√âFICIT PROTEICO",HIGH_POLLUTION:"EXCESO NITR√ìGENO"}[a.code]||a.code.replace("_"," ")}),(0,b.jsx)("p",{className:"font-medium opacity-90",children:a.message}),a.action&&(0,b.jsxs)("div",{className:"mt-2 pt-2 border-t border-current border-opacity-10 flex items-start gap-1.5",children:[(0,b.jsx)("span",{className:"text-[10px]",children:"üí°"}),(0,b.jsx)("p",{className:"text-[10px] italic font-bold leading-tight",children:a.action})]})]},c))})]})]}),(0,b.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col gap-4",children:[(0,b.jsx)("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:"Finanzas y Calidad"}),(0,b.jsx)("div",{className:"mt-4",children:(0,b.jsxs)("div",{className:"flex flex-col gap-5",children:[(0,b.jsx)("div",{className:"bg-white border border-gray-100 rounded-[2.5rem] shadow-sm px-4 py-8",children:(0,b.jsxs)("div",{className:"grid grid-cols-4 gap-0 text-center items-end",children:[(0,b.jsxs)("div",{className:"border-r border-gray-100 h-10 flex flex-col justify-center px-1",children:[(0,b.jsx)("p",{className:"text-gray-400 text-[7px] font-black uppercase tracking-[0.2em] mb-1",children:"Clasificaci√≥n"}),(0,b.jsx)("span",{className:"text-4xl font-black text-gray-900 leading-none tracking-tighter",children:f.carcass?.conformation_est||"R"})]}),(0,b.jsxs)("div",{className:"border-r border-gray-100 h-10 flex flex-col justify-center px-1",children:[(0,b.jsx)("p",{className:"text-gray-400 text-[7px] font-black uppercase tracking-[0.2em] mb-1",children:"Infiltraci√≥n"}),(0,b.jsx)("span",{className:"text-4xl font-black text-gray-900 leading-none tracking-tighter",children:Math.round(f.carcass?.marbling_est||1)})]}),(0,b.jsxs)("div",{className:"border-r border-gray-100 h-10 flex flex-col justify-center px-1",children:[(0,b.jsx)("p",{className:"text-gray-400 text-[7px] font-black uppercase tracking-[0.2em] mb-1",children:"Kg Canal (Est.)"}),(0,b.jsxs)("div",{className:"flex items-baseline justify-center gap-0.5",children:[(0,b.jsx)("span",{className:"text-3xl font-black text-gray-900 leading-none tracking-tighter",children:f.carcass?.weight_est?.toFixed(0)||f.carcass?.rc_percent?((parseFloat(m.currentWeight||m.weight)+30*f.projectedGain)*(f.carcass.rc_percent/100)).toFixed(0):"0"}),(0,b.jsx)("span",{className:"text-xs font-black text-gray-400 uppercase",children:"kg"})]})]}),(0,b.jsxs)("div",{className:"h-10 flex flex-col justify-center px-1",children:[(0,b.jsx)("p",{className:"text-gray-400 text-[7px] font-black uppercase tracking-[0.2em] mb-1",children:"Rendimiento"}),(0,b.jsxs)("div",{className:"flex items-baseline justify-center gap-0.5",children:[(0,b.jsx)("span",{className:"text-3xl font-black text-gray-900 leading-none tracking-tighter",children:f.carcass?.rc_percent||0}),(0,b.jsx)("span",{className:"text-xs font-black text-gray-400 uppercase",children:"%"})]})]})]})}),(0,b.jsxs)("div",{className:"bg-gray-50/50 p-6 rounded-[2rem] border border-gray-100",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,b.jsx)("div",{className:"w-1.5 h-1.5 bg-green-500 rounded-full"}),(0,b.jsx)("p",{className:"text-gray-500 text-[9px] font-black uppercase tracking-widest",children:"Previsi√≥n ROI 30 D√≠as"})]}),(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("div",{className:"flex justify-between items-center group",children:[(0,b.jsxs)("span",{className:"text-gray-500 text-xs font-bold transition-colors group-hover:text-gray-900",children:["Venta Estimada (",f.financials?.category,")"]}),(0,b.jsxs)("div",{className:"flex flex-col items-end",children:[(0,b.jsxs)("span",{className:"font-black text-gray-900 text-base",children:[f.financials?.projectedSales?.toLocaleString()," ‚Ç¨"]}),(0,b.jsx)("span",{className:"text-[9px] text-green-600 font-bold uppercase tracking-tighter",children:"+ Ganancia Bruta"})]})]}),(0,b.jsxs)("div",{className:"flex justify-between items-center group",children:[(0,b.jsx)("span",{className:"text-gray-500 text-xs font-bold transition-colors group-hover:text-gray-900",children:"Costes Acumulados"}),(0,b.jsxs)("div",{className:"flex flex-col items-end",children:[(0,b.jsxs)("span",{className:"font-black text-gray-900 text-base",children:["-",f.financials?.totalCost?.toFixed(0)," ‚Ç¨"]}),(0,b.jsx)("span",{className:"text-[9px] text-red-600 font-bold uppercase tracking-tighter",children:"- Gastos Totales"})]})]}),(0,b.jsx)("div",{className:"pt-4 border-t border-gray-200",children:(0,b.jsxs)("div",{className:"bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-gray-400 text-[8px] font-black uppercase tracking-widest leading-none",children:"Margen Neto Proyectado"}),(0,b.jsx)("p",{className:"text-[9px] text-gray-400 font-medium mt-1",children:"* Resultados netos a 30 d√≠as"})]}),(0,b.jsx)("div",{className:"text-right",children:(0,b.jsxs)("span",{className:`text-3xl font-black tracking-tighter ${f.financials?.margin>0?"text-green-600":"text-red-500"}`,children:[f.financials?.margin?.toFixed(0)," ",(0,b.jsx)("span",{className:"text-base font-black ml-px",children:"‚Ç¨"})]})})]})})]})]})]})})]})]})]}):(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center h-full bg-white rounded-xl border-dashed border-2 border-gray-200 p-12 text-gray-400",children:[(0,b.jsx)("span",{className:"text-6xl mb-4",children:"üß¨"}),(0,b.jsx)("p",{className:"text-lg font-medium text-gray-500",children:"Simulador de Rendimiento"}),(0,b.jsx)("p",{className:"text-center text-sm max-w-xs mt-2",children:"Selecciona un animal para ver su potencial."})]})})]})})}let T={Sanitario:["Saneamiento","Tratamiento","Vacunaci√≥n","Desparasitaci√≥n","Consulta Vet"],Reproductivo:["Celo","Inseminaci√≥n","Diagn√≥stico Gestaci√≥n","Parto","Aborto","Secado"],Productivo:["Pesaje","Condici√≥n Corporal","Orde√±o (Pendiente)"],Movimientos:["Cambio de Corral","Entrada","Salida","Venta","Muerte/Sacrificio"]};function U(){let{read:a,write:d}=(0,e.useStorage)(),[f,g]=(0,c.useState)([]),[h,i]=(0,c.useState)(!0),[j,k]=(0,c.useState)(!1),[l,m]=(0,c.useState)({category:"Sanitario",type:"Saneamiento",date:new Date().toISOString().split("T")[0],formattedDate:new Date().toISOString().split("T")[0],notes:"",cost:"",relatedType:"none",relatedId:"",corral:"",price:"",weightLive:"",weightCarcass:"",yield:"",seuropConf:"",fatCover:""}),[n,o]=(0,c.useState)([]),[p,q]=(0,c.useState)([]),[r,s]=(0,c.useState)(""),[t,u]=(0,c.useState)([]);(0,c.useEffect)(()=>{let b=a("sessionUser","");if(s(b),b){let c=a("events",[]),d=a(`fincas_${b}`,[]),e=a(`animals_${b}`,[]);o(d),q(e);let f=[];e.forEach(a=>{let b=Q.getLifecycleAlerts({...a,birthDate:a.birth});b.length>0&&f.push(...b.map(b=>({...b,crotal:a.crotal,farm:a.farm})))}),u(f),g([...c].sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime())),i(!1)}},[a]);let v=async()=>{if(!l.notes&&!l.type)return void alert("A√±ade al menos una nota o tipo");let b={animals:a(`animals_${r}`,[]),events:a("events",[]),currentUser:r,storage:{read:a,write:d}},c={type:l.type||T[l.category][0],date:l.formattedDate,desc:(l.corral?`[Corral ${l.corral}] `:"")+l.notes,cost:Number(l.cost),animal:"animal"===l.relatedType?b.animals.find(a=>a.id===l.relatedId):{id:"farm"===l.relatedType?l.relatedId:"GENERAL",crotal:"farm"===l.relatedType?"FINCA":"GENERAL"},typeData:{price:l.price,liveWeight:l.weightLive,carcassWeight:l.weightCarcass,yield:l.yield,seuropConf:l.seuropConf,fatCover:l.fatCover}};if("farm"===l.relatedType){let a=n.find(a=>a.id===l.relatedId)?.name||"Finca";c.animal={id:l.relatedId,crotal:a,farmId:l.relatedId}}await F.handleStandardEvent(c,b),g([...a("events",[])].sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime())),k(!1),m({category:"Sanitario",type:"Saneamiento",date:new Date().toISOString().split("T")[0],formattedDate:new Date().toISOString().split("T")[0],notes:"",cost:"",relatedType:"none",relatedId:"",corral:"",price:"",weightLive:"",weightCarcass:"",yield:"",seuropConf:"",fatCover:""})};return(0,b.jsxs)("div",{className:"space-y-6",children:[t.length>0&&(0,b.jsxs)("div",{className:"bg-orange-50 border border-orange-100 rounded-xl p-4 animate-in slide-in-from-top-2",children:[(0,b.jsxs)("h3",{className:"text-orange-800 font-bold flex items-center gap-2 text-sm mb-3",children:[(0,b.jsx)("span",{className:"text-xl",children:"üîî"})," Alertas del Ciclo de Vida"]}),(0,b.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:t.map((a,c)=>(0,b.jsxs)("div",{className:"bg-white p-3 rounded-lg border border-orange-100 shadow-sm flex justify-between items-center text-sm",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("span",{className:"font-bold text-gray-800",children:a.desc}),(0,b.jsxs)("p",{className:"text-xs text-gray-500",children:["Animal: ",a.crotal," (",a.farm,")"]})]}),(0,b.jsx)("div",{className:"text-right",children:(0,b.jsx)("span",{className:`text-xs font-bold px-2 py-1 rounded ${a.isDue?"bg-red-100 text-red-700":"bg-gray-100 text-gray-600"}`,children:a.date})})]},c))})]}),(0,b.jsxs)("div",{className:"flex justify-between items-center",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h2",{className:"text-2xl font-bold text-gray-800",children:"Eventos"}),(0,b.jsx)("p",{className:"text-gray-600",children:"Registro hist√≥rico de acciones y sucesos"})]}),(0,b.jsxs)("button",{onClick:()=>k(!0),className:"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2",children:[(0,b.jsx)("span",{children:"+"})," Nuevo Evento"]})]}),j&&(0,b.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4",children:(0,b.jsxs)("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in-95 duration-200",children:[(0,b.jsxs)("div",{className:"bg-green-50 px-6 py-4 border-b border-green-100 flex justify-between items-center",children:[(0,b.jsx)("h3",{className:"font-bold text-green-900",children:"Registrar Evento"}),(0,b.jsx)("button",{onClick:()=>k(!1),className:"text-gray-400 hover:text-gray-600",children:"‚úï"})]}),(0,b.jsxs)("div",{className:"p-6 space-y-4",children:[(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Fecha"}),(0,b.jsx)("input",{type:"date",value:l.formattedDate,onChange:a=>m({...l,formattedDate:a.target.value}),className:"w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 outline-none"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Categor√≠a"}),(0,b.jsx)("select",{value:l.category,onChange:a=>{let b=a.target.value;m({...l,category:b,type:T[b][0]})},className:"w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 outline-none font-bold text-gray-700",children:Object.keys(T).map(a=>(0,b.jsx)("option",{value:a,children:a},a))})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Evento Espec√≠fico"}),(0,b.jsx)("select",{value:l.type,onChange:a=>m({...l,type:a.target.value}),className:"w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 outline-none bg-gray-50",children:T[l.category].map(a=>(0,b.jsx)("option",{value:a,children:a},a))})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Vinculaci√≥n (Opcional)"}),(0,b.jsxs)("div",{className:"flex gap-2 mb-2",children:[(0,b.jsx)("button",{onClick:()=>m({...l,relatedType:"none",relatedId:"",corral:""}),className:`flex-1 py-1 text-xs rounded border ${"none"===l.relatedType?"bg-gray-800 text-white border-gray-800":"bg-white text-gray-600 border-gray-200"}`,children:"General"}),(0,b.jsx)("button",{onClick:()=>m({...l,relatedType:"farm",relatedId:"",corral:""}),className:`flex-1 py-1 text-xs rounded border ${"farm"===l.relatedType?"bg-green-600 text-white border-green-600":"bg-white text-gray-600 border-gray-200"}`,children:"Finca"}),(0,b.jsx)("button",{onClick:()=>m({...l,relatedType:"animal",relatedId:"",corral:""}),className:`flex-1 py-1 text-xs rounded border ${"animal"===l.relatedType?"bg-orange-500 text-white border-orange-500":"bg-white text-gray-600 border-gray-200"}`,children:"Animal"})]}),"farm"===l.relatedType&&(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsxs)("select",{value:l.relatedId,onChange:a=>m({...l,relatedId:a.target.value,corral:""}),className:"w-full border rounded-lg px-3 py-2 text-sm flex-1",children:[(0,b.jsx)("option",{value:"",children:"Selecciona Finca..."}),n.map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))]}),l.relatedId&&(0,b.jsxs)("select",{value:l.corral,onChange:a=>m({...l,corral:a.target.value}),className:"w-32 border rounded-lg px-3 py-2 text-sm",children:[(0,b.jsx)("option",{value:"",children:"Corral..."}),Array.from({length:n.find(a=>a.id===l.relatedId)?.corrals||0},(a,b)=>b+1).map(a=>(0,b.jsxs)("option",{value:a,children:["Corral ",a]},a))]})]}),"animal"===l.relatedType&&(0,b.jsxs)("select",{value:l.relatedId,onChange:a=>m({...l,relatedId:a.target.value}),className:"w-full border rounded-lg px-3 py-2 text-sm",children:[(0,b.jsx)("option",{value:"",children:"Selecciona Animal..."}),p.map(a=>(0,b.jsxs)("option",{value:a.id,children:[a.crotal," (",a.breed||"?",")"]},a.id))]})]}),["Venta","Salida","Muerte/Sacrificio"].includes(l.type)&&(0,b.jsxs)("div",{className:"bg-red-50 border border-red-100 rounded-lg p-3 space-y-3",children:[(0,b.jsx)("h4",{className:"font-bold text-red-800 text-xs uppercase flex items-center gap-2",children:"ü•© Datos Comerciales / Canal"}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Importe Venta (‚Ç¨)"}),(0,b.jsx)("input",{type:"number",step:"0.01",className:"w-full border rounded px-2 py-1 text-sm field-focus",value:l.price,onChange:a=>m({...l,price:a.target.value})})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Peso Vivo (kg)"}),(0,b.jsx)("input",{type:"number",step:"0.1",className:"w-full border rounded px-2 py-1 text-sm field-focus",value:l.weightLive,onChange:a=>m({...l,weightLive:a.target.value})})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Peso Canal (kg)"}),(0,b.jsx)("input",{type:"number",step:"0.1",className:"w-full border rounded px-2 py-1 text-sm field-focus",value:l.weightCarcass,onChange:a=>{let b=Number(a.target.value),c=Number(l.weightLive),d=c>0?(b/c*100).toFixed(1):"";m({...l,weightCarcass:a.target.value,yield:d})}})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Rendimiento (%)"}),(0,b.jsx)("input",{type:"number",step:"0.1",className:"w-full border rounded px-2 py-1 text-sm field-focus bg-gray-100",value:l.yield,readOnly:!0})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Conf. (SEUROP)"}),(0,b.jsxs)("select",{className:"w-full border rounded px-2 py-1 text-sm field-focus",value:l.seuropConf,onChange:a=>m({...l,seuropConf:a.target.value}),children:[(0,b.jsx)("option",{value:"",children:"-"}),["S","E","U","R","O","P"].map(a=>(0,b.jsx)("option",{value:a,children:a},a))]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Grasa (1-5)"}),(0,b.jsxs)("select",{className:"w-full border rounded px-2 py-1 text-sm field-focus",value:l.fatCover,onChange:a=>m({...l,fatCover:a.target.value}),children:[(0,b.jsx)("option",{value:"",children:"-"}),["1","2","3","4","5"].map(a=>(0,b.jsx)("option",{value:a,children:a},a))]})]})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Descripci√≥n / Notas"}),(0,b.jsx)("textarea",{value:l.notes,onChange:a=>m({...l,notes:a.target.value}),className:"w-full border rounded-lg px-3 py-2 text-sm h-24 resize-none focus:ring-2 focus:ring-green-500 outline-none",placeholder:"Detalles del evento..."})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Coste (‚Ç¨) - Opcional"}),(0,b.jsx)("input",{type:"number",value:l.cost,onChange:a=>m({...l,cost:a.target.value}),className:"w-full border rounded-lg px-3 py-2 text-sm",placeholder:"0.00"})]})]}),(0,b.jsxs)("div",{className:"bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t",children:[(0,b.jsx)("button",{onClick:()=>k(!1),className:"text-gray-600 font-medium text-sm hover:text-gray-800",children:"Cancelar"}),(0,b.jsx)("button",{onClick:v,className:"bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg text-sm shadow-sm transition-transform active:scale-95",children:"Crear Evento"})]})]})}),(0,b.jsx)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden",children:(0,b.jsxs)("table",{className:"w-full text-left",children:[(0,b.jsx)("thead",{className:"bg-gray-50 text-gray-600 font-medium text-sm",children:(0,b.jsxs)("tr",{children:[(0,b.jsx)("th",{className:"p-4",children:"Fecha"}),(0,b.jsx)("th",{className:"p-4",children:"Tipo"}),(0,b.jsx)("th",{className:"p-4",children:"Animal / Finca"}),(0,b.jsx)("th",{className:"p-4",children:"Notas"}),(0,b.jsx)("th",{className:"p-4 text-right",children:"Costo"})]})}),(0,b.jsx)("tbody",{className:"divide-y divide-gray-100",children:h?(0,b.jsx)("tr",{children:(0,b.jsx)("td",{colSpan:5,className:"p-8 text-center text-gray-500",children:"Cargando eventos..."})}):0===f.length?(0,b.jsx)("tr",{children:(0,b.jsx)("td",{colSpan:5,className:"p-8 text-center text-gray-500",children:"No hay eventos recientes."})}):f.map((a,c)=>(0,b.jsxs)("tr",{className:"hover:bg-gray-50 transition-colors",children:[(0,b.jsx)("td",{className:"p-4 text-gray-900 font-medium",children:new Date(a.date).toLocaleDateString()}),(0,b.jsx)("td",{className:"p-4 text-gray-600",children:(0,b.jsx)("span",{className:`inline-block px-2 py-1 rounded text-xs font-bold
                                            ${"Sanitario"===a.type?"bg-red-50 text-red-700":"Alimentaci√≥n"===a.type?"bg-yellow-50 text-yellow-700":"Mantenimiento"===a.type?"bg-blue-50 text-blue-700":"bg-green-50 text-green-700"}`,children:a.type})}),(0,b.jsx)("td",{className:"p-4 text-gray-600 text-sm",children:a.animalCrotal?(0,b.jsx)("span",{className:"font-mono bg-gray-100 px-1 rounded",children:a.animalCrotal}):"-"}),(0,b.jsx)("td",{className:"p-4 text-gray-600 text-sm max-w-xs truncate",children:a.desc||a.notes||"-"}),(0,b.jsx)("td",{className:"p-4 text-gray-600 text-right font-medium",children:a.cost>0?Number(a.cost).toLocaleString("es-ES",{style:"currency",currency:"EUR"}):"-"})]},c))})]})})]})}function V(){let{read:a}=(0,e.useStorage)(),c=async()=>{try{let b=a("sessionUser",""),c=a(`animals_${b}`,[]);if(!c||0===c.length)return void alert("No hay animales registrados para generar el reporte.");let d="ID;Raza;Sexo;Peso (kg);Edad (meses);GMD Estimada (kg/d);Ingesta Objetivo (kg MS);Eficiencia (FCR);Costo Diario Est (‚Ç¨)\n";for(let a of c){let b=(new Date().getTime()-new Date(a.birth).getTime())/2630016e3,c=C.getBreedById(a.breed)||C.getBreedByName(a.breed)||C.getAllBreeds()[0],e="Macho"===a.sex||"Hembra"===a.sex||"Castrado"===a.sex?a.sex:"Macho",f=E.calculateRequirements(a.weight,1.2,b,"Cebo",e),g={totalEnergyMcal:f?10*f.em_mcal:15,totalProteinG:1200,dmiKg:10},h=g.totalEnergyMcal/g.dmiKg,i=E.predictPerformance(c,h,g.dmiKg,a.weight),j=g.dmiKg/.9*.15,k=i>0?(g.dmiKg/i).toFixed(2):"N/A";d+=`${a.id};${a.breed};${a.sex};${a.weight};${b.toFixed(1)};${i.toFixed(2)};${g.dmiKg.toFixed(2)};${k};${j.toFixed(2)}
`}let e=new Blob([d],{type:"text/csv;charset=utf-8;"}),f=URL.createObjectURL(e),g=document.createElement("a");g.setAttribute("href",f),g.setAttribute("download",`reporte_rendimiento_fcr_${new Date().toISOString().slice(0,10)}.csv`),g.style.visibility="hidden",document.body.appendChild(g),g.click(),document.body.removeChild(g)}catch(a){console.error("Error generating report:",a),alert("Error al generar el reporte. Ver consola para detalles.")}};return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h2",{className:"text-2xl font-bold text-gray-800",children:"Reportes"}),(0,b.jsx)("p",{className:"text-gray-600",children:"Generaci√≥n de informes y estad√≠sticas"})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,b.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:border-green-200 transition-colors cursor-pointer group",children:[(0,b.jsx)("span",{className:"text-3xl mb-4 block group-hover:scale-110 transition-transform",children:"üìä"}),(0,b.jsx)("h3",{className:"font-bold text-lg text-gray-800 mb-2",children:"Informe Econ√≥mico"}),(0,b.jsx)("p",{className:"text-gray-500 text-sm",children:"Resumen de gastos, ingresos estimados y valor de inventario."})]}),(0,b.jsxs)("div",{onClick:c,className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:border-green-200 transition-colors cursor-pointer group",children:[(0,b.jsx)("span",{className:"text-3xl mb-4 block group-hover:scale-110 transition-transform",children:"üìà"}),(0,b.jsx)("h3",{className:"font-bold text-lg text-gray-800 mb-2",children:"Informe de Rendimiento (FCR)"}),(0,b.jsx)("p",{className:"text-gray-500 text-sm",children:"Descargar CSV con evoluci√≥n de peso, GMD y eficiencia alimentaria."})]}),(0,b.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:border-green-200 transition-colors cursor-pointer group",children:[(0,b.jsx)("span",{className:"text-3xl mb-4 block group-hover:scale-110 transition-transform",children:"üß¨"}),(0,b.jsx)("h3",{className:"font-bold text-lg text-gray-800 mb-2",children:"Informe Reproductivo"}),(0,b.jsx)("p",{className:"text-gray-500 text-sm",children:"Tasas de fertilidad, partos y saneamiento."})]})]})]})}let W=j("shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]]),X=j("briefcase",[["path",{d:"M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16",key:"jecpp"}],["rect",{width:"20",height:"14",x:"2",y:"6",rx:"2",key:"i6l2r4"}]]),Y=j("phone",[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]]),Z=j("credit-card",[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]]),$=j("trash-2",[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]]),_=j("pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]),aa=j("search",[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]]),ab=j("plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]),ac=j("save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),ad=j("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]);function ae(){let{read:a,write:d}=(0,e.useStorage)(),f=a("users",[]),g=a("sessionUser",""),[h,i]=(0,c.useState)(""),[j,k]=(0,c.useState)(null),[l,m]=(0,c.useState)(!1),[o,p]=(0,c.useState)({role:"worker",jobTitle:"Pe√≥n Ganadero"}),q=f.filter(a=>a.name.toLowerCase().includes(h.toLowerCase())||a.firstName?.toLowerCase().includes(h.toLowerCase())||a.lastName?.toLowerCase().includes(h.toLowerCase()));return(0,b.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,b.jsxs)("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsxs)("h2",{className:"text-2xl font-bold text-gray-800 flex items-center gap-2",children:[(0,b.jsx)(W,{className:"w-8 h-8 text-green-600"}),"Gesti√≥n de Equipo"]}),(0,b.jsx)("p",{className:"text-gray-500",children:"Administra los perfiles y permisos del personal"})]}),(0,b.jsxs)("button",{onClick:()=>{k(null),m(!0),p({role:"worker",jobTitle:"Pe√≥n Ganadero",pass:"123456"})},className:"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 shadow-sm transition-all hover:shadow-md",children:[(0,b.jsx)(ab,{className:"w-4 h-4"}),"Nuevo Empleado"]})]}),(0,b.jsxs)("div",{className:"bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3",children:[(0,b.jsx)(aa,{className:"w-5 h-5 text-gray-400"}),(0,b.jsx)("input",{type:"text",placeholder:"Buscar por nombre, usuario o DNI...",value:h,onChange:a=>i(a.target.value),className:"flex-1 outline-none text-gray-700 placeholder-gray-400"})]}),(l||j)&&(0,b.jsxs)("div",{className:"bg-white rounded-xl shadow-lg border border-green-100 overflow-hidden",children:[(0,b.jsxs)("div",{className:"bg-green-50 px-6 py-4 border-b border-green-100 flex justify-between items-center",children:[(0,b.jsxs)("h3",{className:"font-bold text-green-800 flex items-center gap-2",children:[l?(0,b.jsx)(ab,{className:"w-5 h-5"}):(0,b.jsx)(_,{className:"w-5 h-5"}),l?"Alta de Empleado":`Editando: ${j?.name}`]}),(0,b.jsx)("button",{onClick:()=>{m(!1),k(null)},className:"text-gray-400 hover:text-gray-600",children:(0,b.jsx)(ad,{className:"w-5 h-5"})})]}),(0,b.jsxs)("div",{className:"p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsx)("h4",{className:"text-xs font-bold text-gray-400 uppercase tracking-wider border-b pb-1",children:"Cuenta"}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Usuario (Login)"}),(0,b.jsx)("input",{disabled:!l,value:o.name||"",onChange:a=>p({...o,name:a.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none disabled:bg-gray-100"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Contrase√±a"}),(0,b.jsx)("input",{type:"password",value:o.pass||"",onChange:a=>p({...o,pass:a.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rol de Acceso"}),(0,b.jsxs)("select",{value:o.role||"worker",onChange:a=>p({...o,role:a.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none bg-white",children:[(0,b.jsx)("option",{value:"worker",children:"Trabajador (B√°sico)"}),(0,b.jsx)("option",{value:"vet",children:"Veterinario (Sanitario)"}),(0,b.jsx)("option",{value:"admin",children:"Administrador (Total)"})]})]})]}),(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsx)("h4",{className:"text-xs font-bold text-gray-400 uppercase tracking-wider border-b pb-1",children:"Datos Personales"}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre"}),(0,b.jsx)("input",{value:o.firstName||"",onChange:a=>p({...o,firstName:a.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Apellidos"}),(0,b.jsx)("input",{value:o.lastName||"",onChange:a=>p({...o,lastName:a.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none"})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"DNI / NIE"}),(0,b.jsx)("input",{value:o.dni||"",onChange:a=>p({...o,dni:a.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"F. Nacimiento"}),(0,b.jsx)("input",{type:"date",value:o.dob||"",onChange:a=>p({...o,dob:a.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none"})]})]})]}),(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsx)("h4",{className:"text-xs font-bold text-gray-400 uppercase tracking-wider border-b pb-1",children:"Fitcha T√©cnica"}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Puesto / Cargo"}),(0,b.jsx)("input",{value:o.jobTitle||"",onChange:a=>p({...o,jobTitle:a.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none",placeholder:"Ej: Tractorista, Veterinario Jefe..."})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tel√©fono Contacto"}),(0,b.jsx)("input",{value:o.phone||"",onChange:a=>p({...o,phone:a.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none"})]})]})]}),(0,b.jsxs)("div",{className:"px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100",children:[(0,b.jsx)("button",{onClick:()=>{m(!1),k(null)},className:"px-4 py-2 text-gray-600 font-medium hover:text-gray-800",children:"Cancelar"}),(0,b.jsxs)("button",{onClick:()=>{if(!o.name||!o.pass)return alert("Usuario y Contrase√±a son obligatorios");let a=[...f];if(l){if(f.find(a=>a.name===o.name))return alert("El usuario ya existe");a.push({...o,joined:new Date().toISOString()})}else j&&(a=a.map(a=>a.name===j.name?{...a,...o}:a));d("users",a),k(null),m(!1),p({role:"worker",jobTitle:"Pe√≥n Ganadero"})},className:"bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2 shadow-sm transition-all",children:[(0,b.jsx)(ac,{className:"w-4 h-4"}),"Guardar Ficha"]})]})]}),(0,b.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:q.map((a,c)=>(0,b.jsxs)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow group",children:[(0,b.jsxs)("div",{className:"p-6",children:[(0,b.jsxs)("div",{className:"flex justify-between items-start mb-4",children:[(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsx)("div",{className:`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-sm
                                        ${"admin"===a.role?"bg-purple-600":"vet"===a.role?"bg-blue-500":"bg-green-600"}
                                    `,children:a.firstName?a.firstName.charAt(0):a.name.charAt(0)}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("h3",{className:"font-bold text-gray-900",children:[a.firstName," ",a.lastName]}),(0,b.jsxs)("p",{className:"text-xs text-gray-500",children:["@",a.name]})]})]}),(0,b.jsx)("span",{className:`px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border
                                    ${"admin"===a.role?"bg-purple-50 text-purple-700 border-purple-100":"vet"===a.role?"bg-blue-50 text-blue-700 border-blue-100":"bg-gray-50 text-gray-600 border-gray-200"}
                                `,children:"admin"===a.role?"ADMIN":"vet"===a.role?"VETERINARIO":"TRABAJADOR"})]}),(0,b.jsxs)("div",{className:"space-y-2 text-sm text-gray-600 mt-4",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(X,{className:"w-4 h-4 text-gray-400"}),(0,b.jsx)("span",{children:a.jobTitle||"Sin puesto definido"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(Z,{className:"w-4 h-4 text-gray-400"}),(0,b.jsx)("span",{children:a.dni||"Sin DNI"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(Y,{className:"w-4 h-4 text-gray-400"}),(0,b.jsx)("span",{children:a.phone||"Sin Tel√©fono"})]}),a.dob&&(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(n,{className:"w-4 h-4 text-gray-400"}),(0,b.jsxs)("span",{children:[new Date(a.dob).toLocaleDateString()," (",new Date().getFullYear()-new Date(a.dob).getFullYear()," a√±os)"]})]})]})]}),(0,b.jsxs)("div",{className:"px-6 py-3 bg-gray-50 border-t border-gray-100 flex justify-between items-center opacity-0 group-hover:opacity-100 transition-opacity",children:[(0,b.jsxs)("button",{onClick:()=>{k(a),m(!1),p({...a})},className:"text-green-600 font-medium text-xs hover:underline flex items-center gap-1",children:[(0,b.jsx)(_,{className:"w-3 h-3"})," Editar Ficha"]}),a.name!==g&&(0,b.jsxs)("button",{onClick:()=>(a=>{if(a===g)return alert("No puedes eliminar tu propio usuario");confirm(`\xbfEliminar usuario ${a}?`)&&d("users",f.filter(b=>b.name!==a))})(a.name),className:"text-red-600 font-medium text-xs hover:underline flex items-center gap-1",children:[(0,b.jsx)($,{className:"w-3 h-3"})," Eliminar"]})]})]},c))})]})}function af(){let{read:a,write:d}=(0,e.useStorage)(),f=a("sessionUser","Usuario"),[g,h]=c.default.useState(null);c.default.useEffect(()=>{let b=a("userAvatar",null);b&&h(b)},[a]);let i=a("users",[]).find(a=>a.name===f),j=f?.toLowerCase().includes("gerencia")||"gerencia@sotodelprior.com"===f,k=i?.role==="admin"||j,l=k?"admin":i?.role||"worker",[m,n]=c.default.useState(""),[o,p]=c.default.useState(""),[q,r]=c.default.useState("worker"),[s,t]=c.default.useState(!1);return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsx)("h1",{className:"text-2xl font-bold text-gray-800",children:"Mi Perfil"}),(0,b.jsxs)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 md:p-8",children:[(0,b.jsxs)("div",{className:"flex flex-col md:flex-row items-center gap-6",children:[(0,b.jsxs)("div",{className:"relative group cursor-pointer",children:[(0,b.jsx)("input",{type:"file",accept:"image/*",className:"hidden",id:"avatar-upload",onChange:a=>{let b=a.target.files?.[0];if(b){let a=new FileReader;a.onloadend=()=>{let b=a.result;h(b),d("userAvatar",b)},a.readAsDataURL(b)}}}),(0,b.jsxs)("label",{htmlFor:"avatar-upload",className:"cursor-pointer block",children:[g?(0,b.jsx)("img",{src:g,alt:"Profile",className:"w-24 h-24 rounded-full object-cover shadow-md group-hover:opacity-75 transition-opacity"}):(0,b.jsx)("div",{className:"w-24 h-24 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-4xl shadow-md group-hover:bg-green-700 transition-colors",children:f.charAt(0).toUpperCase()}),(0,b.jsx)("div",{className:"absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/30 rounded-full text-white text-xs font-bold pointer-events-none",children:"CAMBIAR"})]})]}),(0,b.jsxs)("div",{className:"text-center md:text-left space-y-2",children:[(0,b.jsx)("h2",{className:"text-xl font-bold text-gray-900",children:f}),(0,b.jsx)("span",{className:`inline-block text-xs px-2 py-1 rounded-full font-medium ${k?"bg-purple-100 text-purple-800":"bg-gray-100 text-gray-800"}`,children:"admin"===l?"Administrador":"vet"===l?"Veterinario":"Trabajador"}),(0,b.jsx)("p",{className:"text-sm text-gray-500 max-w-md",children:k?"Cuenta administrativa con acceso completo a la gesti√≥n de fincas, inventario animal, finanzas y equipo.":"Cuenta de usuario con permisos limitados seg√∫n su rol asignado."})]})]}),(0,b.jsxs)("div",{className:"mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-6",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-semibold text-gray-500 uppercase mb-1",children:"Email / Usuario"}),(0,b.jsx)("p",{className:"text-gray-900 font-medium",children:f})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-semibold text-gray-500 uppercase mb-1",children:"Rol"}),(0,b.jsx)("p",{className:"text-gray-900 font-medium capitalize",children:"admin"===l?"Administrador":"vet"===l?"Veterinario":"Trabajador"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-xs font-semibold text-gray-500 uppercase mb-1",children:"Empresa"}),(0,b.jsx)("p",{className:"text-gray-900 font-medium",children:"SOTO DEL PRIOR"})]})]})]})]})}function ag(){let{read:a,write:b,isLoaded:d}=(0,e.useStorage)(),f=(0,c.useRef)(!1);return(0,c.useEffect)(()=>{if(!d)return;let c=a("appSession","")||a("sessionUser","");if(!c)return;let e=`animals_${c}`,g=`fincas_${c}`,h=a(e,[]),i=a("events",[]),j=a(g,[]),k=!1;0===j.length&&(j.push({id:"finca-default-001",name:"SOTO del PRIOR",municipio:"Belv√≠s de la Jara",municipioCode:"020",provinciaCode:"45",poligono:"1",parcela:"1",superficie:153940,recintos:[],coords:{lat:39.7589,lng:-4.7634},license:"ES450200000001",maxHeads:90,soilId:"franco_arenoso",corrals:4,feedingSystem:"extensivo"}),k=!0);let l=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:3&b|8).toString(16)}),m=new Set(h.filter(a=>"Buey"===a.category||"Castrado"===a.sex||a.name&&a.name.toLowerCase().includes("buey")).map(a=>a.id)),n=h.some(a=>"SOTO del PRIOR"!==a.farm||a.name&&a.name.toLowerCase().includes("buey")&&"Buey"!==a.category||("Semental"===a.category||"Macho"===a.sex&&"Toro"===a.category&&!a.name.toLowerCase().includes("buey"))&&("Limousin"!==a.breed||a.name.includes("TORO_CHA"))||a.isGhost&&"Cruzada"===a.breed&&a.fatherId||a.fatherId&&m.has(a.fatherId)||i.some(a=>a.desc&&(a.desc.includes("TORO_CHA")||a.desc.includes("Charolais"))));h.length>0&&i.length;let o="true"===a("isSeeded_V10","false"),p=h.filter(a=>a.isGhost).length,q=h.length,r=q>100&&p>.8*q;if((!o||r)&&!k){console.log("Starting Data Enrichment & Reparation Engine V3 (Weight Recalc)..."),n&&(console.log("Bad data detected - Wiping events for fresh regeneration."),i=[]);let a=[...i];r&&(console.warn("CRITICAL: Massive duplication detected. Purging ghosts immediately."),console.log("Purge Result: Reduced animals to "+(h=[...h.filter(a=>!a.isGhost),...h.filter(a=>a.isGhost).slice(-20)]).length),b("events",i=i.slice(-500)),b("isSeeded_V5","true"));let c=new Set;h.forEach(a=>{("Buey"===a.category||"Castrado"===a.sex||a.name&&a.name.toLowerCase().includes("buey"))&&c.add(a.id)}),h.forEach(a=>{a.farm="SOTO del PRIOR",a.farmId="F0SOTO",(a.name&&a.name.toLowerCase().includes("buey")||a.type&&a.type.toLowerCase().includes("buey")||a.observation&&a.observation.toLowerCase().includes("buey"))&&(a.category="Buey",a.sex="Castrado",c.add(a.id)),("Semental"===a.category||"Macho"===a.sex&&"Toro"===a.category)&&"Buey"!==a.category&&"Castrado"!==a.sex&&(a.breed="Limousin",a.name&&a.name.includes("TORO_CHA")&&(a.name=a.name.replace("TORO_CHA","TORO_LIM"))),a.fatherId&&c.has(a.fatherId)&&(console.log(`Clearing invalid paternity: ${a.id} had Ox father ${a.fatherId}`),a.fatherId=null,a.father=null),a.breed&&(a.breed.includes("F1 F1")||a.breed.match(/F1.*F1/))&&(a.breed=a.breed.replace(/F1 F1/g,"F2").replace(/F1.*F1/g,"F2"))});let d=h.find(a=>("Semental"===a.category||"Macho"===a.sex&&"Toro"===a.category)&&"Buey"!==a.category&&"Castrado"!==a.sex);d||(d=h.find(a=>"Macho"===a.sex&&"Buey"!==a.category&&"Castrado"!==a.sex&&new Date().getFullYear()-new Date(a.birthDate||a.birth).getFullYear()>2));let e=d?d.id:"unknown_bull",f=d?d.crotal||d.name:"Toro Externo";console.log(`Sire identified: ${f}`);let g=()=>{let a=Math.floor(1e10*Math.random()).toString().padStart(10,"0");return`ES08${a}`};h.filter(a=>("Vaca"===a.category||"Vaca Nodriza"===a.category||"Hembra"===a.sex)&&new Date().getTime()-new Date(a.birthDate||a.birth).getTime()>63072e6).forEach(b=>{let c=new Date(new Date(b.birthDate||b.birth));c.setMonth(c.getMonth()+24);let d=new Date,i=1;for(;c<d;){let j=new Date(c);a.push({id:l(),type:"Monta Natural",animalId:b.id,animalCrotal:b.crotal,date:j.toISOString().split("T")[0],desc:`Monta Natural con ${f} (Ciclo ${i})`,typeData:{bullId:e},status:"completed"});let m=new Date(j);if(m.setDate(m.getDate()+283),m>d){a.push({id:l(),type:"Parto Previsto",animalId:b.id,animalCrotal:b.crotal,date:m.toISOString().split("T")[0],desc:`Parto estimado (Ciclo ${i})`,status:"scheduled"});break}let n=h.find(a=>a.id!==e&&45>=Math.ceil(Math.abs(new Date(a.birthDate||a.birth).getTime()-m.getTime())/864e5)&&!a.motherId);if(n)n.motherId=b.id,n.fatherId=e,n.father=f,a.push({id:l(),type:"Parto",animalId:b.id,animalCrotal:b.crotal,date:m.toISOString().split("T")[0],desc:`Parto ${i}: ${n.sex} (${n.crotal}) - ACTIVO`,typeData:{calfId:n.id,calfCrotal:n.crotal},status:"completed"}),a.some(a=>a.animalId===n.id&&"Nacimiento"===a.type)||a.push({id:l(),type:"Nacimiento",animalId:n.id,animalCrotal:n.crotal,date:n.birthDate||m.toISOString().split("T")[0],desc:`Nacimiento en finca. Madre: ${b.crotal}, Padre: ${f}`,status:"completed"});else{let c=Math.random()>.5,j=g(),n=Math.random()>.3?"Sacrificado":"Vendido",o="Sacrificado"===n?14:6,p=new Date(m);p.setMonth(p.getMonth()+o),p>d&&p.setTime(d.getTime()-864e6);let q=d.getTime()-p.getTime()<31104e6,r={};if("Sacrificado"===n){let a=280+100*Math.random();r={carcassWeight:a.toFixed(1),price:(5.2*a).toFixed(2),pricePerKg:5.2,conf:["U","R","O"][Math.floor(3*Math.random())],fat:["2","3","4"][Math.floor(3*Math.random())]}}if(q){let a={id:j,crotal:j,name:`(H) ${c?"Novilla":"Ternero"} ${i}`,farm:b.farm||"SOTO del PRIOR",breed:"Limousin"===b.breed||"Limousina"===b.breed?"Limousin":b.breed&&b.breed.includes("F1")?`F2 ${b.breed.replace("F1","").trim()} x Limousin`:`F1 ${b.breed||"Cruzada"} x Limousin`,sex:c?"Hembra":"Macho",birthDate:m.toISOString().split("T")[0],motherId:b.id,fatherId:e,father:f,status:n,exitDate:p.toISOString().split("T")[0],...r,isGhost:!0};h.push(a),k=!0}a.push({id:l(),type:"Parto",animalId:b.id,animalCrotal:b.crotal,date:m.toISOString().split("T")[0],desc:`Parto ${i}: ${c?"Hembra":"Macho"} (${j}) - ${n} ${!q?"(Hist√≥rico)":""}`,typeData:{calfCrotal:j},status:"completed"})}c.setMonth(c.getMonth()+13),i++}}),console.log("Bio-Simulation Complete.");let j=new Set,m=[];for(let a of i.reverse())j.has(a.id)||(j.add(a.id),m.push(a));i.length=0,i.push(...m.reverse()),k=!0,console.log("Enrichment Complete. Generated events:",i.length)}h.forEach(a=>{"Finca Soto del Prior"===a.farm&&(a.farm="SOTO del PRIOR",k=!0)}),k&&(b(e,h),b("events",i));let s=!1;j.forEach(a=>{"Finca Soto del Prior"===a.name&&(a.name="SOTO del PRIOR",s=!0)});let t=new Map;h.forEach(a=>{t.set(a.id,a)});let u=new Map;Array.from(t.values()).forEach(a=>{let b=(a.name||"unknown").trim().toUpperCase();u.has(b)?!u.get(b).crotal&&a.crotal&&u.set(b,a):u.set(b,a)});let v=Array.from(t.values()).filter(a=>{let b=(a.name||"").toUpperCase();return!(b.includes("BUEY")||b.includes("TORO")||b.includes("VACA"))||u.get(b).id===a.id}),w=!1,x=["Sacrificio","Muerte","Venta","Salida"],y=v.map(a=>{let b=a.crotal&&a.crotal.startsWith("ES099"),c=a.id&&a.id.startsWith("ES")&&a.id.length>10;if(!a.crotal||b&&c){if(c)a.crotal=a.id;else if(!a.crotal){(a.id.split("").reduce((a,b)=>a+b.charCodeAt(0),0)%1e4).toString().padStart(4,"0");let b=Math.floor(9e3*Math.random())+1e3;a.crotal=`ES099000${b}`}}let d=i.filter(b=>b.animalId===a.id).find(a=>x.includes(a.type));if(d&&new Date(d.date)<=new Date){let b=a.status;d.type.includes("Sacrificio")?a.status="Sacrificado":"Muerte"===d.type?a.status="Muerto":"Venta"===d.type&&(a.status="Vendido"),a.status!==b&&(w=!0),a.exitDate||(a.exitDate=d.date)}return a}),z=new Date().getTime(),A=y.filter(a=>!a.isGhost||"Activo"===a.status||z-new Date(a.exitDate||a.date||a.createdAt).getTime()<31536e6);if(A.forEach(a=>{a.monthlyRecords&&a.monthlyRecords.length>12&&(a.monthlyRecords=a.monthlyRecords.slice(-12))}),y.length!==A.length&&(console.log(`Pruned ${y.length-A.length} old ghost animals to save space.`),k=!0),y.length!==h.length&&(console.log(`Removed ${h.length-y.length} duplicates.`),k=!0),y.filter(a=>a.isGhost).length>200){console.warn("Detected Ghost Explosion. Purging ALL ghosts for safety reset.");let a=y.filter(a=>!a.isGhost);y.length=0,y.push(...a),k=!0}(k||s||w)&&(b("isSeeded_V10","true"),b(e,A),b(g,j),i.length>1e3&&(i=i.slice(-1e3),console.warn("Truncating events to last 1000 to prevent overflow.")),b("events",i),console.log("Advanced Data Seeding & Migration Completed")),f.current=!0},[d,a,b]),null}let ah=j("download",[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]]),ai=j("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]]),aj=j("circle-alert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);function ak(){let[a,d]=(0,c.useState)(new Date().toLocaleDateString());return(0,b.jsxs)("div",{className:"p-6 bg-gray-50 min-h-full space-y-6",children:[(0,b.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,b.jsx)(q,{className:"w-8 h-8 text-green-600"}),(0,b.jsx)("h1",{className:"text-2xl font-bold text-gray-800",children:"Gesti√≥n de Datos"})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,b.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[(0,b.jsxs)("div",{className:"flex justify-between items-start mb-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h3",{className:"text-lg font-bold text-gray-800",children:"Precios de Referencia (SEUROP)"}),(0,b.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:"Actualice las tablas de precios oficiales para el c√°lculo de rentabilidad."})]}),(0,b.jsx)("span",{className:"bg-green-100 text-green-700 text-[10px] px-2 py-1 rounded-full font-bold uppercase",children:"Activo"})]}),(0,b.jsx)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6",children:(0,b.jsxs)("div",{className:"flex justify-between items-center text-sm",children:[(0,b.jsx)("span",{className:"text-gray-600",children:"√öltima actualizaci√≥n:"}),(0,b.jsx)("span",{className:"font-bold text-gray-800",children:a})]})}),(0,b.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,b.jsxs)("label",{className:"w-full h-32 border-2 border-dashed border-gray-200 rounded-xl flex flex-col items-center justify-center gap-2 hover:border-green-500 hover:bg-green-50 cursor-pointer transition-all group",children:[(0,b.jsx)(ai,{className:"w-8 h-8 text-gray-400 group-hover:text-green-600"}),(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)("p",{className:"text-sm font-bold text-gray-700",children:"Actualizar Tarifas (CSV)"}),(0,b.jsx)("p",{className:"text-xs text-gray-400",children:"Arrastre o haga clic para subir"})]}),(0,b.jsx)("input",{type:"file",accept:".csv",className:"hidden",onChange:a=>{let b=a.target.files?.[0];if(!b)return;let c=new FileReader;c.onload=a=>{let b=a.target?.result;if(b)try{let a=R.importPricesFromCSV(b);alert(`\xc9xito: Se han actualizado ${a} registros de precios SEUROP.`),d(new Date().toLocaleDateString())}catch(a){console.error("Error importing CSV:",a),alert("Error al procesar el archivo CSV. Verifique el formato.")}},c.readAsText(b)}})]}),(0,b.jsxs)("div",{className:"flex items-start gap-2 p-3 bg-amber-50 rounded-lg border border-amber-100 text-xs text-amber-800",children:[(0,b.jsx)(aj,{className:"w-4 h-4 shrink-0 mt-0.5"}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Nota:"})," El CSV debe seguir el formato est√°ndar MAPA para categor√≠as y clasificaciones SEUROP."]})]})]})]}),(0,b.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 opacity-60",children:[(0,b.jsx)("h3",{className:"text-lg font-bold text-gray-400 mb-2",children:"Exportaci√≥n de Datos"}),(0,b.jsx)("p",{className:"text-sm text-gray-400 mb-6",children:"Pr√≥ximamente: Exporte su inventario y registros en formato Excel o PDF."}),(0,b.jsxs)("button",{disabled:!0,className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-gray-100 text-gray-400 rounded-lg cursor-not-allowed font-bold uppercase text-xs",children:[(0,b.jsx)(ah,{className:"w-4 h-4"}),"Descargar Backup"]})]})]})]})}function al({session:a}){let{write:f,isLoaded:g}=(0,e.useStorage)(),[h,i]=(0,c.useState)("home"),j=a?.user?.name||a?.user?.email||null;(0,c.useEffect)(()=>{j&&g&&(f("appSession",j),f("sessionUser",j))},[j,g,f]);let k=async()=>{f("appSession",null),await (0,d.signOut)({callbackUrl:"/login"})};return g?(0,b.jsxs)(v,{activeTab:h,onTabChange:i,onLogout:k,children:[(0,b.jsx)(ag,{}),"home"===h&&(0,b.jsx)(G,{onNavigate:i}),"farms"===h&&(0,b.jsx)(L,{}),"animals"===h&&(0,b.jsx)(P,{}),"events"===h&&(0,b.jsx)(U,{}),"calculator"===h&&(0,b.jsx)(S,{}),"reports"===h&&(0,b.jsx)(V,{}),"users"===h&&(0,b.jsx)(ae,{}),"profile"===h&&(0,b.jsx)(af,{}),"data"===h&&(0,b.jsx)(ak,{})]}):(0,b.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-gray-50",children:(0,b.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})})}a.s(["LivestockApp",()=>al],33770)}];

//# sourceMappingURL=apps_web_components_LivestockApp_tsx_fca22e2b._.js.map