(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,81979,e=>{"use strict";var a=e.i(43476),t=e.i(71645),r=e.i(26732),s=e.i(95107);let l=e=>{let a=e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,a,t)=>t?t.toUpperCase():a.toLowerCase());return a.charAt(0).toUpperCase()+a.slice(1)},i=(...e)=>e.filter((e,a,t)=>!!e&&""!==e.trim()&&t.indexOf(e)===a).join(" ").trim();var n={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let o=(0,t.forwardRef)(({color:e="currentColor",size:a=24,strokeWidth:r=2,absoluteStrokeWidth:s,className:l="",children:o,iconNode:d,...c},m)=>(0,t.createElement)("svg",{ref:m,...n,width:a,height:a,stroke:e,strokeWidth:s?24*Number(r)/Number(a):r,className:i("lucide",l),...!o&&!(e=>{for(let a in e)if(a.startsWith("aria-")||"role"===a||"title"===a)return!0})(c)&&{"aria-hidden":"true"},...c},[...d.map(([e,a])=>(0,t.createElement)(e,a)),...Array.isArray(o)?o:[o]])),d=(e,a)=>{let r=(0,t.forwardRef)(({className:r,...s},n)=>(0,t.createElement)(o,{ref:n,iconNode:a,className:i(`lucide-${l(e).replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}`,`lucide-${e}`,r),...s}));return r.displayName=l(e),r},c=d("house",[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"r6nss1"}]]),m=d("map-pin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]),g=d("beef",[["path",{d:"M16.4 13.7A6.5 6.5 0 1 0 6.28 6.6c-1.1 3.13-.78 3.9-3.18 6.08A3 3 0 0 0 5 18c4 0 8.4-1.8 11.4-4.3",key:"cisjcv"}],["path",{d:"m18.5 6 2.19 4.5a6.48 6.48 0 0 1-2.29 7.2C15.4 20.2 11 22 7 22a3 3 0 0 1-2.68-1.66L2.4 16.5",key:"5byaag"}],["circle",{cx:"12.5",cy:"8.5",r:"2.5",key:"9738u8"}]]),x=d("calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]),p=d("trending-up",[["path",{d:"M16 7h6v6",key:"box55l"}],["path",{d:"m22 7-8.5 8.5-5-5L2 17",key:"1t1m79"}]]),h=d("chart-column",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"M18 17V9",key:"2bz60n"}],["path",{d:"M13 17V5",key:"1frdt8"}],["path",{d:"M8 17v-3",key:"17ska0"}]]),u=d("database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]]),f=d("user",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]),b=d("users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]]),y=d("log-out",[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]]);function j({activeTab:e,onTabChange:r,onLogout:l}){let{read:i,write:n}=(0,s.useStorage)(),o=i("appSession","Usuario"),d=i("userAvatar",null);t.default.useEffect(()=>{let e=i("users",[]),a=e.find(e=>e.name.toLowerCase().includes("gerencia")||"gerencia@sotodelprior.com"===e.email);if(a){if("admin"!==a.role){let t={...a,role:"admin"};n("users",[...e.filter(e=>e.name!==a.name),t]),window.location.reload()}}else n("users",[...e,{name:"Gerencia",email:"gerencia@sotodelprior.com",pass:"admin123",role:"admin",joined:new Date().toISOString(),jobTitle:"Direcci√≥n General",firstName:"Gerencia",lastName:"Soto del Prior"}]),console.log("Auto-created Gerencia account")},[o,i,n]);let j=i("users",[]).find(e=>e.name===o),_=j?.role||"worker",v=o?.toLowerCase().includes("gerencia")||"gerencia@sotodelprior.com"===o,N="admin"===_||v,w=[{id:"home",label:"Inicio",icon:c},{id:"farms",label:"Fincas",icon:m},{id:"animals",label:"Animales",icon:g},{id:"events",label:"Eventos",icon:x},{id:"calculator",label:"Rendimiento",icon:p},{id:"reports",label:"Reportes",icon:h},{id:"users",label:"Equipo",icon:b},{id:"data",label:"Datos",icon:u}].filter(e=>"calculator"!==e.id&&"reports"!==e.id&&"data"!==e.id&&"users"!==e.id||N),C=o||"Usuario";return(0,a.jsxs)("aside",{className:"w-64 bg-white border-r border-gray-200 h-screen flex flex-col fixed left-0 top-0 z-30 shadow-sm",children:[(0,a.jsx)("div",{className:"p-4 flex justify-center border-b border-gray-100",children:(0,a.jsx)("img",{src:"/logo-text.png",alt:"SOTO DEL PRIOR",className:"h-12"})}),(0,a.jsxs)("div",{className:"p-6 border-b border-gray-100 flex items-center gap-3",children:[d?(0,a.jsx)("img",{src:d,alt:"Profile",className:"w-10 h-10 rounded-full object-cover"}):(0,a.jsx)("div",{className:"w-10 h-10 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-lg",children:C.charAt(0).toUpperCase()}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-bold text-gray-800 text-sm truncate w-32",children:C}),(0,a.jsx)("p",{className:"text-xs text-gray-500 capitalize",children:N?"Administrador":_})]})]}),(0,a.jsx)("nav",{className:"flex-1 p-4 space-y-1 overflow-y-auto",children:w.map(t=>(0,a.jsxs)("button",{onClick:()=>r(t.id),className:`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors ${e===t.id?"bg-green-50 text-green-700":"text-gray-600 hover:bg-gray-50 hover:text-gray-900"}`,children:[(0,a.jsx)(t.icon,{className:"w-5 h-5"}),t.label]},t.id))}),(0,a.jsxs)("div",{className:"p-4 border-t border-gray-100 space-y-2",children:[(0,a.jsxs)("button",{onClick:()=>r("profile"),className:`w-full flex items-center gap-3 px-4 py-2 text-sm font-medium transition-colors ${"profile"===e?"bg-green-50 text-green-700":"text-gray-600 hover:bg-gray-50 hover:text-gray-900"}`,children:[(0,a.jsx)(f,{className:"w-5 h-5"}),(0,a.jsx)("span",{children:"Mi Perfil"})]}),(0,a.jsxs)("button",{onClick:l,className:"w-full flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:text-red-700 rounded-lg hover:bg-red-50",children:[(0,a.jsx)(y,{className:"w-5 h-5"}),(0,a.jsx)("span",{children:"Cerrar Sesi√≥n"})]})]})]})}function _({children:e,activeTab:t,onTabChange:r,onLogout:s}){return(0,a.jsxs)("div",{className:"min-h-screen bg-gray-50 flex",children:[(0,a.jsx)(j,{activeTab:t,onTabChange:r,onLogout:s}),(0,a.jsx)("main",{className:"flex-1 ml-64 p-8",children:(0,a.jsx)("div",{className:"max-w-7xl mx-auto",children:e})})]})}let v={getWeatherDescription(e){switch(e){case 0:return"Despejado";case 1:case 2:case 3:return"Nublado";case 45:case 48:return"Niebla";case 51:case 53:case 55:return"Llovizna";case 61:case 63:case 65:return"Lluvia";case 71:case 73:case 75:return"Nueve";case 95:case 96:case 99:return"Tormenta";default:return"Desconocido"}},async getCurrentWeather(e,a){try{let t=`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${a}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m`,r=await fetch(t);if(!r.ok)throw Error("Weather API Error");let s=(await r.json()).current;return{temperature:s.temperature_2m,humidity:s.relative_humidity_2m,wind_speed:s.wind_speed_10m,weather_code:s.weather_code,weather_desc:this.getWeatherDescription(s.weather_code)}}catch(e){return console.error(e),null}},async getWeeklyPrecipitation(e,a){try{let t=`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${a}&daily=precipitation_sum&past_days=7`,r=await fetch(t),s=await r.json();if(s.daily&&s.daily.precipitation_sum)return s.daily.precipitation_sum.reduce((e,a)=>e+a,0);return 0}catch(e){return 0}},async getForecast(e,a){try{let t=`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${a}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto&forecast_days=4`,r=await fetch(t),s=await r.json();if(!s.daily)return[];let l=s.daily,i=[];for(let e=0;e<3;e++)i.push({date:l.time[e],icon:this.getWeatherIcon(l.weather_code[e]),max:l.temperature_2m_max[e],min:l.temperature_2m_min[e],precip:l.precipitation_sum[e],code:l.weather_code[e]});return i}catch(e){return console.error("Forecast Error",e),[]}},getWeatherIcon:e=>0===e?"‚òÄÔ∏è":e<3?"‚õÖ":e<48?"‚òÅÔ∏è":e<60?"üåßÔ∏è":e<80?"‚õàÔ∏è":"üå®Ô∏è",async analyzeClimate(e,a){try{let t=await this.getCurrentWeather(e,a),r=await this.getWeeklyPrecipitation(e,a),s=e<40;return{avgTemp:t?t.temperature:15,classification:s?"Mediterr√°neo Seco":"Continental Templado",annualPrecip:Math.round(40*r+(s?300:600))}}catch(e){return console.error("Climate Analysis Error",e),{avgTemp:15,classification:"Desconocido",annualPrecip:500}}}},N={w_age:.015,w_energy:.01,w_adg:.01,w_stress:-.01,age_ref_start_months:12,age_ref_end_months:24,EN_min:1.3,EN_max:2.2,THI_threshold:72,THI_max:84,adg_ratio_min:.8,adg_ratio_max:1.2},w={rc_feedlot:.59,rc_grazing:.56,rc_mixed:.575},C={EN_finish_threshold:1.85,concentrate_share_threshold:.4},S={clamp:(e,a,t)=>Math.max(a,Math.min(t,e)),normalize(e,a,t){return t===a?0:this.clamp((e-a)/(t-a),0,1)},calculateTHI(e,a){if(null==e)return 0;let t=1.8*e+32;return t-(.55-.0055*(null==a?50:a))*(t-58)},estimateCarcassResult(e,a,t,r,s,l){let i=N,n=parseFloat(l.yield_potential||l.rc_base);if(isNaN(n)){let a=(e.system||"Intensivo").toLowerCase();n=a.includes("pastoreo")?w.rc_grazing:a.includes("mixto")?w.rc_mixed:w.rc_feedlot}let o=e.ageMonths||12,d=this.normalize(o,i.age_ref_start_months,i.age_ref_end_months),c=this.normalize(r,i.EN_min,i.EN_max),m=parseFloat(l.adg_feedlot||"1.2");0===m&&(m=1.2);let g=t/m,x=this.normalize(g,i.adg_ratio_min,i.adg_ratio_max),p=this.normalize(s,i.THI_threshold,i.THI_max),h=i.w_age*d+i.w_energy*c+i.w_adg*x+i.w_stress*p,u=parseFloat(l.rc_min)||.54,f=parseFloat(l.rc_max)||.66,b=this.clamp(n+h,u,f),y=a*b;return{rc_est:parseFloat(b.toFixed(4)),rc_percent:parseFloat((100*b).toFixed(2)),carcass_weight:parseFloat(y.toFixed(1))}},calculateQualityIndex(e,a,t,r,s,l,i,n,o={}){let d={nei_min:a.nei_min||12,nei_max:a.nei_max||18,dof_min:a.dof_min||90,dof_max:a.dof_max||200,adg_min:a.adg_min_quality||.6,adg_max:a.adg_max_quality||1.4,thi_comfort:a.thi_comfort||72,thi_max:a.thi_max||84,changes_limit:a.changes_30d_limit||4,weights:a.weights||{w_dof:1,w_nei:1,w_conc:.6,w_adg:.8,w_heat:1,w_stab:.8,w_health:.7,z0:1,k:3}},c=d.weights,m=e.weight||e.currentWeight||500,g=a.dmi_pct_pv||.021,x=this.normalize(m*g*t,d.nei_min,d.nei_max),p=this.normalize(l,d.dof_min,d.dof_max),h=this.normalize(r,d.adg_min,d.adg_max),u=this.clamp((s-d.thi_comfort)/(d.thi_max-d.thi_comfort),0,1),f=this.clamp(i/d.changes_limit,0,1),b=this.clamp(n,0,1),y=c.w_dof*p+c.w_nei*x+c.w_conc*x+c.w_adg*h-c.w_heat*u-c.w_stab*f-c.w_health*b-c.z0,j=100/(1+Math.exp(-c.k*y)),_=parseFloat(a.marbling_potential)||3,v=this.clamp(1+j/100*(_-1),1,_),N=o&&(o.isBellota||o.highOleic),w=o&&o.hasLecithin;if(N&&w){let a=.25;("Macho"===e.sex||"Castrado"===e.sex)&&(e.ageMonths||0)>30&&(a=.6),v+=a}v=this.clamp(v,1,5);let C=this.clamp(1+(v-1)*2.75,1,12),S=v>=4.2;return{iq_score:parseFloat(j.toFixed(1)),marbling_est:parseFloat(v.toFixed(1)),bms_est:parseFloat(C.toFixed(1)),conformation_est:this.estimateConformation(e.rc_percent||55),is_premium:S}},isFinishingDiet(e,a){let t=C;return e>=t.EN_finish_threshold||a>=t.concentrate_share_threshold},estimateConformation:e=>e?e>=64?"S":e>=62?"E":e>=60?"U":e>=57?"R":e>=54?"O":"P":"R"},k=[{id:"WAG",code:"WAG",name:"Wagyu",subspecies:"Bos taurus",biological_type:"British",weight_male_adult:850,weight_female_adult:550,slaughter_age_months:29,adg_feedlot:.9,adg_grazing:.6,fcr_feedlot:8.5,heat_tolerance:5,marbling_potential:5,calving_ease:9,milk_potential:2,conformation_potential:3,yield_potential:.52},{id:"ANG",code:"ANG",name:"Angus",subspecies:"Bos taurus",biological_type:"British",weight_male_adult:900,weight_female_adult:500,slaughter_age_months:18,adg_feedlot:1.4,adg_grazing:.9,fcr_feedlot:7.9,heat_tolerance:4,marbling_potential:4,calving_ease:8,milk_potential:3,conformation_potential:4,yield_potential:.54},{id:"HER",code:"HER",name:"Hereford",subspecies:"Bos taurus",biological_type:"British",weight_male_adult:1e3,weight_female_adult:580,slaughter_age_months:20,adg_feedlot:1.4,adg_grazing:.8,fcr_feedlot:7.8,heat_tolerance:3,marbling_potential:3,calving_ease:7,milk_potential:2,conformation_potential:4,yield_potential:.53},{id:"CHA",code:"CHA",name:"Charolais",subspecies:"Bos taurus",biological_type:"Continental",weight_male_adult:1100,weight_female_adult:800,slaughter_age_months:24,adg_feedlot:1.5,adg_grazing:1,fcr_feedlot:7.2,heat_tolerance:3,marbling_potential:2,calving_ease:4,milk_potential:2,conformation_potential:5,yield_potential:.58},{id:"LIM",code:"LIM",name:"Limousin",subspecies:"Bos taurus",biological_type:"Continental",weight_male_adult:950,weight_female_adult:650,slaughter_age_months:16,adg_feedlot:1.4,adg_grazing:.9,fcr_feedlot:7.4,heat_tolerance:4,marbling_potential:3,calving_ease:6,milk_potential:2,conformation_potential:5,yield_potential:.58},{id:"BDA",code:"BDA",name:"Blonde d'Aquitaine",subspecies:"Bos taurus",biological_type:"Continental",weight_male_adult:1200,weight_female_adult:700,slaughter_age_months:18,adg_feedlot:1.6,adg_grazing:1.1,fcr_feedlot:7.1,heat_tolerance:3,marbling_potential:2,calving_ease:5,milk_potential:2,conformation_potential:5,yield_potential:.61},{id:"AZB",code:"AZB",name:"Azul Belga",subspecies:"Bos taurus",biological_type:"Continental",weight_male_adult:1175,weight_female_adult:775,slaughter_age_months:16,adg_feedlot:1.7,adg_grazing:1,fcr_feedlot:6.8,heat_tolerance:1,marbling_potential:1,calving_ease:2,milk_potential:2,conformation_potential:6,yield_potential:.64},{id:"PIR",code:"PIR",name:"Pirenaica",subspecies:"Bos taurus",biological_type:"Rustic_European",weight_male_adult:900,weight_female_adult:600,slaughter_age_months:18,adg_feedlot:1.3,adg_grazing:.85,fcr_feedlot:7.8,heat_tolerance:5,marbling_potential:3,calving_ease:7,milk_potential:2,conformation_potential:4,yield_potential:.56},{id:"MOR",code:"MOR",name:"Morucha",subspecies:"Bos taurus",biological_type:"Rustic_European",weight_male_adult:900,weight_female_adult:500,slaughter_age_months:30,adg_feedlot:1.1,adg_grazing:.7,fcr_feedlot:8.4,heat_tolerance:8,marbling_potential:3,calving_ease:8,milk_potential:2,conformation_potential:2,yield_potential:.52},{id:"RET",code:"RET",name:"Retinta",subspecies:"Bos taurus",biological_type:"Rustic_European",weight_male_adult:1e3,weight_female_adult:580,slaughter_age_months:30,adg_feedlot:1.1,adg_grazing:.75,fcr_feedlot:8.3,heat_tolerance:8,marbling_potential:3,calving_ease:8,milk_potential:2,conformation_potential:3,yield_potential:.53},{id:"BER",code:"BER",name:"Berrenda",subspecies:"Bos taurus",biological_type:"Rustic_European",weight_male_adult:800,weight_female_adult:500,slaughter_age_months:23,adg_feedlot:1.1,adg_grazing:.7,fcr_feedlot:8.3,heat_tolerance:8,marbling_potential:3,calving_ease:8,milk_potential:2,conformation_potential:3,yield_potential:.53},{id:"BET",code:"BET",name:"Betizu",subspecies:"Bos taurus",biological_type:"Rustic_European",weight_male_adult:450,weight_female_adult:325,slaughter_age_months:36,adg_feedlot:.9,adg_grazing:.55,fcr_feedlot:9.2,heat_tolerance:7,marbling_potential:2,calving_ease:10,milk_potential:1,conformation_potential:2,yield_potential:.48},{id:"SIM",code:"SIM",name:"Simmental",subspecies:"Bos taurus",biological_type:"Dairy",weight_male_adult:1100,weight_female_adult:750,slaughter_age_months:18,adg_feedlot:1.5,adg_grazing:.85,fcr_feedlot:7,heat_tolerance:4,marbling_potential:3,calving_ease:6,milk_potential:3,conformation_potential:5,yield_potential:.56},{id:"HOL",code:"HOL",name:"Holstein",subspecies:"Bos taurus",biological_type:"Dairy",weight_male_adult:1e3,weight_female_adult:650,slaughter_age_months:20,adg_feedlot:1.2,adg_grazing:.6,fcr_feedlot:8.5,heat_tolerance:2,marbling_potential:2,calving_ease:5,milk_potential:5,conformation_potential:2,yield_potential:.49},{id:"FRI",code:"FRI",name:"Frisona",subspecies:"Bos taurus",biological_type:"Dairy",weight_male_adult:950,weight_female_adult:600,slaughter_age_months:20,adg_feedlot:1.15,adg_grazing:.6,fcr_feedlot:8.6,heat_tolerance:2,marbling_potential:2,calving_ease:5,milk_potential:5,conformation_potential:2,yield_potential:.48},{id:"BRA",code:"BRA",name:"Brahman",subspecies:"Bos indicus",biological_type:"Indicus",weight_male_adult:900,weight_female_adult:550,slaughter_age_months:24,adg_feedlot:1.1,adg_grazing:.8,fcr_feedlot:8,heat_tolerance:10,marbling_potential:2,calving_ease:9,milk_potential:3,conformation_potential:3,yield_potential:.51},{id:"NEL",code:"NEL",name:"Nelore",subspecies:"Bos indicus",biological_type:"Indicus",weight_male_adult:900,weight_female_adult:550,slaughter_age_months:26,adg_feedlot:1.05,adg_grazing:.75,fcr_feedlot:8.2,heat_tolerance:10,marbling_potential:2,calving_ease:9,milk_potential:2,conformation_potential:3,yield_potential:.52},{id:"DRM",code:"DRM",name:"Droughtmaster",subspecies:"Cruzado",biological_type:"Composite",weight_male_adult:900,weight_female_adult:550,slaughter_age_months:24,adg_feedlot:1.2,adg_grazing:.9,fcr_feedlot:7.9,heat_tolerance:9,marbling_potential:3,calving_ease:9,milk_potential:2,conformation_potential:3,yield_potential:.53}],M={getAllBreeds:()=>k,getBreedById:e=>k.find(a=>a.id===e||a.code===e),getBreedByName:e=>k.find(a=>a.name.toLowerCase()===e.toLowerCase()),calculateHybrid(e,a){let t=this.getBreedById(e),r=this.getBreedById(a);if(!t||!r)return null;let s={British:1,Continental:2,Rustic_European:3,Dairy:4,Indicus:5,Composite:3},l=(s[t.biological_type]||3)===(s[r.biological_type]||3)?.02:.05;"Indicus"===t.biological_type!=("Indicus"===r.biological_type)&&(l=.12);let i=t.weight_male_adult/r.weight_female_adult,n=0;i>1.1&&(n=(i-1.1)*20);let o=(.6*t.adg_feedlot+.4*r.adg_feedlot)*(1+1.5*l)*(r.milk_potential>=4?1.05:r.milk_potential<=2?.95:1),d=.6*t.yield_potential+.4*r.yield_potential,c=.4*t.marbling_potential+.6*r.marbling_potential,m=(.6*t.weight_male_adult+.4*r.weight_male_adult)*(1+l),g=(.6*t.weight_female_adult+.4*r.weight_female_adult)*(1+l),x=.6*t.conformation_potential+.4*r.conformation_potential,p=Math.max(1,.3*t.calving_ease+.7*r.calving_ease-n);return{id:`F1_${t.code}_${r.code}`,code:`${t.code}x${r.code}`,name:`F1 ${r.name} x ${t.name}`,subspecies:"Cruzado",biological_type:"Composite",weight_male_adult:m,weight_female_adult:g,slaughter_age_months:(t.slaughter_age_months+r.slaughter_age_months)/2,adg_feedlot:o,adg_grazing:.7*o,fcr_feedlot:(t.fcr_feedlot+r.fcr_feedlot)/2*(1-.5*l),heat_tolerance:Math.max(t.heat_tolerance,r.heat_tolerance),marbling_potential:c,calving_ease:p,milk_potential:.6*t.milk_potential+.4*r.milk_potential,conformation_potential:x,yield_potential:d,is_hybrid:!0,sire_name:t.name,dam_name:r.name}}},D={isBuey:(e,a)=>e?.category==="Buey"||e?.sex==="Castrado"&&!!(a>12),inferSystem(e){let a=(e.farm||"").toLowerCase();return a.includes("feedlot")||a.includes("cebo")?"Intensivo (Feedlot)":"SOTO del PRIOR"===e.farm||a.includes("dehesa")||a.includes("soto")?"Montanera (Bellota)":"Extensivo (Pastoreo)"},getReproStatus(e,a,t){if("Hembra"!==e.sex||!a||0===a.length)return 0;let r=[...a].sort((e,a)=>new Date(a.date).getTime()-new Date(e.date).getTime()).filter(e=>new Date(e.date)<=t),s=r.find(e=>"Parto"===e.type),l=r.find(e=>"Inseminaci√≥n"===e.type||"Monta"===e.type);if(l&&(!s||new Date(l.date)>new Date(s.date))){let e=(t.getTime()-new Date(l.date).getTime())/864e5/30.44;if(e>8.5)return 50;if(e>7.5)return 30;if(e>6)return 15}if(s){let e=(t.getTime()-new Date(s.date).getTime())/864e5;if(e<90)return -35;if(e<150)return -15}return 0},calculateRealisticWeight(e,a,t=[]){if(!e.birth&&!e.birthDate)return 0;let r=new Date(e.birth||e.birthDate),s=new Date,l=M.getBreedByName(e.breed),i=(e.breed||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");!l&&i&&(i.includes("betizu")?l={id:"MANUAL_BETIZU",code:"BET",name:"Betizu",biological_type:"Rustic_European",weight_female_adult:320,weight_male_adult:450,adg_feedlot:.6,slaughter_age_months:36}:i.includes("limousin")||i.includes("limusin")?l={id:"MANUAL_LIM",code:"LIM",name:"Limousin",biological_type:"Continental",weight_female_adult:700,weight_male_adult:1100,adg_feedlot:1.4,slaughter_age_months:18}:i.includes("charol")?l={id:"MANUAL_CHA",code:"CHA",name:"Charolais",biological_type:"Continental",weight_female_adult:800,weight_male_adult:1200,adg_feedlot:1.5,slaughter_age_months:18}:i.includes("avile")?l={id:"MANUAL_AVI",code:"AVI",name:"Avile√±a",biological_type:"Rustic_European",weight_female_adult:550,weight_male_adult:900,adg_feedlot:1.1,slaughter_age_months:24}:i.includes("retinta")?l={id:"MANUAL_RET",code:"RET",name:"Retinta",biological_type:"Rustic_European",weight_female_adult:580,weight_male_adult:950,adg_feedlot:1.1,slaughter_age_months:24}:i.includes("morucha")?l={id:"MANUAL_MOR",code:"MOR",name:"Morucha",biological_type:"Rustic_European",weight_female_adult:550,weight_male_adult:900,adg_feedlot:1.1,slaughter_age_months:24}:i.includes("frison")?l={id:"MANUAL_FRI",code:"FRI",name:"Frisona",biological_type:"Dairy",weight_female_adult:650,weight_male_adult:1e3,adg_feedlot:1.2,slaughter_age_months:22}:i.includes("wagyu")?l={id:"MANUAL_WAG",code:"WAG",name:"Wagyu",biological_type:"British",weight_female_adult:550,weight_male_adult:850,adg_feedlot:.9,slaughter_age_months:30}:(i.includes("mestiz")||i.includes("cruzad"))&&(l={id:"MANUAL_MIX",code:"MIX",name:"Mestiza",biological_type:"Rustic_European",weight_female_adult:580,weight_male_adult:950,adg_feedlot:1.2,slaughter_age_months:24}));let n=600,o=.002;l&&(n="Hembra"===e.sex?l.weight_female_adult:l.weight_male_adult,"Rustic_European"===l.biological_type?o=.0018:"Continental"===l.biological_type?o=.0022:("British"===l.biological_type||l.slaughter_age_months<20)&&(o=.0025));let d="Buey"===e.category||"Castrado"===e.sex;d&&(n*=1.25,o*=.85);let c=40;l&&(c=.07*l.weight_female_adult);let m=new Date(r),g=0;for(;m<s&&g<240;){let e=g,t=m.getMonth(),r=1;if(e<=6)r=1.2,a.includes("Feedlot")&&(r*=1.1);else if(e<=7)r=.5;else if(a.includes("Feedlot"))r=1.3;else if(a.includes("Montanera")){let a=[9,10,11,0,1].includes(t),s=d&&e>12;r=a&&s?1.5:[6,7,8].includes(t)?.4:[2,3,4,5].includes(t)?1.1:.6}else r=[6,7,8].includes(t)?.4:[2,3,4,5].includes(t)?1.1:[9,10].includes(t)?.9:.6;let s=o*(n-c)*r;r<.5&&e>6&&(s=(r-.5)*.5),c+=30.44*s,m.setMonth(m.getMonth()+1),g++}return(c+=this.getReproStatus(e,t,s))<40&&(c=40),parseFloat(c.toFixed(1))}},I={BELLOTA_PROTOCOL:{season_start_month:9,season_end_month:1,min_oleic_acid:55,min_age_months:14,max_bellota_percent:40,min_fdn_bellota:28,min_protein_bellota:12,TYPE_ENCINA:"ENCINA",TYPE_ROBLE:"ROBLE"},calculateKPITargets(e,a,t){let r={adg:.1,fcr:0,energyDensity:2,proteinDensity:10,fiberMin:35,maxConcentrate:30},s=e.functionalType||"rustica_adaptada";!e.functionalType&&e.biological_type&&("Rustic_European"===e.biological_type?s="rustica_adaptada":"Continental"===e.biological_type?s="crecimiento_magro":"British"===e.biological_type?s="infiltracion":"Dairy"===e.biological_type?s="aptitud_lechera":"Indicus"===e.biological_type&&(s="rustica_adaptada"));let l=e.stage||(e.ageMonths<8?"recria":"terminado");return"infiltracion"===s?"terminado"===l||a.includes("Engorde")||a.includes("Cebo")||a.includes("Eficiencia")?(r.energyDensity=2.9,r.proteinDensity=12,r.fiberMin=15,r.maxConcentrate=85,r.adg=.9,r.fcr=8.5):(r.energyDensity=2.4,r.proteinDensity=14,r.adg=.8):"crecimiento_magro"===s?"terminado"===l||a.includes("Engorde")||a.includes("Cebo")||a.includes("Eficiencia")?(r.energyDensity=2.8,r.proteinDensity=14.5,r.fiberMin=18,r.maxConcentrate=80,r.adg=1.6,r.fcr=5.8):(r.energyDensity=2.5,r.proteinDensity=16,r.adg=1.1,r.fcr=5.5):"rustica_adaptada"===s?(r.energyDensity=2.2,r.proteinDensity=11,r.fiberMin=30,r.maxConcentrate=40,r.adg=.7,r.fcr=7.5,t.includes("Montanera")&&(r.adg=1,r.energyDensity=2.8)):"aptitud_lechera"===s?(r.energyDensity=2.6,r.proteinDensity=15,r.fiberMin=25,r.maxConcentrate=60,r.adg=1.2,r.fcr=6.5):"carnica_general"===s?(r.energyDensity=2.7,r.proteinDensity=14,r.fiberMin=20,r.maxConcentrate=70,r.adg=1.4,r.fcr=6.2):"doble_proposito"===s&&(r.energyDensity=2.4,r.proteinDensity=12.5,r.fiberMin=28,r.maxConcentrate=50,r.adg=.9,r.fcr=7.2),"composito"===s&&(r.adg*=1.1,r.fcr*=.95),"Eficiencia Econ√≥mica"===a?(r.adg*=.9,r.maxConcentrate*=.8,r.energyDensity=Math.max(2,.95*r.energyDensity)):"Mantenimiento"===a&&(r.energyDensity=2,r.adg=.1,r.maxConcentrate=10),t.includes("Extensivo")&&!t.includes("Montanera")&&(r.maxConcentrate=Math.min(r.maxConcentrate,30),r.adg=Math.min(r.adg,.8)),r},generateSmartDiet(e,a,t,r){let s=[],l=.025*a.weight,i=0;if(t.includes("Montanera")){let e=.15*l;s.push({feed_id:"paja",feed_name:"Paja de Cereales",dm_kg:parseFloat(e.toFixed(1))});let a=l-(i+=e);return s.push({feed_id:"BELLHO_01",feed_name:"Bellota de Encina",dm_kg:parseFloat((.8*a).toFixed(1))}),s.push({feed_id:"P01",feed_name:"Soja (Harina 44%)",dm_kg:parseFloat((.2*a).toFixed(1))}),s}let n="paja",o="Paja de Cereales",d=.2*l;e.energyDensity>2.7&&(d=.12*l),e.energyDensity<2.3&&(d=.5*l),t.includes("Extensivo")?(n="F01",o="Pasto Dehesa (Primavera)"):t.includes("Ecol√≥gico")&&(n="F03",o="Heno de Avena"),s.push({feed_id:n,feed_name:o,dm_kg:parseFloat(d.toFixed(1))}),i+=d;let c="C01",m="Ma√≠z (Grano)";e.energyDensity<2.5&&(c="C02",m="Cebada"),t.includes("Ecol√≥gico")&&(c="C01",m="Cereal Ecol√≥gico");let g=l-i,x=.6*g;if(e.energyDensity>2.6&&(x=.8*g),e.maxConcentrate<60&&(x=Math.min(x,l*(e.maxConcentrate/100))),s.push({feed_id:c,feed_name:m,dm_kg:parseFloat(x.toFixed(1))}),i+=x,(g=l-i)>0){let e="Soja (Harina 44%)";t.includes("Ecol√≥gico")&&(e="Guisantes Proteicos"),s.push({feed_id:"P01",feed_name:e,dm_kg:parseFloat(g.toFixed(1))})}return s},calculateRequirements(e,a,t,r,s){let l=.025;e>400&&(l=.022),e>700&&(l=.019),"Mantenimiento"===r&&e>600&&(l=.018);let i=e*l,n=Math.pow(e,.75),o=.077*n;"Mantenimiento"===r&&(o*=1.2);let d=1;"Hembra"===s&&(d=1.15),"Castrado"===s&&(d=1.1);let c=12;"Mantenimiento"===r?c=8.5:"Lactancia"===r?c=15:e<300?c=16:e>500&&(c=11.5);let m=30;return"Cebo"===r&&(m=15),"Lactancia"===r&&(m=28),{pb_percent:c,em_mcal:parseFloat(((o+.05*n*Math.pow(a,1.1)*d)/i).toFixed(2)),fdn_min:m,dmi_capacity_kg:parseFloat(i.toFixed(1))}},validateDiet(e,a,t){let r=[];if(a.totalDMI<=0)return r;let s=a.totalFDN/a.totalDMI,l=a.totalProteinVal/10/a.totalDMI,i=String(t||""),n=.28;(i.includes("Cebo")||i.includes("Intensivo"))&&(n=.15),s<n?r.push({code:"ACIDOSIS",level:"critical",message:`Riesgo de Acidosis: Fibra muy baja (${(100*s).toFixed(1)}%). M\xednimo recomendado: ${(100*n).toFixed(0)}%.`,action:"Aumente la proporci√≥n de forraje o fibra efectiva."}):s<n+.04&&r.push({code:"LOW_FIBER",level:"warning",message:`Fibra ajustada (${(100*s).toFixed(1)}%). Vigile la rumia.`,action:"Considere a√±adir algo m√°s de paja o heno."});let o=e.filter(e=>"Leguminosa"===e.item.category||e.item.name.includes("Alfalfa")||e.item.name.includes("Tr√©bol")).reduce((e,a)=>e+a.amount*(a.item.dm_percent/100),0)/a.totalDMI;if((o>.5||o>.3&&s<.22)&&r.push({code:"BLOAT",level:"critical",message:"Alto Riesgo de Meteorismo (Hinchaz√≥n).",action:"Exceso de leguminosas. A√±ada paja o aceite/bloque anti-meteorismo."}),i.includes("Montanera")){let t=e.filter(e=>e.item.name.toLowerCase().includes("bellota")).reduce((e,a)=>e+a.amount*(a.item.dm_percent/100),0)/a.totalDMI,s=e.filter(e=>"Forraje"===e.item.category).reduce((e,a)=>e+a.amount*(a.item.dm_percent/100),0)/a.totalDMI;t>0&&s<.1&&r.push({code:"BELLOTA_FIBER",level:"critical",message:"Falta de Fibra en Montanera.",action:"La bellota no tiene fibra efectiva. El animal DEBE comer hierba o paja."}),t>.6&&l<.1&&r.push({code:"BELLOTA_PROTEIN",level:"warning",message:"D√©ficit Proteico en Montanera.",action:"La bellota es energ√©tica pero baja en prote√≠na. Suplemente con torta de girasol/soja si busca crecimiento."}),e.filter(e=>e.item.name.toLowerCase().includes("roble")).reduce((e,a)=>e+a.amount*(a.item.dm_percent/100),0)/a.totalDMI>.5&&r.push({code:"BELLOTA_TOXICITY",level:"warning",message:"Precauci√≥n: Exceso de Taninos (Roble).",action:"Carga alta de bellota amarga. Vigile el estre√±imiento o rechazo."})}let d=a.reqs.pb_percent/100;return l<d-.02&&r.push({code:"LOW_N_EFF",level:"critical",message:`D\xe9ficit de Prote\xedna (${(100*l).toFixed(1)}% vs ${(100*d).toFixed(1)}%).`,action:"El crecimiento se detendr√°. A√±ada proteaginosas."}),l>d+.04&&r.push({code:"HIGH_POLLUTION",level:"warning",message:`Exceso de Nitr\xf3geno (+${((l-d)*100).toFixed(1)}%). Contaminante y caro.`,action:"Reduzca la prote√≠na para mejorar la eficiencia econ√≥mica y ambiental."}),r},calculateSynergies(e,a,t={}){let r=[],s=e.map(e=>e.feed_name.toLowerCase()),l=s.some(e=>e.includes("bellota")),i=s.some(e=>e.includes("lecitina")||e.includes("harina de soja"));if(l&&i){let e=.5;("Castrado"===a.sex||"Buey"===a.sex)&&(e=.8);let s="üî• Bellota + Lecitina: Infiltraci√≥n mejorada.";"ENCINA"===t.bellotaType?(e+=.4,s="üî• Bellota Encina (Alto Oleico): Infiltraci√≥n M√°xima."):"ROBLE"===t.bellotaType&&(s="üçÇ Bellota Roble (Taninos): Sabor Intenso."),r.push({active:!0,name:"ACIDOS_GRASOS_EMULSIONADOS",bonus_marbling:e,bonus_yield:1.5,description:s})}return r},checkBellotaCompliance:(e,a)=>[9,10,11,0,1].includes(a)?e.ageMonths<14?{compliant:!1,reason:"Muy joven <14m"}:{compliant:!0}:{compliant:!1,reason:"Fuera temporada"},calculateNitrogenBalance(e,a,t,r){let s=t/100*r*1e3/6.25,l=1e3*a*.027,i=Math.max(0,s-l),n=s>0?l/s*100:0,o=a>.1?i/a:0;return{n_intake_g:s.toFixed(1),n_retained_g:l.toFixed(1),n_excreted_g:i.toFixed(1),efficiency_pct:n.toFixed(1),excretion_per_gain:o.toFixed(1),is_critical:o>150}},predictPerformance(e,a,t,r,s={}){let l=.077*Math.pow(r,.75);if("Rustic_European"===e.biological_type?l*=.9:"Continental"===e.biological_type?l*=1.05:"Dairy"===e.biological_type?l*=1.25:"Indicus"===e.biological_type&&(l*=.85),void 0!==s.currentMonth){let a=s.currentMonth;a>=5&&a<=8&&5>(e.heat_tolerance||5)&&(l*=1.25),(11===a||a<=1)&&"AZB"===e.code&&(l*=1.15)}let i=.35*(a*t-l);return s.activeSynergies?.includes("ACIDOS_GRASOS_EMULSIONADOS")&&(i*=1.1),parseFloat((i=i>0?Math.min(i,1.2*e.adg_feedlot):Math.max(i,-2)).toFixed(2))}},A={generateUUID(){if("undefined"!=typeof crypto&&crypto.randomUUID)try{return crypto.randomUUID()}catch(e){}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var a=16*Math.random()|0;return("x"==e?a:3&a|8).toString(16)})},async handleSaneamiento(e,a){let{result:t,infectedCrotalsText:r,date:s,farmId:l}=e,{animals:i,events:n,currentUser:o,storage:d,getFincas:c}=a,m=(c?c():[]).find(e=>e.id===l),g=m?m.name:"Finca Desconocida",x=i.filter(e=>(e.farmId===l||e.farm===g)&&"Muerto"!==e.status&&"Vendido"!==e.status&&"Sacrificado"!==e.status);if(0===x.length)throw Error("No hay animales activos en esta finca.");let p="",h=0;if("Negativo"===t)x.forEach(e=>{e.healthStatus="Sano",e.status||(e.status="Activo")}),p="Saneamiento NEGATIVO. Todo el reba√±o declarado SANO.";else if("Positivo"===t){let e=(r||"").split(",").map(e=>e.trim().toUpperCase()).filter(e=>e);if(0===e.length)throw Error("Has indicado POSITIVO. Introduce los crotales infectados.");x.forEach(a=>{e.some(e=>(a.crotal||"").toUpperCase().endsWith(e))?(a.healthStatus="Tuberculosis+",a.status="Sacrificado",a.exitDate=s,a.actualPrice=0,a.actualCarcassWeight=0,a.deathReason="Saneamiento Positivo",h++,n.push({id:this.generateUUID(),type:"Sacrificio",date:s,animalId:a.id,animalCrotal:a.crotal,desc:"Sacrificio Obligatorio (Saneamiento+)",cost:0,createdAt:new Date().toISOString()})):a.healthStatus="Cuarentena"}),p=`Saneamiento POSITIVO en ${g}. ${h} sacrificados. Resto (${x.length-h}) en CUARENTENA.`;let a=new Date(s);a.setDate(a.getDate()+15),n.push({id:this.generateUUID(),type:"Revisi√≥n Cuarentena",date:a.toISOString().split("T")[0],animalId:x[0].id,animalCrotal:`${g} (REBA\xd1O)`,desc:`‚ö†Ô∏è Revisi\xf3n Cuarentena: ${g} (15 d\xedas post-positivo)`,actionRequired:"Saneamiento",status:"scheduled",createdAt:new Date().toISOString()})}return n.push({id:this.generateUUID(),type:"Saneamiento",date:s,animalId:x[0]?x[0].id:"FARM_EVENT",animalCrotal:`${g} (General)`,desc:p,completed:!0,status:"completed",createdAt:new Date().toISOString()}),d.write(`animals_${o}`,i),d.write("events",n),{message:"Saneamiento procesado correctamente.",events:n,animals:i}},async handleInsemination(e,a){let{animal:t,date:r,bullBreed:s,desc:l}=e,{events:i,storage:n}=a,o=s?` Toro: ${s}.`:"",d={id:this.generateUUID(),type:"Inseminaci√≥n",animalId:t.id,animalCrotal:t.crotal,date:r,desc:`Inicio Protocolo IA (D\xeda 0): Evaluaci\xf3n + GnRH 1.${o} ${l||""}`,cost:0,status:"completed",createdAt:new Date().toISOString()};return i.push(d),[{day:7,type:"Tratamiento",desc:"Protocolo IA (D√≠a 7): Prostaglandina (PGF2a)"},{day:9,type:"Tratamiento",desc:"Protocolo IA (D√≠a 9): GnRH 2¬™ dosis"},{day:10,type:"Inseminaci√≥n",desc:`Protocolo IA (D\xeda 10): IA a Tiempo Fijo (16-20h tras GnRH).${o}`},{day:35,type:"Revisi√≥n",desc:"Protocolo IA (D√≠a 35): Ecograf√≠a (Diagn√≥stico Gestaci√≥n)"},{day:60,type:"Revisi√≥n",desc:"Protocolo IA (D√≠a 60): Confirmaci√≥n Viabilidad"}].forEach(e=>{let a=new Date(r);a.setDate(a.getDate()+e.day),i.push({id:this.generateUUID(),type:e.type,animalId:t.id,animalCrotal:t.crotal,date:a.toISOString().split("T")[0],desc:e.desc,cost:0,status:"scheduled",createdAt:new Date().toISOString()})}),n.write("events",i),{message:"Protocolo de Inseminaci√≥n iniciado (5 eventos programados).",events:i}},async handleWeighing(e,a){let{animal:t,weight:r,date:s,notes:l}=e,{events:i,animals:n,currentUser:o,storage:d}=a,c=t.currentWeight||0;t.currentWeight=r;let m=i.filter(e=>e.animalId===t.id&&"Pesaje"===e.type);m.sort((e,a)=>new Date(a.date).getTime()-new Date(e.date).getTime());let g=m[0],x=new Date(g?g.date:t.birthDate),p=g?g.weight||c:t.birthWeight||0;!g&&c>0&&(p=c);let h=new Date(s),u=(h.getTime()-x.getTime())/864e5,f=1;u>0&&r>p&&(f=(r-p)/u);let b=S.calculateTHI(20,50),y=M.getBreedByName(t.breed),j=D.inferSystem(t),_=(h.getTime()-new Date(t.birthDate).getTime())/2630016e3,v=y&&({British:"infiltracion",Continental:"crecimiento_magro",Rustic_European:"rustica_adaptada",Dairy:"aptitud_lechera",Indicus:"rustica_adaptada",Composite:"composito"})[y.biological_type]||"rustica_adaptada",N=I.calculateKPITargets({breed:t.breed,sex:t.sex,weight:r,ageMonths:_,functionalType:v},"Engorde",j).energyDensity,w=[9,10,11,0,1].includes(h.getMonth()),C=j.includes("Montanera"),k={isBellota:C&&w,highOleic:C&&w&&(t.farm||"").includes("SOTO"),hasLecithin:C},A=S.estimateCarcassResult({ageMonths:_},r,f,N,b,y||{}),E=S.calculateQualityIndex({ageMonths:_,currentWeight:r,sex:t.sex,rc_percent:A.rc_percent},y||{},N,f,b,150,0,1,k);t.monthlyRecords||(t.monthlyRecords=[]),t.monthlyRecords.push({date:s,weightKg:r,adg:f,rc_est:A.rc_percent,carcass_weight_est:A.carcass_weight,meat_quality_index:E.iq_score,marbling_est:E.marbling_est,diet_energy:N,thi:b}),t.monthlyRecords.length>12&&(t.monthlyRecords=t.monthlyRecords.slice(-12));let R=new Date(s);return R.setDate(R.getDate()+30),i.push({id:this.generateUUID(),type:"Pesaje",animalId:t.id,animalCrotal:t.crotal,date:R.toISOString().split("T")[0],desc:"CONTROL MENSUAL AUTOM√ÅTICO",cost:0,status:"pending",createdAt:new Date().toISOString()}),i.push({id:this.generateUUID(),type:"Pesaje",animalId:t.id,animalCrotal:t.crotal,date:s,desc:`Pesaje: ${r.toFixed(2)}kg. ${l||""}`,weight:r,cost:0,status:"completed",createdAt:new Date().toISOString()}),d.write(`animals_${o}`,n),d.write("events",i),{message:"Pesaje registrado y pr√≥xima revisi√≥n programada.",events:i,animals:n}},async handleStandardEvent(e,a){let{type:t,animal:r,date:s,desc:l,cost:i,nextDate:n,typeData:o}=e,{events:d,animals:c,storage:m,currentUser:g}=a;if(["Sacrificio","Venta","Muerte/Sacrificio","Salida"].includes(t)||t.startsWith("Sacrificio")){let{category:e,carcassWeight:a,price:l,conf:i,fat:n,pricePerKg:d,liveWeight:x,yield:p,seuropConf:h,fatCover:u}=o||{};t.includes("Sacrificio")?r.status="Sacrificado":"Venta"===t?r.status="Vendido":"Muerte"===t?r.status="Muerto":r.status="Baja",r.exitDate=s,e&&(r.actualCategory=e),a&&(r.actualCarcassWeight=parseFloat(a)),x&&(r.actualLiveWeight=parseFloat(x)),p&&(r.actualYield=parseFloat(p)),l&&(r.actualPrice=parseFloat(l)),d?r.actualPricePerKg=parseFloat(d):l&&a&&(r.actualPricePerKg=parseFloat((parseFloat(l)/parseFloat(a)).toFixed(2))),(i||h)&&(r.actualSeuropConf=i||h),(n||u)&&(r.actualSeuropFat=n||u),m.write(`animals_${g}`,c)}else if("Cambio de corral"===t){let{newCorralId:e}=o||{};r.corral=parseInt(e),m.write(`animals_${g}`,c)}else if("Decisi√≥n Macho"===t){let{decision:e}=o||{};if("Castrado"===e){r.sex="Castrado";let e=new Date(r.birth||r.birthDate),a=(new Date(s).getTime()-e.getTime())/2630016e3;a>=6&&a<=9?r.category="Buey":a>9?r.category="Toro":r.category="Ternero Castrado",r.castrationDate=s}else"Semental"===e&&(r.sex="Macho",r.category="Semental",r.isBreeder=!0);m.write(`animals_${g}`,c)}else if("Parto"===t){let{calfCrotal:e,calfSex:a,fatherCrotal:t,birthWeight:l}=o||{},i={id:this.generateUUID(),crotal:e,farmId:r.farmId,farm:r.farm,breed:r.breed||"Desconocida",sex:a,father:t,mother:r.crotal,birthDate:s.split("T")[0],birthWeight:l,currentWeight:l,notes:`Nacido de ${r.crotal}`,createdAt:new Date().toISOString()};c.push(i),m.write(`animals_${g}`,c);let n=new Date;n.setDate(n.getDate()+30),d.push({id:this.generateUUID(),type:"Pesaje",animalId:i.id,animalCrotal:i.crotal,date:n.toISOString().split("T")[0],desc:"CONTROL MENSUAL (1er Mes)",cost:0,status:"pending",createdAt:new Date().toISOString()})}return d.push({id:this.generateUUID(),type:t,animalId:r.id,animalCrotal:r.crotal,date:s,desc:l,cost:i,nextDate:n,completed:"Parto"!==t&&"Pesaje"!==t,status:"completed",createdAt:new Date().toISOString()}),m.write("events",d),{message:"Evento registrado correctamente.",events:d,animals:c}},getUpcomingEvents(e,a=30){if(!e||!Array.isArray(e))return[];let t=new Date,r=new Date;return r.setDate(r.getDate()+a),e.filter(e=>{if("completed"===e.status||e.completed)return!1;let a=new Date(e.date);return a>=t&&a<=r}).sort((e,a)=>new Date(e.date).getTime()-new Date(a.date).getTime())}};function E({onNavigate:e}){let{read:r}=(0,s.useStorage)(),[l,i]=(0,t.useState)(null),[n,o]=(0,t.useState)(!0),[d,c]=(0,t.useState)({males:{},females:{}}),[m,g]=(0,t.useState)([]),[x,p]=(0,t.useState)(0),[h,u]=(0,t.useState)([]);(0,t.useEffect)(()=>{try{let e=r("appSession",""),a=r(`fincas_${e}`,[]);if(u(a),a&&0!==a.length){let e=a[x]||a[0],t=40.4168,r=-3.7038,s=e.name||"General";e.coords&&e.coords.lat&&e.coords.lng&&(t=e.coords.lat,r=e.coords.lng),v.getCurrentWeather(t,r).then(async e=>{let a=await v.getForecast(t,r),l=`https://embed.windy.com/embed2.html?lat=${t}&lon=${r}&width=650&height=450&zoom=8&level=surface&overlay=wind&product=ecmwf&menu=&message=&marker=true&pressure=&type=map&location=coordinates&detail=&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1`;e?i({temp:e.temperature,condition:e.weather_desc,location:s,mapUrl:l,icon:v.getWeatherIcon?v.getWeatherIcon(e.weather_code):"‚õÖ",humidity:e.humidity,wind:e.wind_speed,forecast:a}):i(null),o(!1)}).catch(e=>{console.error("Weather load error:",e),i(null),o(!1)})}else o(!1),i(null);let t=r(`animals_${e}`,[]),s=f(t);c(s);let l=r("events",[]),n=A.getUpcomingEvents(l,30);g(n)}catch(e){}},[r,x]);let f=e=>{let a={Bueyes:0,Toros:0,Utreros:0,Novillos:0,A√±ojos:0,Terneros:0,Becerros:0},t={Nodrizas:0,Vacas:0,Novillas:0,A√±ojas:0,Terneras:0,Becerras:0};return e.forEach(e=>{if(e.status&&["Sacrificado","Muerto","Vendido","Baja","Inactivo","Retirado"].includes(e.status)||e.status&&"Activo"!==e.status)return;let r=e.category;if(!r||"Sin Clasificar"===r){let a=new Date(e.birth||e.birthDate),t=(new Date().getTime()-a.getTime())/2630016e3;r="Macho"===e.sex?t<6?"Becerros":t<12?"Terneros":t<24?"A√±ojos":t<36?"Novillos":t<48?"Utreros":"Toros":t<6?"Becerras":t<12?"Terneras":t<24?"A√±ojas":t<36?"Novillas":"Vacas"}"Castrado"===e.sex&&(r="Buey"),"Macho"===e.sex||"Castrado"===e.sex?void 0!==a[r]?a[r]++:"Buey"===r?a.Bueyes++:void 0!==a[r+"s"]&&a[r+"s"]++:void 0!==t[r]?t[r]++:void 0!==t[r+"s"]&&t[r+"s"]++}),{males:a,females:t}};return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-gray-800",children:"Resumen General"}),(0,a.jsx)("p",{className:"text-gray-600",children:"Vista general de tu operaci√≥n ganadera"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:[(0,a.jsxs)("div",{className:"flex flex-col h-full space-y-2",children:[h.length>0&&(0,a.jsx)("div",{className:"flex space-x-1 overflow-x-auto pb-1",children:h.map((e,t)=>(0,a.jsx)("button",{onClick:()=>{p(t),o(!0)},className:`px-4 py-2 rounded-t-lg text-sm font-medium transition-colors border-t border-l border-r ${x===t?"bg-white text-green-700 border-gray-200 border-b-white z-10 -mb-px shadow-[0_-2px_5px_rgba(0,0,0,0.02)]":"bg-gray-100 text-gray-500 hover:bg-gray_50 border-transparent hover:text-gray-700"}`,children:e.name},e.id||t))}),(l||n)&&(0,a.jsxs)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 h-full flex flex-col justify-between",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("p",{className:"text-gray-500 font-bold text-xs uppercase tracking-wider mb-1",children:["Clima en: ",l?.location||"..."]}),n?(0,a.jsx)("p",{className:"text-sm animate-pulse text-gray-400",children:"Cargando..."}):l?(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsx)("span",{className:"text-4xl",children:l.icon}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("span",{className:"text-4xl font-extrabold block text-gray-800",children:[l.temp,"¬∞C"]}),(0,a.jsx)("span",{className:"text-sm text-gray-500 capitalize font-medium",children:l.condition})]})]}):(0,a.jsx)("p",{className:"text-sm text-gray-400",children:"No disponible"})]}),l&&(0,a.jsxs)("div",{className:"text-right text-xs text-gray-400 font-medium space-y-1 bg-gray-50 px-3 py-2 rounded-lg",children:[(0,a.jsxs)("p",{children:["üíß ",l.humidity,"% Humedad"]}),(0,a.jsxs)("p",{children:["üí® ",l.wind," km/h Viento"]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 border-t border-gray-100 pt-4 flex-1",children:[!n&&l?.mapUrl&&(0,a.jsxs)("div",{className:"h-48 rounded-lg overflow-hidden border border-gray-200 shadow-sm relative group",children:[(0,a.jsx)("div",{className:"absolute top-2 left-2 z-10 bg-white/80 text-gray-700 text-[10px] px-2 py-1 rounded backdrop-blur-md font-bold shadow-sm",children:"üå™Ô∏è Viento vivo"}),(0,a.jsx)("iframe",{src:l.mapUrl,className:"w-full h-full border-none",title:"Windy Weather Map"})]}),!n&&l?.forecast&&(0,a.jsxs)("div",{className:"flex flex-col justify-between h-48",children:[(0,a.jsx)("p",{className:"text-xs font-bold text-gray-400 uppercase tracking-widest mb-2",children:"Pron√≥stico 3 D√≠as"}),(0,a.jsx)("div",{className:"flex-1 flex flex-col gap-2",children:l.forecast.map((e,t)=>(0,a.jsxs)("div",{className:"flex items-center justify-between bg-gray-50 rounded-lg p-3 border border-gray-100 hover:border-gray-300 transition-colors flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("span",{className:"text-xl",children:e.icon}),(0,a.jsx)("span",{className:"text-sm font-bold text-gray-700 capitalize",children:new Date(e.date).toLocaleDateString(void 0,{weekday:"short"})})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[e.precip>0&&(0,a.jsxs)("span",{className:"text-[10px] font-bold text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded-full flex items-center gap-1",children:["‚òî ",e.precip,"mm"]}),(0,a.jsxs)("div",{className:"text-sm font-bold text-gray-800",children:[(0,a.jsxs)("span",{className:"text-gray-900",children:[Math.round(e.max),"¬∞"]}),(0,a.jsx)("span",{className:"mx-1 text-gray-300",children:"/"}),(0,a.jsxs)("span",{className:"text-gray-500",children:[Math.round(e.min),"¬∞"]})]})]})]},t))})]})]})]})]}),(0,a.jsxs)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 h-full",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Distribuci√≥n de Animales"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8 h-full",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"text-blue-600 font-semibold mb-3 border-b border-blue-100 pb-2",children:"Machos"}),(0,a.jsx)("div",{className:"space-y-2 text-sm",children:Object.entries(d.males).map(([e,t])=>(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:e}),(0,a.jsx)("span",{className:"font-bold text-gray-900",children:String(t)})]},e))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"text-pink-600 font-semibold mb-3 border-b border-pink-100 pb-2",children:"Hembras"}),(0,a.jsx)("div",{className:"space-y-2 text-sm",children:Object.entries(d.females).map(([e,t])=>(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:e}),(0,a.jsx)("span",{className:"font-bold text-gray-900",children:String(t)})]},e))})]})]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,a.jsxs)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Acciones R√°pidas"}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("button",{onClick:()=>e?.("animals"),className:"w-full bg-green-50 text-green-700 font-medium py-2 px-4 rounded-lg hover:bg-green-100 transition-colors text-left flex items-center gap-2",children:"Registrar nuevo animal"}),(0,a.jsx)("button",{onClick:()=>e?.("events"),className:"w-full bg-green-50 text-green-700 font-medium py-2 px-4 rounded-lg hover:bg-green-100 transition-colors text-left flex items-center gap-2",children:"Registrar evento sanitario"}),(0,a.jsx)("button",{onClick:()=>e?.("reports"),className:"w-full bg-green-50 text-green-700 font-medium py-2 px-4 rounded-lg hover:bg-green-100 transition-colors text-left flex items-center gap-2",children:"Generar reporte mensual"})]})]}),(0,a.jsxs)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Pr√≥ximos Eventos"}),(0,a.jsx)("div",{className:"space-y-3",children:0===m.length?(0,a.jsx)("p",{className:"text-gray-500 italic text-sm",children:"No hay eventos pr√≥ximos."}):m.map((e,t)=>(0,a.jsxs)("div",{className:"flex items-start gap-3 p-3 bg-gray-50 rounded-lg",children:[(0,a.jsx)("div",{className:"w-2 h-2 mt-2 rounded-full bg-green-500 shrink-0"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-gray-800 text-sm",children:e.type}),(0,a.jsxs)("p",{className:"text-xs text-gray-500",children:[new Date(e.date).toLocaleDateString()," - ",e.animalId||"General"]})]})]},t))})]})]})]})}let R={async fetchParcelData(e,a,t,r){try{let s=`PROVINCIA=${e} AND MUNICIPIO=${a} AND AGREGADO=0 AND ZONA=0 AND POLIGONO=${t} AND PARCELA=${r}`,l=new URLSearchParams({where:s,outFields:"*",returnGeometry:"true",f:"json"}),i=await fetch(`https://sigpac-hubcloud.mapama.es/server/rest/services/SIGPAC/PARCELAS/MapServer/0/query?${l.toString()}`);if(!i.ok)throw Error("SIGPAC API Error");let n=await i.json();if(!n.features||0===n.features.length)return null;let o=n.features[0],d=o.attributes,c=o.geometry,m=0,g=0;if(c&&c.rings&&c.rings.length>0){let e=c.rings[0],a=e[0][0],t=e[0][1];if(t>1e6){let e=function(e,a,t=30){let r=.00669438/.99330562,s=Math.sqrt(.99330562),l=(1-s)/(1+s),i=Math.pow(l,2),n=Math.pow(l,3),o=Math.pow(l,4),d=a/.9996/(6378137*(1-.001673595-1344441707532e-16/64-15000339463446782e-22/256)),c=d+(3*l/2-27*n/32)*Math.sin(2*d)+(21*i/16-55*o/32)*Math.sin(4*d)+151*n/96*Math.sin(6*d)+1097*o/512*Math.sin(8*d),m=r*Math.pow(Math.cos(c),2),g=Math.pow(Math.tan(c),2),x=6378137/Math.sqrt(1-.00669438*Math.pow(Math.sin(c),2)),p=6378137*.99330562/Math.pow(1-.00669438*Math.pow(Math.sin(c),2),1.5),h=(e-5e5)/(.9996*x);return{lat:180*(c-x*Math.tan(c)/p*(Math.pow(h,2)/2-(5+3*g+10*m-4*Math.pow(m,2)-9*r)*Math.pow(h,4)/24+(61+90*g+298*m+45*Math.pow(g,2)-252*r-3*Math.pow(m,2))*Math.pow(h,6)/720))/Math.PI,lon:180*(Math.PI/180*(6*t-183)+(h-(1+2*g+m)*Math.pow(h,3)/6+(5-2*m+28*g-3*Math.pow(m,2)+8*r+24*Math.pow(g,2))*Math.pow(h,5)/120)/Math.cos(c))/Math.PI}}(a,t,30);m=e.lat,g=e.lon}else m=t,g=a}return{provincia:e,municipio:a,poligono:t,parcela:r,area_ha:(d.SUPERFICIE||0)/1e4,use:d.USO_SIGPAC||"PR",slope_avg:d.PENDIENTE_MEDIA||0,irrigation_coef:d.COEF_REGADIO||0,coordinates:0!==m?{lat:m,lon:g}:void 0}}catch(e){return console.error("SigpacService Error:",e),null}}},F=[{code:"01",name:"Araba/√Ålava",community:"Pa√≠s Vasco"},{code:"02",name:"Albacete",community:"Castilla-La Mancha"},{code:"03",name:"Alicante/Alacant",community:"Comunidad Valenciana"},{code:"04",name:"Almer√≠a",community:"Andaluc√≠a"},{code:"05",name:"√Åvila",community:"Castilla y Le√≥n"},{code:"06",name:"Badajoz",community:"Extremadura"},{code:"07",name:"Illes Balears",community:"Illes Balears"},{code:"08",name:"Barcelona",community:"Catalu√±a"},{code:"09",name:"Burgos",community:"Castilla y Le√≥n"},{code:"10",name:"C√°ceres",community:"Extremadura"},{code:"11",name:"C√°diz",community:"Andaluc√≠a"},{code:"12",name:"Castell√≥n/Castell√≥",community:"Comunidad Valenciana"},{code:"13",name:"Ciudad Real",community:"Castilla-La Mancha"},{code:"14",name:"C√≥rdoba",community:"Andaluc√≠a"},{code:"15",name:"A Coru√±a",community:"Galicia"},{code:"16",name:"Cuenca",community:"Castilla-La Mancha"},{code:"17",name:"Girona",community:"Catalu√±a"},{code:"18",name:"Granada",community:"Andaluc√≠a"},{code:"19",name:"Guadalajara",community:"Castilla-La Mancha"},{code:"20",name:"Gipuzkoa",community:"Pa√≠s Vasco"},{code:"21",name:"Huelva",community:"Andaluc√≠a"},{code:"22",name:"Huesca",community:"Arag√≥n"},{code:"23",name:"Ja√©n",community:"Andaluc√≠a"},{code:"24",name:"Le√≥n",community:"Castilla y Le√≥n"},{code:"25",name:"Lleida",community:"Catalu√±a"},{code:"26",name:"La Rioja",community:"La Rioja"},{code:"27",name:"Lugo",community:"Galicia"},{code:"28",name:"Madrid",community:"Comunidad de Madrid"},{code:"29",name:"M√°laga",community:"Andaluc√≠a"},{code:"30",name:"Murcia",community:"Regi√≥n de Murcia"},{code:"31",name:"Navarra",community:"Comunidad Foral de Navarra"},{code:"32",name:"Ourense",community:"Galicia"},{code:"33",name:"Asturias",community:"Principado de Asturias"},{code:"34",name:"Palencia",community:"Castilla y Le√≥n"},{code:"35",name:"Las Palmas",community:"Canarias"},{code:"36",name:"Pontevedra",community:"Galicia"},{code:"37",name:"Salamanca",community:"Castilla y Le√≥n"},{code:"38",name:"Santa Cruz de Tenerife",community:"Canarias"},{code:"39",name:"Cantabria",community:"Cantabria"},{code:"40",name:"Segovia",community:"Castilla y Le√≥n"},{code:"41",name:"Sevilla",community:"Andaluc√≠a"},{code:"42",name:"Soria",community:"Castilla y Le√≥n"},{code:"43",name:"Tarragona",community:"Catalu√±a"},{code:"44",name:"Teruel",community:"Arag√≥n"},{code:"45",name:"Toledo",community:"Castilla-La Mancha"},{code:"46",name:"Valencia/Val√®ncia",community:"Comunidad Valenciana"},{code:"47",name:"Valladolid",community:"Castilla y Le√≥n"},{code:"48",name:"Bizkaia",community:"Pa√≠s Vasco"},{code:"49",name:"Zamora",community:"Castilla y Le√≥n"},{code:"50",name:"Zaragoza",community:"Arag√≥n"},{code:"51",name:"Ceuta",community:"Ceuta"},{code:"52",name:"Melilla",community:"Melilla"}],P=[{id:"1",name:"Arcilloso",texture:"Arcillosa",ph_typical:6,water_retention:"Alta",drainage:"Lento",risks:["Encharcamiento","Agrietamiento en sequ√≠a"],recommended_uses:["Pradera permanente","Pastoreo controlado"],productive_objectives:["Cr√≠a extensiva","Doble prop√≥sito"],indices:{retention:.9,drainage:.2,fertility:.8,risk_waterlogging:.9,risk_drought:.2,risk_erosion:.4}},{id:"2",name:"Arenoso",texture:"Arenosa",ph_typical:5.5,water_retention:"Baja",drainage:"R√°pido",risks:["Sequ√≠a","Lixiviaci√≥n de nutrientes","Erosi√≥n e√≥lica"],recommended_uses:["Cultivos de invierno","Pastoreo invernal"],productive_objectives:["Recr√≠a","Cebo ligero"],indices:{retention:.3,drainage:.9,fertility:.4,risk_waterlogging:.1,risk_drought:.9,risk_erosion:.7}},{id:"3",name:"Franco (Loam)",texture:"Franca",ph_typical:6.5,water_retention:"Media",drainage:"Medio",risks:["Ninguno grave"],recommended_uses:["Policultivo","Ma√≠z forrajero","Alfalfa"],productive_objectives:["Engorde intensivo","Alto rendimiento"],indices:{retention:.6,drainage:.6,fertility:.85,risk_waterlogging:.3,risk_drought:.3,risk_erosion:.3}},{id:"4",name:"Franco-Arcilloso",texture:"Franco-Arcillosa",ph_typical:6.8,water_retention:"Alta",drainage:"Medio-Lento",risks:["Compactaci√≥n"],recommended_uses:["Praderas de alto rendimiento","Cereales"],productive_objectives:["Leche","Cr√≠a intensiva"],indices:{retention:.75,drainage:.45,fertility:.9,risk_waterlogging:.5,risk_drought:.2,risk_erosion:.4}},{id:"5",name:"Franco-Arenoso",texture:"Franco-Arenosa",ph_typical:6.2,water_retention:"Media-Baja",drainage:"R√°pido",risks:["Erosi√≥n","Lavado nutrientes"],recommended_uses:["Hort√≠colas","Leguminosas anuales"],productive_objectives:["Rotaci√≥n r√°pida","Pastoreo estacional"],indices:{retention:.45,drainage:.8,fertility:.6,risk_waterlogging:.2,risk_drought:.7,risk_erosion:.5}}],T={getAllSoils:()=>P,getSoilById:e=>P.find(a=>a.id===e),getRecommendedCrops(e,a,t=0){let r=this.getSoilById(e);if(!r)return[];let s=[];for(let e of[{name:"Trigo Blando",type:"Cereal Invierno",min_precip:450,max_slope:12,ph_min:6,ph_max:8,drainage:["Medio","R√°pido","Medio-Lento"],season:"Oto√±o"},{name:"Cebada",type:"Cereal Invierno",min_precip:350,max_slope:12,ph_min:6,ph_max:8.5,drainage:["Medio","R√°pido"],season:"Oto√±o"},{name:"Avena",type:"Cereal Invierno",min_precip:400,max_slope:15,ph_min:5,ph_max:7.5,drainage:["Medio","Lento","Medio-Lento"],season:"Oto√±o"},{name:"Triticale",type:"Cereal Invierno",min_precip:350,max_slope:15,ph_min:5.5,ph_max:8,drainage:["Medio","Medio-Lento"],season:"Oto√±o"},{name:"Centeno",type:"Cereal Invierno",min_precip:300,max_slope:15,ph_min:5,ph_max:8,drainage:["R√°pido","Medio"],season:"Oto√±o"},{name:"Ray-grass Italiano",type:"Pradera",min_precip:600,max_slope:15,ph_min:5.5,ph_max:7.5,drainage:["Medio","Lento","Medio-Lento"],season:"Oto√±o"},{name:"Festuca Alta",type:"Pradera",min_precip:450,max_slope:15,ph_min:5,ph_max:8,drainage:["Lento","Medio-Lento","Medio"],season:"Oto√±o"},{name:"Alfalfa",type:"Leguminosa",min_precip:500,max_slope:10,ph_min:6.2,ph_max:8.2,drainage:["R√°pido","Medio"],season:"Primavera"},{name:"Vezas",type:"Leguminosa",min_precip:350,max_slope:15,ph_min:5.5,ph_max:8,drainage:["R√°pido","Medio","Medio-Lento"],season:"Oto√±o"},{name:"Tr√©bol Subterr√°neo",type:"Leguminosa",min_precip:400,max_slope:20,ph_min:5,ph_max:6.5,drainage:["Medio","R√°pido","Medio-Lento"],season:"Oto√±o"},{name:"Ma√≠z Forrajero",type:"Cereal Verano",min_precip:300,max_slope:8,ph_min:5.8,ph_max:8,drainage:["Medio","Medio-Lento"],season:"Primavera"},{name:"Sorgo",type:"Cereal Verano",min_precip:250,max_slope:10,ph_min:5.5,ph_max:8.5,drainage:["Medio","R√°pido"],season:"Primavera"}]){let l=[],i=!0;t>e.max_slope&&(i=!1),(r.ph_typical<e.ph_min||r.ph_typical>e.ph_max)&&(i=!1),e.drainage.includes(r.drainage)||(i=!1),a&&a.annualPrecip<e.min_precip&&"Ma√≠z Forrajero"!==e.name&&a.annualPrecip<.7*e.min_precip&&(i=!1),i&&(t>8&&t<=e.max_slope&&l.push("Pendiente l√≠mite"),a&&a.annualPrecip>e.min_precip+200&&l.push("Clima favorable"),"Alfalfa"===e.name&&"R√°pido"===r.drainage&&l.push("Excelente drenaje"),"Festuca Alta"===e.name&&("Lento"===r.drainage||"Medio-Lento"===r.drainage)&&l.push("Tolera suelo pesado"),s.push({crop:e.name,type:`${e.type} (${e.season})`,reason:l.length?l.join(". "):"Condiciones aptas."}))}return t>15&&s.push({crop:"Prado Natural",type:"Pradera",reason:"Pendiente alta: evitar laboreo."}),s},calculateSuitability(e,a){let t=this.getSoilById(e);if(!t)return 0;let r=t.indices;if("Pastoreo"===a){let e=40*r.retention+40*r.drainage+20*r.fertility;return r.risk_waterlogging>.7&&(e-=20),Math.min(100,Math.max(0,e))}return"Cultivo"===a?Math.min(100,60*r.fertility+20*r.drainage+20*r.retention):"Engorde"===a?Math.min(100,70*r.fertility+30*r.drainage):50}};function B(){let e,{read:r,write:l}=(0,s.useStorage)(),[i,n]=(0,t.useState)([]),[o,d]=(0,t.useState)(!1),[c,m]=(0,t.useState)(""),[g,x]=(0,t.useState)(""),[p,h]=(0,t.useState)("45"),[u,f]=(0,t.useState)(""),[b,y]=(0,t.useState)(""),[j,_]=(0,t.useState)(""),[N,w]=(0,t.useState)(""),[C,S]=(0,t.useState)(""),[k,D]=(0,t.useState)(""),[I,A]=(0,t.useState)(""),[E,P]=(0,t.useState)(""),[B,O]=(0,t.useState)([]),[L,$]=(0,t.useState)(""),[z,U]=(0,t.useState)(null),[G,V]=(0,t.useState)(!1),[H,W]=(0,t.useState)({crops:[],breeds:[],f1s:[]}),[q,K]=(0,t.useState)(!1),[Y,Z]=(0,t.useState)(!1),[J,X]=(0,t.useState)(!1),[Q,ee]=(0,t.useState)([]),[ea,et]=(0,t.useState)([]),[er,es]=(0,t.useState)(!1),[el,ei]=(0,t.useState)(null);(0,t.useEffect)(()=>{et(T.getAllSoils().map(e=>({id_suelo:e.id,nombre:e.name})));let e=r("sessionUser","");m(e),n(r(`fincas_${e}`,[]));let a=localStorage.getItem(`farm_draft_${e}`);if(a)try{let t=JSON.parse(a);confirm("Hemos encontrado datos de una finca que no se guard√≥. ¬øQuieres recuperarlos?")?(x(t.newName||""),h(t.provincia||"10"),f(t.municipio||""),y(t.municipioName||""),_(t.poligono||""),w(t.parcela||""),S(t.license||""),D(t.maxHeads||""),A(t.soilId||""),P(t.corrals||""),$(t.feedingSystem||""),d(!0)):localStorage.removeItem(`farm_draft_${e}`)}catch(e){console.error("Error restoring draft",e)}},[r]),(0,t.useEffect)(()=>{c&&o&&(g||C||j||N)&&localStorage.setItem(`farm_draft_${c}`,JSON.stringify({newName:g,provincia:p,municipio:u,municipioName:b,poligono:j,parcela:N,license:C,maxHeads:k,soilId:I,corrals:E,feedingSystem:L}))},[g,p,u,j,N,C,k,I,E,L,o,c]);let[en,eo]=(0,t.useState)([]),[ed,ec]=(0,t.useState)(!1);(0,t.useEffect)(()=>{(async()=>{try{let e=await fetch("/data/municipios.json");if(e.ok){let a=await e.json();eo(a)}}catch(e){console.error("Error loading municipalities",e)}})()},[]),(0,t.useEffect)(()=>{p&&en.length>0?ee(en.filter(e=>e.provincia_id===p).map(e=>({codigo:e.cmun,descripcion:e.nombre})).sort((e,a)=>e.descripcion.localeCompare(a.descripcion))):ee([])},[p,en]),(0,t.useEffect)(()=>{I&&W(em(I,z,el?.slope_avg||(ev?i.find(e=>e.id===ev)?.slope:0)||0))},[I,z]);let em=(e,a,t)=>{let r=T.getRecommendedCrops(e,a,t).map(e=>({nombre_alimento:e.crop,tipo:e.type,reasons:[e.reason]})),s=[M.calculateHybrid("ANG","BRA"),M.calculateHybrid("HER","ANG"),M.calculateHybrid("LIM","RET"),M.calculateHybrid("LIM","MOR"),M.calculateHybrid("CHA","RET")].filter(e=>null!==e),l=M.getAllBreeds(),i=e=>a&&a.avgTemp>25?e.filter(e=>e.heat_tolerance>=7).sort((e,a)=>a.heat_tolerance-e.heat_tolerance).slice(0,3).map(e=>({breed:e.name,reasons:["Alta tolerancia al calor","Adaptaci√≥n"]})):e.filter(e=>e.adg_feedlot>1.2).sort((e,a)=>a.adg_feedlot-e.adg_feedlot).slice(0,3).map(e=>({breed:e.name,reasons:["Alta productividad","Eficiencia"]})),n=i(l),o=i(s);return 0===n.length&&n.push(...l.slice(0,3).map(e=>({breed:e.name,reasons:["Est√°ndar"]}))),0===o.length&&s.length>0&&o.push(...s.slice(0,3).map(e=>({breed:e.name,reasons:["Vigor H√≠brido Est√°ndar"]}))),{crops:r,breeds:n,f1s:o}},eg=async()=>{if(!u||!j||!N)return void alert("Completa los datos de SIGPAC");es(!0);try{let e=await R.fetchParcelData(Number(p),Number(u),Number(j),Number(N));e?(ei(e),k||D(Math.floor(2*e.area_ha).toString()),e.coordinates?ey(e.coordinates.lat,e.coordinates.lon):ey(39.4,-6),alert(`‚úÖ Parcela Localizada: ${e.area_ha.toFixed(2)} ha - Uso: ${e.use}`)):alert("No se encontr√≥ la parcela en SIGPAC")}catch(e){console.error(e),alert("Error consultando SIGPAC")}finally{es(!1)}},[ex,ep]=(0,t.useState)("public"),[eh,eu]=(0,t.useState)(""),[ef,eb]=(0,t.useState)(""),ey=async(e,a)=>{V(!0);try{if("private"===ex&&eh)alert(`Conectando a estaci\xf3n privada en: ${eh}... (Simulaci\xf3n)`),U({avgTemp:16.5,classification:"Clima Local (Estaci√≥n)",annualPrecip:550});else{let t=await v.analyzeClimate(e,a);t&&U(t)}}catch(e){console.error(e)}finally{V(!1)}},[ej,e_]=(0,t.useState)(null),[ev,eN]=(0,t.useState)(null),[ew,eC]=(0,t.useState)({}),eS=e=>{let a=r(`animals_${c}`,[]).filter(a=>a.farm===e.name&&(!a.status||"Activo"===a.status)).length,t=a/(e.maxHeads||1)*100,s="bg-green-500";return t>=100?s="bg-red-500":t>90&&(s="bg-yellow-500"),{current:a,pct:t,color:s}};return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-gray-800",children:"Mis Fincas"}),(0,a.jsx)("p",{className:"text-gray-600",children:"Gesti√≥n de parcelas y terrenos"})]}),(0,a.jsx)("button",{onClick:()=>{eN(null),x(""),S(""),D(""),A(""),P(""),O([]),$(""),U(null),W({crops:[],breeds:[]}),d(!0)},className:"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors",children:o?"Cancelar":"Nueva Finca"})]}),o&&(0,a.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-in fade-in slide-in-from-top-4",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Registrar Finca (SIGPAC)"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4",children:[(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre Finca *"}),(0,a.jsx)("input",{type:"text",value:g,onChange:e=>x(e.target.value),className:`w-full border rounded-lg px-3 py-2 ${ew.name?"border-red-500 bg-red-50":""}`,placeholder:"Ej: La Dehesa"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"N¬∫ Licencia REGA *"}),(0,a.jsx)("input",{type:"text",value:C,onChange:e=>S(e.target.value),className:`w-full border rounded-lg px-3 py-2 ${ew.license?"border-red-500 bg-red-50":""}`,placeholder:"ES..."})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cabezas M√°ximas *"}),(0,a.jsx)("input",{type:"number",value:k,onChange:e=>D(e.target.value),className:`w-full border rounded-lg px-3 py-2 ${ew.maxHeads?"border-red-500 bg-red-50":""}`,placeholder:"Ej: 150"})]})]}),(0,a.jsxs)("div",{className:"space-y-4 mb-6 pt-4 border-t border-gray-100",children:[(0,a.jsx)("h4",{className:"font-semibold text-gray-800 text-sm",children:"Ubicaci√≥n (SIGPAC)"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Provincia"}),(0,a.jsxs)("select",{value:p,onChange:e=>{h(e.target.value),f("")},className:"w-full border rounded-lg px-3 py-2 bg-white focus:border-green-500 focus:outline-none",children:[(0,a.jsx)("option",{value:"",children:"Seleccione Provincia"}),F.map(e=>(0,a.jsx)("option",{value:e.code,children:e.name},e.code))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Municipio"}),(0,a.jsxs)("select",{value:u,onChange:e=>{f(e.target.value);let a=Q.find(a=>a.codigo==e.target.value);a&&y(a.descripcion)},className:"w-full border rounded-lg px-3 py-2 bg-white focus:border-green-500 focus:outline-none",disabled:!p,children:[(0,a.jsx)("option",{value:"",children:"Seleccione Municipio"}),Q.map(e=>(0,a.jsx)("option",{value:e.codigo,children:e.descripcion},e.codigo))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Pol√≠gono"}),(0,a.jsx)("input",{type:"text",value:j,onChange:e=>_(e.target.value),className:"w-full border rounded-lg px-3 py-2 focus:border-green-500 focus:outline-none",placeholder:"0"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Parcela"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{type:"text",value:N,onChange:e=>w(e.target.value),className:"w-full border rounded-lg px-3 py-2 focus:border-green-500 focus:outline-none",placeholder:"0"}),(0,a.jsx)("button",{onClick:eg,disabled:er,className:"bg-green-600 text-white px-4 rounded-lg hover:bg-green-700 font-medium transition-colors border border-green-700 shadow-sm",children:er?"...":"Buscar"})]})]})]})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tipo de Suelo *"}),(0,a.jsxs)("select",{value:I,onChange:e=>A(e.target.value),className:`w-full border rounded-lg px-3 py-2 bg-white ${ew.soilId?"border-red-500 bg-red-50":""}`,children:[(0,a.jsx)("option",{value:"",children:"Selecciona Suelo"}),ea.map(e=>(0,a.jsx)("option",{value:e.id_suelo,children:e.nombre},e.id_suelo))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Sistema Alimentaci√≥n *"}),(0,a.jsxs)("select",{value:L,onChange:e=>$(e.target.value),className:`w-full border rounded-lg px-3 py-2 bg-white ${ew.feedingSystem?"border-red-500 bg-red-50":""}`,children:[(0,a.jsx)("option",{value:"",children:"Selecciona..."}),(0,a.jsx)("option",{value:"extensivo",children:"Extensivo (Pastoreo)"}),(0,a.jsx)("option",{value:"intensivo",children:"Intensivo (Cebadero)"}),(0,a.jsx)("option",{value:"mixto",children:"Mixto (Suplementaci√≥n)"}),(0,a.jsx)("option",{value:"ecologico",children:"Ecol√≥gico"})]})]}),(0,a.jsxs)("div",{className:"flex gap-4",children:[(0,a.jsxs)("div",{className:"w-1/3",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"N¬∫ Corrales"}),(0,a.jsx)("input",{type:"number",value:E,onChange:e=>{let a=e.target.value;P(a);let t=parseInt(a)||0;O(e=>{let a=[...e];if(t>a.length)for(let e=a.length;e<t;e++)a.push(`Corral ${e+1}`);else a.length=t;return a})},className:"w-full border rounded-lg px-3 py-2",placeholder:"0"})]}),(0,a.jsx)("div",{className:"flex-1",children:B.length>0&&(0,a.jsxs)("div",{className:"bg-gray-50 rounded border border-gray-100 p-2 max-h-40 overflow-y-auto",children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-2",children:"Nombres"}),(0,a.jsx)("div",{className:"space-y-2",children:B.map((e,t)=>(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("span",{className:"text-xs text-gray-400 w-6",children:["#",t+1]}),(0,a.jsx)("input",{type:"text",value:e,onChange:e=>{let a=[...B];a[t]=e.target.value,O(a)},className:"flex-1 text-xs border rounded px-2 py-1 focus:ring-1 focus:ring-green-500 outline-none"})]},t))})]})})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 items-start",children:[(0,a.jsxs)("div",{className:"border border-green-200 bg-green-50 p-3 rounded-lg flex flex-col h-full",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"font-semibold text-green-900 text-sm mb-3",children:"Datos Clim√°ticos"}),(0,a.jsxs)("div",{className:"space-y-2 mb-3",children:[(0,a.jsxs)("label",{className:"flex items-center gap-2 text-sm text-green-800 cursor-pointer",children:[(0,a.jsx)("input",{type:"radio",name:"climateSource",defaultChecked:!0,className:"text-green-600 focus:ring-green-500"}),"API P√∫blica"]}),(0,a.jsxs)("label",{className:"flex items-center gap-2 text-sm text-green-800/50 cursor-not-allowed",children:[(0,a.jsx)("input",{type:"radio",name:"climateSource",disabled:!0}),"Estaci√≥n Propia"]})]})]}),(0,a.jsx)("div",{className:"text-sm text-green-800 pt-3 border-t border-green-200/50",children:p&&u?(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsxs)("p",{className:"flex justify-between",children:[(0,a.jsx)("span",{children:"Media:"})," ",(0,a.jsx)("strong",{children:"15.4¬∞C"})]}),(0,a.jsxs)("p",{className:"flex justify-between",children:[(0,a.jsx)("span",{children:"Clima:"})," ",(0,a.jsx)("strong",{children:"Templado Seco"})]}),(0,a.jsxs)("p",{className:"flex justify-between",children:[(0,a.jsx)("span",{children:"Precip:"})," ",(0,a.jsx)("strong",{children:"431mm"})]})]}):(0,a.jsx)("p",{className:"text-green-600 italic",children:"Selecciona ubicaci√≥n..."})})]}),(0,a.jsxs)("div",{className:"border border-orange-200 bg-orange-50 p-3 rounded-lg flex flex-col h-full",children:[(0,a.jsx)("h4",{className:"font-semibold text-orange-900 text-sm mb-3",children:"Razas Puras"}),H.breeds.length>0?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("ul",{className:"text-sm space-y-3 flex-1",children:H.breeds.slice(0,q?void 0:3).map((e,t)=>(0,a.jsxs)("li",{className:"text-orange-900 pb-2 border-b border-orange-200/50 last:border-0 last:pb-0",children:[(0,a.jsx)("strong",{className:"text-orange-900 block",children:e.breed}),(0,a.jsxs)("span",{className:"text-[11px] text-orange-700",children:["(",e.reasons.join(", ").replace("(GMD)",""),")"]})]},t))}),H.breeds.length>3&&(0,a.jsx)("button",{onClick:()=>K(!q),className:"text-[11px] text-orange-700 font-medium hover:text-orange-900 mt-2 text-center w-full pt-2 border-t border-orange-200/50",children:q?"Ver menos":`Ver ${H.breeds.length-3} m\xe1s...`})]}):(0,a.jsx)("p",{className:"text-sm text-orange-400 italic",children:"Completa datos..."})]}),(0,a.jsxs)("div",{className:"border border-amber-200 bg-amber-50 p-3 rounded-lg flex flex-col h-full",children:[(0,a.jsx)("h4",{className:"font-semibold text-amber-900 text-sm mb-3",children:"Cruces F1"}),H.f1s&&H.f1s.length>0?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("ul",{className:"text-sm space-y-3 flex-1",children:H.f1s.slice(0,Y?void 0:3).map((e,t)=>(0,a.jsxs)("li",{className:"text-amber-900 pb-2 border-b border-amber-200/50 last:border-0 last:pb-0",children:[(0,a.jsx)("strong",{className:"text-amber-900 block",title:e.breed,children:e.breed}),(0,a.jsxs)("span",{className:"text-[11px] text-amber-700",children:["(",e.reasons.join(", "),")"]})]},t))}),H.f1s.length>3&&(0,a.jsx)("button",{onClick:()=>Z(!Y),className:"text-[11px] text-amber-700 font-medium hover:text-amber-900 mt-2 text-center w-full pt-2 border-t border-amber-200/50",children:Y?"Ver menos":`Ver ${H.f1s.length-3} m\xe1s...`})]}):(0,a.jsx)("p",{className:"text-sm text-amber-400 italic",children:"Calculando..."})]}),(0,a.jsxs)("div",{className:"border border-emerald-200 bg-emerald-50 p-3 rounded-lg flex flex-col h-full",children:[(0,a.jsx)("h4",{className:"font-semibold text-emerald-900 text-sm mb-3",children:"Cultivos"}),H.crops.length>0?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("ul",{className:"text-sm space-y-3 flex-1",children:H.crops.slice(0,J?void 0:3).map((e,t)=>(0,a.jsxs)("li",{className:"text-emerald-900 pb-2 border-b border-emerald-200/50 last:border-0 last:pb-0",children:[(0,a.jsx)("strong",{className:"text-emerald-900 block",children:e.nombre_alimento}),(0,a.jsxs)("span",{className:"text-[11px] text-emerald-700",children:["(",e.tipo,")"]})]},t))}),H.crops.length>3&&(0,a.jsx)("button",{onClick:()=>X(!J),className:"text-[11px] text-emerald-700 font-medium hover:text-emerald-900 mt-2 text-center w-full pt-2 border-t border-emerald-200/50",children:J?"Ver menos":`Ver ${H.crops.length-3} m\xe1s...`})]}):(0,a.jsx)("p",{className:"text-sm text-emerald-400 italic",children:"Completa datos..."})]})]})]}),(0,a.jsxs)("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[(0,a.jsx)("button",{onClick:()=>d(!1),className:"text-gray-600 hover:text-gray-800 font-medium px-4",children:"Cancelar"}),(0,a.jsx)("button",{onClick:()=>{var e;let a,t={};if(g||(t.name=!0),C||(t.license=!0),I||(t.soilId=!0),k||(t.maxHeads=!0),L||(t.feedingSystem=!0),Object.keys(t).length>0){eC(t),alert("Por favor, completa todos los campos obligatorios marcados en rojo.");return}let r=0,s=[];el&&(r=(s=!(e=el)?[]:!e.recintos||0===e.recintos.length?e.area_ha?[{usage:e.use||"PR",area:Math.round(1e4*e.area_ha),dn_oid:0}]:[]:e.recintos.map(e=>({usage:e.uso,area:1e4*e.superficie,dn_oid:0}))).reduce((e,a)=>e+(a.area||0),0),el.lat&&el.lon&&(a={lat:el.lat,lng:el.lon}));let o=Q.find(e=>e.codigo==u||e.codigo==parseInt(u)),m=o?o.descripcion:b,h={id:ev||("undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():`farm-${Date.now()}`),name:g,municipio:m,municipioCode:u,provinciaCode:p,poligono:j,parcela:N,superficie:r||ev&&i.find(e=>e.id===ev)?.superficie||0,recintos:s.length?s:ev&&i.find(e=>e.id===ev)?.recintos||[],coords:a||(ev?i.find(e=>e.id===ev)?.coords:void 0),slope:el?.slope_avg||(ev?i.find(e=>e.id===ev)?.slope:0),license:C,maxHeads:Number(k),soilId:I,corrals:Number(E),corralNames:B,feedingSystem:L,climateStudy:z,cropsRecommendation:H.crops,breedsRecommendation:H.breeds,f1Recommendation:H.f1s},v=ev?i.map(e=>e.id===ev?h:e):[...i,h];n(v),l(`fincas_${c}`,v),x(""),S(""),D(""),A(""),P(""),O([]),$(""),U(null),W({crops:[],breeds:[]}),eC({}),f(""),y(""),_(""),w(""),ei(null),d(!1),eN(null),localStorage.removeItem(`farm_draft_${c}`),alert(ev?"‚úÖ Finca actualizada correctamente":"‚úÖ Finca guardada correctamente")},className:"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg",children:"Guardar Finca Completa"})]})]}),ej&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4",children:(0,a.jsx)("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:(0,a.jsxs)("div",{className:"p-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:ej.name}),(0,a.jsxs)("p",{className:"text-gray-500 text-sm",children:["Licencia: ",ej.license]})]}),(0,a.jsx)("button",{onClick:()=>e_(null),className:"text-gray-400 hover:text-gray-600",children:"‚úï"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-6 text-sm",children:[(0,a.jsxs)("div",{className:"bg-gray-50 p-3 rounded",children:[(0,a.jsx)("p",{className:"text-gray-500 text-xs uppercase mb-1",children:"Ubicaci√≥n"}),(0,a.jsx)("p",{className:"font-medium",children:ej.municipio}),(0,a.jsxs)("p",{children:["Pol√≠gono ",ej.poligono," / Parcela ",ej.parcela]})]}),(0,a.jsxs)("div",{className:"bg-gray-50 p-3 rounded",children:[(0,a.jsx)("p",{className:"text-gray-500 text-xs uppercase mb-1",children:"Superficie"}),(0,a.jsxs)("p",{className:"font-medium text-lg",children:[Number(ej.superficie/1e4).toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:4})," ha"]})]}),(0,a.jsxs)("div",{className:"bg-gray-50 p-3 rounded",children:[(0,a.jsx)("p",{className:"text-gray-500 text-xs uppercase mb-1",children:"Capacidad"}),(0,a.jsxs)("p",{className:"font-medium",children:[eS(ej).current," / ",ej.maxHeads," cabezas"]}),(0,a.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-1.5 mt-2",children:(0,a.jsx)("div",{className:`${eS(ej).color} h-1.5 rounded-full`,style:{width:`${Math.min(eS(ej).pct,100)}%`}})})]}),(0,a.jsxs)("div",{className:"bg-gray-50 p-3 rounded",children:[(0,a.jsx)("p",{className:"text-gray-500 text-xs uppercase mb-1",children:"Suelo / Sistema"}),(0,a.jsx)("p",{className:"text-sm font-medium text-gray-900",children:ea.find(e=>e.id_suelo===ej.soilId)?.nombre||"Desconocido"}),(0,a.jsx)("p",{className:"text-sm font-medium text-gray-900 capitalize",children:ej.feedingSystem||"No definido"})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 items-start",children:[ej.climateStudy&&(0,a.jsxs)("div",{className:"border border-green-200 bg-green-50 p-3 rounded-lg flex flex-col h-full",children:[(0,a.jsx)("h4",{className:"font-semibold text-green-900 text-sm mb-3",children:"Datos Clim√°ticos"}),(0,a.jsxs)("div",{className:"space-y-1 text-sm text-green-800",children:[(0,a.jsxs)("p",{className:"flex justify-between",children:[(0,a.jsx)("span",{children:"Clima:"})," ",(0,a.jsx)("strong",{children:ej.climateStudy.classification})]}),(0,a.jsxs)("p",{className:"flex justify-between",children:[(0,a.jsx)("span",{children:"Media:"})," ",(0,a.jsxs)("strong",{children:[ej.climateStudy.avgTemp,"¬∞C"]})]}),(0,a.jsxs)("p",{className:"flex justify-between",children:[(0,a.jsx)("span",{children:"Precip:"})," ",(0,a.jsxs)("strong",{children:[ej.climateStudy.annualPrecip,"mm"]})]})]})]}),ej.breedsRecommendation&&(0,a.jsxs)("div",{className:"border border-orange-200 bg-orange-50 p-3 rounded-lg flex flex-col h-full",children:[(0,a.jsx)("h4",{className:"font-semibold text-orange-900 text-sm mb-3",children:"Razas Puras"}),(0,a.jsx)("ul",{className:"text-sm space-y-2",children:ej.breedsRecommendation.slice(0,3).map((e,t)=>(0,a.jsxs)("li",{className:"text-orange-900 pb-1 border-b border-orange-200/50 last:border-0",children:[(0,a.jsx)("strong",{className:"text-orange-900 block",children:e.breed}),(0,a.jsxs)("span",{className:"text-[11px] text-orange-700",children:["(",e.reasons?e.reasons[0].replace("(GMD)",""):"",")"]})]},t))})]}),(0,a.jsxs)("div",{className:"border border-amber-200 bg-amber-50 p-3 rounded-lg flex flex-col h-full",children:[(0,a.jsx)("h4",{className:"font-semibold text-amber-900 text-sm mb-3",children:"Cruces F1"}),(e=ej.f1Recommendation&&ej.f1Recommendation.length>0?ej.f1Recommendation:ej.climateStudy?em(ej.soilId,ej.climateStudy,ej.slope||0).f1s:[]).length>0?(0,a.jsx)("ul",{className:"text-sm space-y-2",children:e.slice(0,3).map((e,t)=>(0,a.jsxs)("li",{className:"text-amber-900 pb-1 border-b border-amber-200/50 last:border-0",children:[(0,a.jsx)("strong",{className:"text-amber-900 block",children:e.breed}),(0,a.jsxs)("span",{className:"text-[11px] text-amber-700",children:["(",e.reasons?e.reasons.join(", "):"",")"]})]},t))}):(0,a.jsx)("p",{className:"text-sm text-amber-600/70 italic",children:"No calculados"})]}),ej.cropsRecommendation&&(0,a.jsxs)("div",{className:"border border-emerald-200 bg-emerald-50 p-3 rounded-lg flex flex-col h-full",children:[(0,a.jsx)("h4",{className:"font-semibold text-emerald-900 text-sm mb-3",children:"Cultivos"}),(0,a.jsx)("ul",{className:"text-sm space-y-2",children:ej.cropsRecommendation.slice(0,3).map((e,t)=>(0,a.jsxs)("li",{className:"text-emerald-900 pb-1 border-b border-emerald-200/50 last:border-0",children:[(0,a.jsx)("strong",{className:"text-emerald-900 block",children:e.nombre_alimento}),(0,a.jsxs)("span",{className:"text-[11px] text-emerald-700",children:["(",e.tipo,")"]})]},t))})]})]}),(0,a.jsxs)("div",{className:"flex justify-end gap-3 mt-8 pt-4 border-t",children:[r("users",[]).find(e=>e.name===c)?.role==="admin"&&(0,a.jsx)("button",{onClick:()=>(e=>{if(confirm("¬øEst√°s seguro de que quieres eliminar esta finca? Esta acci√≥n no se puede deshacer.")){let a=i.filter(a=>a.id!==e);n(a),l(`fincas_${c}`,a),e_(null)}})(ej.id),className:"px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition-colors",children:"Eliminar Finca"}),(0,a.jsx)("button",{onClick:()=>{eN(ej.id),x(ej.name),S(ej.license||""),h(ej.provinciaCode||""),f(ej.municipioCode||""),y(ej.municipio||""),_(ej.poligono||""),w(ej.parcela||""),A(ej.soilId||""),D(ej.maxHeads?.toString()||""),P(ej.corrals?.toString()||""),O(ej.corralNames||Array.from({length:ej.corrals||0},(e,a)=>`Corral ${a+1}`)),$(ej.feedingSystem||""),ej.climateStudy&&U(ej.climateStudy),ej.cropsRecommendation&&W({crops:ej.cropsRecommendation,breeds:ej.breedsRecommendation||[]}),e_(null),d(!0)},className:"px-6 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors shadow-sm",children:"Editar Informaci√≥n"})]})]})})}),(0,a.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:i.map(e=>{let t=eS(e);return(0,a.jsxs)("div",{onClick:()=>e_(e),className:"cursor-pointer bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-lg transition-all transform hover:-translate-y-1 group",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,a.jsx)("h3",{className:"text-xl font-bold text-gray-800 group-hover:text-green-700 transition-colors",children:e.name}),(0,a.jsx)("span",{className:"text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded",children:e.license||"Sin Licencia"})]}),(0,a.jsxs)("div",{className:"text-sm text-gray-600 space-y-2 mb-4",children:[(0,a.jsxs)("p",{children:[e.municipio," (",Number(e.superficie/1e4).toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:4})," ha)"]}),(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsxs)("div",{className:"flex justify-between text-xs",children:[(0,a.jsxs)("span",{children:["Capacidad (",t.current,"/",e.maxHeads,")"]}),(0,a.jsxs)("span",{className:t.pct>=100?"text-red-600 font-bold":"text-gray-500",children:[t.pct.toFixed(0),"%"]})]}),(0,a.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,a.jsx)("div",{className:`${t.color} h-2 rounded-full`,style:{width:`${Math.min(t.pct,100)}%`}})}),t.pct>=100&&(0,a.jsx)("p",{className:"text-xs text-red-600 font-bold",children:"Exceso de capacidad"})]}),(0,a.jsxs)("p",{className:"text-xs text-gray-500",children:["Suelo: ",ea.find(a=>a.id_suelo===e.soilId)?.nombre||"Desconocido",e.climateStudy&&` | Clima: ${e.climateStudy.classification}`]})]}),(0,a.jsx)("div",{className:"text-center text-xs text-green-600 font-medium opacity-0 group-hover:opacity-100 transition-opacity",children:"Ver Ficha Completa ‚Üí"})]},e.id)})})]})}let O={clamp:(e,a,t)=>Math.min(Math.max(e,a),t),norm(e,a,t){return this.clamp((e-a)/(t-a),0,1)},calculateCarcass(e,a,t,r,s,l={}){let i={...t};l.fatherBreed&&l.motherBreed&&l.fatherBreed.name!==l.motherBreed.name&&(i.conformation_potential=(l.fatherBreed.conformation_potential+l.motherBreed.conformation_potential)/2,i.marbling_potential=(l.fatherBreed.marbling_potential+l.motherBreed.marbling_potential)/2,i.yield_potential=((l.fatherBreed.yield_potential||.58)+(l.motherBreed.yield_potential||.58))/2,l.motherBreed.marbling_potential>=4&&(i.marbling_potential+=.5),l.motherBreed.milk_potential>=4&&(i.conformation_potential=(i.conformation_potential||3)+.3),l.motherBreed.milk_potential<=1&&(i.conformation_potential=(i.conformation_potential||3)-.2),i.yield_potential=(i.yield_potential||.58)+.01);let n=i.yield_potential||.53;i.yield_potential||("AZB"===t.code?n=.63:"LIM"===t.code||"BDA"===t.code?n=.59:"CHA"===t.code?n=.58:("ANG"===t.code||"HER"===t.code)&&(n=.55)),"Macho"===l.sex&&(n+=.01),"Hembra"===l.sex&&(n-=.02),("Castrado"===l.sex||l.isOx)&&(n-=.01);let o=.012*this.norm(r,1.5,3),d=.01*this.norm(a,12,36),c=l.synergyBonuses?l.synergyBonuses.yield_percent/100:0,m=n+o+d+c;console.log("[CarcassEngine] Yield Calc:",{baseYield:n,energyFactor:o,ageFactor:d,synergyYield:c,rc:m,breedCode:t.code}),m=this.clamp(m,.45,.7);let g=i.marbling_potential||1;if(g+=2*this.norm(r,1.6,3),g*=.5+.5*this.norm(e,300,600),l.isBellota&&(g+=.8),l.synergyBonuses?.marbling&&(g+=l.synergyBonuses.marbling),void 0!==l.currentMonth){let e=l.currentMonth;e>=5&&e<=8&&5>(i.heat_tolerance||5)&&(g-=.5)}("Castrado"===l.sex||l.isOx)&&(g+=.5,a>36&&(g+=.3));let x=Math.round(1+((g=Math.max(1,g))-1)*2.2);x=this.clamp(x,1,12);let p=this.clamp(g,1,5),h=i.conformation_potential||3;if(h+=1.5*this.norm(r,1.8,2.8),void 0!==l.currentMonth){let e=l.currentMonth,a=i.heat_tolerance||5;e>=5&&e<=8&&(a>=8&&(h+=.3),a<=3&&(h-=.5))}"Macho"===l.sex&&(h+=.5),"Hembra"===l.sex&&"AZB"!==t.code&&(h-=.5),("Castrado"===l.sex||l.isOx)&&(h+=0);let u=e/(("Hembra"===l.sex?i.weight_female_adult:i.weight_male_adult)||600);u<.75||u>1.15&&(r>2.75?h-=Math.min(2*(u-1.15),1):h+=.5);let f=["P","O","R","U","E","S"][(h=Math.min(Math.max(h=Math.round(h),1),6))-1]||"R";return{rc_est:parseFloat(m.toFixed(4)),rc_percent:parseFloat((100*m).toFixed(2)),carcass_weight:parseFloat((e*m).toFixed(1)),marbling_score:parseFloat(p.toFixed(1)),bms:this.clamp(x,1,12),conformation:f,synergy_bonus_applied:l.synergyBonuses?.marbling||0,is_premium:h>=4&&x>=5}}},L=[{id:"F01",name:"Pasto Natural",category:"Forraje",dm_percent:22,energy_mcal:1.28,protein_percent:13,fiber_percent:45,cost_per_kg:.12,description:"Mantenimiento y recr√≠a"},{id:"F02",name:"Pasto Mejorado (Ryegrass)",category:"Forraje",dm_percent:23,energy_mcal:1.35,protein_percent:15,fiber_percent:45,cost_per_kg:.12,description:"Recr√≠a y crecimiento"},{id:"F03",name:"Heno de Pradera",category:"Forraje",dm_percent:88,energy_mcal:1.1,protein_percent:10,fiber_percent:60,cost_per_kg:.12,description:"Mantenimiento"},{id:"F04",name:"Heno de Alfalfa",category:"Forraje",dm_percent:89,energy_mcal:1.25,protein_percent:18,fiber_percent:45,cost_per_kg:.12,description:"Recr√≠a y lactaci√≥n. Alto calcio"},{id:"F05",name:"Ensilado de Ma√≠z",category:"Forraje",dm_percent:35,energy_mcal:1.6,protein_percent:8,fiber_percent:49,cost_per_kg:.12,description:"Engorde. Alto aporte energ√©tico"},{id:"paja",name:"Paja de Cereal",category:"Forraje",dm_percent:90,energy_mcal:.6,protein_percent:3,fiber_percent:75,cost_per_kg:.05,description:"Fibra efectiva"},{id:"BELLHO_01",name:"Bellota (Dehesa)",category:"Forraje",dm_percent:62,energy_mcal:2.2,protein_percent:6,fiber_percent:22,cost_per_kg:.1,description:"Acabado extensivo estacional. Alta en √°cido oleico"},{id:"C01",name:"Ma√≠z Grano",category:"Concentrado",dm_percent:89,energy_mcal:2.05,protein_percent:9,fiber_percent:12,cost_per_kg:.25,description:"ADG y marmoleo"},{id:"C02",name:"Cebada",category:"Concentrado",dm_percent:88,energy_mcal:1.95,protein_percent:11,fiber_percent:18,cost_per_kg:.25,description:"Engorde seguro"},{id:"C03",name:"Trigo",category:"Concentrado",dm_percent:88,energy_mcal:2,protein_percent:12,fiber_percent:10,cost_per_kg:.25,description:"Engorde r√°pido. Peligro de acidosis"},{id:"C04",name:"DDGS (Ma√≠z)",category:"Concentrado",dm_percent:90,energy_mcal:2.05,protein_percent:28,fiber_percent:32,cost_per_kg:.25,description:"Sustituto de cereal"},{id:"C05",name:"Pulpa de Remolacha",category:"Concentrado",dm_percent:90,energy_mcal:1.7,protein_percent:10,fiber_percent:40,cost_per_kg:.25,description:"Mejora digestibilidad"},{id:"C06",name:"Cascarilla de Soja",category:"Concentrado",dm_percent:90,energy_mcal:1.4,protein_percent:14,fiber_percent:60,cost_per_kg:.25,description:"Fuente de fibra"},{id:"triticale",name:"Triticale",category:"Concentrado",dm_percent:88,energy_mcal:1.85,protein_percent:12,fiber_percent:14,cost_per_kg:.24},{id:"avena",name:"Avena",category:"Concentrado",dm_percent:89,energy_mcal:1.7,protein_percent:11,fiber_percent:28,cost_per_kg:.22},{id:"P01",name:"Harina de Soja 47%",category:"Concentrado",dm_percent:88,energy_mcal:1.9,protein_percent:47,fiber_percent:15,cost_per_kg:.42,description:"Construcci√≥n muscular"},{id:"P02",name:"Colza",category:"Concentrado",dm_percent:90,energy_mcal:1.7,protein_percent:38,fiber_percent:13,cost_per_kg:.42,description:"Sustituto de soja eficiente"},{id:"P03",name:"Guisante Proteico",category:"Concentrado",dm_percent:88,energy_mcal:1.6,protein_percent:24,fiber_percent:20,cost_per_kg:.42,description:"Recr√≠a joven. Producci√≥n KM0"},{id:"P04",name:"Urea (NNP)",category:"Suplemento",dm_percent:100,energy_mcal:0,protein_percent:281,fiber_percent:0,cost_per_kg:.42,description:"Solo animales >8 meses"},{id:"S01",name:"N√∫cleo Mineral",category:"Suplemento",dm_percent:100,energy_mcal:0,protein_percent:0,fiber_percent:0,cost_per_kg:.8,description:"Salud general"},{id:"S02",name:"Premezcla de Engorde",category:"Suplemento",dm_percent:95,energy_mcal:0,protein_percent:12,fiber_percent:0,cost_per_kg:.8,description:"Mejorar FCR"},{id:"S03",name:"Vitaminas ADE",category:"Suplemento",dm_percent:100,energy_mcal:0,protein_percent:0,fiber_percent:0,cost_per_kg:.8,description:"Salud inmunitaria"},{id:"S04",name:"Corrector de Acidosis",category:"Suplemento",dm_percent:100,energy_mcal:0,protein_percent:0,fiber_percent:0,cost_per_kg:.8,description:"Estabilidad ruminal"},{id:"pienso_eco",name:"Pienso Eco Certificado",category:"Ecol√≥gico",dm_percent:90,energy_mcal:1.9,protein_percent:13,fiber_percent:14,cost_per_kg:.58,is_ecological:!0},{id:"guisante_eco",name:"Guisante Eco",category:"Ecol√≥gico",dm_percent:90,energy_mcal:1.8,protein_percent:22,fiber_percent:6,cost_per_kg:.45,is_ecological:!0}];function $({animal:e,onClose:r,fatherBreed:s,motherBreed:l}){let[i,n]=(0,t.useState)([]),[o,d]=(0,t.useState)(L),[c,m]=(0,t.useState)(""),[g,x]=(0,t.useState)("ENCINA"),[p,h]=(0,t.useState)(null),[u,f]=(0,t.useState)([]),[b,y]=(0,t.useState)([]),[j,_]=(0,t.useState)(null),[v,N]=(0,t.useState)(0),w=(e,a=2)=>e?e.toFixed(a):"0";(0,t.useEffect)(()=>{C()},[i,e,g]);let C=()=>{let a=0,t=0,r=0,n=0,o=0,d=0,c=[],m=!1;i.forEach(e=>{let s=e.kg_as_fed,l=s*(e.feed.dm_percent/100);a+=s,t+=l,r+=e.feed.energy_mcal*l,n+=e.feed.protein_percent/100*l*1e3,o+=e.feed.fiber_percent/100*l,e.feed.name.toLowerCase().includes("bellota")&&(d+=l,m=!0),c.push({feed_name:e.feed.name,type:e.feed.category,percent_dm:0,dm_kg:l})}),c.forEach(e=>{e.percent_dm=t>0?e.dm_kg/t*100:0});let x=t>0?n/1e3/t*100:0,p=t>0?r/t:0,u=t>0?o/t*100:0,b=S(e.birth||e.birthDate),j=M.getBreedByName(e.breed)||M.getAllBreeds()[0],v=j.adg_feedlot||1.2,w=I.calculateRequirements(e.weight||e.currentWeight||400,v,b,"Cebo",e.sex||"Macho"),C=i.map(e=>({item:e.feed,amount:e.kg_as_fed})),k={totalDMI:t,totalFDN:o,totalProteinVal:n,totalEnergy:r,reqs:w},D=m?"Montanera":"Intensivo";f(I.validateDiet(C,k,D));let A=new Date().getMonth();j.heat_tolerance,j.code;let E=I.calculateSynergies(c,{sex:e.sex,ageMonths:b},{bellotaType:g});y(E);let R=E.filter(e=>e.active).map(e=>e.name),F=I.predictPerformance(j,p,t,e.weight||e.currentWeight||400,{currentMonth:A,activeSynergies:R});N(F);let P={marbling:0,yield_percent:0};E.forEach(e=>{e.active&&(P.marbling+=e.bonus_marbling,P.yield_percent+=e.bonus_yield)}),_(O.calculateCarcass(e.weight||e.currentWeight||400,b,j,p,F,{sex:e.sex,synergyBonuses:P,currentMonth:A,fatherBreed:s||(e.father?M.getBreedByName(e.father):void 0),motherBreed:l||(e.mother?M.getBreedByName(e.mother):void 0)}));let T=I.calculateNitrogenBalance(e.weight||400,F,x,t);h({dmi:t,mcal:p,cp:x,fdn:u,cost:i.reduce((e,a)=>e+a.kg_as_fed*a.feed.cost_per_kg,0),env:T,hasBellota:m})},S=e=>{if(!e)return 12;let a=new Date(e);return(new Date().getTime()-a.getTime())/2630016e3};return(0,a.jsxs)("div",{className:"flex flex-col h-full bg-gray-50 rounded-xl overflow-hidden",children:[(0,a.jsxs)("div",{className:"bg-gray-900 text-white p-4 flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h3",{className:"font-bold text-lg flex items-center gap-2",children:["üß™ Compositor de Dieta Cient√≠fica",b.length>0&&(0,a.jsx)("span",{className:"bg-yellow-500 text-black text-xs px-2 py-0.5 rounded font-black animate-pulse",children:"SINERGIA ACTIVA"})]}),(0,a.jsxs)("p",{className:"text-gray-400 text-xs",children:[e.breed," ‚Ä¢ ",e.weight,"kg ‚Ä¢ ",e.sex]})]}),(0,a.jsx)("button",{onClick:r,className:"text-gray-400 hover:text-white",children:"√ó"})]}),(0,a.jsxs)("div",{className:"flex-1 flex flex-col md:flex-row overflow-hidden",children:[(0,a.jsxs)("div",{className:"w-full md:w-1/2 p-4 flex flex-col gap-4 border-r border-gray-200 overflow-y-auto",children:[(0,a.jsxs)("div",{className:"bg-white p-4 rounded-lg shadow-sm",children:[(0,a.jsx)("label",{className:"text-xs font-bold text-gray-500 uppercase mb-2 block",children:"A√±adir Ingrediente"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)("select",{className:"flex-1 border rounded px-3 py-2 text-sm",value:c,onChange:e=>m(e.target.value),children:[(0,a.jsx)("option",{value:"",children:"Seleccionar..."}),(0,a.jsx)("optgroup",{label:"Forrajes",children:o.filter(e=>"Forraje"===e.category).map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))}),(0,a.jsx)("optgroup",{label:"Concentrados",children:o.filter(e=>"Concentrado"===e.category).map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))}),(0,a.jsx)("optgroup",{label:"Suplementos",children:o.filter(e=>"Suplemento"===e.category).map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))})]}),(0,a.jsx)("button",{onClick:()=>{if(!c)return;let e=o.find(e=>e.id===c);e&&n([...i,{id:Date.now().toString(),feed:e,kg_as_fed:1}])},className:"bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 font-bold",children:"+"})]})]}),p?.hasBellota&&(0,a.jsxs)("div",{className:"bg-green-50 border border-green-200 p-4 rounded-lg shadow-sm animate-in fade-in slide-in-from-top-2",children:[(0,a.jsx)("h4",{className:"flex items-center gap-2 text-sm font-bold text-green-900 mb-3",children:"üå≤ Origen de Montanera (Bellota)"}),(0,a.jsxs)("div",{className:"flex gap-4",children:[(0,a.jsxs)("label",{className:`flex-1 cursor-pointer border rounded-lg p-3 transition-all ${"ENCINA"===g?"bg-white border-green-500 ring-2 ring-green-100 shadow":"bg-transparent border-green-200 hover:bg-white"}`,children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,a.jsx)("input",{type:"radio",name:"bellotaType",value:"ENCINA",checked:"ENCINA"===g,onChange:()=>x("ENCINA"),className:"text-green-600 focus:ring-green-500"}),(0,a.jsx)("span",{className:"font-bold text-gray-800 text-sm",children:"Bellota Encina"})]}),(0,a.jsx)("div",{className:"text-xs text-green-700 font-medium pl-6",children:"Perfil: Alto Oleico"})]}),(0,a.jsxs)("label",{className:`flex-1 cursor-pointer border rounded-lg p-3 transition-all ${"ROBLE"===g?"bg-white border-green-500 ring-2 ring-green-100 shadow":"bg-transparent border-green-200 hover:bg-white"}`,children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,a.jsx)("input",{type:"radio",name:"bellotaType",value:"ROBLE",checked:"ROBLE"===g,onChange:()=>x("ROBLE"),className:"text-green-600 focus:ring-green-500"}),(0,a.jsx)("span",{className:"font-bold text-gray-800 text-sm",children:"Bellota Roble"})]}),(0,a.jsx)("div",{className:"text-xs text-green-700 font-medium pl-6",children:"Perfil: Taninos"})]})]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[i.map(e=>(0,a.jsxs)("div",{className:"bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex items-center justify-between group",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("div",{className:"font-bold text-gray-800",children:e.feed.name}),(0,a.jsxs)("div",{className:"text-xs text-gray-400",children:[e.feed.category," ‚Ä¢ ",e.feed.dm_percent,"% MS"]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)("div",{className:"flex flex-col items-end",children:[(0,a.jsx)("input",{type:"number",step:"0.1",min:"0",className:"w-16 text-right border rounded px-1 py-1 font-mono text-sm font-bold text-gray-900 focus:ring-2 focus:ring-green-500 outline-none",value:e.kg_as_fed,onChange:a=>{var t,r;return t=e.id,r=parseFloat(a.target.value)||0,void n(i.map(e=>e.id===t?{...e,kg_as_fed:r}:e))}}),(0,a.jsx)("span",{className:"text-[10px] text-gray-400",children:"kg fresco"})]}),(0,a.jsx)("button",{onClick:()=>{var a;return a=e.id,void n(i.filter(e=>e.id!==a))},className:"text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity",children:"üóëÔ∏è"})]})]},e.id)),0===i.length&&(0,a.jsx)("div",{className:"text-center py-10 text-gray-400 italic text-sm",children:"No hay ingredientes en la raci√≥n."})]})]}),(0,a.jsxs)("div",{className:"w-full md:w-1/2 bg-gray-50 flex flex-col overflow-y-auto",children:[(0,a.jsxs)("div",{className:"p-4 space-y-2",children:[u.map((e,t)=>(0,a.jsxs)("div",{className:`p-3 rounded-lg border text-sm flex items-start gap-3 ${"critical"===e.level?"bg-red-50 border-red-200 text-red-800":"bg-yellow-50 border-yellow-200 text-yellow-800"}`,children:[(0,a.jsx)("span",{className:"text-xl",children:"critical"===e.level?"‚õî":"‚ö†Ô∏è"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-bold",children:e.message}),e.action&&(0,a.jsxs)("div",{className:"text-xs mt-1 opacity-80 font-medium",children:["Recomendaci√≥n: ",e.action]})]})]},t)),b.map((e,t)=>(0,a.jsxs)("div",{className:"bg-indigo-50 border border-indigo-200 p-3 rounded-lg text-sm flex items-start gap-3 text-indigo-900",children:[(0,a.jsx)("span",{className:"text-xl",children:"üß¨"}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"font-bold",children:[e.name.replace(/_/g," ")," DETECTADA"]}),(0,a.jsx)("div",{className:"text-xs mt-1",children:e.description}),(0,a.jsxs)("div",{className:"text-xs mt-1 font-mono bg-indigo-100 px-1 rounded inline-block",children:["+",(e.bonus_marbling||0).toFixed(1)," BMS ‚Ä¢ +",(e.bonus_yield||0).toFixed(1),"% Rendimiento"]})]})]},`syn-${t}`))]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-px bg-gray-200 border-t border-b border-gray-200",children:[(0,a.jsxs)("div",{className:"bg-white p-4 flex flex-col items-center justify-center",children:[(0,a.jsx)("span",{className:"text-xs text-gray-500 uppercase tracking-wider",children:"ADG Predicha"}),(0,a.jsxs)("span",{className:`text-2xl font-black ${v<0?"text-red-600":v>1.2?"text-green-600":"text-gray-700"}`,children:[w(v)," ",(0,a.jsx)("span",{className:"text-sm font-normal text-gray-400",children:"kg/d√≠a"})]})]}),(0,a.jsxs)("div",{className:"bg-white p-4 flex flex-col items-center justify-center",children:[(0,a.jsx)("span",{className:"text-xs text-gray-500 uppercase tracking-wider",children:"Coste D√≠a"}),(0,a.jsxs)("span",{className:"text-2xl font-black text-gray-700",children:[w(p?p.cost:0)," ",(0,a.jsx)("span",{className:"text-sm font-normal text-gray-400",children:"‚Ç¨"})]})]}),(0,a.jsxs)("div",{className:"bg-white p-4 flex flex-col items-center justify-center",children:[(0,a.jsx)("span",{className:"text-xs text-gray-500 uppercase tracking-wider",children:"Marmoleo (BMS)"}),(0,a.jsxs)("span",{className:"text-2xl font-black text-purple-700",children:[j?j.bms:"?"," ",(0,a.jsx)("span",{className:"text-sm font-normal text-purple-300",children:"/ 12"})]}),(0,a.jsxs)("span",{className:"text-[10px] text-gray-400",children:["Score: ",j?j.marbling_score:0]})]}),(0,a.jsxs)("div",{className:"bg-white p-4 flex flex-col items-center justify-center",children:[(0,a.jsx)("span",{className:"text-xs text-gray-500 uppercase tracking-wider",children:"Clasificaci√≥n"}),(0,a.jsx)("span",{className:"text-2xl font-black text-gray-800",children:j?j.conformation:"?"}),(0,a.jsxs)("span",{className:"text-[10px] text-gray-400",children:["Rend: ",j?j.rc_percent:0,"%"]})]})]}),(0,a.jsxs)("div",{className:"p-4 bg-white",children:[(0,a.jsx)("h4",{className:"text-xs font-bold text-gray-400 uppercase mb-3",children:"Balance Nutricional"}),(0,a.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Energ√≠a Dieta"}),(0,a.jsxs)("span",{className:"font-mono font-bold",children:[w(p?.mcal)," Mcal/kg"]})]}),(0,a.jsx)("div",{className:"w-full bg-gray-100 h-2 rounded-full overflow-hidden",children:(0,a.jsx)("div",{className:"bg-blue-500 h-full",style:{width:`${Math.min(100,(p?.mcal||0)/3*100)}%`}})}),(0,a.jsxs)("div",{className:"flex justify-between pt-2",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Prote√≠na Bruta"}),(0,a.jsxs)("span",{className:"font-mono font-bold",children:[w(p?.cp)," %"]})]}),(0,a.jsx)("div",{className:"w-full bg-gray-100 h-2 rounded-full overflow-hidden",children:(0,a.jsx)("div",{className:"bg-green-500 h-full",style:{width:`${Math.min(100,(p?.cp||0)/20*100)}%`}})}),(0,a.jsxs)("div",{className:"flex justify-between pt-2",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Fibra (FDN)"}),(0,a.jsxs)("span",{className:`font-mono font-bold ${p?.fdn<28?"text-red-500":"text-gray-900"}`,children:[w(p?.fdn)," %"]})]})]})]}),p?.env&&(0,a.jsxs)("div",{className:`p-4 border-t ${p.env.is_critical?"bg-red-50":"bg-green-50"}`,children:[(0,a.jsxs)("h4",{className:"text-xs font-bold uppercase mb-2 flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-lg",children:"üåç"})," Impacto Ambiental"]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-gray-500",children:"Eficiencia N"}),(0,a.jsxs)("div",{className:"font-bold text-lg",children:[p.env.efficiency_pct,"%"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-gray-500",children:"Excreci√≥n/kg Ganancia"}),(0,a.jsxs)("div",{className:`font-bold text-lg ${p.env.is_critical?"text-red-600":"text-green-700"}`,children:[p.env.excretion_per_gain," g N"]})]})]})]})]})]}),(0,a.jsxs)("div",{className:"p-4 bg-white border-t border-gray-200 flex justify-end gap-2",children:[(0,a.jsx)("button",{className:"px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium",onClick:r,children:"Cancelar"}),(0,a.jsx)("button",{className:"px-6 py-2 bg-gray-900 text-white rounded-lg text-sm font-bold hover:bg-black transition-colors shadow-lg flex items-center gap-2",onClick:()=>alert("Guardado en historial (Simulado)"),children:"üíæ Guardar Dieta"})]})]})}function z(){var e;let r,l,i,n,o,d,c,{read:m,write:g}=(0,s.useStorage)(),[x,p]=(0,t.useState)([]),[h,u]=(0,t.useState)([]),[f,b]=(0,t.useState)([]),[y,j]=(0,t.useState)(""),[_,v]=(0,t.useState)(!1),[N,w]=(0,t.useState)(!1),[C,S]=(0,t.useState)({id:"",name:"",farm:"",breed:"",sex:"",birth:"",weight:"",notes:"",father:"",mother:"",corral:""});(0,t.useEffect)(()=>{let e=m("sessionUser","");if(j(e),e){let a=`animals_${e}`,t=`animals_${e} `,r=m(a,[]),s=m(t,[]),l=!1;s.length>0&&0===r.length&&(console.log("Recuperando datos antiguos..."),r=[...s],g(t,[]),l=!0),r=r.map(e=>{if(e.h_w&&Array.isArray(e.h_w)&&!e.monthlyRecords){let a=[],t=e.h_end?new Date(e.h_end):new Date;for(let r=0;r<e.h_w.length;r++){let s=e.h_w[r],l=e.h_w.length-1-r,i=new Date(t);i.setMonth(i.getMonth()-l),a.push({date:i.toISOString().split("T")[0].substring(0,7)+"-01",weightKg:s,adg:0})}return{...e,monthlyRecords:a}}return e});let i=m("events",[]),n=r.map(e=>{let a=parseFloat(e.weight)||0,t="current";if(e.monthlyRecords&&Array.isArray(e.monthlyRecords)&&e.monthlyRecords.length>0){let r=[...e.monthlyRecords].sort((e,a)=>new Date(a.date).getTime()-new Date(e.date).getTime())[0];r&&(r.weightKg||r.w)&&(a=parseFloat(r.weightKg||r.w),t="monthlyRecord")}else{let r=i.filter(a=>(a.animalId===e.id||a.animalCrotal===e.crotal)&&"Pesaje"===a.type).sort((e,a)=>new Date(a.date).getTime()-new Date(e.date).getTime());r.length>0&&(a=parseFloat(r[0].weight)||a,t="event")}return Math.abs(a-parseFloat(e.weight))>.1?(console.log(`Corrigiendo peso de ${e.crotal}: ${e.weight} -> ${a} (Fuente: ${t})`),l=!0,{...e,weight:a,currentWeight:a}):e});l&&(console.log("Sincronizando pesos con historial..."),r=n),p(r),b(m(`fincas_${e}`,[])),u(i)}},[m]);let k=(e,t=!1)=>{if(!e)return"";let r=e.length;if(r<4)return(0,a.jsx)("span",{className:`font - medium ${t?"text-white":"text-gray-900"} `,children:e});let s=e.substring(0,r-4),l=e.substring(r-4);return(0,a.jsxs)("span",{className:`${t?"text-white":"text-gray-900"} inline-flex font-mono tracking-tight items-baseline`,children:[(0,a.jsx)("span",{className:`${t?"text-green-100":"text-gray-400"} font-normal text-sm`,children:s}),(0,a.jsx)("span",{className:"font-black text-xl",children:l})]})},[D,A]=(0,t.useState)(""),[E,R]=(0,t.useState)(!1),F=x.filter(e=>{let a=!e.status||"Activo"===e.status;if(E){if(a)return!1}else if(!a)return!1;if(!D)return!0;let t=D.toLowerCase();return e.id.toLowerCase().includes(t)||e.id.slice(-4).includes(t)||e.breed&&e.breed.toLowerCase().includes(t)}),[P,T]=(0,t.useState)(null);return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-gray-800",children:"Inventario de Animales"}),(0,a.jsx)("p",{className:"text-gray-600",children:"Registro y monitoreo individual"})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("button",{onClick:()=>{let e=encodeURI("data:text/csv;charset=utf-8,Crotal,Nombre,Finca,Raza,Sexo,Nacimiento,Peso,Notas,Padre,Madre\n"),a=document.createElement("a");a.setAttribute("href",e),a.setAttribute("download","plantilla_animales.csv"),document.body.appendChild(a),a.click(),document.body.removeChild(a)},className:"bg-green-50 text-green-700 hover:bg-green-100 font-medium py-2 px-4 rounded-lg transition-colors text-sm",children:"‚¨á Plantilla CSV"}),(0,a.jsxs)("label",{className:"bg-green-50 text-green-700 hover:bg-green-100 font-medium py-2 px-4 rounded-lg transition-colors cursor-pointer text-sm flex items-center",children:["‚¨Ü Cargar CSV",(0,a.jsx)("input",{type:"file",accept:".csv",onChange:e=>{let a=e.target.files?.[0];if(!a)return;let t=new FileReader;t.onload=e=>{let a=e.target?.result;if(!a)return;let t=a.split("\n"),r=[],s=0;for(let e=1;e<t.length;e++){let a=t[e].trim();if(!a)continue;let l=a.split(",");if(l.length<5||!l[0]){s++;continue}r.push({id:l[0].trim(),name:l[1]?.trim()||"",farm:l[2]?.trim()||"Sin Asignar",breed:l[3]?.trim()||"Desconocida",sex:l[4]?.trim()||"Hembra",birth:l[5]?.trim()||"",weight:parseFloat(l[6])||0,notes:l[7]?.trim()||"",father:l[8]?.trim()||"",mother:l[9]?.trim()||"",corral:"",joined:new Date().toISOString()})}if(r.length>0){let e=[...x,...r];p(e),g(`animals_${y}`,e),alert(`Importados ${r.length} animales.${s>0?`(${s} errores)`:""} `)}else alert("No se pudieron importar animales. Verifica el formato del CSV.")},t.readAsText(a)},className:"hidden"})]}),(0,a.jsx)("button",{onClick:()=>v(!_),className:"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors",children:_?"Cancelar":"Nuevo Animal"})]})]}),(0,a.jsxs)("div",{className:"flex flex-col md:flex-row gap-4 items-center justify-between",children:[(0,a.jsx)("div",{className:"relative flex-1 w-full",children:(0,a.jsx)("input",{type:"text",placeholder:"Buscar por Crotal (ej. 1234), Raza...",className:"w-full border rounded-lg px-4 py-3 text-lg shadow-sm focus:ring-2 focus:ring-green-500 outline-none",value:D,onChange:e=>A(e.target.value)})}),(0,a.jsxs)("label",{className:"flex items-center gap-2 text-gray-700 font-medium cursor-pointer select-none whitespace-nowrap bg-gray-50 px-4 py-3 rounded-lg border border-gray-200 hover:bg-gray-100",children:[(0,a.jsx)("input",{type:"checkbox",checked:E,onChange:e=>R(e.target.checked),className:"w-5 h-5 text-green-600 rounded focus:ring-green-500"}),"Ver Bajas"]})]}),_&&(0,a.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-in fade-in slide-in-from-top-4",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Registrar Animal"}),(0,a.jsxs)("form",{onSubmit:e=>{if(e.preventDefault(),!C.id||!C.farm||!C.sex||!C.breed)return void alert("Por favor completa los campos obligatorios");if(x.find(e=>e.id===C.id))return void alert("Ya existe un animal con ese Crotal");let a=[...x,{...C,weight:parseFloat(C.weight)||0,category:"Sin Clasificar",joined:new Date().toISOString()}];p(a),g(`animals_${y}`,a),v(!1),S({id:"",name:"",farm:"",breed:"",sex:"",birth:"",weight:"",notes:"",father:"",mother:"",corral:""})},className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Crotal (ID) *"}),(0,a.jsx)("input",{type:"text",required:!0,className:"w-full border rounded-lg px-3 py-2",value:C.id,onChange:e=>S({...C,id:e.target.value})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre (Opcional)"}),(0,a.jsx)("input",{type:"text",className:"w-full border rounded-lg px-3 py-2",value:C.name,onChange:e=>S({...C,name:e.target.value})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Finca *"}),(0,a.jsxs)("select",{required:!0,className:"w-full border rounded-lg px-3 py-2",value:C.farm,onChange:e=>S({...C,farm:e.target.value}),children:[(0,a.jsx)("option",{value:"",children:"Selecciona Finca"}),(0,a.jsx)("option",{value:f[0]?.name||"SOTO del PRIOR",children:f[0]?.name||"SOTO del PRIOR"}),f.slice(1).map(e=>(0,a.jsx)("option",{value:e.name,children:e.name},e.id))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Corral"}),(0,a.jsxs)("select",{className:"w-full border rounded-lg px-3 py-2",value:C.corral||"",onChange:e=>S({...C,corral:e.target.value}),disabled:!C.farm,children:[(0,a.jsx)("option",{value:"",children:"Sin Asignar"}),(d=f.find(e=>e.name===C.farm))?d.corralNames&&d.corralNames.length>0?d.corralNames.map((e,t)=>(0,a.jsx)("option",{value:e,children:e},t)):Array.from({length:d.corrals||0},(e,a)=>a+1).map(e=>(0,a.jsxs)("option",{value:e,children:["Corral ",e]},e)):null]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Raza *"}),(0,a.jsxs)("select",{required:!0,className:"w-full border rounded-lg px-3 py-2",value:C.breed,onChange:e=>S({...C,breed:e.target.value}),children:[(0,a.jsx)("option",{value:"",children:"Selecciona Raza"}),(0,a.jsx)("option",{value:"Wagyu",children:"Wagyu"}),(0,a.jsx)("option",{value:"Angus",children:"Angus"}),(0,a.jsx)("option",{value:"Hereford",children:"Hereford"}),(0,a.jsx)("option",{value:"Charolais",children:"Charolais"}),(0,a.jsx)("option",{value:"Limousin",children:"Limousin"}),(0,a.jsx)("option",{value:"Brahman",children:"Brahman"}),(0,a.jsx)("option",{value:"Nelore",children:"Nelore"}),(0,a.jsx)("option",{value:"Droughtmaster",children:"Droughtmaster"}),(0,a.jsx)("option",{value:"Retinta",children:"Retinta"}),(0,a.jsx)("option",{value:"Morucha",children:"Morucha"}),(0,a.jsx)("option",{value:"Pirenaica",children:"Pirenaica"}),(0,a.jsx)("option",{value:"Betiz√∫",children:"Betiz√∫"}),(0,a.jsx)("option",{value:"Berrenda",children:"Berrenda"}),(0,a.jsx)("option",{value:"Simmental",children:"Simmental"}),(0,a.jsx)("option",{value:"Blonde d'Aquitaine",children:"Blonde d'Aquitaine"}),(0,a.jsx)("option",{value:"Azul Belga",children:"Azul Belga"}),(0,a.jsx)("option",{value:"Cruzada",children:"Cruzada"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Sexo *"}),(0,a.jsxs)("select",{required:!0,className:"w-full border rounded-lg px-3 py-2",value:C.sex,onChange:e=>S({...C,sex:e.target.value}),children:[(0,a.jsx)("option",{value:"",children:"Selecciona Sexo"}),(0,a.jsx)("option",{value:"Macho",children:"Macho"}),(0,a.jsx)("option",{value:"Hembra",children:"Hembra"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Fecha Nacimiento"}),(0,a.jsx)("input",{type:"date",className:"w-full border rounded-lg px-3 py-2",value:C.birth,onChange:e=>S({...C,birth:e.target.value})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Peso Actual (kg)"}),(0,a.jsx)("input",{type:"number",step:"0.1",className:"w-full border rounded-lg px-3 py-2",value:C.weight,onChange:e=>S({...C,weight:e.target.value})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Padre (Crotal) - Opcional"}),(0,a.jsx)("input",{type:"text",className:"w-full border rounded-lg px-3 py-2",placeholder:"ID del Padre",value:C.father,onChange:e=>S({...C,father:e.target.value})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Madre (Crotal) - Opcional"}),(0,a.jsx)("input",{type:"text",className:"w-full border rounded-lg px-3 py-2",placeholder:"ID de la Madre",value:C.mother,onChange:e=>S({...C,mother:e.target.value})})]}),(0,a.jsx)("div",{className:"md:col-span-2",children:(0,a.jsx)("button",{type:"submit",className:"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg w-full md:w-auto",children:"Guardar Animal"})})]})]}),(0,a.jsx)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden",children:(0,a.jsxs)("table",{className:"w-full text-left",children:[(0,a.jsx)("thead",{className:"bg-gray-50 text-gray-600 font-medium text-sm",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"p-4 w-1/3",children:"Crotal"}),(0,a.jsx)("th",{className:"p-4 w-1/3",children:"Sexo"}),(0,a.jsx)("th",{className:"p-4 w-1/3",children:"Finca"})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-gray-100",children:0===F.length?(0,a.jsx)("tr",{children:(0,a.jsx)("td",{colSpan:3,className:"p-8 text-center text-gray-500",children:"No hay animales que coincidan."})}):F.map((e,t)=>(0,a.jsxs)("tr",{onClick:()=>T(e),className:"hover:bg-green-50 transition-colors cursor-pointer group",children:[(0,a.jsx)("td",{className:"p-4",children:(0,a.jsx)("div",{className:"flex flex-col",children:k(e.id)})}),(0,a.jsx)("td",{className:"p-4 text-gray-600",children:e.sex}),(0,a.jsx)("td",{className:"p-4 text-gray-600",children:(0,a.jsxs)("div",{className:"flex flex-col text-sm",children:[(0,a.jsx)("span",{children:e.farm}),e.corral&&(0,a.jsxs)("span",{className:"text-xs text-green-600 font-medium",children:["‚ûú ",e.corral]})]})})]},t))})]})}),P&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4 backdrop-blur-sm",children:(0,a.jsx)("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden animate-in fade-in zoom-in-95 h-[90vh] flex flex-col",children:N?(0,a.jsx)($,{animal:P,onClose:()=>w(!1),fatherBreed:(()=>{if(!P.father)return;let e=x.find(e=>e.id===P.father);return M.getBreedByName(e?e.breed:P.father)})(),motherBreed:(()=>{if(!P.mother)return;let e=x.find(e=>e.id===P.mother);return M.getBreedByName(e?e.breed:P.mother)})()}):(0,a.jsxs)("div",{className:"flex flex-col h-full",children:[(0,a.jsxs)("div",{className:"bg-green-700 px-6 py-5 flex justify-between items-start text-white relative overflow-hidden flex-shrink-0",children:[(0,a.jsx)("div",{className:"absolute top-0 right-0 opacity-10 transform translate-x-1/4 -translate-y-1/4",children:(0,a.jsx)("svg",{width:"200",height:"200",viewBox:"0 0 200 200",fill:"currentColor",children:(0,a.jsx)("path",{d:"M100 0L200 200H0L100 0Z"})})}),(0,a.jsxs)("div",{className:"relative z-10",children:[(0,a.jsx)("div",{className:"scale-125 origin-top-left mb-1",children:k(P.id,!0)}),(0,a.jsxs)("div",{className:"flex items-center gap-2 mt-2 opacity-90 text-sm font-medium",children:[(0,a.jsx)("span",{className:"bg-white/20 px-2 py-0.5 rounded backdrop-blur-sm",children:P.breed}),(0,a.jsx)("span",{children:"‚Ä¢"}),(0,a.jsx)("span",{children:P.sex})]})]}),(0,a.jsxs)("div",{className:"flex gap-2 z-10 items-center",children:[(0,a.jsx)("button",{onClick:()=>w(!0),className:"bg-yellow-400 hover:bg-yellow-300 text-yellow-900 px-4 py-2 rounded-lg font-bold text-sm shadow-lg transform hover:scale-105 transition-all flex items-center gap-2",title:"Simular Dieta Cient√≠fica",children:"üß™ Crear Dieta"}),(0,a.jsx)("button",{onClick:()=>window.print(),className:"bg-white/20 hover:bg-white/30 text-white p-2 rounded-lg backdrop-blur-sm transition-colors",title:"Imprimir Ficha",children:"üñ®Ô∏è"}),(0,a.jsx)("button",{onClick:()=>{T(null),w(!1)},className:"text-white hover:text-green-200 text-3xl leading-none",children:"√ó"})]})]}),(0,a.jsxs)("div",{className:"p-6 space-y-6 overflow-y-auto flex-1",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{className:"bg-green-50 p-4 rounded-xl border border-green-100",children:[(0,a.jsx)("p",{className:"text-green-600 text-xs font-bold uppercase tracking-wider mb-1",children:"Peso Actual"}),(0,a.jsxs)("div",{className:"flex items-baseline gap-1",children:[(0,a.jsx)("span",{className:"text-3xl font-black text-gray-900",children:P.currentWeight||P.weight}),(0,a.jsx)("span",{className:"text-base font-medium text-gray-500",children:"kg"})]}),(0,a.jsxs)("p",{className:"text-xs text-green-700 mt-1 flex items-center gap-1",children:[(0,a.jsx)("span",{children:"‚öñÔ∏è"})," √öltimo pesaje verificado"]})]}),(0,a.jsxs)("div",{className:"bg-blue-50 p-4 rounded-xl border border-blue-100",children:[(0,a.jsx)("p",{className:"text-blue-600 text-xs font-bold uppercase tracking-wider mb-1",children:"Edad Exacta"}),(0,a.jsx)("p",{className:"font-bold text-gray-900 text-lg leading-tight",children:(e=>{if(!e)return"?";let a=new Date(e),t=new Date,r=t.getFullYear()-a.getFullYear(),s=t.getMonth()-a.getMonth(),l=t.getDate()-a.getDate();l<0&&(s--,l+=new Date(t.getFullYear(),t.getMonth(),0).getDate()),s<0&&(r--,s+=12);let i=[];return r>0&&i.push(`${r} a\xf1os`),s>0&&i.push(`${s} meses`),l>=0&&i.push(`${l} d\xedas`),i.join(", ")})(P.birth||P.birthDate)}),(0,a.jsxs)("p",{className:"text-xs text-blue-700 mt-2",children:["Nacimiento: ",P.birth||"Desconocido"]})]})]}),(0,a.jsxs)("div",{className:"bg-gray-50 rounded-xl border border-gray-100 p-4",children:[(0,a.jsxs)("h4",{className:"font-bold text-gray-800 text-sm mb-3 flex items-center gap-2",children:[(0,a.jsx)("span",{children:"üåæ"})," Estrategia Nutricional"]}),(r=new Date((e=P).birth||e.birthDate),i=((l=new Date).getTime()-r.getTime())/2630016e3,n=I.checkBellotaCompliance({ageMonths:i},l.getMonth()).compliant,o="Buey"===e.category||"Castrado"===e.sex&&i>12,c=n&&o?{label:"Bellota y Soja (Premium)",color:"bg-emerald-800 text-white border-emerald-900"}:"Lactancia"===e.status||e.category?.includes("Nodriza")?{label:"Pasto + Suplemento Materno",color:"bg-blue-100 text-blue-800 border-blue-200"}:e.farm&&e.farm.toLowerCase().includes("feedlot")?{label:"Cebo Intensivo",color:"bg-orange-100 text-orange-800 border-orange-200"}:{label:"Pasto / Mantenimiento",color:"bg-green-50 text-green-700 border-green-200"},(0,a.jsx)("div",{className:"flex items-center justify-between",children:(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-xs text-gray-500 mb-1",children:"Programa Actual"}),(0,a.jsx)("span",{className:`px - 3 py - 1 rounded - full text - sm font - bold border ${c.color} `,children:c.label})]})}))]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 text-sm border-t pt-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-gray-500 text-xs uppercase font-bold tracking-wider mb-1",children:"Ubicaci√≥n Actual"}),(0,a.jsx)("p",{className:"font-medium text-gray-900 text-base mb-2",children:P.farm}),P.corral&&(0,a.jsxs)("span",{className:"text-green-700 font-bold text-xs bg-white px-2 py-1 rounded border border-green-200 shadow-sm inline-block",children:["üìç Corral ",P.corral]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-gray-500 text-xs uppercase font-bold tracking-wider mb-1",children:"Genealog√≠a"}),(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-xs font-bold text-blue-600",children:"P:"}),(0,a.jsx)("span",{children:P.father||"N/A"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-xs font-bold text-pink-600",children:"M:"}),(0,a.jsx)("span",{children:P.mother||"N/A"})]})]})]})]}),(0,a.jsxs)("div",{className:"mt-6 border-t pt-4",children:[(0,a.jsx)("h4",{className:"font-bold text-gray-800 text-sm mb-3",children:"Historial de Eventos"}),(0,a.jsx)("div",{className:"border rounded-lg overflow-hidden text-sm",children:(0,a.jsxs)("table",{className:"w-full text-left",children:[(0,a.jsx)("thead",{className:"bg-gray-50 text-gray-600 text-xs uppercase",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-3 py-2",children:"Fecha"}),(0,a.jsx)("th",{className:"px-3 py-2",children:"Evento"}),(0,a.jsx)("th",{className:"px-3 py-2",children:"Detalle"})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-gray-100",children:h.filter(e=>e.animalId===P.id||e.animalCrotal===P.id).sort((e,a)=>new Date(a.date).getTime()-new Date(e.date).getTime()).map((e,t)=>(0,a.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,a.jsx)("td",{className:"px-3 py-2 font-mono text-xs text-gray-500",children:e.date}),(0,a.jsx)("td",{className:"px-3 py-2 font-medium text-gray-800",children:e.type}),(0,a.jsx)("td",{className:"px-3 py-2 text-gray-600",children:e.desc})]},t))})]})})]})]}),(0,a.jsxs)("div",{className:"bg-gray-50 px-6 py-4 flex justify-between items-center border-t border-gray-100 flex-shrink-0",children:[(0,a.jsxs)("span",{className:"text-xs text-gray-400 font-mono",children:["ID: ",P.id]}),(0,a.jsx)("button",{onClick:()=>{T(null),w(!1)},className:"px-4 py-2 bg-white border border-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-50 text-sm shadow-sm transition-colors",children:"Cerrar Ficha"})]})]})})})]})}let U={getAgeInMonths(e){if(!e)return 0;let a=new Date(e);return parseFloat((Math.abs(new Date().getTime()-a.getTime())/2630016e3).toFixed(1))},getReproductiveStatus(e,a){if("Hembra"!==e.sex)return{status:"Inmadura",daysInState:0};let t=[...a].filter(a=>a.animalId===e.id||a.animalCrotal===e.crotal).sort((e,a)=>new Date(a.date).getTime()-new Date(e.date).getTime()),r=t.find(e=>"Parto"===e.type),s=t.find(e=>"Inseminaci√≥n"===e.type||"Monta"===e.type),l=t.find(e=>"Diagn√≥stico"===e.type||"Revisi√≥n"===e.type&&e.desc.includes("Diagn√≥stico")),i=new Date;if(r){let e=new Date(r.date);s&&s.date;let a=Math.floor((i.getTime()-e.getTime())/864e5),l=t.filter(a=>new Date(a.date)>e),n=l.find(e=>"Inseminaci√≥n"===e.type),o=l.find(e=>"Diagn√≥stico"===e.type);if(!n)return a<45?{status:"Postparto",daysInState:a}:{status:"Vac√≠a",daysInState:a};if(n){let e=Math.floor((i.getTime()-new Date(n.date).getTime())/864e5);return o?"Positivo"===o.result||o.desc.includes("Gesta")||o.desc.includes("Pre√±a")?{status:"Gestante",daysInState:e}:{status:"Vac√≠a",daysInState:0}:{status:"Cubierta",daysInState:e}}}if(s){let e=Math.floor((i.getTime()-new Date(s.date).getTime())/864e5);return l?"Positivo"===l.result||l.desc.includes("Gesta")?{status:"Gestante",daysInState:e}:{status:"Vac√≠a",daysInState:0}:{status:"Cubierta",daysInState:e}}return{status:"Vac√≠a",daysInState:0}},getLifecycleAlerts(e){let a=[];if(!e.birthDate)return a;let t=new Date(e.birthDate),r=new Date,s=(r.getTime()-t.getTime())/2630016e3,l=new Date(t);if(l.setDate(l.getDate()+210),s>=6.5&&s<=8&&a.push({type:"Destete",date:l.toISOString().split("T")[0],desc:"Animal cumple 7 meses. Planificar destete.",animalId:e.id,isDue:r>=l}),"Macho"===e.sex&&s>=5.5&&s<=7){let s=new Date(t);s.setDate(s.getDate()+180),a.push({type:"Castraci√≥n",date:s.toISOString().split("T")[0],desc:`Decisi\xf3n Macho (6 meses): \xbfSemental o Buey?`,animalId:e.id,isDue:r>=s})}return a}},G={defaultPrices:{AR3:758,AU2:779,AU3:779,AO3:745,DR3:760,DO3:720,DP2:640,DU4:800,DR4:760,ER3:779,EU3:791,EO3:763,ZR3:780,ZU3:795,CR3:850,CU3:880,BR3:680,VR3:800,A:750,B:650,C:800,D:680,E:770,Z:780,V:800},determineMAPACode(e){let{ageMonths:a,sex:t,isCastrated:r,isParida:s}=e,l=(t||"").toLowerCase();return a<8?"V":a<12?"Z":"macho"===l||"castrado"===l?r||"castrado"===l?"C":a<24?"A":"B":"hembra"===l?s||a>48?"D":"E":"A"},calculateSalesPrice(e,a,t,r){let s=this.determineMAPACode(e),l=(t||"R").toUpperCase(),i=(r||3).toString(),n=`${s}${l}${i}`,o=`${s}${l}`,d=this.defaultPrices[n]||this.defaultPrices[o]||this.defaultPrices[s]||500;return{totalValue:parseFloat((a/100*d).toFixed(2)),pricePerKg:parseFloat((d/100).toFixed(2)),categoryCode:n,baseCategory:s}},importPricesFromCSV(e){let a=e.split("\n"),t={};return a.forEach(e=>{let a=e.split(/,|;/);if(a.length>=2){let e=a[0].trim().toUpperCase(),r=parseFloat(a[1].trim());isNaN(r)||(t[e]=r)}}),Object.assign(this.defaultPrices,t),Object.keys(t).length}};function V(){let{read:e}=(0,s.useStorage)(),{calculate:r,results:l,loading:i,error:n}=function(){let[e,a]=(0,t.useState)({}),[r,s]=(0,t.useState)(null),[l,i]=(0,t.useState)(!1),[n,o]=(0,t.useState)(null);return(0,t.useEffect)(()=>{let e=M.getAllBreeds(),t={};e.forEach(e=>{t[e.id]=e}),a(t)},[]),{breeds:e,calculate:async e=>{i(!0),o(null),s(null);try{let a,t,r,l,{animal:i,system:n}=e,o=U.getAgeInMonths(i.birth_date||i.birth||i.birthDate),d=e.overrideBreed||M.getBreedById(i.breed);if(!d||"Cruzado"===i.breed||"Mestizo"===i.breed){let e=i.genotype?.fatherBreedId||i.fatherBreedId,a=i.genotype?.motherBreedId||i.motherBreedId;if(e&&a){let t=M.calculateHybrid(e,a);t&&(d=t)}}if(!d){let e=(i.breed||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(!(d=M.getAllBreeds().find(a=>e.includes(a.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""))||e.includes(a.code.toLowerCase())))&&(e.includes("cruzad")||e.includes("mestiz"))){let e=i.genotype?.fatherBreedId||i.fatherBreedId,a=i.genotype?.motherBreedId||i.motherBreedId;e&&a&&(d=M.calculateHybrid(e,a))}d||(d={id:"GENERIC_CROSS",code:"CROSS",name:"Cruzado (Gen√©rico)",subspecies:"Cruzado",biological_type:"Composite",weight_female_adult:600,weight_male_adult:950,adg_feedlot:1.2,slaughter_age_months:20,conformation_potential:4,marbling_potential:3,yield_potential:.58,heat_tolerance:6,milk_potential:3})}if(!d)throw Error("No se pudo determinar la raza del animal.");let c=parseFloat(i.currentWeight||i.weight||0),m="Cebo";"Mantenimiento"===e.objective&&(m="Mantenimiento"),e.objective.includes("Recr√≠a")&&(m="Mantenimiento"),(e.objective.includes("Cebo")||e.objective.includes("Engorde"))&&(m="Cebo");let g=d.adg_feedlot||1.2,x=I.calculateRequirements(c,g,o,m,i.sex||"Macho"),p=e.feeds||[];p&&0!==p.length||(p=[{name:"Raci√≥n Base (Estimada)",amount:10,dm_percent:40,energy_mcal:x.em_mcal,protein_percent:x.pb_percent,cost_per_kg:.03}]);let h=p.reduce((e,a)=>e+a.amount,0),u=p.reduce((e,a)=>e+a.amount*(a.cost_per_kg||0),0),f=0,b=0,y=0,j=0;p.forEach(e=>{let a=e.amount*(e.dm_percent/100);j+=a,f+=a*(e.energy_mcal||0),b+=a*(10*(e.protein_percent||0)),y+=a*((e.fiber_percent||e.ndf_percent||e.fdn_percent||0)/100)});let _=j>0?f/j:0,v=I.predictPerformance(d,_,j,c),N=O.calculateCarcass(i.weight+30*v,o+1,d,_,v,{isBellota:n.toLowerCase().includes("montanera")||n.toLowerCase().includes("bellota"),isOx:("Macho"===i.sex||"Castrado"===i.sex)&&o>24,sex:i.sex||"Macho"}),w=j>0?b/10/j:0,C=I.calculateNitrogenBalance(c,v,w,j),S=(e.events||[]).reduce((e,a)=>e+(parseFloat(a.cost)||0),0),k=(i.monthlyRecords||[]).reduce((e,a)=>{let t=a.totalCost||.02*(a.w||a.weightKg||0)*7.5;return e+t},0),D=30*u,A=S+k+D,E=G.calculateSalesPrice({ageMonths:o+1,sex:i.sex,isCastrated:"Castrado"===i.sex,isParida:"Parto"===i.status||"Nodriza"===i.category},N.carcass_weight,N.conformation,Math.round(N.marbling_score));s({diet:p,projectedGain:v,dmiTarget:x.dmi_capacity_kg,dmiActual:j,totalCost:u,totalKg:h,historicalCosts:{events:S,feed:k,total:S+k},financials:{projectedSales:E.totalValue,pricePerKg:E.pricePerKg,category:E.categoryCode,totalCost:A,margin:E.totalValue-A},fcr:v>0?u/v:0,energyTarget:x.em_mcal*j,energyActual:f,proteinPercent:w,alerts:I.validateDiet(p.map(e=>({item:e,amount:e.amount})),{totalDMI:j,totalFDN:y,totalProteinVal:b,totalEnergy:f,reqs:x},e.system),imbalances:[],carcass:{conformation_est:N.conformation,marbling_est:N.marbling_score,is_premium:N.is_premium,rc_percent:N.rc_percent,limitingFactor:(a=x.em_mcal*j,t=x.pb_percent/100*j*1e3,r=a>0?f/a:1,l=t>0?b/t:1,v>=(d.adg_feedlot||1.4)?"Gen√©tica (M√°x)":j>=.95*x.dmi_capacity_kg&&r<1&&l<1?"Ingesta (Llenado)":r<l?"Energ√≠a":"Prote√≠na")},envImpact:C})}catch(e){console.error(e),o(e.message||"Error en c√°lculo")}finally{i(!1)}},results:r,loading:l,error:n}}(),[o,d]=(0,t.useState)([]),[c,m]=(0,t.useState)(""),[g,x]=(0,t.useState)(null),[p,h]=(0,t.useState)("Mantenimiento"),[u,f]=(0,t.useState)("Extensivo (Pastoreo)"),[b,y]=(0,t.useState)(!1),[j,_]=(0,t.useState)(!1),[v,N]=(0,t.useState)([]),w=`${u}${b?" + Montanera":""}${j?" + Ecol√≥gico":""}`,[C,S]=(0,t.useState)(""),[k,D]=(0,t.useState)(!1),[A,E]=(0,t.useState)([]),[R]=(0,t.useState)(L);(0,t.useEffect)(()=>{let a=e("sessionUser","");a&&(d(e(`animals_${a}`,[])),N(e("events",[])))},[e]),(0,t.useEffect)(()=>{g&&r({animal:g,objective:p,system:w,feeds:A.map(e=>({...e.item,amount:e.amount})),events:v.filter(e=>e.animalId===g.id||e.animalCrotal===g.id)})},[A,g,p,w,v]);let[F,P]=(0,t.useState)(null);(0,t.useEffect)(()=>{if(g){let e=(e=>{if(!e)return null;let a=M.getBreedById(e.breed);if(!a){let t=e.genotype?.fatherBreedId||e.fatherBreedId,r=e.genotype?.motherBreedId||e.motherBreedId;t&&r&&(a=M.calculateHybrid(t,r)||void 0)}if(!a){let t=(e.breed||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");a=M.getAllBreeds().find(e=>t.includes(e.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""))||t.includes(e.code.toLowerCase()))}return a||void 0})(g);P(I.calculateKPITargets({breed:g.breed||"Unknown",sex:g.sex||"Macho",weight:parseFloat(g.currentWeight||g.weight||400),ageMonths:(e=>{if(!e)return 0;let a=new Date(e),t=new Date;return(t.getFullYear()-a.getFullYear())*12+(t.getMonth()-a.getMonth())})(g.birth||g.birthDate),biological_type:e?.biological_type},p,w))}},[g,p,w]);let T=Array.from(new Map(o.filter(e=>e.crotal||e.id).map(e=>[e.crotal||e.id,e])).values()).filter(e=>{let a=C.toLowerCase();return(e.crotal||"").toLowerCase().includes(a)||(e.id||"").toLowerCase().includes(a)}).sort((e,a)=>(e.crotal||e.id||"").localeCompare(a.crotal||a.id||""));return(0,a.jsx)("div",{className:"h-full bg-gray-50 p-6 overflow-y-auto",children:(0,a.jsxs)("div",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Seleccionar Animal"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Crotal del Animal"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("input",{type:"text",placeholder:"Buscar Crotal (ej. 8196)",className:"w-full border rounded-lg px-3 py-2 text-sm text-gray-700 focus:ring-2 focus:ring-green-500 outline-none",value:C,onFocus:()=>{D(!0)},onChange:e=>{S(e.target.value),D(!0)},onBlur:()=>setTimeout(()=>D(!1),200)}),(0,a.jsx)("div",{className:"absolute right-3 top-2.5 pointer-events-none text-gray-400 text-xs",children:"‚ñº"})]}),k&&T.length>0&&(0,a.jsx)("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-xl max-h-64 overflow-y-auto",children:T.map(e=>(0,a.jsxs)("div",{className:"px-4 py-3 hover:bg-green-50 cursor-pointer border-b last:border-0 flex justify-between items-center",onMouseDown:()=>{let a=parseFloat(e.currentWeight||e.weight||0),t=v.filter(a=>(a.animalId===e.id||a.animalCrotal===e.crotal)&&"Pesaje"===a.type).sort((e,a)=>new Date(a.date).getTime()-new Date(e.date).getTime());if(t.length>0){let e=parseFloat(t[0].weight);e>0&&(a=e)}x({...e,currentWeight:a,weight:a}),S(e.crotal||e.id),D(!1)},children:[(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"font-bold text-gray-800",children:e.crotal?(e=>{if(!e)return null;let t=e.length;if(t<4)return(0,a.jsx)("span",{className:"font-bold text-gray-900",children:e});let r=e.substring(0,t-4),s=e.substring(t-4);return(0,a.jsxs)("span",{className:"font-mono tracking-tight",children:[(0,a.jsx)("span",{className:"text-gray-400 font-normal text-xs align-middle mr-0.5",children:r}),(0,a.jsx)("span",{className:"font-black text-lg text-gray-900 align-middle",children:s})]})})(e.crotal):e.id}),(0,a.jsxs)("span",{className:"text-[10px] text-gray-400 font-bold uppercase",children:[e.breed," ‚Ä¢ ",e.sex]})]}),(0,a.jsx)("span",{className:"bg-gray-100 px-2 py-0.5 rounded text-[10px] font-bold text-gray-500 uppercase",children:e.farm})]},e.id))})]}),g&&(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm bg-gray-50 p-3 rounded-lg border border-gray-100",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-gray-500",children:"Raza"}),(0,a.jsx)("p",{className:"font-bold text-gray-800",children:g.breed})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-gray-500",children:"Peso"}),(0,a.jsxs)("p",{className:"font-bold text-gray-800",children:[g.currentWeight||g.weight," kg"]})]})]})]})]}),(0,a.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Objetivos"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Objetivo"}),(0,a.jsxs)("select",{className:"w-full border rounded-lg px-3 py-2",value:p,onChange:e=>h(e.target.value),children:[(0,a.jsx)("option",{value:"Mantenimiento",children:"Mantenimiento"}),(0,a.jsx)("option",{value:"Recr√≠a (Crecimiento Moderado)",children:"Recr√≠a (Crecimiento Moderado)"}),(0,a.jsx)("option",{value:"Cebo (M√°ximo Crecimiento)",children:"Cebo (M√°ximo Crecimiento)"}),(0,a.jsx)("option",{value:"Engorde",children:"Engorde (Acabado)"}),(0,a.jsx)("option",{value:"Eficiencia Econ√≥mica",children:"Eficiencia Econ√≥mica (Min Coste)"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Sistema Base"}),(0,a.jsxs)("select",{className:"w-full border rounded-lg px-3 py-2 mb-3",value:u,onChange:e=>f(e.target.value),children:[(0,a.jsx)("option",{value:"Extensivo (Pastoreo)",children:"Extensivo (Pastoreo)"}),(0,a.jsx)("option",{value:"Semi-Intensivo",children:"Semi-Intensivo"}),(0,a.jsx)("option",{value:"Cebo (Feedlot)",children:"Cebo (Feedlot)"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase",children:"Modificadores"}),(0,a.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,a.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-gray-50 border border-transparent hover:border-gray-200 transition-colors",children:[(0,a.jsx)("input",{type:"checkbox",checked:b,onChange:e=>y(e.target.checked),className:"w-4 h-4 text-green-600 rounded focus:ring-green-500"}),(0,a.jsx)("span",{className:"text-sm text-gray-700",children:"Montanera (Bellota)"})]}),(0,a.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-gray-50 border border-transparent hover:border-gray-200 transition-colors",children:[(0,a.jsx)("input",{type:"checkbox",checked:j,onChange:e=>_(e.target.checked),className:"w-4 h-4 text-green-600 rounded focus:ring-green-500"}),(0,a.jsx)("span",{className:"text-sm text-gray-700",children:"Ecol√≥gico"})]})]})]})]})]})]})]}),(0,a.jsx)("div",{className:"lg:col-span-2 space-y-6",children:l?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[(0,a.jsxs)("div",{className:`p-4 rounded-xl shadow-sm border ${l.projectedGain>=(F?.adg||0)?"bg-green-50 border-green-200":"bg-white border-gray-100"}`,children:[(0,a.jsx)("p",{className:"text-gray-500 text-xs uppercase font-bold",children:"GMD Estimada"}),(0,a.jsxs)("p",{className:`text-3xl font-bold ${l.projectedGain>=(F?.adg||0)?"text-green-700":"text-gray-900"} mt-1`,children:[(l.projectedGain||0).toFixed(2)," ",(0,a.jsx)("span",{className:"text-sm text-gray-400",children:"kg/d"})]}),(0,a.jsxs)("div",{className:"mt-2 text-xs font-medium",children:[(0,a.jsxs)("span",{className:"text-gray-500",children:["Meta: ",F?.adg]}),(0,a.jsx)("span",{className:`block mt-1 ${l.projectedGain>=(F?.adg||0)?"text-green-600":"text-gray-900"}`,children:l.projectedGain>=(F?.adg||0)?"Objetivo Cumplido":"Bajo Rendimiento"})]})]}),(0,a.jsxs)("div",{className:"bg-white p-4 rounded-xl shadow-sm border border-gray-100",children:[(0,a.jsx)("p",{className:"text-gray-500 text-xs uppercase font-bold",children:"Ingesta (MS)"}),(0,a.jsxs)("p",{className:"text-3xl font-bold text-gray-900 mt-1",children:[(l.dmiTarget||0).toFixed(1)," ",(0,a.jsx)("span",{className:"text-sm text-gray-400",children:"kg"})]}),(0,a.jsx)("p",{className:"text-xs text-gray-400 mt-2",children:"Capacidad M√°x. (Est.)"})]}),(0,a.jsxs)("div",{className:`p-4 rounded-xl shadow-sm border ${Number(l.fcr)<=(F?.fcr||10)?"bg-green-50 border-green-200":"bg-white border-gray-100"}`,children:[(0,a.jsx)("p",{className:"text-gray-500 text-xs uppercase font-bold",children:"Eficiencia (FCR)"}),(0,a.jsx)("p",{className:`text-3xl font-bold ${Number(l.fcr)<=(F?.fcr||10)?"text-green-700":"text-gray-900"} mt-1`,children:Number(l.fcr||0).toFixed(2)}),(0,a.jsxs)("div",{className:"mt-2 text-xs font-medium",children:[(0,a.jsxs)("span",{className:"text-gray-500",children:["Meta: <",F?.fcr]}),(0,a.jsx)("span",{className:`block mt-1 ${Number(l.fcr)<=(F?.fcr||10)?"text-green-600":"text-gray-900"}`,children:Number(l.fcr)<=(F?.fcr||10)?"Excelente Conversi√≥n":"Mejorable"})]})]}),(0,a.jsxs)("div",{className:"bg-white p-4 rounded-xl shadow-sm border border-gray-100",children:[(0,a.jsx)("p",{className:"text-gray-500 text-xs uppercase font-bold",children:"Coste Diario"}),(0,a.jsxs)("p",{className:"text-3xl font-bold text-gray-900 mt-1",children:[Number(l.totalCost||0).toFixed(2)," ",(0,a.jsx)("span",{className:"text-sm text-gray-400",children:"‚Ç¨"})]})]})]}),(0,a.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-800",children:"Constructor de Dieta"}),(0,a.jsx)("button",{onClick:()=>{if(!g||!F)return;let e=parseFloat(g.weight)||400;E(I.generateSmartDiet(F,{weight:e},w,R).map(e=>{let a=R.find(a=>a.id===e.feed_id);if(!a)return null;let t=a.dm_percent||100;return{item:a,amount:parseFloat((e.dm_kg/(t/100)).toFixed(1))}}).filter(Boolean))},className:"text-xs bg-green-600 text-white px-3 py-1 rounded-full hover:bg-green-700 shadow-sm transition-colors font-bold flex items-center gap-1",children:"Generar Dieta"})]}),(0,a.jsx)("div",{className:"flex gap-2",children:(0,a.jsxs)("select",{className:"border rounded-lg px-2 py-1 text-sm max-w-xs",onChange:e=>{if(e.target.value){var a;let t;a=e.target.value,(t=R.find(e=>e.id===a))&&!A.find(e=>e.item.id===a)&&E([...A,{item:t,amount:1}]),e.target.value=""}},children:[(0,a.jsx)("option",{value:"",children:"+ A√±adir Alimento"}),(0,a.jsx)("optgroup",{label:"Forrajes",children:R.filter(e=>"Forraje"===e.category).map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))}),(0,a.jsx)("optgroup",{label:"Concentrados",children:R.filter(e=>"Concentrado"===e.category).map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))}),(0,a.jsx)("optgroup",{label:"Suplementos",children:R.filter(e=>"Suplemento"===e.category).map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))}),(0,a.jsx)("optgroup",{label:"Ecol√≥gicos",children:R.filter(e=>"Ecol√≥gico"===e.category).map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))})]})})]}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full text-left text-sm",children:[(0,a.jsx)("thead",{className:"bg-gray-50 text-gray-600",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"p-3",children:"Ingrediente"}),(0,a.jsx)("th",{className:"p-3 w-32",children:"Kg (Fresco)"}),(0,a.jsx)("th",{className:"p-3 w-24",children:"Kg (MS)"}),(0,a.jsx)("th",{className:"p-3 text-right",children:"Costo"}),(0,a.jsx)("th",{className:"p-3 w-10"})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-gray-100",children:0===A.length?(0,a.jsx)("tr",{children:(0,a.jsx)("td",{colSpan:5,className:"p-4 text-center text-gray-400 italic",children:"No hay ingredientes."})}):A.map((e,t)=>(0,a.jsxs)("tr",{className:"group hover:bg-gray-50",children:[(0,a.jsxs)("td",{className:"p-3 font-medium flex items-center gap-2",children:[(0,a.jsx)("span",{className:`w-2 h-2 rounded-full ${"Forraje"===e.item.category?"bg-green-500":"bg-yellow-500"}`}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{children:e.item.name}),(0,a.jsxs)("p",{className:"text-xs text-gray-400",children:[e.item.energy_mcal," Mcal/kg ‚Ä¢ ",e.item.protein_percent,"% PB"]})]})]}),(0,a.jsx)("td",{className:"p-3",children:(0,a.jsx)("input",{type:"number",min:"0",step:"0.5",className:"w-full border rounded px-2 py-1 text-center font-bold focus:ring-1 focus:ring-green-500 outline-none",value:e.amount,onChange:a=>{var t,r;return t=e.item.id,r=parseFloat(a.target.value)||0,void E(A.map(e=>e.item.id===t?{...e,amount:r}:e))}})}),(0,a.jsx)("td",{className:"p-3 text-gray-500",children:(e.amount*(e.item.dm_percent/100)).toFixed(2)}),(0,a.jsxs)("td",{className:"p-3 text-right text-gray-600",children:[(e.amount*e.item.cost_per_kg).toFixed(2)," ‚Ç¨"]}),(0,a.jsx)("td",{className:"p-3 text-right",children:(0,a.jsx)("button",{onClick:()=>{var a;return a=e.item.id,void E(A.filter(e=>e.item.id!==a))},className:"text-gray-400 hover:text-red-500 transition-colors",children:"‚úï"})})]},t))}),(0,a.jsx)("tfoot",{className:"border-t font-bold bg-green-50",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{className:"p-3 text-green-800",children:"TOTAL"}),(0,a.jsxs)("td",{className:"p-3 text-green-800",children:[(l.totalKg||0).toFixed(2)," kg"]}),(0,a.jsxs)("td",{className:"p-3 text-green-800",children:[(l.dmiActual||0).toFixed(2)," kg"]}),(0,a.jsxs)("td",{className:"p-3 text-right text-green-800",children:[(l.totalCost||0).toFixed(2)," ‚Ç¨"]}),(0,a.jsx)("td",{})]})})]})})]}),(0,a.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,a.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4 flex items-center gap-2",children:"Balance Nutricional"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex justify-between text-sm mb-1",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Energ√≠a (Mcal)"}),(0,a.jsxs)("span",{className:"font-bold",children:[(l.energyTarget||0).toFixed(1)," / Requerido"]})]}),(0,a.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,a.jsx)("div",{className:"bg-green-600 h-2 rounded-full",style:{width:"85%"}})})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex justify-between text-sm mb-1",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Prote√≠na (%)"}),(0,a.jsxs)("span",{className:"font-bold",children:[(l.proteinPercent||0).toFixed(1),"%"]})]}),(0,a.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,a.jsx)("div",{className:"bg-green-600 h-2 rounded-full",style:{width:`${Math.min(5*l.proteinPercent,100)}%`}})})]}),(0,a.jsxs)("div",{className:"mt-4 bg-gray-50 p-3 rounded-lg border border-gray-200",children:[(0,a.jsx)("p",{className:"text-xs font-bold text-gray-500 uppercase mb-1",children:"Factor Limitante"}),(0,a.jsx)("p",{className:"text-red-600 font-bold",children:l.carcass?.limitingFactor||"Energ√≠a"})]}),l.alerts&&l.alerts.length>0&&(0,a.jsx)("div",{className:"space-y-2 mt-4",children:l.alerts.map((e,t)=>(0,a.jsxs)("div",{className:`p-4 rounded-2xl text-xs transition-all hover:shadow-md ${"critical"===e.level?"bg-red-50 text-red-700":"bg-orange-50 text-orange-800"}`,children:[(0,a.jsx)("p",{className:"font-black uppercase mb-1 tracking-widest",children:{ACIDOSIS:"RIESGO ACIDOSIS",LOW_FIBER:"FIBRA BAJA",BLOAT:"METEORISMO",BELLOTA_FIBER:"FIBRA (MONTANERA)",BELLOTA_PROTEIN:"PROTE√çNA (MONTANERA)",BELLOTA_TOXICITY:"TANINOS (BELLOTA)",LOW_N_EFF:"D√âFICIT PROTEICO",HIGH_POLLUTION:"EXCESO NITR√ìGENO"}[e.code]||e.code.replace("_"," ")}),(0,a.jsx)("p",{className:"font-medium opacity-90",children:e.message}),e.action&&(0,a.jsxs)("div",{className:"mt-2 pt-2 border-t border-current border-opacity-10 flex items-start gap-1.5",children:[(0,a.jsx)("span",{className:"text-[10px]",children:"üí°"}),(0,a.jsx)("p",{className:"text-[10px] italic font-bold leading-tight",children:e.action})]})]},t))})]})]}),(0,a.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col gap-4",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:"Finanzas y Calidad"}),(0,a.jsx)("div",{className:"mt-4",children:(0,a.jsxs)("div",{className:"flex flex-col gap-5",children:[(0,a.jsx)("div",{className:"bg-white border border-gray-100 rounded-[2.5rem] shadow-sm px-4 py-8",children:(0,a.jsxs)("div",{className:"grid grid-cols-4 gap-0 text-center items-end",children:[(0,a.jsxs)("div",{className:"border-r border-gray-100 h-10 flex flex-col justify-center px-1",children:[(0,a.jsx)("p",{className:"text-gray-400 text-[7px] font-black uppercase tracking-[0.2em] mb-1",children:"Clasificaci√≥n"}),(0,a.jsx)("span",{className:"text-4xl font-black text-gray-900 leading-none tracking-tighter",children:l.carcass?.conformation_est||"R"})]}),(0,a.jsxs)("div",{className:"border-r border-gray-100 h-10 flex flex-col justify-center px-1",children:[(0,a.jsx)("p",{className:"text-gray-400 text-[7px] font-black uppercase tracking-[0.2em] mb-1",children:"Infiltraci√≥n"}),(0,a.jsx)("span",{className:"text-4xl font-black text-gray-900 leading-none tracking-tighter",children:Math.round(l.carcass?.marbling_est||1)})]}),(0,a.jsxs)("div",{className:"border-r border-gray-100 h-10 flex flex-col justify-center px-1",children:[(0,a.jsx)("p",{className:"text-gray-400 text-[7px] font-black uppercase tracking-[0.2em] mb-1",children:"Kg Canal (Est.)"}),(0,a.jsxs)("div",{className:"flex items-baseline justify-center gap-0.5",children:[(0,a.jsx)("span",{className:"text-3xl font-black text-gray-900 leading-none tracking-tighter",children:l.carcass?.weight_est?.toFixed(0)||l.carcass?.rc_percent?((parseFloat(g.currentWeight||g.weight)+30*l.projectedGain)*(l.carcass.rc_percent/100)).toFixed(0):"0"}),(0,a.jsx)("span",{className:"text-xs font-black text-gray-400 uppercase",children:"kg"})]})]}),(0,a.jsxs)("div",{className:"h-10 flex flex-col justify-center px-1",children:[(0,a.jsx)("p",{className:"text-gray-400 text-[7px] font-black uppercase tracking-[0.2em] mb-1",children:"Rendimiento"}),(0,a.jsxs)("div",{className:"flex items-baseline justify-center gap-0.5",children:[(0,a.jsx)("span",{className:"text-3xl font-black text-gray-900 leading-none tracking-tighter",children:l.carcass?.rc_percent||0}),(0,a.jsx)("span",{className:"text-xs font-black text-gray-400 uppercase",children:"%"})]})]})]})}),(0,a.jsxs)("div",{className:"bg-gray-50/50 p-6 rounded-[2rem] border border-gray-100",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,a.jsx)("div",{className:"w-1.5 h-1.5 bg-green-500 rounded-full"}),(0,a.jsx)("p",{className:"text-gray-500 text-[9px] font-black uppercase tracking-widest",children:"Previsi√≥n ROI 30 D√≠as"})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center group",children:[(0,a.jsxs)("span",{className:"text-gray-500 text-xs font-bold transition-colors group-hover:text-gray-900",children:["Venta Estimada (",l.financials?.category,")"]}),(0,a.jsxs)("div",{className:"flex flex-col items-end",children:[(0,a.jsxs)("span",{className:"font-black text-gray-900 text-base",children:[l.financials?.projectedSales?.toLocaleString()," ‚Ç¨"]}),(0,a.jsx)("span",{className:"text-[9px] text-green-600 font-bold uppercase tracking-tighter",children:"+ Ganancia Bruta"})]})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center group",children:[(0,a.jsx)("span",{className:"text-gray-500 text-xs font-bold transition-colors group-hover:text-gray-900",children:"Costes Acumulados"}),(0,a.jsxs)("div",{className:"flex flex-col items-end",children:[(0,a.jsxs)("span",{className:"font-black text-gray-900 text-base",children:["-",l.financials?.totalCost?.toFixed(0)," ‚Ç¨"]}),(0,a.jsx)("span",{className:"text-[9px] text-red-600 font-bold uppercase tracking-tighter",children:"- Gastos Totales"})]})]}),(0,a.jsx)("div",{className:"pt-4 border-t border-gray-200",children:(0,a.jsxs)("div",{className:"bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-gray-400 text-[8px] font-black uppercase tracking-widest leading-none",children:"Margen Neto Proyectado"}),(0,a.jsx)("p",{className:"text-[9px] text-gray-400 font-medium mt-1",children:"* Resultados netos a 30 d√≠as"})]}),(0,a.jsx)("div",{className:"text-right",children:(0,a.jsxs)("span",{className:`text-3xl font-black tracking-tighter ${l.financials?.margin>0?"text-green-600":"text-red-500"}`,children:[l.financials?.margin?.toFixed(0)," ",(0,a.jsx)("span",{className:"text-base font-black ml-px",children:"‚Ç¨"})]})})]})})]})]})]})})]})]})]}):(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-full bg-white rounded-xl border-dashed border-2 border-gray-200 p-12 text-gray-400",children:[(0,a.jsx)("span",{className:"text-6xl mb-4",children:"üß¨"}),(0,a.jsx)("p",{className:"text-lg font-medium text-gray-500",children:"Simulador de Rendimiento"}),(0,a.jsx)("p",{className:"text-center text-sm max-w-xs mt-2",children:"Selecciona un animal para ver su potencial."})]})})]})})}let H={Sanitario:["Saneamiento","Tratamiento","Vacunaci√≥n","Desparasitaci√≥n","Consulta Vet"],Reproductivo:["Celo","Inseminaci√≥n","Diagn√≥stico Gestaci√≥n","Parto","Aborto","Secado"],Productivo:["Pesaje","Condici√≥n Corporal","Orde√±o (Pendiente)"],Movimientos:["Cambio de Corral","Entrada","Salida","Venta","Muerte/Sacrificio"]};function W(){let{read:e,write:r}=(0,s.useStorage)(),[l,i]=(0,t.useState)([]),[n,o]=(0,t.useState)(!0),[d,c]=(0,t.useState)(!1),[m,g]=(0,t.useState)({category:"Sanitario",type:"Saneamiento",date:new Date().toISOString().split("T")[0],formattedDate:new Date().toISOString().split("T")[0],notes:"",cost:"",relatedType:"none",relatedId:"",corral:"",price:"",weightLive:"",weightCarcass:"",yield:"",seuropConf:"",fatCover:""}),[x,p]=(0,t.useState)([]),[h,u]=(0,t.useState)([]),[f,b]=(0,t.useState)(""),[y,j]=(0,t.useState)([]);(0,t.useEffect)(()=>{let a=e("sessionUser","");if(b(a),a){let t=e("events",[]),r=e(`fincas_${a}`,[]),s=e(`animals_${a}`,[]);p(r),u(s);let l=[];s.forEach(e=>{let a=U.getLifecycleAlerts({...e,birthDate:e.birth});a.length>0&&l.push(...a.map(a=>({...a,crotal:e.crotal,farm:e.farm})))}),j(l),i([...t].sort((e,a)=>new Date(a.date).getTime()-new Date(e.date).getTime())),o(!1)}},[e]);let _=async()=>{if(!m.notes&&!m.type)return void alert("A√±ade al menos una nota o tipo");let a={animals:e(`animals_${f}`,[]),events:e("events",[]),currentUser:f,storage:{read:e,write:r}},t={type:m.type||H[m.category][0],date:m.formattedDate,desc:(m.corral?`[Corral ${m.corral}] `:"")+m.notes,cost:Number(m.cost),animal:"animal"===m.relatedType?a.animals.find(e=>e.id===m.relatedId):{id:"farm"===m.relatedType?m.relatedId:"GENERAL",crotal:"farm"===m.relatedType?"FINCA":"GENERAL"},typeData:{price:m.price,liveWeight:m.weightLive,carcassWeight:m.weightCarcass,yield:m.yield,seuropConf:m.seuropConf,fatCover:m.fatCover}};if("farm"===m.relatedType){let e=x.find(e=>e.id===m.relatedId)?.name||"Finca";t.animal={id:m.relatedId,crotal:e,farmId:m.relatedId}}await A.handleStandardEvent(t,a),i([...e("events",[])].sort((e,a)=>new Date(a.date).getTime()-new Date(e.date).getTime())),c(!1),g({category:"Sanitario",type:"Saneamiento",date:new Date().toISOString().split("T")[0],formattedDate:new Date().toISOString().split("T")[0],notes:"",cost:"",relatedType:"none",relatedId:"",corral:"",price:"",weightLive:"",weightCarcass:"",yield:"",seuropConf:"",fatCover:""})};return(0,a.jsxs)("div",{className:"space-y-6",children:[y.length>0&&(0,a.jsxs)("div",{className:"bg-orange-50 border border-orange-100 rounded-xl p-4 animate-in slide-in-from-top-2",children:[(0,a.jsxs)("h3",{className:"text-orange-800 font-bold flex items-center gap-2 text-sm mb-3",children:[(0,a.jsx)("span",{className:"text-xl",children:"üîî"})," Alertas del Ciclo de Vida"]}),(0,a.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:y.map((e,t)=>(0,a.jsxs)("div",{className:"bg-white p-3 rounded-lg border border-orange-100 shadow-sm flex justify-between items-center text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-bold text-gray-800",children:e.desc}),(0,a.jsxs)("p",{className:"text-xs text-gray-500",children:["Animal: ",e.crotal," (",e.farm,")"]})]}),(0,a.jsx)("div",{className:"text-right",children:(0,a.jsx)("span",{className:`text-xs font-bold px-2 py-1 rounded ${e.isDue?"bg-red-100 text-red-700":"bg-gray-100 text-gray-600"}`,children:e.date})})]},t))})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-gray-800",children:"Eventos"}),(0,a.jsx)("p",{className:"text-gray-600",children:"Registro hist√≥rico de acciones y sucesos"})]}),(0,a.jsxs)("button",{onClick:()=>c(!0),className:"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2",children:[(0,a.jsx)("span",{children:"+"})," Nuevo Evento"]})]}),d&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4",children:(0,a.jsxs)("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in-95 duration-200",children:[(0,a.jsxs)("div",{className:"bg-green-50 px-6 py-4 border-b border-green-100 flex justify-between items-center",children:[(0,a.jsx)("h3",{className:"font-bold text-green-900",children:"Registrar Evento"}),(0,a.jsx)("button",{onClick:()=>c(!1),className:"text-gray-400 hover:text-gray-600",children:"‚úï"})]}),(0,a.jsxs)("div",{className:"p-6 space-y-4",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Fecha"}),(0,a.jsx)("input",{type:"date",value:m.formattedDate,onChange:e=>g({...m,formattedDate:e.target.value}),className:"w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 outline-none"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Categor√≠a"}),(0,a.jsx)("select",{value:m.category,onChange:e=>{let a=e.target.value;g({...m,category:a,type:H[a][0]})},className:"w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 outline-none font-bold text-gray-700",children:Object.keys(H).map(e=>(0,a.jsx)("option",{value:e,children:e},e))})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Evento Espec√≠fico"}),(0,a.jsx)("select",{value:m.type,onChange:e=>g({...m,type:e.target.value}),className:"w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 outline-none bg-gray-50",children:H[m.category].map(e=>(0,a.jsx)("option",{value:e,children:e},e))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Vinculaci√≥n (Opcional)"}),(0,a.jsxs)("div",{className:"flex gap-2 mb-2",children:[(0,a.jsx)("button",{onClick:()=>g({...m,relatedType:"none",relatedId:"",corral:""}),className:`flex-1 py-1 text-xs rounded border ${"none"===m.relatedType?"bg-gray-800 text-white border-gray-800":"bg-white text-gray-600 border-gray-200"}`,children:"General"}),(0,a.jsx)("button",{onClick:()=>g({...m,relatedType:"farm",relatedId:"",corral:""}),className:`flex-1 py-1 text-xs rounded border ${"farm"===m.relatedType?"bg-green-600 text-white border-green-600":"bg-white text-gray-600 border-gray-200"}`,children:"Finca"}),(0,a.jsx)("button",{onClick:()=>g({...m,relatedType:"animal",relatedId:"",corral:""}),className:`flex-1 py-1 text-xs rounded border ${"animal"===m.relatedType?"bg-orange-500 text-white border-orange-500":"bg-white text-gray-600 border-gray-200"}`,children:"Animal"})]}),"farm"===m.relatedType&&(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)("select",{value:m.relatedId,onChange:e=>g({...m,relatedId:e.target.value,corral:""}),className:"w-full border rounded-lg px-3 py-2 text-sm flex-1",children:[(0,a.jsx)("option",{value:"",children:"Selecciona Finca..."}),x.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))]}),m.relatedId&&(0,a.jsxs)("select",{value:m.corral,onChange:e=>g({...m,corral:e.target.value}),className:"w-32 border rounded-lg px-3 py-2 text-sm",children:[(0,a.jsx)("option",{value:"",children:"Corral..."}),Array.from({length:x.find(e=>e.id===m.relatedId)?.corrals||0},(e,a)=>a+1).map(e=>(0,a.jsxs)("option",{value:e,children:["Corral ",e]},e))]})]}),"animal"===m.relatedType&&(0,a.jsxs)("select",{value:m.relatedId,onChange:e=>g({...m,relatedId:e.target.value}),className:"w-full border rounded-lg px-3 py-2 text-sm",children:[(0,a.jsx)("option",{value:"",children:"Selecciona Animal..."}),h.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.crotal," (",e.breed||"?",")"]},e.id))]})]}),["Venta","Salida","Muerte/Sacrificio"].includes(m.type)&&(0,a.jsxs)("div",{className:"bg-red-50 border border-red-100 rounded-lg p-3 space-y-3",children:[(0,a.jsx)("h4",{className:"font-bold text-red-800 text-xs uppercase flex items-center gap-2",children:"ü•© Datos Comerciales / Canal"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Importe Venta (‚Ç¨)"}),(0,a.jsx)("input",{type:"number",step:"0.01",className:"w-full border rounded px-2 py-1 text-sm field-focus",value:m.price,onChange:e=>g({...m,price:e.target.value})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Peso Vivo (kg)"}),(0,a.jsx)("input",{type:"number",step:"0.1",className:"w-full border rounded px-2 py-1 text-sm field-focus",value:m.weightLive,onChange:e=>g({...m,weightLive:e.target.value})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Peso Canal (kg)"}),(0,a.jsx)("input",{type:"number",step:"0.1",className:"w-full border rounded px-2 py-1 text-sm field-focus",value:m.weightCarcass,onChange:e=>{let a=Number(e.target.value),t=Number(m.weightLive),r=t>0?(a/t*100).toFixed(1):"";g({...m,weightCarcass:e.target.value,yield:r})}})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Rendimiento (%)"}),(0,a.jsx)("input",{type:"number",step:"0.1",className:"w-full border rounded px-2 py-1 text-sm field-focus bg-gray-100",value:m.yield,readOnly:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Conf. (SEUROP)"}),(0,a.jsxs)("select",{className:"w-full border rounded px-2 py-1 text-sm field-focus",value:m.seuropConf,onChange:e=>g({...m,seuropConf:e.target.value}),children:[(0,a.jsx)("option",{value:"",children:"-"}),["S","E","U","R","O","P"].map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Grasa (1-5)"}),(0,a.jsxs)("select",{className:"w-full border rounded px-2 py-1 text-sm field-focus",value:m.fatCover,onChange:e=>g({...m,fatCover:e.target.value}),children:[(0,a.jsx)("option",{value:"",children:"-"}),["1","2","3","4","5"].map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})]})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Descripci√≥n / Notas"}),(0,a.jsx)("textarea",{value:m.notes,onChange:e=>g({...m,notes:e.target.value}),className:"w-full border rounded-lg px-3 py-2 text-sm h-24 resize-none focus:ring-2 focus:ring-green-500 outline-none",placeholder:"Detalles del evento..."})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Coste (‚Ç¨) - Opcional"}),(0,a.jsx)("input",{type:"number",value:m.cost,onChange:e=>g({...m,cost:e.target.value}),className:"w-full border rounded-lg px-3 py-2 text-sm",placeholder:"0.00"})]})]}),(0,a.jsxs)("div",{className:"bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t",children:[(0,a.jsx)("button",{onClick:()=>c(!1),className:"text-gray-600 font-medium text-sm hover:text-gray-800",children:"Cancelar"}),(0,a.jsx)("button",{onClick:_,className:"bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg text-sm shadow-sm transition-transform active:scale-95",children:"Crear Evento"})]})]})}),(0,a.jsx)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden",children:(0,a.jsxs)("table",{className:"w-full text-left",children:[(0,a.jsx)("thead",{className:"bg-gray-50 text-gray-600 font-medium text-sm",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"p-4",children:"Fecha"}),(0,a.jsx)("th",{className:"p-4",children:"Tipo"}),(0,a.jsx)("th",{className:"p-4",children:"Animal / Finca"}),(0,a.jsx)("th",{className:"p-4",children:"Notas"}),(0,a.jsx)("th",{className:"p-4 text-right",children:"Costo"})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-gray-100",children:n?(0,a.jsx)("tr",{children:(0,a.jsx)("td",{colSpan:5,className:"p-8 text-center text-gray-500",children:"Cargando eventos..."})}):0===l.length?(0,a.jsx)("tr",{children:(0,a.jsx)("td",{colSpan:5,className:"p-8 text-center text-gray-500",children:"No hay eventos recientes."})}):l.map((e,t)=>(0,a.jsxs)("tr",{className:"hover:bg-gray-50 transition-colors",children:[(0,a.jsx)("td",{className:"p-4 text-gray-900 font-medium",children:new Date(e.date).toLocaleDateString()}),(0,a.jsx)("td",{className:"p-4 text-gray-600",children:(0,a.jsx)("span",{className:`inline-block px-2 py-1 rounded text-xs font-bold
                                            ${"Sanitario"===e.type?"bg-red-50 text-red-700":"Alimentaci√≥n"===e.type?"bg-yellow-50 text-yellow-700":"Mantenimiento"===e.type?"bg-blue-50 text-blue-700":"bg-green-50 text-green-700"}`,children:e.type})}),(0,a.jsx)("td",{className:"p-4 text-gray-600 text-sm",children:e.animalCrotal?(0,a.jsx)("span",{className:"font-mono bg-gray-100 px-1 rounded",children:e.animalCrotal}):"-"}),(0,a.jsx)("td",{className:"p-4 text-gray-600 text-sm max-w-xs truncate",children:e.desc||e.notes||"-"}),(0,a.jsx)("td",{className:"p-4 text-gray-600 text-right font-medium",children:e.cost>0?Number(e.cost).toLocaleString("es-ES",{style:"currency",currency:"EUR"}):"-"})]},t))})]})})]})}function q(){let{read:e}=(0,s.useStorage)(),t=async()=>{try{let a=e("sessionUser",""),t=e(`animals_${a}`,[]);if(!t||0===t.length)return void alert("No hay animales registrados para generar el reporte.");let r="ID;Raza;Sexo;Peso (kg);Edad (meses);GMD Estimada (kg/d);Ingesta Objetivo (kg MS);Eficiencia (FCR);Costo Diario Est (‚Ç¨)\n";for(let e of t){let a=(new Date().getTime()-new Date(e.birth).getTime())/2630016e3,t=M.getBreedById(e.breed)||M.getBreedByName(e.breed)||M.getAllBreeds()[0],s="Macho"===e.sex||"Hembra"===e.sex||"Castrado"===e.sex?e.sex:"Macho",l=I.calculateRequirements(e.weight,1.2,a,"Cebo",s),i={totalEnergyMcal:l?10*l.em_mcal:15,totalProteinG:1200,dmiKg:10},n=i.totalEnergyMcal/i.dmiKg,o=I.predictPerformance(t,n,i.dmiKg,e.weight),d=i.dmiKg/.9*.15,c=o>0?(i.dmiKg/o).toFixed(2):"N/A";r+=`${e.id};${e.breed};${e.sex};${e.weight};${a.toFixed(1)};${o.toFixed(2)};${i.dmiKg.toFixed(2)};${c};${d.toFixed(2)}
`}let s=new Blob([r],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(s),i=document.createElement("a");i.setAttribute("href",l),i.setAttribute("download",`reporte_rendimiento_fcr_${new Date().toISOString().slice(0,10)}.csv`),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i)}catch(e){console.error("Error generating report:",e),alert("Error al generar el reporte. Ver consola para detalles.")}};return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-gray-800",children:"Reportes"}),(0,a.jsx)("p",{className:"text-gray-600",children:"Generaci√≥n de informes y estad√≠sticas"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,a.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:border-green-200 transition-colors cursor-pointer group",children:[(0,a.jsx)("span",{className:"text-3xl mb-4 block group-hover:scale-110 transition-transform",children:"üìä"}),(0,a.jsx)("h3",{className:"font-bold text-lg text-gray-800 mb-2",children:"Informe Econ√≥mico"}),(0,a.jsx)("p",{className:"text-gray-500 text-sm",children:"Resumen de gastos, ingresos estimados y valor de inventario."})]}),(0,a.jsxs)("div",{onClick:t,className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:border-green-200 transition-colors cursor-pointer group",children:[(0,a.jsx)("span",{className:"text-3xl mb-4 block group-hover:scale-110 transition-transform",children:"üìà"}),(0,a.jsx)("h3",{className:"font-bold text-lg text-gray-800 mb-2",children:"Informe de Rendimiento (FCR)"}),(0,a.jsx)("p",{className:"text-gray-500 text-sm",children:"Descargar CSV con evoluci√≥n de peso, GMD y eficiencia alimentaria."})]}),(0,a.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:border-green-200 transition-colors cursor-pointer group",children:[(0,a.jsx)("span",{className:"text-3xl mb-4 block group-hover:scale-110 transition-transform",children:"üß¨"}),(0,a.jsx)("h3",{className:"font-bold text-lg text-gray-800 mb-2",children:"Informe Reproductivo"}),(0,a.jsx)("p",{className:"text-gray-500 text-sm",children:"Tasas de fertilidad, partos y saneamiento."})]})]})]})}let K=d("shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]]),Y=d("briefcase",[["path",{d:"M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16",key:"jecpp"}],["rect",{width:"20",height:"14",x:"2",y:"6",rx:"2",key:"i6l2r4"}]]),Z=d("phone",[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]]),J=d("credit-card",[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]]),X=d("trash-2",[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]]),Q=d("pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]),ee=d("search",[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]]),ea=d("plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]),et=d("save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),er=d("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]);function es(){let{read:e,write:r}=(0,s.useStorage)(),l=e("users",[]),i=e("sessionUser",""),[n,o]=(0,t.useState)(""),[d,c]=(0,t.useState)(null),[m,g]=(0,t.useState)(!1),[p,h]=(0,t.useState)({role:"worker",jobTitle:"Pe√≥n Ganadero"}),u=l.filter(e=>e.name.toLowerCase().includes(n.toLowerCase())||e.firstName?.toLowerCase().includes(n.toLowerCase())||e.lastName?.toLowerCase().includes(n.toLowerCase()));return(0,a.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,a.jsxs)("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h2",{className:"text-2xl font-bold text-gray-800 flex items-center gap-2",children:[(0,a.jsx)(K,{className:"w-8 h-8 text-green-600"}),"Gesti√≥n de Equipo"]}),(0,a.jsx)("p",{className:"text-gray-500",children:"Administra los perfiles y permisos del personal"})]}),(0,a.jsxs)("button",{onClick:()=>{c(null),g(!0),h({role:"worker",jobTitle:"Pe√≥n Ganadero",pass:"123456"})},className:"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 shadow-sm transition-all hover:shadow-md",children:[(0,a.jsx)(ea,{className:"w-4 h-4"}),"Nuevo Empleado"]})]}),(0,a.jsxs)("div",{className:"bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3",children:[(0,a.jsx)(ee,{className:"w-5 h-5 text-gray-400"}),(0,a.jsx)("input",{type:"text",placeholder:"Buscar por nombre, usuario o DNI...",value:n,onChange:e=>o(e.target.value),className:"flex-1 outline-none text-gray-700 placeholder-gray-400"})]}),(m||d)&&(0,a.jsxs)("div",{className:"bg-white rounded-xl shadow-lg border border-green-100 overflow-hidden",children:[(0,a.jsxs)("div",{className:"bg-green-50 px-6 py-4 border-b border-green-100 flex justify-between items-center",children:[(0,a.jsxs)("h3",{className:"font-bold text-green-800 flex items-center gap-2",children:[m?(0,a.jsx)(ea,{className:"w-5 h-5"}):(0,a.jsx)(Q,{className:"w-5 h-5"}),m?"Alta de Empleado":`Editando: ${d?.name}`]}),(0,a.jsx)("button",{onClick:()=>{g(!1),c(null)},className:"text-gray-400 hover:text-gray-600",children:(0,a.jsx)(er,{className:"w-5 h-5"})})]}),(0,a.jsxs)("div",{className:"p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h4",{className:"text-xs font-bold text-gray-400 uppercase tracking-wider border-b pb-1",children:"Cuenta"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Usuario (Login)"}),(0,a.jsx)("input",{disabled:!m,value:p.name||"",onChange:e=>h({...p,name:e.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none disabled:bg-gray-100"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Contrase√±a"}),(0,a.jsx)("input",{type:"password",value:p.pass||"",onChange:e=>h({...p,pass:e.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rol de Acceso"}),(0,a.jsxs)("select",{value:p.role||"worker",onChange:e=>h({...p,role:e.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none bg-white",children:[(0,a.jsx)("option",{value:"worker",children:"Trabajador (B√°sico)"}),(0,a.jsx)("option",{value:"vet",children:"Veterinario (Sanitario)"}),(0,a.jsx)("option",{value:"admin",children:"Administrador (Total)"})]})]})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h4",{className:"text-xs font-bold text-gray-400 uppercase tracking-wider border-b pb-1",children:"Datos Personales"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre"}),(0,a.jsx)("input",{value:p.firstName||"",onChange:e=>h({...p,firstName:e.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Apellidos"}),(0,a.jsx)("input",{value:p.lastName||"",onChange:e=>h({...p,lastName:e.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none"})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"DNI / NIE"}),(0,a.jsx)("input",{value:p.dni||"",onChange:e=>h({...p,dni:e.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"F. Nacimiento"}),(0,a.jsx)("input",{type:"date",value:p.dob||"",onChange:e=>h({...p,dob:e.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none"})]})]})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h4",{className:"text-xs font-bold text-gray-400 uppercase tracking-wider border-b pb-1",children:"Fitcha T√©cnica"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Puesto / Cargo"}),(0,a.jsx)("input",{value:p.jobTitle||"",onChange:e=>h({...p,jobTitle:e.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none",placeholder:"Ej: Tractorista, Veterinario Jefe..."})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tel√©fono Contacto"}),(0,a.jsx)("input",{value:p.phone||"",onChange:e=>h({...p,phone:e.target.value}),className:"w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none"})]})]})]}),(0,a.jsxs)("div",{className:"px-6 py-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100",children:[(0,a.jsx)("button",{onClick:()=>{g(!1),c(null)},className:"px-4 py-2 text-gray-600 font-medium hover:text-gray-800",children:"Cancelar"}),(0,a.jsxs)("button",{onClick:()=>{if(!p.name||!p.pass)return alert("Usuario y Contrase√±a son obligatorios");let e=[...l];if(m){if(l.find(e=>e.name===p.name))return alert("El usuario ya existe");e.push({...p,joined:new Date().toISOString()})}else d&&(e=e.map(e=>e.name===d.name?{...e,...p}:e));r("users",e),c(null),g(!1),h({role:"worker",jobTitle:"Pe√≥n Ganadero"})},className:"bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2 shadow-sm transition-all",children:[(0,a.jsx)(et,{className:"w-4 h-4"}),"Guardar Ficha"]})]})]}),(0,a.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:u.map((e,t)=>(0,a.jsxs)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow group",children:[(0,a.jsxs)("div",{className:"p-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-sm
                                        ${"admin"===e.role?"bg-purple-600":"vet"===e.role?"bg-blue-500":"bg-green-600"}
                                    `,children:e.firstName?e.firstName.charAt(0):e.name.charAt(0)}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("h3",{className:"font-bold text-gray-900",children:[e.firstName," ",e.lastName]}),(0,a.jsxs)("p",{className:"text-xs text-gray-500",children:["@",e.name]})]})]}),(0,a.jsx)("span",{className:`px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border
                                    ${"admin"===e.role?"bg-purple-50 text-purple-700 border-purple-100":"vet"===e.role?"bg-blue-50 text-blue-700 border-blue-100":"bg-gray-50 text-gray-600 border-gray-200"}
                                `,children:"admin"===e.role?"ADMIN":"vet"===e.role?"VETERINARIO":"TRABAJADOR"})]}),(0,a.jsxs)("div",{className:"space-y-2 text-sm text-gray-600 mt-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(Y,{className:"w-4 h-4 text-gray-400"}),(0,a.jsx)("span",{children:e.jobTitle||"Sin puesto definido"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(J,{className:"w-4 h-4 text-gray-400"}),(0,a.jsx)("span",{children:e.dni||"Sin DNI"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(Z,{className:"w-4 h-4 text-gray-400"}),(0,a.jsx)("span",{children:e.phone||"Sin Tel√©fono"})]}),e.dob&&(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(x,{className:"w-4 h-4 text-gray-400"}),(0,a.jsxs)("span",{children:[new Date(e.dob).toLocaleDateString()," (",new Date().getFullYear()-new Date(e.dob).getFullYear()," a√±os)"]})]})]})]}),(0,a.jsxs)("div",{className:"px-6 py-3 bg-gray-50 border-t border-gray-100 flex justify-between items-center opacity-0 group-hover:opacity-100 transition-opacity",children:[(0,a.jsxs)("button",{onClick:()=>{c(e),g(!1),h({...e})},className:"text-green-600 font-medium text-xs hover:underline flex items-center gap-1",children:[(0,a.jsx)(Q,{className:"w-3 h-3"})," Editar Ficha"]}),e.name!==i&&(0,a.jsxs)("button",{onClick:()=>(e=>{if(e===i)return alert("No puedes eliminar tu propio usuario");confirm(`\xbfEliminar usuario ${e}?`)&&r("users",l.filter(a=>a.name!==e))})(e.name),className:"text-red-600 font-medium text-xs hover:underline flex items-center gap-1",children:[(0,a.jsx)(X,{className:"w-3 h-3"})," Eliminar"]})]})]},t))})]})}function el(){let{read:e,write:r}=(0,s.useStorage)(),l=e("sessionUser","Usuario"),[i,n]=t.default.useState(null);t.default.useEffect(()=>{let a=e("userAvatar",null);a&&n(a)},[e]);let o=e("users",[]).find(e=>e.name===l),d=l?.toLowerCase().includes("gerencia")||"gerencia@sotodelprior.com"===l,c=o?.role==="admin"||d,m=c?"admin":o?.role||"worker",[g,x]=t.default.useState(""),[p,h]=t.default.useState(""),[u,f]=t.default.useState("worker"),[b,y]=t.default.useState(!1);return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-800",children:"Mi Perfil"}),(0,a.jsxs)("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 md:p-8",children:[(0,a.jsxs)("div",{className:"flex flex-col md:flex-row items-center gap-6",children:[(0,a.jsxs)("div",{className:"relative group cursor-pointer",children:[(0,a.jsx)("input",{type:"file",accept:"image/*",className:"hidden",id:"avatar-upload",onChange:e=>{let a=e.target.files?.[0];if(a){let e=new FileReader;e.onloadend=()=>{let a=e.result;n(a),r("userAvatar",a)},e.readAsDataURL(a)}}}),(0,a.jsxs)("label",{htmlFor:"avatar-upload",className:"cursor-pointer block",children:[i?(0,a.jsx)("img",{src:i,alt:"Profile",className:"w-24 h-24 rounded-full object-cover shadow-md group-hover:opacity-75 transition-opacity"}):(0,a.jsx)("div",{className:"w-24 h-24 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-4xl shadow-md group-hover:bg-green-700 transition-colors",children:l.charAt(0).toUpperCase()}),(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/30 rounded-full text-white text-xs font-bold pointer-events-none",children:"CAMBIAR"})]})]}),(0,a.jsxs)("div",{className:"text-center md:text-left space-y-2",children:[(0,a.jsx)("h2",{className:"text-xl font-bold text-gray-900",children:l}),(0,a.jsx)("span",{className:`inline-block text-xs px-2 py-1 rounded-full font-medium ${c?"bg-purple-100 text-purple-800":"bg-gray-100 text-gray-800"}`,children:"admin"===m?"Administrador":"vet"===m?"Veterinario":"Trabajador"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 max-w-md",children:c?"Cuenta administrativa con acceso completo a la gesti√≥n de fincas, inventario animal, finanzas y equipo.":"Cuenta de usuario con permisos limitados seg√∫n su rol asignado."})]})]}),(0,a.jsxs)("div",{className:"mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-semibold text-gray-500 uppercase mb-1",children:"Email / Usuario"}),(0,a.jsx)("p",{className:"text-gray-900 font-medium",children:l})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-semibold text-gray-500 uppercase mb-1",children:"Rol"}),(0,a.jsx)("p",{className:"text-gray-900 font-medium capitalize",children:"admin"===m?"Administrador":"vet"===m?"Veterinario":"Trabajador"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-xs font-semibold text-gray-500 uppercase mb-1",children:"Empresa"}),(0,a.jsx)("p",{className:"text-gray-900 font-medium",children:"SOTO DEL PRIOR"})]})]})]})]})}function ei(){let{read:e,write:a,isLoaded:r}=(0,s.useStorage)(),l=(0,t.useRef)(!1);return(0,t.useEffect)(()=>{if(!r)return;let t=e("appSession","")||e("sessionUser","");if(!t)return;let s=`animals_${t}`,i=`fincas_${t}`,n=e(s,[]),o=e("events",[]),d=e(i,[]),c=!1;0===d.length&&(d.push({id:"finca-default-001",name:"SOTO del PRIOR",municipio:"Belv√≠s de la Jara",municipioCode:"020",provinciaCode:"45",poligono:"1",parcela:"1",superficie:153940,recintos:[],coords:{lat:39.7589,lng:-4.7634},license:"ES450200000001",maxHeads:90,soilId:"franco_arenoso",corrals:4,feedingSystem:"extensivo"}),c=!0);let m=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var a=16*Math.random()|0;return("x"==e?a:3&a|8).toString(16)}),g=new Set(n.filter(e=>"Buey"===e.category||"Castrado"===e.sex||e.name&&e.name.toLowerCase().includes("buey")).map(e=>e.id)),x=n.some(e=>"SOTO del PRIOR"!==e.farm||e.name&&e.name.toLowerCase().includes("buey")&&"Buey"!==e.category||("Semental"===e.category||"Macho"===e.sex&&"Toro"===e.category&&!e.name.toLowerCase().includes("buey"))&&("Limousin"!==e.breed||e.name.includes("TORO_CHA"))||e.isGhost&&"Cruzada"===e.breed&&e.fatherId||e.fatherId&&g.has(e.fatherId)||o.some(e=>e.desc&&(e.desc.includes("TORO_CHA")||e.desc.includes("Charolais"))));n.length>0&&o.length;let p="true"===e("isSeeded_V10","false"),h=n.filter(e=>e.isGhost).length,u=n.length,f=u>100&&h>.8*u;if((!p||f)&&!c){console.log("Starting Data Enrichment & Reparation Engine V3 (Weight Recalc)..."),x&&(console.log("Bad data detected - Wiping events for fresh regeneration."),o=[]);let e=[...o];f&&(console.warn("CRITICAL: Massive duplication detected. Purging ghosts immediately."),console.log("Purge Result: Reduced animals to "+(n=[...n.filter(e=>!e.isGhost),...n.filter(e=>e.isGhost).slice(-20)]).length),a("events",o=o.slice(-500)),a("isSeeded_V5","true"));let t=new Set;n.forEach(e=>{("Buey"===e.category||"Castrado"===e.sex||e.name&&e.name.toLowerCase().includes("buey"))&&t.add(e.id)}),n.forEach(e=>{e.farm="SOTO del PRIOR",e.farmId="F0SOTO",(e.name&&e.name.toLowerCase().includes("buey")||e.type&&e.type.toLowerCase().includes("buey")||e.observation&&e.observation.toLowerCase().includes("buey"))&&(e.category="Buey",e.sex="Castrado",t.add(e.id)),("Semental"===e.category||"Macho"===e.sex&&"Toro"===e.category)&&"Buey"!==e.category&&"Castrado"!==e.sex&&(e.breed="Limousin",e.name&&e.name.includes("TORO_CHA")&&(e.name=e.name.replace("TORO_CHA","TORO_LIM"))),e.fatherId&&t.has(e.fatherId)&&(console.log(`Clearing invalid paternity: ${e.id} had Ox father ${e.fatherId}`),e.fatherId=null,e.father=null),e.breed&&(e.breed.includes("F1 F1")||e.breed.match(/F1.*F1/))&&(e.breed=e.breed.replace(/F1 F1/g,"F2").replace(/F1.*F1/g,"F2"))});let r=n.find(e=>("Semental"===e.category||"Macho"===e.sex&&"Toro"===e.category)&&"Buey"!==e.category&&"Castrado"!==e.sex);r||(r=n.find(e=>"Macho"===e.sex&&"Buey"!==e.category&&"Castrado"!==e.sex&&new Date().getFullYear()-new Date(e.birthDate||e.birth).getFullYear()>2));let s=r?r.id:"unknown_bull",l=r?r.crotal||r.name:"Toro Externo";console.log(`Sire identified: ${l}`);let i=()=>{let e=Math.floor(1e10*Math.random()).toString().padStart(10,"0");return`ES08${e}`};n.filter(e=>("Vaca"===e.category||"Vaca Nodriza"===e.category||"Hembra"===e.sex)&&new Date().getTime()-new Date(e.birthDate||e.birth).getTime()>63072e6).forEach(a=>{let t=new Date(new Date(a.birthDate||a.birth));t.setMonth(t.getMonth()+24);let r=new Date,o=1;for(;t<r;){let d=new Date(t);e.push({id:m(),type:"Monta Natural",animalId:a.id,animalCrotal:a.crotal,date:d.toISOString().split("T")[0],desc:`Monta Natural con ${l} (Ciclo ${o})`,typeData:{bullId:s},status:"completed"});let g=new Date(d);if(g.setDate(g.getDate()+283),g>r){e.push({id:m(),type:"Parto Previsto",animalId:a.id,animalCrotal:a.crotal,date:g.toISOString().split("T")[0],desc:`Parto estimado (Ciclo ${o})`,status:"scheduled"});break}let x=n.find(e=>e.id!==s&&45>=Math.ceil(Math.abs(new Date(e.birthDate||e.birth).getTime()-g.getTime())/864e5)&&!e.motherId);if(x)x.motherId=a.id,x.fatherId=s,x.father=l,e.push({id:m(),type:"Parto",animalId:a.id,animalCrotal:a.crotal,date:g.toISOString().split("T")[0],desc:`Parto ${o}: ${x.sex} (${x.crotal}) - ACTIVO`,typeData:{calfId:x.id,calfCrotal:x.crotal},status:"completed"}),e.some(e=>e.animalId===x.id&&"Nacimiento"===e.type)||e.push({id:m(),type:"Nacimiento",animalId:x.id,animalCrotal:x.crotal,date:x.birthDate||g.toISOString().split("T")[0],desc:`Nacimiento en finca. Madre: ${a.crotal}, Padre: ${l}`,status:"completed"});else{let t=Math.random()>.5,d=i(),x=Math.random()>.3?"Sacrificado":"Vendido",p="Sacrificado"===x?14:6,h=new Date(g);h.setMonth(h.getMonth()+p),h>r&&h.setTime(r.getTime()-864e6);let u=r.getTime()-h.getTime()<31104e6,f={};if("Sacrificado"===x){let e=280+100*Math.random();f={carcassWeight:e.toFixed(1),price:(5.2*e).toFixed(2),pricePerKg:5.2,conf:["U","R","O"][Math.floor(3*Math.random())],fat:["2","3","4"][Math.floor(3*Math.random())]}}if(u){let e={id:d,crotal:d,name:`(H) ${t?"Novilla":"Ternero"} ${o}`,farm:a.farm||"SOTO del PRIOR",breed:"Limousin"===a.breed||"Limousina"===a.breed?"Limousin":a.breed&&a.breed.includes("F1")?`F2 ${a.breed.replace("F1","").trim()} x Limousin`:`F1 ${a.breed||"Cruzada"} x Limousin`,sex:t?"Hembra":"Macho",birthDate:g.toISOString().split("T")[0],motherId:a.id,fatherId:s,father:l,status:x,exitDate:h.toISOString().split("T")[0],...f,isGhost:!0};n.push(e),c=!0}e.push({id:m(),type:"Parto",animalId:a.id,animalCrotal:a.crotal,date:g.toISOString().split("T")[0],desc:`Parto ${o}: ${t?"Hembra":"Macho"} (${d}) - ${x} ${!u?"(Hist√≥rico)":""}`,typeData:{calfCrotal:d},status:"completed"})}t.setMonth(t.getMonth()+13),o++}}),console.log("Bio-Simulation Complete.");let d=new Set,g=[];for(let e of o.reverse())d.has(e.id)||(d.add(e.id),g.push(e));o.length=0,o.push(...g.reverse()),c=!0,console.log("Enrichment Complete. Generated events:",o.length)}n.forEach(e=>{"Finca Soto del Prior"===e.farm&&(e.farm="SOTO del PRIOR",c=!0)}),c&&(a(s,n),a("events",o));let b=!1;d.forEach(e=>{"Finca Soto del Prior"===e.name&&(e.name="SOTO del PRIOR",b=!0)});let y=new Map;n.forEach(e=>{y.set(e.id,e)});let j=new Map;Array.from(y.values()).forEach(e=>{let a=(e.name||"unknown").trim().toUpperCase();j.has(a)?!j.get(a).crotal&&e.crotal&&j.set(a,e):j.set(a,e)});let _=Array.from(y.values()).filter(e=>{let a=(e.name||"").toUpperCase();return!(a.includes("BUEY")||a.includes("TORO")||a.includes("VACA"))||j.get(a).id===e.id}),v=!1,N=["Sacrificio","Muerte","Venta","Salida"],w=_.map(e=>{let a=e.crotal&&e.crotal.startsWith("ES099"),t=e.id&&e.id.startsWith("ES")&&e.id.length>10;if(!e.crotal||a&&t){if(t)e.crotal=e.id;else if(!e.crotal){(e.id.split("").reduce((e,a)=>e+a.charCodeAt(0),0)%1e4).toString().padStart(4,"0");let a=Math.floor(9e3*Math.random())+1e3;e.crotal=`ES099000${a}`}}let r=o.filter(a=>a.animalId===e.id).find(e=>N.includes(e.type));if(r&&new Date(r.date)<=new Date){let a=e.status;r.type.includes("Sacrificio")?e.status="Sacrificado":"Muerte"===r.type?e.status="Muerto":"Venta"===r.type&&(e.status="Vendido"),e.status!==a&&(v=!0),e.exitDate||(e.exitDate=r.date)}return e}),C=new Date().getTime(),S=w.filter(e=>!e.isGhost||"Activo"===e.status||C-new Date(e.exitDate||e.date||e.createdAt).getTime()<31536e6);if(S.forEach(e=>{e.monthlyRecords&&e.monthlyRecords.length>12&&(e.monthlyRecords=e.monthlyRecords.slice(-12))}),w.length!==S.length&&(console.log(`Pruned ${w.length-S.length} old ghost animals to save space.`),c=!0),w.length!==n.length&&(console.log(`Removed ${n.length-w.length} duplicates.`),c=!0),w.filter(e=>e.isGhost).length>200){console.warn("Detected Ghost Explosion. Purging ALL ghosts for safety reset.");let e=w.filter(e=>!e.isGhost);w.length=0,w.push(...e),c=!0}(c||b||v)&&(a("isSeeded_V10","true"),a(s,S),a(i,d),o.length>1e3&&(o=o.slice(-1e3),console.warn("Truncating events to last 1000 to prevent overflow.")),a("events",o),console.log("Advanced Data Seeding & Migration Completed")),l.current=!0},[r,e,a]),null}let en=d("download",[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]]),eo=d("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]]),ed=d("circle-alert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);function ec(){let[e,r]=(0,t.useState)(new Date().toLocaleDateString());return(0,a.jsxs)("div",{className:"p-6 bg-gray-50 min-h-full space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,a.jsx)(u,{className:"w-8 h-8 text-green-600"}),(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-800",children:"Gesti√≥n de Datos"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,a.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-800",children:"Precios de Referencia (SEUROP)"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:"Actualice las tablas de precios oficiales para el c√°lculo de rentabilidad."})]}),(0,a.jsx)("span",{className:"bg-green-100 text-green-700 text-[10px] px-2 py-1 rounded-full font-bold uppercase",children:"Activo"})]}),(0,a.jsx)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6",children:(0,a.jsxs)("div",{className:"flex justify-between items-center text-sm",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"√öltima actualizaci√≥n:"}),(0,a.jsx)("span",{className:"font-bold text-gray-800",children:e})]})}),(0,a.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,a.jsxs)("label",{className:"w-full h-32 border-2 border-dashed border-gray-200 rounded-xl flex flex-col items-center justify-center gap-2 hover:border-green-500 hover:bg-green-50 cursor-pointer transition-all group",children:[(0,a.jsx)(eo,{className:"w-8 h-8 text-gray-400 group-hover:text-green-600"}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("p",{className:"text-sm font-bold text-gray-700",children:"Actualizar Tarifas (CSV)"}),(0,a.jsx)("p",{className:"text-xs text-gray-400",children:"Arrastre o haga clic para subir"})]}),(0,a.jsx)("input",{type:"file",accept:".csv",className:"hidden",onChange:e=>{let a=e.target.files?.[0];if(!a)return;let t=new FileReader;t.onload=e=>{let a=e.target?.result;if(a)try{let e=G.importPricesFromCSV(a);alert(`\xc9xito: Se han actualizado ${e} registros de precios SEUROP.`),r(new Date().toLocaleDateString())}catch(e){console.error("Error importing CSV:",e),alert("Error al procesar el archivo CSV. Verifique el formato.")}},t.readAsText(a)}})]}),(0,a.jsxs)("div",{className:"flex items-start gap-2 p-3 bg-amber-50 rounded-lg border border-amber-100 text-xs text-amber-800",children:[(0,a.jsx)(ed,{className:"w-4 h-4 shrink-0 mt-0.5"}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Nota:"})," El CSV debe seguir el formato est√°ndar MAPA para categor√≠as y clasificaciones SEUROP."]})]})]})]}),(0,a.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 opacity-60",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-400 mb-2",children:"Exportaci√≥n de Datos"}),(0,a.jsx)("p",{className:"text-sm text-gray-400 mb-6",children:"Pr√≥ximamente: Exporte su inventario y registros en formato Excel o PDF."}),(0,a.jsxs)("button",{disabled:!0,className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-gray-100 text-gray-400 rounded-lg cursor-not-allowed font-bold uppercase text-xs",children:[(0,a.jsx)(en,{className:"w-4 h-4"}),"Descargar Backup"]})]})]})]})}function em({session:e}){let{write:l,isLoaded:i}=(0,s.useStorage)(),[n,o]=(0,t.useState)("home"),d=e?.user?.name||e?.user?.email||null;(0,t.useEffect)(()=>{d&&i&&(l("appSession",d),l("sessionUser",d))},[d,i,l]);let c=async()=>{l("appSession",null),await (0,r.signOut)({callbackUrl:"/login"})};return i?(0,a.jsxs)(_,{activeTab:n,onTabChange:o,onLogout:c,children:[(0,a.jsx)(ei,{}),"home"===n&&(0,a.jsx)(E,{onNavigate:o}),"farms"===n&&(0,a.jsx)(B,{}),"animals"===n&&(0,a.jsx)(z,{}),"events"===n&&(0,a.jsx)(W,{}),"calculator"===n&&(0,a.jsx)(V,{}),"reports"===n&&(0,a.jsx)(q,{}),"users"===n&&(0,a.jsx)(es,{}),"profile"===n&&(0,a.jsx)(el,{}),"data"===n&&(0,a.jsx)(ec,{})]}):(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-gray-50",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})})}e.s(["LivestockApp",()=>em],81979)}]);