<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Granjas - Soto del Prior</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="background"></div>
    <main class="shell">
        <!-- AUTH SECTION -->
        <section id="auth" class="auth-shell">
            <div class="auth-card">
                <img src="images/logo-soto.svg" alt="Soto del Prior" class="logo" style="height: 60px;">
                <h1 class="auth-title">Acceso a Granjas</h1>
                <div class="tabs">
                    <button id="loginTab" class="tab active">Iniciar sesión</button>
                    <button id="registerTab" class="tab">Crear cuenta</button>
                </div>
                <form id="loginForm" class="auth-form">
                    <div class="alert hidden" id="loginAlert">Estas credenciales no coinciden con nuestros registros.
                    </div>
                    <label>Usuario
                        <input type="text" id="loginUser" placeholder="usuario@email.com" required>
                    </label>
                    <label>Contraseña
                        <input type="password" id="loginPass" placeholder="******" required>
                    </label>
                    <button type="submit" class="primary full">Acceder</button>
                    <label class="remember">
                        <input type="checkbox" id="rememberCheck">
                        <span>Recordarme (guardar usuario y contraseña en este navegador)</span>
                    </label>
                    <a class="link" href="#" onclick="return false;">¿Olvidaste la contraseña?</a>
                </form>
                <form id="registerForm" class="auth-form hidden">
                    <label>Usuario
                        <input type="text" id="regUser" placeholder="nuevo usuario" required>
                    </label>
                    <label>Correo electrónico
                        <input type="email" id="regEmail" placeholder="tu@correo.com" required>
                    </label>
                    <label>Contraseña
                        <input type="password" id="regPass" placeholder="crea una clave" required>
                    </label>
                    <button type="submit" class="primary full">Registrarse</button>
                </form>
                <div class="footer-bar">Datos guardados en este navegador</div>
            </div>
        </section>

        <!-- DASHBOARD SECTION -->
        <div id="app" class="dashboard hidden">
            <div class="app-layout">
                <!-- SIDEBAR -->
                <aside class="sidebar">
                    <div class="user-card">
                        <div class="avatar" id="sidebarAvatar">U</div>
                        <div>
                            <p class="profile-name" id="sidebarName">Usuario</p>
                            <p class="profile-role">Usuario</p>
                        </div>
                    </div>
                    <nav class="nav">
                        <a href="#" class="nav-link active" data-target="home">Inicio</a>
                        <a href="#" class="nav-link" data-target="farms">Fincas</a>
                        <a href="#" class="nav-link" data-target="animals">Animales</a>
                        <a href="#" class="nav-link" data-target="events">Eventos</a>
                        <a href="#" class="nav-link" data-target="reports">Reportes</a>
                        <a href="#" class="nav-link" data-target="fcr">Calculadora FCR</a>
                        <a href="#" class="nav-link" id="nav-data" data-target="data">Datos</a>
                    </nav>
                    <div class="sidebar-actions">
                        <button class="ghost full" id="profileBtn">Mi perfil</button>
                        <button class="ghost full" id="logoutBtn">Cerrar sesión</button>
                    </div>
                </aside>

                <!-- MAIN CONTENT -->
                <div class="content">
                    <!-- HOME / DASHBOARD -->
                    <div id="home" class="section">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">PANEL DE CONTROL</p>
                                <h2>Resumen General</h2>
                                <p class="lede">Vista general de tu operación ganadera</p>
                            </div>
                        </div>

                        <div class="kpi-row">
                            <div class="kpi" id="weather-card"
                                style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; display: none; grid-column: 1 / -1;">
                                <div
                                    style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 8px;">
                                    <div>
                                        <p class="kpi-label" style="color: white; opacity: 0.9;">Clima en Finca</p>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <p class="kpi-value" id="weather-temp" style="margin:0;">--°C</p>
                                            <div id="rain-alert" class="hidden"
                                                style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px;">
                                                ☔ Alerta Lluvia
                                            </div>
                                        </div>
                                        <div
                                            style="display: flex; gap: 12px; font-size: 14px; opacity: 0.9; margin-top: 8px;">
                                            <span id="weather-hum">--%</span>
                                            <span id="weather-wind">-- km/h</span>
                                        </div>
                                    </div>
                                    <div id="weather-forecast"
                                        style="text-align: right; font-size: 13px; display: flex; flex-direction: column; gap: 4px;">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>

                                <div style="margin-top: 15px;">
                                    <p style="font-size: 12px; margin-bottom: 5px; opacity: 0.9;">Radar de Lluvia (En
                                        vivo)</p>
                                    <iframe id="rain-radar-frame" src=""
                                        style="width: 100%; height: 250px; border: 0; border-radius: 8px; background: rgba(0,0,0,0.2);"></iframe>
                                </div>
                            </div>
                        </div>

                        <!-- DISTRIBUTION (TOP) -->
                        <div class="card panel-chart" style="margin-bottom: 20px;">
                            <div class="card-head">
                                <h3>Distribución de Animales</h3>
                            </div>
                            <div class="distribution-grid"
                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h4 style="margin: 0 0 10px; color: #3b82f6;">Machos</h4>
                                    <table class="dist-table">
                                        <tr>
                                            <td>Bueyes</td>
                                            <td id="count-bueyes" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Toros</td>
                                            <td id="count-toros" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Utreros</td>
                                            <td id="count-utreros" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Novillos</td>
                                            <td id="count-novillos" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Añojos</td>
                                            <td id="count-anojos" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Terneros</td>
                                            <td id="count-terneros-m" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Becerros</td>
                                            <td id="count-becerros" class="text-right">0</td>
                                        </tr>
                                    </table>
                                </div>
                                <div>
                                    <h4 style="margin: 0 0 10px; color: #ec4899;">Hembras</h4>
                                    <table class="dist-table">
                                        <tr>
                                            <td>Nodrizas</td>
                                            <td id="count-nodrizas" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Vacas</td>
                                            <td id="count-vacas" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Novillas</td>
                                            <td id="count-novillas" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Añojas</td>
                                            <td id="count-anojas" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Terneras</td>
                                            <td id="count-terneras-h" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Becerras</td>
                                            <td id="count-becerras" class="text-right">0</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- ALERTS & ACTIONS (BOTTOM GRID) -->
                        <div class="panel-grid">
                            <div class="card panel-quality">
                                <div class="card-head">
                                    <h3>Próximos Eventos</h3>
                                </div>
                                <ul class="quality-list" id="alertsList">
                                    <li>
                                        <span>No hay eventos próximos</span>
                                    </li>
                                </ul>
                            </div>

                            <div class="card actions-card">
                                <h3>Acciones Rápidas</h3>
                                <div class="action-list">
                                    <button class="action-btn" data-action="add-animal">Registrar nuevo animal</button>
                                    <button class="action-btn" data-action="add-event">Registrar evento</button>
                                    <button class="action-btn" data-action="calc-fcr">Calcular FCR</button>
                                    <button class="action-btn" id="action-report">Generar reporte</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ANIMALS SECTION -->
                    <div id="animals" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">GESTIÓN DE ANIMALES</p>
                                <h2>Inventario de Animales</h2>
                                <p class="lede">Registro y seguimiento individual</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="ghost" onclick="downloadAnimalTemplate()"
                                    title="Descargar plantilla CSV">Plantilla</button>
                                <button class="ghost" onclick="document.getElementById('animalBatchInput').click()"
                                    title="Importar animales desde CSV">Cargar CSV</button>
                                <input type="file" id="animalBatchInput" accept=".csv" class="hidden"
                                    onchange="handleAnimalBatchImport(event)">
                                <button class="primary" id="toggleAnimalForm">Nuevo Animal</button>
                            </div>
                        </div>

                        <div class="card farm-card hidden" id="animalFormCard">
                            <h3>Registrar Nuevo Animal</h3>
                            <form id="animalForm" class="farm-form">
                                <label>Crotal
                                    <input type="text" id="animalId" placeholder="Ej: ES000000000000" required>
                                </label>
                                <label>Nombre (opcional)
                                    <input type="text" id="animalName" placeholder="Ej: Lola">
                                </label>
                                <label>Finca
                                    <select id="animalFarm" required>
                                        <option value="">Selecciona una finca</option>
                                    </select>
                                </label>
                                <label>Raza
                                    <select id="animalBreed" required>
                                        <option value="">Selecciona raza</option>
                                        <option value="Avileña-Negra Ibérica">Avileña-Negra Ibérica</option>
                                        <option value="Retinta">Retinta</option>
                                        <option value="Morucha">Morucha</option>
                                        <option value="Lidia">Lidia</option>
                                        <option value="Charolais">Charolais</option>
                                        <option value="Limousin">Limousin</option>
                                        <option value="Angus">Angus</option>
                                        <option value="Otra">Otra</option>
                                    </select>
                                </label>
                                <label>Sexo
                                    <select id="animalSex" required>
                                        <option value="">Selecciona sexo</option>
                                        <option value="Hembra">Hembra</option>
                                        <option value="Macho">Macho</option>
                                    </select>
                                </label>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                    <label style="margin: 0;">Padre (Crotal)
                                        <input type="text" id="animalFather" placeholder="Opcional">
                                    </label>
                                    <label style="margin: 0;">Madre (Crotal)
                                        <input type="text" id="animalMother" placeholder="Opcional">
                                    </label>
                                </div>
                                <label>Fecha de Nacimiento
                                    <input type="date" id="animalBirth" required>
                                </label>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                    <label style="margin: 0;">Peso Nacimiento (kg)
                                        <input type="number" id="animalBirthWeight" placeholder="Ej: 35" step="0.1">
                                    </label>
                                    <label style="margin: 0;">Peso Actual (kg)
                                        <input type="number" id="animalWeight" placeholder="Ej: 200" step="0.1"
                                            required>
                                </div>
                                <label>Notas
                                    <input type="text" id="animalNotes" placeholder="Información adicional">
                                </label>
                                <div class="profile-actions">
                                    <button type="submit" class="primary">Guardar Animal</button>
                                    <button type="button" class="ghost" id="cancelAnimalForm">Cancelar</button>
                                </div>
                            </form>
                        </div>

                        <div class="card">
                            <div class="card-head">
                                <h3>Filtros</h3>
                            </div>
                            <div class="farm-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                <label>Buscar
                                    <input type="text" id="searchAnimal" list="animal-ids" placeholder="ID, nombre...">
                                    <datalist id="animal-ids"></datalist>
                                </label>
                                <label>Finca
                                    <select id="filterFarm">
                                        <option value="">Todas las fincas</option>
                                    </select>
                                </label>
                                <label>Raza
                                    <select id="filterBreed">
                                        <option value="">Todas las razas</option>
                                    </select>
                                </label>
                                <label>Sexo
                                    <select id="filterSex">
                                        <option value="">Todos</option>
                                        <option value="Hembra">Hembra</option>
                                        <option value="Macho">Macho</option>
                                    </select>
                                </label>
                                <label>Edad / Tipo
                                    <select id="filterAge">
                                        <option value="">Todos</option>
                                    </select>
                                </label>
                            </div>
                        </div>

                        <div class="farm-list">
                            <div id="animalsList" class="farms">
                                <p class="status">No hay animales registrados</p>
                            </div>
                        </div>
                    </div>

                    <!-- EVENTS SECTION -->
                    <div id="events" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">GESTIÓN DE EVENTOS</p>
                                <h2>Registro de Eventos</h2>
                                <p class="lede">Vacunaciones, tratamientos y más</p>
                            </div>
                            <button class="primary" id="toggleEventForm">Nuevo Evento</button>
                        </div>

                        <div class="card farm-card hidden" id="eventFormCard">
                            <h3>Registrar Nuevo Evento</h3>
                            <form id="eventForm" class="farm-form">
                                <label>Tipo de Evento
                                    <select id="eventType" required>
                                        <option value="">Selecciona tipo</option>
                                        <option value="Vacunación">Vacunación</option>
                                        <option value="Tratamiento">Tratamiento</option>
                                        <option value="Parto">Parto</option>
                                        <option value="Destete">Destete</option>
                                        <option value="Pesaje">Pesaje</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </label>
                                <label style="position:relative;">Animal
                                    <input type="text" id="eventAnimal"
                                        placeholder="Buscar por Crotal (últimos 4 dígitos)" autocomplete="off">
                                    <ul id="eventAnimalSuggestions" class="suggestions-list hidden"></ul>
                                </label>

                                <!-- Parto Specific Fields -->
                                <label id="partoFields" class="hidden"
                                    style="color:#15803d; font-weight:600; margin-top:8px;">Datos de la Cría</label>
                                <label class="parto-field hidden">Crotal Cría
                                    <input type="text" id="eventCalfCrotal" placeholder="Nuevo Crotal">
                                </label>
                                <label class="parto-field hidden">Sexo
                                    <select id="eventSex">
                                        <option value="">Selecciona sexo</option>
                                        <option value="Macho">Macho</option>
                                        <option value="Hembra">Hembra</option>
                                    </select>
                                </label>
                                <label class="parto-field hidden" style="position:relative;">Padre (Opcional)
                                    <input type="text" id="eventFather" placeholder="Crotal Padre" autocomplete="off">
                                    <ul id="eventFatherSuggestions" class="suggestions-list hidden"></ul>
                                </label>

                                <label style="display:none;">Fecha
                                    <input type="date" id="eventDate" required readonly>
                                </label>
                                <label>Descripción
                                    <input type="text" id="eventDesc" placeholder="Ej: Vacunación anual">
                                </label>
                                <label>Costo (€, opcional)
                                    <input type="number" id="eventCost" placeholder="0.00" step="0.01">
                                </label>
                                <label id="eventWeightLabel" class="hidden">Peso Registrado (kg)
                                    <input type="number" id="eventWeight" placeholder="Ej: 250.1234" step="0.0001">
                                </label>
                                <label>Próxima Fecha (opcional)
                                    <input type="date" id="eventNext" placeholder="Para seguimiento">
                                </label>
                                <div class="profile-actions">
                                    <button type="submit" class="primary">Guardar Evento</button>
                                    <button type="button" class="ghost" id="cancelEventForm">Cancelar</button>
                                </div>
                            </form>
                        </div>

                        <div class="card">
                            <div class="card-head">
                                <h3>Filtros</h3>
                            </div>
                            <div class="farm-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                <label>Tipo
                                    <select id="filterEventType">
                                        <option value="">Todos los tipos</option>
                                        <option value="Vacunación">Vacunación</option>
                                        <option value="Tratamiento">Tratamiento</option>
                                        <option value="Parto">Parto</option>
                                        <option value="Destete">Destete</option>
                                        <option value="Pesaje">Pesaje</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </label>
                                <label>Animal
                                    <select id="filterEventAnimal">
                                        <option value="">Todos los animales</option>
                                    </select>
                                </label>
                            </div>
                        </div>

                        <div class="farm-list">
                            <h3>Historial de Eventos (<span id="eventCount">0</span>)</h3>
                            <div id="eventsList" class="farms">
                                <p class="status">No hay eventos registrados</p>
                            </div>
                        </div>
                    </div>

                    <!-- FCR CALCULATOR SECTION -->
                    <div id="fcr" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">CALCULADORA</p>
                                <h2>Índice de Conversión Alimenticia (FCR)</h2>
                                <p class="lede">Calcula la eficiencia de conversión de alimento</p>
                            </div>
                        </div>

                        <div class="panel-grid">
                            <div class="card">
                                <h3>Calcular FCR</h3>
                                <form id="fcrForm" class="farm-form">
                                    <label>Animal (opcional)
                                        <select id="fcrAnimal">
                                            <option value="">Cálculo general</option>
                                        </select>
                                    </label>
                                    <label>Peso Inicial (kg)
                                        <input type="number" id="fcrWeightInit" placeholder="Ej: 200" step="0.1"
                                            required>
                                    </label>
                                    <label>Peso Final (kg)
                                        <input type="number" id="fcrWeightFinal" placeholder="Ej: 450" step="0.1"
                                            required>
                                    </label>
                                    <label>Alimento Consumido (kg)
                                        <input type="number" id="fcrFeed" placeholder="Ej: 1500" step="0.1" required>
                                    </label>
                                    <label>Días de Engorde
                                        <input type="number" id="fcrDays" placeholder="Ej: 180" required>
                                    </label>
                                    <button type="submit" class="primary full">Calcular</button>
                                </form>
                            </div>

                            <div class="card" id="fcrResults" style="display: none;">
                                <h3>Resultados</h3>
                                <div class="kpi-row" style="grid-template-columns: 1fr;">
                                    <div class="kpi card-soft">
                                        <p class="kpi-label">FCR (Feed Conversion Ratio)</p>
                                        <p class="kpi-value" id="result-fcr">-</p>
                                        <p class="kpi-foot">kg alimento / kg ganancia</p>
                                    </div>
                                    <div class="kpi card-soft">
                                        <p class="kpi-label">Ganancia Total</p>
                                        <p class="kpi-value" id="result-gain">-</p>
                                        <p class="kpi-foot">kg</p>
                                    </div>
                                    <div class="kpi card-soft">
                                        <p class="kpi-label">Ganancia Diaria Promedio</p>
                                        <p class="kpi-value" id="result-adg">-</p>
                                        <p class="kpi-foot">kg/día</p>
                                    </div>
                                    <div class="kpi card-soft">
                                        <p class="kpi-label">Eficiencia</p>
                                        <p class="kpi-value" id="result-efficiency">-</p>
                                        <p class="kpi-foot" id="result-rating">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="farm-list">
                            <h3>Historial de Cálculos (<span id="fcrHistoryCount">0</span>)</h3>
                            <div id="fcrHistory" class="farms">
                                <p class="status">No hay cálculos guardados</p>
                            </div>
                        </div>
                    </div>

                    <!-- FARMS SECTION -->
                    <div id="farms" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">GESTIÓN DE FINCAS</p>
                                <h2>Mis Fincas</h2>
                                <p class="lede">Administra tus explotaciones ganaderas</p>
                            </div>
                            <div>
                                <button class="primary" id="toggleFarmForm">Nueva Finca</button>
                            </div>
                        </div>

                        <!-- FILTERS CARD -->
                        <div class="card farm-card">
                            <div class="card-head">
                                <h3>Filtros</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px;">
                                <label style="margin:0">Buscar
                                    <input type="text" id="searchFarm" placeholder="Nombre, ubicación...">
                                </label>
                            </div>
                        </div>

                        <!-- FORM CARD (Hidden by default) -->
                        <div class="card farm-card hidden" id="farmFormCard">
                            <h3 id="farmFormTitle">Registrar Nueva Finca</h3>
                            <form id="farmForm" class="farm-form" style="border:none; padding:0; background:none;">
                                <input type="hidden" id="farmEditId">
                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                    <label>Latitud
                                        <input type="number" id="farmLat" step="any" placeholder="Ej: 40.41" readonly
                                            style="background: #f3f4f6; cursor: not-allowed;">
                                    </label>
                                    <label>Longitud
                                        <input type="number" id="farmLon" step="any" placeholder="Ej: -3.70" readonly
                                            style="background: #f3f4f6; cursor: not-allowed;">
                                    </label>
                                </div>

                                <!-- SIGPAC SEARCH -->
                                <div class="sigpac-container"
                                    style="background: linear-gradient(135deg, #e7f7ee, #f8fafc); border: 2px solid #bbebd1; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                    <h4 style="margin: 0 0 8px; color: #15803d;">Buscar en SIGPAC</h4>
                                    <p style="margin: 0 0 12px; font-size: 13px; color: #6b7280;">Introduce los datos de
                                        la parcela para autocompletar</p>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                        <label style="margin: 0;">Provincia
                                            <select id="sigpacProv">
                                                <option value="">Selecciona provincia</option>
                                                <option value="15">A Coruña</option>
                                                <option value="01">Álava</option>
                                                <option value="02">Albacete</option>
                                                <option value="03">Alicante</option>
                                                <option value="04">Almería</option>
                                                <option value="33">Asturias</option>
                                                <option value="05">Ávila</option>
                                                <option value="06">Badajoz</option>
                                                <option value="07">Baleares</option>
                                                <option value="08">Barcelona</option>
                                                <option value="09">Burgos</option>
                                                <option value="10">Cáceres</option>
                                                <option value="11">Cádiz</option>
                                                <option value="39">Cantabria</option>
                                                <option value="12">Castellón</option>
                                                <option value="51">Ceuta</option>
                                                <option value="13">Ciudad Real</option>
                                                <option value="14">Córdoba</option>
                                                <option value="16">Cuenca</option>
                                                <option value="17">Girona</option>
                                                <option value="18">Granada</option>
                                                <option value="19">Guadalajara</option>
                                                <option value="20">Guipúzcoa</option>
                                                <option value="21">Huelva</option>
                                                <option value="22">Huesca</option>
                                                <option value="23">Jaén</option>
                                                <option value="24">León</option>
                                                <option value="25">Lleida</option>
                                                <option value="27">Lugo</option>
                                                <option value="28">Madrid</option>
                                                <option value="29">Málaga</option>
                                                <option value="52">Melilla</option>
                                                <option value="30">Murcia</option>
                                                <option value="31">Navarra</option>
                                                <option value="32">Ourense</option>
                                                <option value="34">Palencia</option>
                                                <option value="35">Las Palmas</option>
                                                <option value="36">Pontevedra</option>
                                                <option value="26">La Rioja</option>
                                                <option value="37">Salamanca</option>
                                                <option value="38">S.C. Tenerife</option>
                                                <option value="40">Segovia</option>
                                                <option value="41">Sevilla</option>
                                                <option value="42">Soria</option>
                                                <option value="43">Tarragona</option>
                                                <option value="44">Teruel</option>
                                                <option value="45">Toledo</option>
                                                <option value="46">Valencia</option>
                                                <option value="47">Valladolid</option>
                                                <option value="48">Vizcaya</option>
                                                <option value="49">Zamora</option>
                                                <option value="50">Zaragoza</option>
                                            </select>
                                        </label>
                                        <label style="margin: 0;">Municipio
                                            <select id="sigpacMuni" disabled>
                                                <option value="">Selecciona provincia primero</option>
                                            </select>
                                        </label>
                                        <label style="margin: 0;">Polígono
                                            <input type="text" id="sigpacPoli" placeholder="Ej: 1">
                                        </label>
                                        <label style="margin: 0;">Parcela
                                            <input type="text" id="sigpacParc" placeholder="Ej: 1">
                                        </label>
                                    </div>
                                    <button type="button" class="primary full" id="searchSigpacBtn"
                                        style="margin-top: 8px;">
                                        Buscar en SIGPAC</button>
                                    <div id="sigpacLoading" class="hidden"
                                        style="margin-top: 12px; display: flex; align-items: center; gap: 8px; color: #6b7280;">
                                        <div
                                            style="width: 16px; height: 16px; border: 2px solid #22c55e; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;">
                                        </div>
                                        <span>Consultando SIGPAC...</span>
                                    </div>
                                    <div id="sigpacStatus" class="hidden"
                                        style="margin-top: 12px; padding: 10px; border-radius: 8px; font-size: 14px;">
                                    </div>
                                </div>

                                <label>Nombre de la finca
                                    <input type="text" id="farmName" placeholder="Ej: Finca El Roble">
                                </label>
                                <label>Ubicación
                                    <input type="text" id="farmLocation" placeholder="Ej: Salamanca, España" required>
                                </label>
                                <label>Tamaño (hectáreas)
                                    <input type="number" id="farmSize" placeholder="Ej: 150" step="any" required>
                                </label>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                    <label style="margin: 0;">Pendiente Media (%)
                                        <input type="number" id="farmSlope" placeholder="Ej: 5.4" step="0.1">
                                    </label>
                                    <label style="margin: 0;">Coef. Regadío (%)
                                        <input type="number" id="farmIrrigation" placeholder="Ej: 0" step="1">
                                    </label>
                                </div>
                                <label>Uso SIGPAC
                                    <input type="text" id="farmSigpacUse" placeholder="Ej: ZU, TA...">
                                </label>
                                <label>Tipo de suelo
                                    <select id="farmSoil" required>
                                        <option value="">Selecciona tipo</option>
                                        <option value="Arcilloso">Arcilloso</option>
                                        <option value="Arenoso">Arenoso</option>
                                        <option value="Franco">Franco</option>
                                        <option value="Limoso">Limoso</option>
                                        <option value="Pedregoso">Pedregoso</option>
                                    </select>
                                </label>
                                <label>Licencia ganadera
                                    <input type="text" id="farmLicense" placeholder="Ej: ES-37-12345" required>
                                </label>
                                <label>Número de animales
                                    <input type="number" id="farmAnimals" placeholder="Ej: 50" required>
                                </label>
                                <label>Sistema de manejo
                                    <select id="farmManagement" required>
                                        <option value="">Selecciona sistema</option>
                                        <option value="Intensivo">Intensivo</option>
                                        <option value="Semi-intensivo">Semi-intensivo</option>
                                        <option value="Extensivo">Extensivo</option>
                                    </select>
                                </label>
                                <label class="section-label"
                                    style="margin-top: 20px; font-weight: 600; color: #4b5563;">Control
                                    Climático</label>
                                <div
                                    style="background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 20px;">
                                    <label
                                        style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-weight: normal;">
                                        <input type="radio" name="weatherSource" value="public" checked
                                            onchange="toggleWeatherConfig()">
                                        <span>🌐 Estación Pública (Open-Meteo)</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; font-weight: normal;">
                                        <input type="radio" name="weatherSource" value="private"
                                            onchange="toggleWeatherConfig()">
                                        <span>📡 Estación Meteorológica Propia</span>
                                    </label>

                                    <div id="weatherStationConfig" class="hidden"
                                        style="margin-left: 24px; border-left: 2px solid #e5e7eb; padding-left: 12px;">
                                        <label style="font-size: 0.9em; color: #6b7280;">ID de Estación / API Key
                                            <input type="text" id="farmWeatherId" placeholder="Ej: STATION_001_SOTO"
                                                style="font-size: 0.9em;">
                                        </label>
                                    </div>
                                    <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                                        ℹ️ La opción pública usa la ubicación de la finca para obtener datos gratuitos.
                                    </p>
                                </div>
                                <div class="profile-actions">
                                    <button type="submit" class="primary" id="farmSubmitBtn">Guardar Finca</button>
                                    <button type="button" class="ghost" id="cancelFarmEdit"
                                        style="display: none;">Cancelar</button>
                                </div>
                            </form>
                        </div>

                        <!-- LIST CARD -->
                        <div class="card farm-list">
                            <div id="fincasList" class="farms" style="margin-top: 12px;">
                                <p class="status">No hay fincas registradas</p>
                            </div>
                        </div>
                    </div>

                    <!-- REPORTS SECTION -->
                    <div id="reports" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">REPORTES Y EXPORTACIÓN</p>
                                <h2>Generar Reportes</h2>
                                <p class="lede">Exporta tus datos en diferentes formatos</p>
                            </div>
                        </div>

                        <div class="panel-grid">
                            <div class="card">
                                <h3>Fecha del Reporte</h3>
                                <div class="farm-form"
                                    style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
                                    <label>Desde
                                        <input type="date" id="reportStartDate">
                                    </label>
                                    <label>Hasta
                                        <input type="date" id="reportEndDate">
                                    </label>
                                </div>
                            </div>

                            <div class="card">
                                <h3>Tipo de Reporte</h3>
                                <div class="action-list">
                                    <button class="action-btn" data-report="inventory">Inventario de
                                        Animales</button>
                                    <button class="action-btn" data-report="events">Historial de Eventos</button>
                                    <button class="action-btn" data-report="weights">Historial de Pesos</button>
                                    <button class="action-btn" data-report="fcr">Análisis FCR</button>
                                    <button class="action-btn" data-report="farms">Resumen de Fincas</button>
                                    <button class="action-btn" data-report="weather_history">Historial
                                        Climatológico</button>
                                    <button class="action-btn" data-report="complete">Reporte Completo</button>
                                </div>
                            </div>

                            <div class="card">
                                <h3>Formato de Exportación</h3>
                                <div class="action-list">
                                    <button class="action-btn" id="exportCSV">Exportar a CSV</button>
                                    <button class="action-btn" id="exportPDF">Exportar a PDF</button>
                                </div>
                                <div style="margin-top: 16px;">
                                    <p class="status">Selecciona un tipo de reporte arriba</p>
                                    <p class="status" id="reportStatus"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PROFILE SECTION -->
                    <div id="profile" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">MI CUENTA</p>
                                <h2>Perfil de Usuario</h2>
                                <p class="lede">Gestiona tu información personal</p>
                            </div>
                        </div>

                        <div class="card profile-card">
                            <div class="profile-avatar-wrap">
                                <div class="avatar large" id="profileAvatar">U</div>
                                <label class="upload-btn">
                                    Subir foto
                                    <input type="file" id="avatarInput" accept="image/*">
                                </label>
                                <button class="ghost small" id="avatarRemove">Eliminar</button>
                            </div>
                            <form id="profileForm" class="profile-form">
                                <label>Nombre completo
                                    <input type="text" id="profileName" placeholder="Tu nombre">
                                </label>
                                <label>Correo electrónico
                                    <input type="email" id="profileEmail" placeholder="tu@correo.com">
                                </label>
                                <div class="profile-actions">
                                    <button type="submit" class="primary">Guardar cambios</button>
                                    <button type="button" class="ghost" id="profileCancel">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- DATOS SECTION (Admin Only) -->
                    <div id="data" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">CONFIGURACIÓN</p>
                                <h2>Datos de Razas</h2>
                                <p class="lede">Gestión de información de razas bovinas</p>
                            </div>
                        </div>

                        <!-- CSV Upload Card -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>Importar/Actualizar Razas desde CSV</h3>
                            <div class="farm-form" style="grid-template-columns: 1fr;">
                                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <input type="file" id="breedCSVInput" accept=".csv"
                                        style="flex: 1; min-width: 200px;">
                                    <button class="primary" id="uploadBreedCSV">Cargar CSV</button>
                                    <button class="ghost" id="downloadBreedTemplate">Descargar Plantilla</button>
                                </div>
                                <div id="csvUploadStatus" class="hidden"
                                    style="padding: 10px; border-radius: 4px; margin-top: 10px;"></div>
                                <p style="font-size: 13px; color: #666; margin-top: 8px;">
                                    📋 Sube un archivo CSV con las columnas: raza_id, raza, subespecie,
                                    peso_macho_adulto_kg, peso_hembra_adulta_kg, edad_sacrificio_meses,
                                    ADG_feedlot_kg_dia, FCR, termotolerancia etc.
                                </p>
                            </div>
                        </div>

                        <!-- Breed Data Table -->
                        <div class="card">
                            <div class="card-head">
                                <h3>Razas Registradas (<span id="breedCount">0</span>)</h3>
                            </div>
                            <div style="overflow-x: auto;">
                                <table id="breedTable" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">ID</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Raza</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Subespecie
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Peso ♂ (kg)
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Peso ♀ (kg)
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Edad
                                                Sacrificio (meses)</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">ADG Feedlot
                                                (kg/dia)</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">ADG Pastoreo
                                                (kg/dia)</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">FCR</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">
                                                Termotolerancia</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Marmoleo</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Facilidad
                                                Parto</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Feed Data Section -->
                        <h2 style="margin-top: 40px; margin-bottom: 20px;">Gestión de Alimentos</h2>

                        <!-- CSV Upload Card for Feeds -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>Importar/Actualizar Alimentos desde CSV</h3>
                            <div class="farm-form" style="grid-template-columns: 1fr;">
                                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <input type="file" id="feedCSVInput" accept=".csv"
                                        style="flex: 1; min-width: 200px;">
                                    <button class="primary" id="uploadFeedCSV">Cargar CSV</button>
                                    <button class="ghost" id="downloadFeedTemplate">Descargar Plantilla</button>
                                </div>
                                <div id="feedUploadStatus" class="hidden"
                                    style="padding: 10px; border-radius: 4px; margin-top: 10px;"></div>
                                <p style="font-size: 13px; color: #666; margin-top: 8px;">
                                    Sube un archivo CSV con las columnas: Feed Type, Example, DM %, CP %, NDF %, ADF %,
                                    Notes, Breed Interaction
                                </p>
                            </div>
                        </div>

                        <!-- Feed Data Table -->
                        <div class="card">
                            <div class="card-head">
                                <h3>Alimentos Registrados (<span id="feedCount">0</span>)</h3>
                            </div>
                            <div style="overflow-x: auto;">
                                <table id="feedTable" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Tipo</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Nombre</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">% MS</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">% PB</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">% FDN</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">% ADF</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Energía Neta
                                                (Mcal/kg)</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Uso
                                                Recomendado</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Soil Data Section (NEW) -->
                        <h2 style="margin-top: 40px; margin-bottom: 20px;">Gestión de Suelos y Cultivos</h2>
                        <div class="card">
                            <div class="card-head">
                                <h3>Matriz Suelo-Cultivo</h3>
                                <div style="display:flex; gap:10px; align-items:center;">
                                    <input type="file" id="soilCSVInput" accept=".csv" style="display:none;">
                                    <button class="ghost small" id="btnImportSoils"
                                        onclick="document.getElementById('soilCSVInput').click()">Importar CSV
                                        Suelos</button>
                                    <button class="ghost small" id="downloadSoilTemplate">Descargar Plantilla</button>
                                </div>
                            </div>
                            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                Define qué cultivos forrajeros son aptos para cada tipo de suelo. Usado para
                                recomendaciones automáticas.
                            </p>
                            <div style="overflow-x: auto;">
                                <table id="soilTable" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                            <th style="padding: 12px; text-align: left;">Cultivo</th>
                                            <th style="padding: 12px; text-align: left;">Textura Ideal</th>
                                            <th style="padding: 12px; text-align: left;">pH Ideal</th>
                                            <th style="padding: 12px; text-align: left;">Mat. Orgánica</th>
                                            <th style="padding: 12px; text-align: left;">Drenaje Req.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="soilTableBody">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        </div>
        </div>
    </main>

    <!-- Animal Detail Modal (Moved to root) -->
    <div id="animalDetailModal" class="modal hidden">
        <div class="modal-content card">
            <span class="close-modal" id="closeAnimalDetail">&times;</span>
            <div class="detail-header">
                <h2 id="detailCrotal">ESXXXXX</h2>
                <span class="tag" id="detailStatus">Activo</span>
            </div>

            <div class="detail-grid">
                <div class="detail-item">
                    <span class="label">Raza</span>
                    <span class="value" id="detailBreed">-</span>
                </div>
                <div class="detail-item">
                    <span class="label">Sexo</span>
                    <span class="value" id="detailSex">-</span>
                </div>
                <div class="detail-item">
                    <span class="label">Nacimiento</span>
                    <span class="value" id="detailBirth">-</span>
                </div>
                <div class="detail-item">
                    <span class="label">Finca</span>
                    <span class="value" id="detailFarm">-</span>
                </div>
            </div>

            <h4 style="margin: 0 0 10px;">Pesos (kg)</h4>
            <div class="detail-grid">
                <div class="detail-item">
                    <span class="label">Al Nacer</span>
                    <span class="value" id="detailBirthWeight">0</span>
                </div>
                <div class="detail-item">
                    <span class="label">Actual</span>
                    <span class="value" id="detailWeight">0</span>
                </div>
                <div class="detail-item">
                    <span class="label">Ganancia Total</span>
                    <span class="value" id="detailGain">0</span>
                </div>
            </div>

            <h4 style="margin: 0 0 10px;">Genealogía</h4>
            <div class="detail-grid" style="margin-bottom: 20px;">
                <div class="detail-item">
                    <span class="label">Padre</span>
                    <span class="value" id="detailFather">-</span>
                </div>
                <div class="detail-item">
                    <span class="label">Madre</span>
                    <span class="value" id="detailMother">-</span>
                </div>
            </div>

            <h4 style="margin: 0 0 10px;">Descendencia</h4>
            <ul id="detailOffspring"
                style="padding-left: 20px; margin: 0 0 20px 0; font-size: 14px; color: var(--text);">
                <!-- Populated via JS -->
            </ul>

            <h4 style="margin: 0 0 10px;">Notas</h4>
            <p id="detailNotes" style="font-size: 14px; color: var(--muted); margin: 0;">-</p>

            <div class="modal-actions" style="margin-top: 15px; display: flex; justify-content: flex-end;">
                <button class="ghost" id="closeDetailBtn">Cerrar</button>
            </div>
        </div>
    </div>
    </div>
    <!-- Farm Detail Modal [NEW] -->
    <div id="farmDetailModal" class="modal hidden">
        <div class="modal-content card" style="max-width: 600px;">
            <span class="close-modal" id="closeFarmDetail">&times;</span>
            <div class="detail-header">
                <h2 id="detailFarmName">Finca</h2>
                <span class="tag" id="detailFarmSize">0 ha</span>
            </div>

            <div style="margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 6px;">
                <strong>📍 Ubicación:</strong> <span id="detailFarmLocation">-</span>
                <br>
                <span style="font-size: 0.9em; color: #64748b;">Lat: <span id="detailFarmLat">-</span>, Lon: <span
                        id="detailFarmLon">-</span></span>
            </div>

            <h4 style="margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Datos SIGPAC</h4>
            <div class="detail-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="detail-item"><strong>Pendiente:</strong> <span id="detailFarmSlope">-</span>%</div>
                <div class="detail-item"><strong>Regadío:</strong> <span id="detailFarmIrrigation">-</span>%</div>
                <div class="detail-item"><strong>Uso:</strong> <span id="detailFarmUse">-</span></div>
                <div class="detail-item"><strong>Suelo:</strong> <span id="detailFarmSoil">-</span></div>
            </div>

            <h4 style="margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Producción</h4>
            <div class="detail-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="detail-item"><strong>Licencia:</strong> <span id="detailFarmLicense">-</span></div>
                <div class="detail-item"><strong>Animales:</strong> <span id="detailFarmAnimals">-</span></div>
                <div class="detail-item"><strong>Manejo:</strong> <span id="detailFarmManagement">-</span></div>
                <div class="detail-item"><strong>Alimentación:</strong> <span id="detailFarmFeed">-</span></div>
            </div>

            <h4 style="margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Clima (Tiempo Real)</h4>
            <div id="detailFarmWeather"
                style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 10px; min-height: 60px; display: flex; align-items: center; justify-content: center;">
                ⏳ Cargando datos climáticos...
            </div>

            <!-- Nutrition Engine Output -->
            <h4 style="margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px; color: #7c2d12;">🌱 Suelos
                y Cultivos</h4>
            <div id="detailFarmCrops" style="font-size: 0.9em; margin-top: 10px; color: #4b5563;">
                Calculando compatibilidad edafológica...
            </div>

            <div class="detail-actions" style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="ghost" id="btnDeleteFarmModal" style="color: #ef4444;">Eliminar Finca</button>
                <button class="primary" id="btnEditFarmModal">Editar Finca</button>
            </div>
        </div>
    </div>
    </main>
    <script src="breed-manager.js"></script>
    <script src="breeding-engine.js"></script>
    <script src="feed-manager.js"></script>
    <script src="soil-manager.js"></script>
    <script src="nutrition-engine.js"></script>
    <script src="csv-download-fix.js"></script>
    <script src="feed-csv-handler.js"></script>
    <script src="farm-feed-manager.js"></script>
    <script src="weather-service.js"></script>
    <script src="app-sigpac.js"></script>
    <script src="app.js"></script>
    <script src="app-reports.js"></script>
</body>

</html>