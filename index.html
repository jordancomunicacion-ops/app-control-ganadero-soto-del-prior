<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Granjas - Soto del Prior</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="background"></div>
    <main class="shell">
        <!-- AUTH SECTION -->
        <section id="auth" class="auth-shell">
            <div class="auth-card">
                <img src="images/logo-soto.svg" alt="Soto del Prior" class="logo" style="height: 60px;">
                <h1 class="auth-title">Acceso a Granjas</h1>
                <div class="tabs">
                    <button id="loginTab" class="tab active">Iniciar sesión</button>
                    <button id="registerTab" class="tab">Crear cuenta</button>
                </div>
                <form id="loginForm" class="auth-form">
                    <div class="alert hidden" id="loginAlert">Estas credenciales no coinciden con nuestros registros.
                    </div>
                    <label>Usuario
                        <input type="text" id="loginUser" placeholder="usuario@email.com" required>
                    </label>
                    <label>Contraseña
                        <input type="password" id="loginPass" placeholder="******" required>
                    </label>
                    <button type="submit" class="primary full">Acceder</button>
                    <label class="remember">
                        <input type="checkbox" id="rememberCheck">
                        <span>Recordarme (guardar usuario y contraseña en este navegador)</span>
                    </label>
                    <a class="link" href="#" onclick="return false;">¿Olvidaste la contraseña?</a>
                </form>
                <form id="registerForm" class="auth-form hidden">
                    <label>Usuario
                        <input type="text" id="regUser" placeholder="nuevo usuario" required>
                    </label>
                    <label>Correo electrónico
                        <input type="email" id="regEmail" placeholder="tu@correo.com" required>
                    </label>
                    <label>Contraseña
                        <input type="password" id="regPass" placeholder="crea una clave" required>
                    </label>
                    <button type="submit" class="primary full">Registrarse</button>
                </form>
                <div class="footer-bar">Datos guardados en este navegador</div>
            </div>
        </section>

        <!-- DASHBOARD SECTION -->
        <div id="app" class="dashboard hidden">
            <div class="app-layout">
                <!-- SIDEBAR -->
                <aside class="sidebar">
                    <div class="user-card">
                        <div class="avatar" id="sidebarAvatar">U</div>
                        <div>
                            <p class="profile-name" id="sidebarName">Usuario</p>
                            <p class="profile-role">Usuario</p>
                        </div>
                    </div>
                    <nav class="nav">
                        <a href="#" class="nav-link active" data-target="home">Inicio</a>
                        <a href="#" class="nav-link" data-target="farms">Fincas</a>
                        <a href="#" class="nav-link" data-target="animals">Animales</a>
                        <a href="#" class="nav-link" data-target="events">Eventos</a>
                        <a href="#" class="nav-link" data-target="reports">Reportes</a>
                        <a href="#" class="nav-link" data-target="calculator">Rendimiento</a>
                        <a href="#" class="nav-link" id="nav-data" data-target="data">Datos</a>
                    </nav>
                    <div class="sidebar-actions">
                        <button class="ghost full" id="profileBtn">Mi perfil</button>
                        <button class="ghost full" id="logoutBtn">Cerrar sesión</button>
                    </div>
                </aside>

                <!-- MAIN CONTENT -->
                <div class="content">
                    <!-- HOME / DASHBOARD -->
                    <div id="home" class="section">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">PANEL DE CONTROL</p>
                                <h2>Resumen General</h2>
                                <p class="lede">Vista general de tu operación ganadera</p>
                            </div>
                        </div>

                        <div class="kpi-row">
                            <div class="kpi" id="weather-card"
                                style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; display: none; grid-column: 1 / -1;">
                                <div
                                    style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 8px;">
                                    <div>
                                        <p class="kpi-label" style="color: white; opacity: 0.9;">Clima en Finca</p>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <p class="kpi-value" id="weather-temp" style="margin:0;">--°C</p>
                                            <div id="rain-alert" class="hidden"
                                                style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px;">
                                                ☔ Alerta Lluvia
                                            </div>
                                        </div>
                                        <div
                                            style="display: flex; gap: 12px; font-size: 14px; opacity: 0.9; margin-top: 8px;">
                                            <span id="weather-hum">--%</span>
                                            <span id="weather-wind">-- km/h</span>
                                        </div>
                                    </div>
                                    <div id="weather-forecast"
                                        style="text-align: right; font-size: 13px; display: flex; flex-direction: column; gap: 4px;">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>

                                <div style="margin-top: 15px;">
                                    <p style="font-size: 12px; margin-bottom: 5px; opacity: 0.9;">Radar de Lluvia (En
                                        vivo)</p>
                                    <iframe id="rain-radar-frame" src=""
                                        style="width: 100%; height: 250px; border: 0; border-radius: 8px; background: rgba(0,0,0,0.2);"></iframe>
                                </div>
                            </div>
                        </div>

                        <!-- DISTRIBUTION (TOP) -->
                        <div class="card panel-chart" style="margin-bottom: 20px;">
                            <div class="card-head">
                                <h3>Distribución de Animales</h3>
                            </div>
                            <div class="distribution-grid"
                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h4 style="margin: 0 0 10px; color: #3b82f6;">Machos</h4>
                                    <table class="dist-table">
                                        <tr>
                                            <td>Bueyes</td>
                                            <td id="count-bueyes" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Toros</td>
                                            <td id="count-toros" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Utreros</td>
                                            <td id="count-utreros" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Novillos</td>
                                            <td id="count-novillos" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Añojos</td>
                                            <td id="count-anojos" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Terneros</td>
                                            <td id="count-terneros-m" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Becerros</td>
                                            <td id="count-becerros" class="text-right">0</td>
                                        </tr>
                                    </table>
                                </div>
                                <div>
                                    <h4 style="margin: 0 0 10px; color: #ec4899;">Hembras</h4>
                                    <table class="dist-table">
                                        <tr>
                                            <td>Nodrizas</td>
                                            <td id="count-nodrizas" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Vacas</td>
                                            <td id="count-vacas" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Novillas</td>
                                            <td id="count-novillas" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Añojas</td>
                                            <td id="count-anojas" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Terneras</td>
                                            <td id="count-terneras-h" class="text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td>Becerras</td>
                                            <td id="count-becerras" class="text-right">0</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- ALERTS & ACTIONS (BOTTOM GRID) -->
                        <div class="panel-grid">
                            <div class="card panel-quality">
                                <div class="card-head" style="cursor:pointer;" onclick="activateSection('events')">
                                    <h3>Próximos Eventos</h3>
                                    <span style="font-size:12px; font-weight:700; color:#2563eb;">Ver todo</span>
                                </div>
                                <ul id="alertsList">
                                    <li>
                                        <span>No hay eventos próximos</span>
                                    </li>
                                </ul>
                            </div>

                            <div class="card actions-card">
                                <h3>Acciones Rápidas</h3>
                                <div class="action-list">
                                    <button class="action-btn" data-action="add-animal">Registrar nuevo animal</button>
                                    <button class="action-btn" data-action="add-event">Registrar evento</button>
                                    <button class="action-btn" id="action-report">Generar reporte</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ANIMALS SECTION -->
                    <div id="animals" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">GESTIÓN DE ANIMALES</p>
                                <h2>Inventario de Animales</h2>
                                <p class="lede">Registro y seguimiento individual</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="ghost" onclick="downloadAnimalTemplate()"
                                    title="Descargar plantilla CSV">Plantilla</button>
                                <button class="ghost" onclick="document.getElementById('animalBatchInput').click()"
                                    title="Importar animales desde CSV">Cargar CSV</button>
                                <input type="file" id="animalBatchInput" accept=".csv" class="hidden"
                                    onchange="handleAnimalBatchImport(event)">
                                <button class="primary" id="toggleAnimalForm">Nuevo Animal</button>
                            </div>
                        </div>

                        <div class="card farm-card hidden" id="animalFormCard">
                            <h3>Registrar Nuevo Animal</h3>
                            <form id="animalForm" class="farm-form">
                                <label>Crotal
                                    <input type="text" id="animalId" placeholder="Ej: ES000000000000" required>
                                </label>
                                <label>Nombre (opcional)
                                    <input type="text" id="animalName" placeholder="Ej: Lola">
                                </label>
                                <label>Finca
                                    <select id="animalFarm" required>
                                        <option value="">Selecciona una finca</option>
                                    </select>
                                </label>
                                <label>Corral
                                    <select id="animalCorral" disabled>
                                        <option value="">Selecciona Finca primero</option>
                                    </select>
                                </label>
                                <label>Raza
                                    <select id="animalBreed" required>
                                        <option value="">Selecciona raza</option>
                                        <option value="Avileña-Negra Ibérica">Avileña-Negra Ibérica</option>
                                        <option value="Retinta">Retinta</option>
                                        <option value="Morucha">Morucha</option>
                                        <option value="Lidia">Lidia</option>
                                        <option value="Charolais">Charolais</option>
                                        <option value="Limousin">Limousin</option>
                                        <option value="Angus">Angus</option>
                                        <option value="Otra">Otra</option>
                                    </select>
                                </label>
                                <label>Sexo
                                    <select id="animalSex" required>
                                        <option value="">Selecciona sexo</option>
                                        <option value="Hembra">Hembra</option>
                                        <option value="Macho">Macho</option>
                                    </select>
                                </label>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                    <label style="margin: 0;">Padre (Crotal)
                                        <input type="text" id="animalFather" placeholder="Opcional">
                                    </label>
                                    <label style="margin: 0;">Madre (Crotal)
                                        <input type="text" id="animalMother" placeholder="Opcional">
                                    </label>
                                </div>
                                <label>Fecha de Nacimiento
                                    <input type="date" id="animalBirth" required>
                                </label>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                    <label style="margin: 0;">Peso Nacimiento (kg)
                                        <input type="number" id="animalBirthWeight" placeholder="Ej: 35" step="0.1">
                                    </label>
                                    <label style="margin: 0;">Peso Actual (kg)
                                        <input type="number" id="animalWeight" placeholder="Ej: 200" step="0.1"
                                            required>
                                </div>
                                <label>Notas
                                    <input type="text" id="animalNotes" placeholder="Información adicional">
                                </label>
                                <div class="profile-actions">
                                    <button type="submit" class="primary">Guardar Animal</button>
                                    <button type="button" class="ghost" id="cancelAnimalForm">Cancelar</button>
                                </div>
                            </form>
                        </div>

                        <div class="card">
                            <div class="card-head">
                                <h3>Filtros</h3>
                            </div>
                            <div class="farm-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                <label>Buscar
                                    <input type="text" id="searchAnimal" list="animal-ids" placeholder="ID, nombre...">
                                    <datalist id="animal-ids"></datalist>
                                </label>
                                <label>Finca
                                    <select id="filterFarm">
                                        <option value="">Todas las fincas</option>
                                    </select>
                                </label>
                                <label>Raza
                                    <select id="filterBreed">
                                        <option value="">Todas las razas</option>
                                    </select>
                                </label>
                                <label>Sexo
                                    <select id="filterSex">
                                        <option value="">Todos</option>
                                        <option value="Hembra">Hembra</option>
                                        <option value="Macho">Macho</option>
                                    </select>
                                </label>
                                <label>Edad / Tipo
                                    <select id="filterAge">
                                        <option value="">Todos</option>
                                    </select>
                                </label>
                            </div>
                        </div>

                        <div class="farm-list">
                            <div id="animalsList" class="farms">
                                <p class="status">No hay animales registrados</p>
                            </div>
                        </div>
                    </div>

                    <!-- EVENTS SECTION -->
                    <div id="events" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">GESTIÓN DE EVENTOS</p>
                                <h2>Registro de Eventos</h2>
                                <p class="lede">Vacunaciones, tratamientos y más</p>
                            </div>
                            <button class="primary" id="toggleEventForm">Nuevo Evento</button>
                        </div>

                        <div class="card farm-card hidden" id="eventFormCard">
                            <h3>Registrar Nuevo Evento</h3>
                            <form id="eventForm" class="farm-form">
                                <label>Tipo de Evento
                                    <select id="eventType" required>
                                        <option value="">Selecciona tipo</option>
                                        <option value="Vacunación">Vacunación</option>
                                        <option value="Tratamiento">Tratamiento</option>
                                        <option value="Parto">Parto</option>
                                        <option value="Aborto">Aborto</option>
                                        <option value="Inseminación">Inseminación</option>
                                        <option value="Decisión Macho">Decisión Macho</option>
                                        <option value="Destete">Destete</option>
                                        <option value="Sacrificio">Sacrificio</option>
                                        <option value="Saneamiento">Saneamiento</option>
                                        <option value="Pesaje">Pesaje</option>
                                        <option value="Cambio de corral">Cambio de corral</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </label>
                                <label style="position:relative;" id="eventAnimalContainer">Animal
                                    <input type="text" id="eventAnimal"
                                        placeholder="Buscar por Crotal (últimos 4 dígitos)" autocomplete="off">
                                    <ul id="eventAnimalSuggestions" class="suggestions-list hidden"></ul>
                                </label>

                                <label id="eventFarmContainer" class="hidden">Finca (Saneamiento)
                                    <select id="eventFarmKey">
                                        <option value="">Selecciona Finca</option>
                                    </select>
                                </label>

                                <!-- Parto Specific Fields -->
                                <label id="partoFields" class="hidden"
                                    style="color:#15803d; font-weight:600; margin-top:8px;">Datos de la Cría</label>
                                <label class="parto-field hidden">Crotal Cría
                                    <input type="text" id="eventCalfCrotal" placeholder="Nuevo Crotal">
                                </label>
                                <label class="parto-field hidden">Sexo
                                    <select id="eventSex">
                                        <option value="">Selecciona sexo</option>
                                        <option value="Macho">Macho</option>
                                        <option value="Hembra">Hembra</option>
                                    </select>
                                </label>
                                <label class="parto-field hidden" style="position:relative;">Padre (Opcional)
                                    <input type="text" id="eventFather" placeholder="Crotal Padre" autocomplete="off">
                                    <ul id="eventFatherSuggestions" class="suggestions-list hidden"></ul>
                                </label>

                                <label id="eventBullBreedLabel" class="hidden">Raza Padre (Inseminación)
                                    <select id="eventBullBreed">
                                        <option value="">Selecciona raza</option>
                                    </select>
                                </label>

                                <label id="decisionMachoFields" class="hidden"
                                    style="color:#7c3aed; font-weight:600;">Resultado de la Decisión
                                    <select id="decisionMachoResult">
                                        <option value="">Selecciona opción...</option>
                                        <option value="Semental">Elección como Semental (Padre)</option>
                                        <option value="Castrado">Castración (Buey)</option>
                                    </select>
                                </label>

                                <!-- Sacrificio Specific Fields -->
                                <div id="sacrificeFields" class="hidden">
                                    <label>Categoría Canal (Edad/Sexo)
                                        <select id="sacrificeCategory">
                                            <option value="">Selecciona categoría</option>
                                            <option value="V">V - Ternera (&lt;8m)</option>
                                            <option value="Z">Z - Añojo (8-12m)</option>
                                            <option value="A">A - Macho Joven (12-24m)</option>
                                            <option value="B">B - Toro (&gt;24m)</option>
                                            <option value="C">C - Buey (Castrado)</option>
                                            <option value="E">E - Novilla (Hembra no parida)</option>
                                            <option value="D">D - Vaca (Hembra parida)</option>
                                        </select>
                                    </label>
                                    <label>Peso Canal (kg)
                                        <input type="number" id="sacrificeWeight" placeholder="Ej: 350.5" step="0.1">
                                    </label>
                                    <div style="display:flex; gap:10px;">
                                        <label style="flex:1;">Conf. (SEUROP)
                                            <select id="sacrificeConf">
                                                <option value="">-</option>
                                                <option value="S">S (Superior)</option>
                                                <option value="E">E (Excelente)</option>
                                                <option value="U">U (Muy buena)</option>
                                                <option value="R">R (Buena)</option>
                                                <option value="O">O (Menos buena)</option>
                                                <option value="P">P (Mediocre)</option>
                                            </select>
                                        </label>
                                        <label style="flex:1;">Grasa (1-5)
                                            <select id="sacrificeFat">
                                                <option value="">-</option>
                                                <option value="1">1 (No grasa)</option>
                                                <option value="2">2 (Poca)</option>
                                                <option value="3">3 (Media)</option>
                                                <option value="4">4 (Alta)</option>
                                                <option value="5">5 (Muy alta)</option>
                                            </select>
                                        </label>
                                    </div>
                                    <label>Precio Total Percibido (€)
                                        <input type="number" id="sacrificePrice" placeholder="Ej: 1850.50" step="0.01">
                                    </label>
                                </div>

                                <!-- Saneamiento Specific Fields -->
                                <div id="saneamientoFields" class="hidden">
                                    <label>Resultado Global / Corral
                                        <select id="saneamientoResult">
                                            <option value="">Selecciona resultado</option>
                                            <option value="Negativo">Negativo (Todos Sanos)</option>
                                            <option value="Positivo">Positivo (Detectados infectados)</option>
                                        </select>
                                        <p style="font-size: 11px; color:#6b7280; margin-top:2px;">*Se aplicará a toda
                                            la explotación del animal seleccionado.</p>
                                    </label>

                                    <div id="saneamientoPositiveInput" class="hidden">
                                        <label style="color:#dc2626; font-weight:600;">Crotales Positivos (Infectados)
                                            <textarea id="saneamientoInfected" rows="3"
                                                placeholder="Introduce los crotales separados por coma (ej: ES001, ES002)"></textarea>
                                            <span style="font-size:11px; color:#ef4444;">*Estos animales serán marcados
                                                para SACRIFICIO obligatorio.</span>
                                        </label>
                                    </div>
                                </div>

                                <label style="display:none;">Fecha
                                    <input type="date" id="eventDate" required readonly>
                                </label>
                                <label>Descripción
                                    <input type="text" id="eventDesc" placeholder="Ej: Vacunación anual">
                                </label>
                                <label>Costo (€, opcional)
                                    <input type="number" id="eventCost" placeholder="0.00" step="0.01">
                                </label>
                                <label id="eventWeightLabel" class="hidden">Peso Registrado (kg)
                                    <input type="number" id="eventWeight" placeholder="Ej: 250.1234" step="0.0001">
                                </label>
                                <label>Próxima Fecha (opcional)
                                    <input type="date" id="eventNext" placeholder="Para seguimiento">
                                </label>
                                <div class="profile-actions">
                                    <button type="submit" class="primary">Guardar Evento</button>
                                    <button type="button" class="ghost" id="cancelEventForm">Cancelar</button>
                                </div>
                            </form>
                        </div>

                        <div class="card">
                            <div class="card-head">
                                <h3>Filtros</h3>
                            </div>
                            <div class="farm-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                <label>Tipo
                                    <select id="filterEventType">
                                        <option value="">Todos los tipos</option>
                                        <option value="Vacunación">Vacunación</option>
                                        <option value="Tratamiento">Tratamiento</option>
                                        <option value="Parto">Parto</option>
                                        <option value="Aborto">Aborto</option>
                                        <option value="Inseminación">Inseminación</option>
                                        <option value="Revisión">Revisión</option>
                                        <option value="Destete">Destete</option>
                                        <option value="Pesaje">Pesaje</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </label>
                                <label>Animal
                                    <select id="filterEventAnimal">
                                        <option value="">Todos los animales</option>
                                    </select>
                                </label>
                            </div>
                        </div>

                        <div class="farm-list">
                            <h3>Historial de Eventos (<span id="eventCount">0</span>)</h3>
                            <div id="eventsList" class="farms">
                                <p class="status">No hay eventos registrados</p>
                            </div>
                        </div>
                    </div>



                    <!-- ANIMAL CALCULATOR SECTION -->
                    <div id="calculator" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">PLANIFICACIÓN</p>
                                <h2>Rendimiento</h2>
                                <p class="lede">Proyección de crecimiento y plan nutricional</p>
                            </div>
                        </div>

                        <div class="panel-grid">
                            <!-- LEFT COLUMN -->
                            <div style="display:flex; flex-direction:column; gap:20px;">
                                <!-- INPUTS -->
                                <div class="card">
                                    <h3>Selección y Datos</h3>
                                    <div class="farm-form">
                                        <label style="position:relative;">Crotal
                                            <input type="text" id="calcAnimalInput"
                                                placeholder="Buscar por Crotal (últimos 4 dígitos)" autocomplete="off">
                                            <ul id="calcAnimalSuggestions" class="suggestions-list hidden"></ul>
                                        </label>

                                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                            <label>Raza <input type="text" id="calcBreed" readonly
                                                    class="read-only"></label>
                                            <label>Sexo <input type="text" id="calcSex" readonly
                                                    class="read-only"></label>
                                        </div>

                                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                            <label>Edad (meses) <input type="text" id="calcAgeMonths" readonly
                                                    class="read-only"></label>
                                            <label>Etapa <input type="text" id="calcStage" readonly
                                                    class="read-only"></label>
                                        </div>

                                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                            <label>Peso Actual (kg) <input type="text" id="calcWeight" readonly
                                                    class="read-only"></label>
                                            <label>Sistema
                                                <select id="calcSystem" class="calc-input" style="width:100%;">
                                                    <option value="Intensivo (Feedlot)">Intensivo (Feedlot)</option>
                                                    <option value="Extensivo (Pastoreo)">Extensivo (Pastoreo)</option>
                                                    <option value="Mixto">Mixto</option>
                                                </select>
                                            </label>
                                            <label>Objetivo
                                                <select id="calcObjective" class="calc-input" style="width:100%;">
                                                    <option value="Mantenimiento">Mantenimiento</option>
                                                    <option value="Crecimiento Moderado">Crecimiento Moderado</option>
                                                    <option value="Máximo Crecimiento">Máximo Crecimiento (Cebo)
                                                    </option>
                                                    <option value="Resultados Económicos">Resultados Económicos</option>
                                                    <option value="Recuperación">Recuperación / Condición</option>
                                                </select>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- DIET PLAN -->
                                <div class="card">
                                    <div class="card-head">
                                        <div
                                            style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                                            <div>
                                                <h3>Plan de Alimentación Recomendado (Próximo Mes)</h3>
                                                <div id="dietPhase"
                                                    style="color: #9ca3af; font-size: 0.75rem; margin-top: 2px;">Fase: -
                                                </div>
                                            </div>
                                            <button class="primary" id="saveDietPlan"
                                                style="font-size:0.85em; padding:6px 12px;">
                                                <i class="fas fa-save"></i> Guardar y Agendar Revisión
                                            </button>
                                        </div>
                                    </div>
                                    <div id="dietAlerts" style="margin-bottom:10px;"></div>
                                    <div id="nutritionRequirements"></div>

                                    <table class="dist-table" style="margin-top:10px;">
                                        <thead>
                                            <tr style="text-align:left; color:#6b7280; font-size:0.9em;">
                                                <th style="padding-bottom:10px;">Alimento</th>
                                                <th style="padding-bottom:10px;">Tipo</th>
                                                <th style="padding-bottom:10px; text-align:right;">% MS Total</th>
                                                <th style="padding-bottom:10px; text-align:right;">Kg/día (Fresco)</th>
                                                <th style="padding-bottom:10px; text-align:right;">Coste/día (€)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dietTableBody">
                                            <!-- Slot 1: Forraje Base -->
                                            <tr data-slot="1" data-role="Forraje" data-default-pct="60">
                                                <td style="padding:4px;">
                                                    <select class="diet-select" id="dietSlot1"
                                                        style="width:100%; font-size:0.9em; padding:4px;">
                                                        <option value="">Seleccionar Forraje</option>
                                                    </select>
                                                </td>
                                                <td style="color:#6b7280; font-size:0.85em;">Forraje</td>
                                                <td style="text-align:right;" id="dietSlot1Pct">-</td>
                                                <td style="text-align:right; font-weight:bold;" id="dietSlot1Kg">-</td>
                                                <td style="text-align:right; color:#059669;" id="dietSlot1Cost">-</td>
                                            </tr>
                                            <!-- Slot 3: Energía -->
                                            <tr data-slot="3" data-role="Concentrado" data-default-pct="25">
                                                <td style="padding:4px;">
                                                    <select class="diet-select" id="dietSlot3"
                                                        style="width:100%; font-size:0.9em; padding:4px;">
                                                        <option value="">Seleccionar Energía</option>
                                                    </select>
                                                </td>
                                                <td style="color:#6b7280; font-size:0.85em;">Energía</td>
                                                <td style="text-align:right;" id="dietSlot3Pct">-</td>
                                                <td style="text-align:right; font-weight:bold;" id="dietSlot3Kg">-</td>
                                                <td style="text-align:right; color:#059669;" id="dietSlot3Cost">-</td>
                                            </tr>
                                            <!-- Slot 4: Proteína -->
                                            <tr data-slot="4" data-role="Proteico" data-default-pct="12">
                                                <td style="padding:4px;">
                                                    <select class="diet-select" id="dietSlot4"
                                                        style="width:100%; font-size:0.9em; padding:4px;">
                                                        <option value="">Seleccionar Proteína</option>
                                                    </select>
                                                </td>
                                                <td style="color:#6b7280; font-size:0.85em;">Proteína</td>
                                                <td style="text-align:right;" id="dietSlot4Pct">-</td>
                                                <td style="text-align:right; font-weight:bold;" id="dietSlot4Kg">-</td>
                                                <td style="text-align:right; color:#059669;" id="dietSlot4Cost">-</td>
                                            </tr>
                                            <!-- Slot 5: Suplemento -->
                                            <tr data-slot="5" data-role="Suplemento" data-default-pct="3">
                                                <td style="padding:4px;">
                                                    <select class="diet-select" id="dietSlot5"
                                                        style="width:100%; font-size:0.9em; padding:4px;">
                                                        <option value="">Seleccionar Suplemento</option>
                                                    </select>
                                                </td>
                                                <td style="color:#6b7280; font-size:0.85em;">Correctores</td>
                                                <td style="text-align:right;" id="dietSlot5Pct">-</td>
                                                <td style="text-align:right; font-weight:bold;" id="dietSlot5Kg">-</td>
                                                <td style="text-align:right; color:#059669;" id="dietSlot5Cost">-</td>
                                            </tr>
                                            <!-- TOTALS -->
                                            <tr
                                                style="background:#f8fafc; font-weight:bold; border-top:2px solid #e2e8f0;">
                                                <td colspan="2" style="padding:10px;">TOTAL DIARIO</td>
                                                <td style="text-align:right; padding:10px;">100%</td>
                                                <td style="text-align:right; padding:10px;" id="dietTotalKg">-</td>
                                                <td style="text-align:right; padding:10px; color:#166534;"
                                                    id="dietTotalCost">-
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- BALANCE AMBIENTAL (New Module) - MOVED HERE -->
                                <div class="card" style="margin-top:20px;">
                                    <div class="card-head">
                                        <h3>Balance Ambiental (N/P)</h3>
                                        <span class="tag" style="background:#dbeafe; color:#1e40af;">Simulación</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                        <!-- Nitro -->
                                        <div style="border:1px solid #e5e7eb; border-radius:8px; padding:15px;">
                                            <h4
                                                style="margin:0 0 10px; color:#1f2937; display:flex; justify-content:space-between;">
                                                Nitrógeno (N)
                                                <small style="font-weight:normal; color:#6b7280; font-size:0.8em;">(Base
                                                    Proteína)</small>
                                            </h4>
                                            <div class="kpi-row"
                                                style="grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:0;">
                                                <div>
                                                    <p class="kpi-label">Ingesta</p>
                                                    <p class="kpi-value" id="npIngestN" style="font-size:1.2em;">-</p>
                                                    <p class="kpi-foot">g/día</p>
                                                </div>
                                                <div>
                                                    <p class="kpi-label">Excreción</p>
                                                    <p class="kpi-value" id="npExcretN"
                                                        style="font-size:1.2em; color:#dc2626;">
                                                        -</p>
                                                    <p class="kpi-foot">g/día</p>
                                                </div>
                                            </div>
                                            <div style="margin-top:10px; font-size:0.9em;">
                                                <div
                                                    style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                                    <span>Retención (Prod):</span>
                                                    <strong id="npRetentN">- g/d</strong>
                                                </div>
                                                <div
                                                    style="display:flex; justify-content:space-between; padding-top:4px; border-top:1px dashed #e5e7eb;">
                                                    <span>Eficiencia:</span>
                                                    <strong id="npEffN" style="color:#059669;">-%</strong>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Phosphor -->
                                        <div style="border:1px solid #e5e7eb; border-radius:8px; padding:15px;">
                                            <h4
                                                style="margin:0 0 10px; color:#1f2937; display:flex; justify-content:space-between;">
                                                Fósforo (P)
                                                <small style="font-weight:normal; color:#6b7280; font-size:0.8em;">(Base
                                                    Mineral)</small>
                                            </h4>
                                            <div class="kpi-row"
                                                style="grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:0;">
                                                <div>
                                                    <p class="kpi-label">Ingesta</p>
                                                    <p class="kpi-value" id="npIngestP" style="font-size:1.2em;">-</p>
                                                    <p class="kpi-foot">g/día</p>
                                                </div>
                                                <div>
                                                    <p class="kpi-label">Excreción</p>
                                                    <p class="kpi-value" id="npExcretP"
                                                        style="font-size:1.2em; color:#dc2626;">
                                                        -</p>
                                                    <p class="kpi-foot">g/día</p>
                                                </div>
                                            </div>
                                            <div style="margin-top:10px; font-size:0.9em;">
                                                <div
                                                    style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                                    <span>Retención (Prod):</span>
                                                    <strong id="npRetentP">- g/d</strong>
                                                </div>
                                                <div
                                                    style="display:flex; justify-content:space-between; padding-top:4px; border-top:1px dashed #e5e7eb;">
                                                    <span>Eficiencia:</span>
                                                    <strong id="npEffP" style="color:#059669;">-%</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- RIGHT COLUMN: OUTPUTS (PROJECTIONS) -->
                            <div id="projectionsBoard" style="display:flex; flex-direction:column; gap:20px;">
                                <div class="card">
                                    <h3>Proyecciones</h3>
                                    <div class="kpi-row" style="grid-template-columns: 1fr;">
                                        <div class="kpi card-soft">
                                            <p class="kpi-label">Peso Objetivo</p>
                                            <p class="kpi-value" id="calcTargetWeight">-</p>
                                            <p class="kpi-foot">kg</p>
                                        </div>
                                        <div class="kpi card-soft">
                                            <p class="kpi-label">Fecha Sacrificio</p>
                                            <p class="kpi-value" id="calcDate">-</p>
                                            <p class="kpi-foot" id="calcDaysRemaining">0 días</p>
                                        </div>
                                        <div class="kpi card-soft">
                                            <p class="kpi-label">Ganancia Diaria (ADG)</p>
                                            <p class="kpi-value" id="calcADG">-</p>
                                            <p class="kpi-foot">kg/día</p>
                                        </div>
                                        <!-- Optional Carcass -->
                                        <div class="kpi card-soft"
                                            style="background:#fefce8; border-color:#fef08a; color:#854d0e;">
                                            <p class="kpi-label">Peso Canal Est.</p>
                                            <p class="kpi-value" id="calcCarcass">-</p>
                                            <p class="kpi-foot">Rendimiento <span id="calcYield"
                                                    style="font-size:1.2em; font-weight:bold; color:#000; margin:0 2px;">58</span>%
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                    <!-- FARMS SECTION -->
                    <div id="farms" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">GESTIÓN DE FINCAS</p>
                                <h2>Mis Fincas</h2>
                                <p class="lede">Administra tus explotaciones ganaderas</p>
                            </div>
                            <div>
                                <button class="primary" id="toggleFarmForm">Nueva Finca</button>
                            </div>
                        </div>

                        <!-- FILTERS CARD -->
                        <div class="card farm-card">
                            <div class="card-head">
                                <h3>Filtros</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px;">
                                <label style="margin:0">Buscar
                                    <input type="text" id="searchFarm" placeholder="Nombre, ubicación...">
                                </label>
                            </div>
                        </div>

                        <!-- FORM CARD (Hidden by default) -->
                        <div class="card farm-card hidden" id="farmFormCard">
                            <h3 id="farmFormTitle">Registrar Nueva Finca</h3>
                            <form id="farmForm" class="farm-form" style="border:none; padding:0; background:none;">
                                <input type="hidden" id="farmEditId">
                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                    <label>Latitud
                                        <input type="number" id="farmLat" step="any" placeholder="Ej: 40.41" readonly
                                            style="background: #f3f4f6; cursor: not-allowed;">
                                    </label>
                                    <label>Longitud
                                        <input type="number" id="farmLon" step="any" placeholder="Ej: -3.70" readonly
                                            style="background: #f3f4f6; cursor: not-allowed;">
                                    </label>
                                </div>

                                <!-- SIGPAC SEARCH -->
                                <div class="sigpac-container"
                                    style="background: linear-gradient(135deg, #e7f7ee, #f8fafc); border: 2px solid #bbebd1; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                    <h4 style="margin: 0 0 8px; color: #15803d;">Buscar en SIGPAC</h4>
                                    <p style="margin: 0 0 12px; font-size: 13px; color: #6b7280;">Introduce los
                                        datos de
                                        la parcela para autocompletar</p>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                        <label style="margin: 0;">Provincia
                                            <select id="sigpacProv">
                                                <option value="">Selecciona provincia</option>
                                                <option value="15">A Coruña</option>
                                                <option value="01">Álava</option>
                                                <option value="02">Albacete</option>
                                                <option value="03">Alicante</option>
                                                <option value="04">Almería</option>
                                                <option value="33">Asturias</option>
                                                <option value="05">Ávila</option>
                                                <option value="06">Badajoz</option>
                                                <option value="07">Baleares</option>
                                                <option value="08">Barcelona</option>
                                                <option value="09">Burgos</option>
                                                <option value="10">Cáceres</option>
                                                <option value="11">Cádiz</option>
                                                <option value="39">Cantabria</option>
                                                <option value="12">Castellón</option>
                                                <option value="51">Ceuta</option>
                                                <option value="13">Ciudad Real</option>
                                                <option value="14">Córdoba</option>
                                                <option value="16">Cuenca</option>
                                                <option value="17">Girona</option>
                                                <option value="18">Granada</option>
                                                <option value="19">Guadalajara</option>
                                                <option value="20">Guipúzcoa</option>
                                                <option value="21">Huelva</option>
                                                <option value="22">Huesca</option>
                                                <option value="23">Jaén</option>
                                                <option value="24">León</option>
                                                <option value="25">Lleida</option>
                                                <option value="27">Lugo</option>
                                                <option value="28">Madrid</option>
                                                <option value="29">Málaga</option>
                                                <option value="52">Melilla</option>
                                                <option value="30">Murcia</option>
                                                <option value="31">Navarra</option>
                                                <option value="32">Ourense</option>
                                                <option value="34">Palencia</option>
                                                <option value="35">Las Palmas</option>
                                                <option value="36">Pontevedra</option>
                                                <option value="26">La Rioja</option>
                                                <option value="37">Salamanca</option>
                                                <option value="38">S.C. Tenerife</option>
                                                <option value="40">Segovia</option>
                                                <option value="41">Sevilla</option>
                                                <option value="42">Soria</option>
                                                <option value="43">Tarragona</option>
                                                <option value="44">Teruel</option>
                                                <option value="45">Toledo</option>
                                                <option value="46">Valencia</option>
                                                <option value="47">Valladolid</option>
                                                <option value="48">Vizcaya</option>
                                                <option value="49">Zamora</option>
                                                <option value="50">Zaragoza</option>
                                            </select>
                                        </label>
                                        <label style="margin: 0;">Municipio
                                            <select id="sigpacMuni" disabled>
                                                <option value="">Selecciona provincia primero</option>
                                            </select>
                                        </label>
                                        <label style="margin: 0;">Polígono
                                            <input type="text" id="sigpacPoli" placeholder="Ej: 1">
                                        </label>
                                        <label style="margin: 0;">Parcela
                                            <input type="text" id="sigpacParc" placeholder="Ej: 1">
                                        </label>
                                    </div>
                                    <button type="button" class="primary full" id="searchSigpacBtn"
                                        style="margin-top: 8px;">
                                        Buscar en SIGPAC</button>
                                    <div id="sigpacLoading" class="hidden"
                                        style="margin-top: 12px; display: flex; align-items: center; gap: 8px; color: #6b7280;">
                                        <div
                                            style="width: 16px; height: 16px; border: 2px solid #22c55e; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;">
                                        </div>
                                        <span>Consultando SIGPAC...</span>
                                    </div>
                                    <div id="sigpacStatus" class="hidden"
                                        style="margin-top: 12px; padding: 10px; border-radius: 8px; font-size: 14px;">
                                    </div>
                                </div>

                                <label>Nombre de la finca
                                    <input type="text" id="farmName" placeholder="Ej: Finca El Roble">
                                </label>
                                <label>Ubicación
                                    <input type="text" id="farmLocation" placeholder="Ej: Salamanca, España" required>
                                </label>
                                <label>Tamaño (hectáreas)
                                    <input type="number" id="farmSize" placeholder="Ej: 150" step="any" required>
                                </label>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                    <label style="margin: 0;">Pendiente Media (%)
                                        <input type="number" id="farmSlope" placeholder="Ej: 5.4" step="0.1">
                                    </label>
                                    <label style="margin: 0;">Coef. Regadío (%)
                                        <input type="number" id="farmIrrigation" placeholder="Ej: 0" step="1">
                                    </label>
                                </div>
                                <label>Uso SIGPAC
                                    <input type="text" id="farmSigpacUse" placeholder="Ej: ZU, TA...">
                                </label>
                                <label>Tipo de suelo
                                    <select id="farmSoil" required>
                                        <option value="">Selecciona tipo</option>
                                        <option value="Arcilloso">Arcilloso</option>
                                        <option value="Arenoso">Arenoso</option>
                                        <option value="Franco">Franco</option>
                                        <option value="Limoso">Limoso</option>
                                        <option value="Pedregoso">Pedregoso</option>
                                    </select>
                                </label>
                                <label>Licencia ganadera
                                    <input type="text" id="farmLicense" placeholder="Ej: ES-37-12345" required>
                                </label>
                                <label>Licencia: Cabezas Máximas
                                    <input type="number" id="farmAnimals" placeholder="Ej: 50" required>
                                </label>
                                <label>Número de Corrales
                                    <input type="number" id="farmCorrales" placeholder="Ej: 5" min="1" step="1"
                                        required>
                                </label>
                                <div id="corralConfigContainer" class="hidden"
                                    style="margin-bottom: 15px; background: #f9fafb; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <h4 style="margin: 0 0 8px; font-size: 0.9em; color: #4b5563;">Nombres de Corrales
                                    </h4>
                                    <div id="corralInputs"
                                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
                                        <!-- Dynamic inputs -->
                                    </div>
                                </div>
                                <label>Sistema de manejo
                                    <select id="farmManagement" required>
                                        <option value="">Selecciona sistema</option>
                                        <option value="Intensivo">Intensivo</option>
                                        <option value="Semi-intensivo">Semi-intensivo</option>
                                        <option value="Extensivo">Extensivo</option>
                                    </select>
                                </label>
                                <label class="section-label"
                                    style="margin-top: 20px; font-weight: 600; color: #4b5563;">Control
                                    Climático</label>
                                <div
                                    style="background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 20px;">
                                    <label
                                        style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-weight: normal;">
                                        <input type="radio" name="weatherSource" value="public" checked
                                            onchange="toggleWeatherConfig()">
                                        <span>🌐 Estación Pública (Open-Meteo)</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; font-weight: normal;">
                                        <input type="radio" name="weatherSource" value="private"
                                            onchange="toggleWeatherConfig()">
                                        <span>📡 Estación Meteorológica Propia</span>
                                    </label>

                                    <div id="weatherStationConfig" class="hidden"
                                        style="margin-left: 24px; border-left: 2px solid #e5e7eb; padding-left: 12px;">
                                        <label style="font-size: 0.9em; color: #6b7280;">ID de Estación / API Key
                                            <input type="text" id="farmWeatherId" placeholder="Ej: STATION_001_SOTO"
                                                style="font-size: 0.9em;">
                                        </label>
                                    </div>
                                    <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                                        ℹ️ La opción pública usa la ubicación de la finca para obtener datos
                                        gratuitos.
                                    </p>
                                </div>
                                <div class="profile-actions">
                                    <button type="submit" class="primary" id="farmSubmitBtn">Guardar Finca</button>
                                    <button type="button" class="ghost" id="cancelFarmEdit"
                                        style="display: none;">Cancelar</button>
                                </div>
                            </form>
                        </div>

                        <!-- LIST CARD -->
                        <div class="card farm-list">
                            <div id="fincasList" class="farms" style="margin-top: 12px;">
                                <p class="status">No hay fincas registradas</p>
                            </div>
                        </div>
                    </div>

                    <!-- REPORTS SECTION -->
                    <div id="reports" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">REPORTES Y EXPORTACIÓN</p>
                                <h2>Generar Reportes</h2>
                                <p class="lede">Exporta tus datos en diferentes formatos</p>
                            </div>
                        </div>

                        <div class="panel-grid">
                            <div class="card">
                                <h3>Fecha del Reporte</h3>
                                <div class="farm-form"
                                    style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 0;">
                                    <label>Desde
                                        <input type="date" id="reportStartDate">
                                    </label>
                                    <label>Hasta
                                        <input type="date" id="reportEndDate">
                                    </label>
                                </div>
                            </div>

                            <div class="card">
                                <h3>Filtros de Datos</h3>
                                <div class="farm-form"
                                    style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 0;">
                                    <label>Finca
                                        <select id="reportFarm">
                                            <option value="">Todas las fincas</option>
                                        </select>
                                    </label>
                                    <label>Corral
                                        <select id="reportCorral" disabled>
                                            <option value="">Todos los corrales</option>
                                        </select>
                                    </label>
                                    <label style="position:relative;">Animal (Crotal)
                                        <input type="text" id="reportAnimal" placeholder="Buscar por ID..."
                                            list="report-animal-list">
                                        <datalist id="report-animal-list"></datalist>
                                    </label>
                                </div>
                            </div>

                            <div class="card">
                                <h3>Tipo de Reporte</h3>
                                <div class="action-list">
                                    <button class="action-btn" data-report="inventory">Inventario de
                                        Animales</button>
                                    <button class="action-btn" data-report="events">Historial de Eventos</button>
                                    <button class="action-btn" data-report="weights">Historial de Pesos</button>
                                    <button class="action-btn" data-report="farms">Resumen de Fincas</button>
                                    <button class="action-btn" data-report="weather_history">Historial
                                        Climatológico</button>
                                    <button class="action-btn" data-report="economics">Balance Económico
                                        (Avanzado)</button>
                                    <button class="action-btn" data-report="productivity">Productividad (GMD)</button>
                                    <button class="action-btn" data-report="reproductive">Ciclo Reproductivo</button>
                                    <button class="action-btn" data-report="complete">Reporte Completo</button>
                                </div>
                            </div>

                            <div class="card">
                                <h3>Formato de Exportación</h3>
                                <div class="action-list">
                                    <button class="action-btn" id="exportCSV">Exportar a CSV</button>
                                    <button class="action-btn" id="exportPDF">Exportar a PDF</button>
                                </div>
                                <div style="margin-top: 16px;">
                                    <p class="status">Selecciona un tipo de reporte arriba</p>
                                    <p class="status" id="reportStatus"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PROFILE SECTION -->
                    <div id="profile" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">MI CUENTA</p>
                                <h2>Perfil de Usuario</h2>
                                <p class="lede">Gestiona tu información personal</p>
                            </div>
                        </div>

                        <div class="card profile-card">
                            <div class="profile-avatar-wrap">
                                <div class="avatar large" id="profileAvatar">U</div>
                                <label class="upload-btn">
                                    Subir foto
                                    <input type="file" id="avatarInput" accept="image/*">
                                </label>
                                <button class="ghost small" id="avatarRemove">Eliminar</button>
                            </div>
                            <form id="profileForm" class="profile-form">
                                <label>Nombre completo
                                    <input type="text" id="profileName" placeholder="Tu nombre">
                                </label>
                                <label>Correo electrónico
                                    <input type="email" id="profileEmail" placeholder="tu@correo.com">
                                </label>
                                <div class="profile-actions">
                                    <button type="submit" class="primary">Guardar cambios</button>
                                    <button type="button" class="ghost" id="profileCancel">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- DATOS SECTION (Admin Only) -->
                    <div id="data" class="section hidden">
                        <div class="content-head">
                            <div>
                                <p class="eyebrow">CONFIGURACIÓN</p>
                                <h2>Datos de Razas</h2>
                                <p class="lede">Gestión de información de razas bovinas</p>
                            </div>
                        </div>



                        <!-- CSV Upload Card -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>Importar/Actualizar Razas desde CSV</h3>
                            <div class="farm-form" style="grid-template-columns: 1fr;">
                                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <input type="file" id="breedCSVInput" accept=".csv"
                                        style="flex: 1; min-width: 200px;">
                                    <button class="primary" id="uploadBreedCSV">Cargar CSV</button>
                                    <button class="ghost" id="downloadBreedTemplate">Descargar Plantilla</button>
                                </div>
                                <div id="csvUploadStatus" class="hidden"
                                    style="padding: 10px; border-radius: 4px; margin-top: 10px;"></div>
                                <p style="font-size: 13px; color: #666; margin-top: 8px;">
                                    📋 Sube un archivo CSV con las columnas: raza_id, raza, subespecie,
                                    peso_macho_adulto_kg, peso_hembra_adulta_kg, edad_sacrificio_meses,
                                    ADG_feedlot_kg_dia, FCR, termotolerancia etc.
                                </p>
                            </div>
                        </div>

                        <!-- Breed Data Table -->
                        <div class="card">
                            <div class="card-head">
                                <h3>Razas Registradas (<span id="breedCount">0</span>)</h3>
                            </div>
                            <div style="overflow-x: auto;">
                                <table id="breedTable" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">ID</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Raza</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">
                                                Subespecie
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Peso ♂
                                                (kg)
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Peso ♀
                                                (kg)
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Edad
                                                Sacrificio (meses)</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">ADG
                                                Feedlot
                                                (kg/dia)</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">ADG
                                                Pastoreo
                                                (kg/dia)</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">FCR</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">
                                                Termotolerancia</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Marmoleo
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Facilidad
                                                Parto</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Market Data Management -->
                        <h2 style="margin-top: 40px; margin-bottom: 20px;">Datos de Mercado (Precios)</h2>
                        <div class="card" style="margin-bottom: 20px;">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- Beef Prices -->
                                <div>
                                    <h3 style="font-size:1.1em; margin-bottom:10px;">Precios Vacuno (SEUROP)</h3>
                                    <p style="font-size:0.85em; color:#666; margin-bottom:8px;">CSV: Categoria;
                                        Conformacion; Grasa; Precio</p>
                                    <div style="display:flex; gap:5px;">
                                        <input type="file" id="beefPriceCSV" accept=".csv"
                                            class="border p-1 w-full text-sm">
                                        <button id="uploadBeefPriceBtn" class="primary small">Subir</button>
                                        <button id="downloadBeefTemplateBtn" class="ghost small"
                                            title="Descargar plantilla CSV">📄</button>
                                    </div>
                                    <div id="beefPriceStatus" class="mt-2 text-xs hidden"></div>
                                </div>

                                <!-- Feed Price Updates -->
                                <div>
                                    <h3 style="font-size:1.1em; margin-bottom:10px;">Actualizar Precios Pienso</h3>
                                    <p style="font-size:0.85em; color:#666; margin-bottom:8px;">CSV: Alimento_ID;
                                        Nuevo_Precio</p>
                                    <div style="display:flex; gap:5px;">
                                        <input type="file" id="feedUpdateCSV" accept=".csv"
                                            class="border p-1 w-full text-sm">
                                        <button id="updateFeedPriceBtn" class="primary small"
                                            style="background-color:#16a34a;">Actualizar</button>
                                        <button id="downloadFeedUpdateTemplateBtn" class="ghost small"
                                            title="Descargar plantilla CSV">📄</button>
                                    </div>
                                    <div id="feedUpdateStatus" class="mt-2 text-xs hidden"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Feed Data Section -->
                        <h2 style="margin-top: 40px; margin-bottom: 20px;">Gestión de Alimentos</h2>

                        <!-- CSV Upload Card for Feeds -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>Importar/Actualizar Alimentos desde CSV</h3>
                            <div class="farm-form" style="grid-template-columns: 1fr;">
                                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <input type="file" id="feedCSVInput" accept=".csv"
                                        style="flex: 1; min-width: 200px;">
                                    <button class="primary" id="uploadFeedCSV">Cargar CSV</button>
                                    <button class="ghost" id="downloadFeedTemplate">Descargar Plantilla</button>
                                </div>
                                <div id="feedUploadStatus" class="hidden"
                                    style="padding: 10px; border-radius: 4px; margin-top: 10px;"></div>
                                <p style="font-size: 13px; color: #666; margin-top: 8px;">
                                    Sube un archivo CSV (separado por punto y coma) con las columnas: ID; Tipo;
                                    Nombre;
                                    Porcentaje_MS; Porcentaje_PB; Porcentaje_FDN; Porcentaje_ADF;
                                    Energia_Neta_Mcal_kg; Riesgo; Uso_Recomendado; Notas; Coste_Eur_kg
                                </p>
                            </div>
                        </div>

                        <!-- Feed Data Table -->
                        <div class="card">
                            <div class="card-head">
                                <h3>Alimentos Registrados (<span id="feedCount">0</span>)</h3>
                            </div>
                            <div style="overflow-x: auto;">
                                <table id="feedTable" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">ID</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Tipo</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Nombre
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">% MS</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">% PB</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">% FDN
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">% ADF
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Energía
                                                Neta
                                                (Mcal/kg)</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Riesgo
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Uso
                                                Recomendado</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Notas
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Coste
                                                (€/kg)</th>

                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Soil Data Section -->
                        <h2 style="margin-top: 40px; margin-bottom: 20px;">Gestión de Suelos</h2>

                        <!-- Soil Data Table -->
                        <div class="card">
                            <div class="card-head">
                                <h3>Tipos de Suelo (<span id="soilCount">0</span>)</h3>
                            </div>
                            <div style="overflow-x: auto;">
                                <table id="soilTable" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">ID</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Nombre
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Textura
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">pH Típico
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Retención
                                                Agua</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Drenaje
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Riesgos
                                                Principales</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Soil-Feed Matrix Table -->
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-head">
                                <h3>Matriz Suelo-Cultivo</h3>
                            </div>
                            <div style="overflow-x: auto;">
                                <table id="soilFeedTable" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Suelo
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Tipo
                                                Alimento
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">Nombre
                                                Alimento</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600;">
                                                Condiciones
                                                Especiales</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Animal Detail Modal (Moved to root) -->
    <div id="animalDetailModal" class="modal hidden">
        <div class="modal-content card">
            <span class="close-modal" id="closeAnimalDetail">&times;</span>
            <div class="detail-header">
                <h2 id="detailCrotal">ESXXXXX</h2>
                <span class="tag" id="detailStatus">Activo</span>
            </div>

            <div class="detail-grid">
                <div class="detail-item">
                    <span class="label">Raza</span>
                    <span class="value" id="detailBreed">-</span>
                </div>
                <div class="detail-item">
                    <span class="label">Sexo</span>
                    <span class="value" id="detailSex">-</span>
                </div>
                <div class="detail-item">
                    <span class="label">Nacimiento</span>
                    <span class="value" id="detailBirth">-</span>
                </div>
                <div class="detail-item">
                    <span class="label">Finca</span>
                    <span class="value" id="detailFarm">-</span>
                </div>
                <div class="detail-item">
                    <span class="label">Corral</span>
                    <span class="value" id="detailCorralDisplay">-</span>
                </div>
                <div class="detail-item" style="grid-column: span 2;">
                    <span class="label">Etapa Productiva</span>
                    <span class="value" id="detailStage" style="color: #d97706; font-weight: bold;">-</span>
                </div>
            </div>

            <!-- Lifecycle & Nutrition Info -->
            <div id="detailLifecycle"></div>

            <h4 style="margin: 0 0 10px;">Pesos (kg)</h4>
            <div class="detail-grid">
                <div class="detail-item">
                    <span class="label">Al Nacer</span>
                    <span class="value" id="detailBirthWeight">0</span>
                </div>
                <div class="detail-item">
                    <span class="label">Actual</span>
                    <span class="value" id="detailWeight">0</span>
                </div>
                <div class="detail-item">
                    <span class="label">Ganancia Total</span>
                    <span class="value" id="detailGain">0</span>
                </div>
            </div>

            <h4 style="margin: 0 0 10px;">Genealogía</h4>
            <div class="detail-grid" style="margin-bottom: 20px;">
                <div class="detail-item">
                    <span class="label">Padre</span>
                    <span class="value" id="detailFather">-</span>
                </div>
                <div class="detail-item">
                    <span class="label">Madre</span>
                    <span class="value" id="detailMother">-</span>
                </div>
            </div>

            <h4 style="margin: 0 0 10px;">Descendencia</h4>
            <ul id="detailOffspring"
                style="padding-left: 20px; margin: 0 0 20px 0; font-size: 14px; color: var(--text);">
                <!-- Populated via JS -->
            </ul>

            <h4 style="margin: 0 0 10px;">Notas</h4>
            <p id="detailNotes" style="font-size: 14px; color: var(--muted); margin: 0;">-</p>

            <div class="modal-actions" style="margin-top: 15px; display: flex; justify-content: flex-end;">
                <button class="ghost" id="closeDetailBtn">Cerrar</button>
            </div>
        </div>
    </div>
    </div>
    <!-- Farm Detail Modal [NEW] -->
    <div id="farmDetailModal" class="modal hidden">
        <div class="modal-content card" style="max-width: 600px;">
            <span class="close-modal" id="closeFarmDetail">&times;</span>
            <div class="detail-header" style="flex-direction: column; align-items: flex-start; gap: 10px;">
                <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                    <h2 id="detailFarmName" style="margin:0;">Finca</h2>
                    <span class="tag" id="detailFarmSize">0 ha</span>
                </div>
                <!-- STATS ROW -->
                <div style="width: 100%; display: flex; gap: 15px; font-size: 0.9em; margin-top: 5px;">
                    <div style="background: #f1f5f9; padding: 6px 10px; border-radius: 6px;">
                        <div style="color: #64748b; font-size: 0.8em; font-weight: 700;">LICENCIA</div>
                        <div style="font-weight: 800; font-size: 1.1em;" id="detailFarmLimit">-</div>
                    </div>
                    <div style="background: #f1f5f9; padding: 6px 10px; border-radius: 6px;">
                        <div style="color: #64748b; font-size: 0.8em; font-weight: 700;">TOTAL</div>
                        <div style="font-weight: 800; font-size: 1.1em;" id="detailFarmTotal">-</div>
                    </div>
                    <div style="background: #f1f5f9; padding: 6px 10px; border-radius: 6px;">
                        <div style="color: #64748b; font-size: 0.8em; font-weight: 700;">PRODUCTORAS</div>
                        <div style="font-weight: 800; font-size: 1.1em;" id="detailFarmProductive">-</div>
                    </div>
                </div>
                <!-- COMPLIANCE ALERT -->
                <div id="detailFarmAlert"
                    style="width: 100%; padding: 8px 12px; border-radius: 6px; font-weight: bold; font-size: 0.9em; display: none;">
                </div>
            </div>

            <div style="margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 6px;">
                <strong>📍 Ubicación:</strong> <span id="detailFarmLocation">-</span>
                <br>
                <span style="font-size: 0.9em; color: #64748b;">Lat: <span id="detailFarmLat">-</span>, Lon: <span
                        id="detailFarmLon">-</span></span>
            </div>



            <h4 style="margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Datos SIGPAC</h4>
            <div class="detail-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="detail-item"><strong>Pendiente:</strong> <span id="detailFarmSlope">-</span>%</div>
                <div class="detail-item"><strong>Regadío:</strong> <span id="detailFarmIrrigation">-</span>%</div>
                <div class="detail-item"><strong>Uso:</strong> <span id="detailFarmUse">-</span></div>
                <div class="detail-item"><strong>Suelo:</strong> <span id="detailFarmSoil">-</span></div>
            </div>

            <h4 style="margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Razas Recomendadas</h4>
            <div id="detailFarmBreeds"
                style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; margin-bottom: 20px;">
                <span style="color: #9ca3af; font-size: 0.9em;">Cargando recomendaciones...</span>
            </div>

            <h4 style="margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Producción</h4>
            <div class="detail-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="detail-item"><strong>Licencia:</strong> <span id="detailFarmLicense">-</span></div>
                <div class="detail-item"><strong>Animales:</strong> <span id="detailFarmAnimals">-</span></div>
                <div class="detail-item"><strong>Corrales:</strong> <span id="detailFarmCorrales">-</span></div>
                <div class="detail-item"><strong>Manejo:</strong> <span id="detailFarmManagement">-</span></div>
                <div class="detail-item"><strong>Alimentación:</strong> <span id="detailFarmFeed">-</span></div>
            </div>

            <h4 style="margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Clima (Tiempo Real)</h4>
            <div id="detailFarmWeather"
                style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 10px; min-height: 60px; display: flex; align-items: center; justify-content: center;">
                ⏳ Cargando datos climáticos...
            </div>

            <!-- Nutrition Engine Output -->
            <h4 style="margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px; color: #7c2d12;">🌱 Suelos
                y Cultivos</h4>
            <div id="detailFarmCrops" style="font-size: 0.9em; margin-top: 10px; color: #4b5563;">
                Calculando compatibilidad edafológica...
            </div>

            <div class="detail-actions" style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="ghost" id="btnDeleteFarmModal" style="color: #ef4444;">Eliminar Finca</button>
                <button class="primary" id="btnEditFarmModal">Editar Finca</button>
            </div>
        </div>
    </div>

    <!-- EVENT DETAIL MODAL -->
    <div id="eventDetailModal" class="modal hidden">
        <div class="modal-content" style="max-width: 450px;">
            <span class="close-modal" id="closeEventDetail">&times;</span>
            <div id="eventDetailContent" style="padding: 24px 24px 0 24px;">
                <!-- Injected via JS -->
            </div>
            <div class="modal-actions" style="padding: 20px;">
                <button class="ghost" id="btnDeleteEventModal" style="color: #ef4444;">Eliminar</button>
                <button class="primary" id="btnCloseEventModal">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="app-config.js?v=2025_v16"></script>
    <script src="carcass-quality-engine.js?v=2025_v16"></script>
    <script src="market-data-manager.js?v=2025_v16"></script>
    <script src="breed-manager.js?v=2025_v16"></script>
    <script src="breeding-engine.js?v=2025_v16"></script>
    <script src="feed-manager.js?v=2025_v16"></script>
    <script src="soil-manager.js?v=2025_v16"></script>
    <script src="soil-ui-handler.js?v=2025_v16"></script>
    <script src="nutrition-engine.js?v=2025_v16"></script>
    <script src="feed-csv-handler.js?v=2025_v16"></script>
    <script src="animal-calculator.js?v=2025_v16"></script>
    <script src="farm-feed-manager.js?v=2025_v16"></script>
    <script src="weather-service.js?v=2025_v16"></script>
    <script src="app-sigpac.js?v=2025_v16"></script>
    <script src="app.js?v=2025_v17"></script>
    <script src="app-reports.js?v=2025_v16"></script>
</body>

</html>